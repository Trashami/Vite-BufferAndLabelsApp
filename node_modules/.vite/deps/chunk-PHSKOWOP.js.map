{
  "version": 3,
  "sources": ["../../@arcgis/core/layers/support/rasterDatasets/EphemeralBlockCache.js", "../../@arcgis/core/layers/support/rasterDatasets/RawBlockCache.js"],
  "sourcesContent": ["/*\nAll material copyright ESRI, All Rights Reserved, unless otherwise specified.\nSee https://js.arcgis.com/4.25/esri/copyright.txt for details.\n*/\nclass t{constructor(t=15e3,e=5e3){this._timer=null,this._cachedBlocks=new Map,this._size=-1,this._duration=t,this._interval=Math.min(t,e)}decreaseRefCount(t,e){const s=t+\"/\"+e,r=this._cachedBlocks;if(r.has(s)){const t=r.get(s);return t.refCount--,t.refCount<=0&&(r.delete(s),t.controller&&t.controller.abort()),t.refCount}return 0}getBlock(t,e){const s=t+\"/\"+e,r=this._cachedBlocks;if(r.has(s)){const t=r.get(s);return t.ts=Date.now(),t.refCount++,r.delete(s),r.set(s,t),t.block}return null}putBlock(t,e,s,r){const i=this._cachedBlocks,c=t+\"/\"+e;if(i.has(c)){const t=i.get(c);t.ts=Date.now(),t.refCount++}else i.set(c,{block:s,ts:Date.now(),refCount:1,controller:r});this._trim(),this._updateTimer()}deleteBlock(t,e){const s=this._cachedBlocks,r=t+\"/\"+e;s.has(r)&&s.delete(r)}updateMaxSize(t){this._size=t,this._trim()}empty(){this._cachedBlocks.clear(),this._clearTimer()}getCurrentSize(){return this._cachedBlocks.size}_updateTimer(){if(null!=this._timer)return;const t=this._cachedBlocks;this._timer=setInterval((()=>{const e=Array.from(t),s=Date.now();for(let r=0;r<e.length&&e[r][1].ts<=s-this._duration;r++)t.delete(e[r][0]);0===t.size&&this._clearTimer()}),this._interval)}_trim(){const t=this._cachedBlocks;if(-1===this._size||this._size>=t.size)return;const e=Array.from(t);for(let s=0;s<e.length-this._size;s++)t.delete(e[s][0])}_clearTimer(){null!=this._timer&&(clearInterval(this._timer),this._timer=null)}}export{t as default};\n", "/*\nAll material copyright ESRI, All Rights Reserved, unless otherwise specified.\nSee https://js.arcgis.com/4.25/esri/copyright.txt for details.\n*/\nimport\"../../../geometry.js\";import{isSome as e}from\"../../../core/maybe.js\";import t from\"./EphemeralBlockCache.js\";import{projectExtent as n,projectResolution as o,snapPyramid as l}from\"../rasterFunctions/rasterProjectionHelper.js\";import r from\"../../../geometry/Point.js\";const c=new Map,i=new t;function a(e,t){return null==t?e:`${e}?sliceId=${t}`}function u(e,t){const n={extent:null,rasterInfo:t,cache:new Map},o=c.get(e);return o?(o.push(n),o.length-1):(c.set(e,[n]),0)}function f(e,t){const n=c.get(e);n&&(n[t]=null,n.some((e=>null!=e))||c.delete(e))}function s(e){c.delete(e)}function m(e,t,n){const o=c.get(e);if(!o)return null==t?i.decreaseRefCount(e,n):0;if(null==t||null==o[t])return i.decreaseRefCount(e,n);const l=o[t]?.cache,r=l?.get(n);if(l&&r){if(r.refCount--,0===r.refCount){l.delete(n);for(let e=0;e<o.length;e++)o[e]?.cache.delete(n);r.controller&&r.controller.abort()}return r.refCount}return 0}function x(e,t,n){const o=c.get(e);if(!o)return null==t?i.getBlock(e,n):null;if(null==t||null==o[t]){for(let e=0;e<o.length;e++){const t=o[e]?.cache.get(n);if(t)return t.refCount++,t.block}return i.getBlock(e,n)}const l=o[t]?.cache.get(n);if(l)return l.refCount++,l.block;for(let r=0;r<o.length;r++){if(r===t||!o[r])continue;const e=o[r]?.cache,l=e?.get(n);if(e&&l)return l.refCount++,e.set(n,l),l.block}return null}function h(e,t,n,o,l=null){const r=c.get(e);if(!r)return void(null==t&&i.putBlock(e,n,o,l));if(null==t||null==r[t])return void i.putBlock(e,n,o,l);const a={refCount:1,block:o,isResolved:!1,isRejected:!1,controller:l};o.then((()=>a.isResolved=!0)).catch((()=>a.isRejected=!0)),r[t]?.cache.set(n,a)}function d(e,t,n){const o=c.get(e);o?null!=t&&null!=o[t]?o[t]?.cache.delete(n):i.deleteBlock(e,n):null==t&&i.deleteBlock(e,n)}function y(e,t){const n=c.get(e);return n?n[t]??null:null}function g(t,c,i,a,u,f,s=null){const m=y(t,c);if(!m)return;const x=m.extent,{cache:h,rasterInfo:d}=m;if(x&&x.xmin===i.xmin&&x.xmax===i.xmax&&x.ymin===i.ymin&&x.ymax===i.ymax)return;a=a??0;const g=i.clone().normalize(),{spatialReference:p,transform:k}=d,M=new Set;for(let y=0;y<g.length;y++){const t=g[y];if(t.xmax-t.xmin<=a||t.ymax-t.ymin<=a)continue;let c=n(t,p,s);e(k)&&(c=k.inverseTransform(c));const i=new r({x:a,y:a,spatialReference:t.spatialReference});if(null==u&&!(u=o(i,p,t,s)))return;const{pyramidLevel:m,pyramidResolution:x,excessiveReading:h}=l(u,d,f||\"closest\");if(h)return;const{storageInfo:R}=d,{origin:C}=R,j={x:Math.max(0,Math.floor((c.xmin-C.x)/x.x)),y:Math.max(0,Math.floor((C.y-c.ymax)/x.y))},B=Math.ceil((c.xmax-c.xmin)/x.x-.1),b=Math.ceil((c.ymax-c.ymin)/x.y-.1),v=m>0?R.pyramidBlockWidth:R.blockWidth,w=m>0?R.pyramidBlockHeight:R.blockHeight,$=1,I=Math.max(0,Math.floor(j.x/v)-$),H=Math.max(0,Math.floor(j.y/w)-$),E=Math.floor((j.x+B-1)/v)+$,P=Math.floor((j.y+b-1)/w)+$;for(let e=H;e<=P;e++)for(let t=I;t<=E;t++)M.add(`${m}/${e}/${t}`)}h.forEach(((e,t)=>{if(!M.has(t)){const e=h.get(t);(null==e||e.isResolved||e.isRejected)&&h.delete(t)}})),m.extent={xmin:i.xmin,ymin:i.ymin,xmax:i.xmax,ymax:i.ymax}}export{m as decreaseRefCount,d as deleteBlock,s as deleteRaster,x as getBlock,a as getRasterId,h as putBlock,u as register,f as unregister,g as update};\n"],
  "mappings": "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",
  "names": ["t", "r", "i", "c", "t", "e", "t", "r", "e", "l", "a", "c", "i", "u", "f", "m", "x", "h", "d", "g", "y", "C", "w"]
}
