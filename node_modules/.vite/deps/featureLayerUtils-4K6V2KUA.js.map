{
  "version": 3,
  "sources": ["../../@arcgis/core/layers/save/featureLayerUtils.js"],
  "sourcesContent": ["/*\nAll material copyright ESRI, All Rights Reserved, unless otherwise specified.\nSee https://js.arcgis.com/4.25/esri/copyright.txt for details.\n*/\nimport{difference as e}from\"../../core/arrayUtils.js\";import t from\"../../core/Error.js\";import r from\"../../core/Logger.js\";import{isNone as a,isSome as o}from\"../../core/maybe.js\";import{debounce as s,eachAlways as l}from\"../../core/promiseUtils.js\";import{updateOrigins as i}from\"../../core/accessorSupport/originUtils.js\";import n from\"../FeatureLayer.js\";import{parse as u}from\"../support/arcgisLayerUrl.js\";import{fetchFeatureService as p}from\"../support/fetchService.js\";import{isFeatureCollectionLayer as c,isFeatureServiceLayer as y}from\"../support/layerUtils.js\";import d from\"../../portal/Portal.js\";import m from\"../../portal/PortalItem.js\";import{createForItemWrite as f}from\"../../portal/support/jsonContext.js\";import{addTypeKeyword as w,TypeKeyword as h,getWGS84ExtentForItem as v,removeTypeKeyword as b}from\"../../portal/support/portalItemUtils.js\";const I=r.getLogger(\"esri.layers.FeatureLayer\"),S=\"Feature Service\";function g(e,t){return`Layer (title: ${e.title}, id: ${e.id}) of type '${e.declaredClass}' ${t}`}function j(e,r){if(r.type!==S)throw new t(\"feature-layer:portal-item-wrong-type\",g(e,`should have portal item of type \"${S}\"`))}async function L(e){if(await e.load(),c(e))throw new t(\"feature-layer:save\",g(e,\"using an in-memory source cannot be saved to a portal item\"))}function P(e,r){let a=(e.messages??[]).filter((({type:e})=>\"error\"===e)).map((({name:e,message:r,details:a})=>new t(e,r,a)));if(r?.ignoreUnsupported&&(a=a.filter((({name:e})=>\"layer:unsupported\"!==e&&\"symbol:unsupported\"!==e&&\"symbol-layer:unsupported\"!==e&&\"property:unsupported\"!==e&&\"url:unsupported\"!==e))),a.length>0)throw new t(\"feature-layer:save\",\"Failed to save feature layer due to unsupported or invalid content. See 'details.errors' for more detailed information\",{errors:a})}async function J(e,t,r){\"beforeSave\"in e&&\"function\"==typeof e.beforeSave&&await e.beforeSave();const a=e.write({},t);return P(t,r),a}function N(e){const{layer:t,layerJSON:r}=e;return t.isTable?{layers:[],tables:[r]}:{layers:[r],tables:[]}}function O(e){w(e,h.JSAPI),e.typeKeywords&&(e.typeKeywords=e.typeKeywords.filter(((e,t,r)=>r.indexOf(e)===t)))}function E(e){const r=e.portalItem;if(!r)throw I.error(\"save: requires the portalItem property to be set\"),new t(\"feature-layer:portal-item-not-set\",g(e,\"requires the portalItem property to be set\"));if(!r.loaded)throw new t(\"feature-layer:portal-item-not-loaded\",g(e,\"cannot be saved to a portal item that does not exist or is inaccessible\"));j(e,r)}async function T(e,t){return/\\/\\d+\\/?$/.test(e.url??\"\")?N(t[0]):$(e,t)}async function $(e,t){const{layer:{url:r,customParameters:a,apiKey:o}}=t[0];let s=await e.fetchData(\"json\");s&&null!=s.layers&&null!=s.tables||(s=await x(s,{url:r??\"\",customParameters:a,apiKey:o},t.map((e=>e.layer.layerId))));for(const l of t)K(l.layer,l.layerJSON,s);return s}async function x(e,t,r){var a,o;e||(e={}),(a=e).layers||(a.layers=[]),(o=e).tables||(o.tables=[]);const{url:s,customParameters:l,apiKey:i}=t,{serviceJSON:n,layersJSON:u}=await p(s,{customParameters:l,apiKey:i}),c=A(e.layers,n.layers,r),y=A(e.tables,n.tables,r);e.layers=c.itemResources,e.tables=y.itemResources;const d=[...c.added,...y.added],m=u?[...u.layers,...u.tables]:[];return await U(e,d,s,m),e}function A(t,r,a){const o=e(t,r,((e,t)=>e.id===t.id));t=t.filter((e=>!o.removed.some((t=>t.id===e.id))));const s=o.added.map((({id:e})=>({id:e})));return s.forEach((({id:e})=>{t.push({id:e})})),{itemResources:t,added:s.filter((({id:e})=>!a.includes(e)))}}async function U(e,t,r,o){const s=t.map((({id:e})=>new n({url:r,layerId:e,sourceJSON:o.find((({id:t})=>t===e))})));await l(s.map((e=>e.load()))),s.forEach((t=>{const{layerId:r,loaded:o,defaultPopupTemplate:s}=t;if(!o||a(s))return;K(t,{id:r,popupInfo:s.toJSON()},e)}))}function K(e,t,r){e.isTable?F(r.tables,t):F(r.layers,t)}function F(e,t){if(!e)return;const r=e.findIndex((({id:e})=>e===t.id));-1===r?e.push(t):e[r]=t}function R(e){const{portalItem:t}=e;return y(e)&&!e.dynamicDataSource&&!!t?.loaded&&t.type===S}async function D(e){if(!e?.length)throw new t(\"feature-layer-utils-saveall:missing-parameters\",\"'layers' array should contain at least one feature layer\");await Promise.all(e.map((e=>e.load())));for(const o of e)if(!R(o))throw new t(\"feature-layer-utils-saveall:invalid-parameters\",`'layers' array should only contain layers or tables in a feature service loaded from 'Feature Service' item. ${g(o,\"does not conform\")}`,{layer:o});const r=e.map((e=>e.portalItem.id));if(new Set(r).size>1)throw new t(\"feature-layer-utils-saveall:invalid-parameters\",\"All layers in the 'layers' array should be loaded from the same portal item\");const a=e.map((e=>e.layerId));if(new Set(a).size!==a.length)throw new t(\"feature-layer-utils-saveall:invalid-parameters\",\"'layers' array should contain only one instance each of layer or table in a feature service\")}function _(e,t){var r,a;let o=m.from(t);return o.id&&(o=o.clone(),o.id=null),(r=o).type??(r.type=S),(a=o).portal??(a.portal=d.getDefault()),j(e,o),o}async function q(e,t){const{url:r,layerId:a,title:s,fullExtent:l,isTable:i}=e,n=u(r),p=o(n)&&\"FeatureServer\"===n.serverType;t.url=p?r:`${r}/${a}`,t.title||(t.title=s),t.extent=null,!i&&o(l)&&(t.extent=await v(l)),b(t,h.METADATA),b(t,h.MULTI_LAYER),w(t,h.SINGLE_LAYER),i&&w(t,h.TABLE),O(t)}async function z(e,t,r){const a=e.portal;await(a?._signIn()),await(a?.user?.addItem({item:e,data:t,folder:r?.folder}))}const C=s(M);async function M(e,t){await L(e),E(e);const r=e.portalItem,a=f(r),o=await J(e,a,t),s=await T(r,[{layer:e,layerJSON:o}]);return O(r),await r.update({data:s}),i(a),r}const Y=s((async(e,t)=>{await D(e);const r=e[0].portalItem,a=f(r),o=await Promise.all(e.map((e=>J(e,a,t)))),s=await T(r,e.map(((e,t)=>({layer:e,layerJSON:o[t]}))));return O(r),await r.update({data:s}),await Promise.all(e.slice(1).map((e=>e.portalItem.reload()))),i(a),r.clone()})),B=s(G);async function G(e,t,r){await L(e);const a=_(e,t),o=f(a),s=N({layer:e,layerJSON:await J(e,o,r)});return await q(e,a),await z(a,s,r),e.portalItem=a,i(o),a}export{C as save,Y as saveAll,B as saveAs};\n"],
  "mappings": "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",
  "names": ["s", "t", "j", "r", "a", "e", "E", "o", "x", "l", "i", "c", "m"]
}
