/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.25/esri/copyright.txt for details.
*/
import"../../../geometry.js";import{isSome as e}from"../../../core/maybe.js";import{isSameTagIgnoreNS as t,getElementValue as n,getElements as r,getElement as s,getElementNumericValue as a,getElementNumericValues as i}from"./xmlUtilities.js";import l from"../rasterTransforms/PolynomialTransform.js";import o from"../../../geometry/SpatialReference.js";function f(e,t){if(!e||!t)return null;const n=[];for(let r=0;r<e.length;r++)n.push(e[r]),n.push(t[r]);return n}function u(e){const t=s(e,"GeodataXform"),r=m(a(t,"SpatialReference/WKID")||n(t,"SpatialReference/WKT"));if("typens:PolynomialXform"!==t.getAttribute("xsi:type"))return{spatialReference:r,transform:null};const o=a(t,"PolynomialOrder")??1,u=i(t,"CoeffX/Double"),c=i(t,"CoeffY/Double"),d=i(t,"InverseCoeffX/Double"),p=i(t,"InverseCoeffY/Double"),S=f(u,c),C=f(d,p);return{spatialReference:r,transform:S&&C&&S.length&&C.length?new l({spatialReference:r,polynomialOrder:o,forwardCoefficients:S,inverseCoefficients:C}):null}}function c(e){const t=a(e,"NoDataValue"),i=s(e,"Histograms/HistItem"),l=a(i,"HistMin"),o=a(i,"HistMax"),f=a(i,"BucketCount"),u=n(i,"HistCounts")?.split("|").map((e=>Number(e)));let c,m,d,p;r(e,"Metadata/MDI").forEach((e=>{const t=Number(e.textContent??e.nodeValue);switch(e.getAttribute("key").toUpperCase()){case"STATISTICS_MINIMUM":c=t;break;case"STATISTICS_MAXIMUM":m=t;break;case"STATISTICS_MEAN":d=t;break;case"STATISTICS_STDDEV":p=t}}));const S=a(e,"Metadata/SourceBandIndex");return{noDataValue:t,histogram:u?.length&&null!=l&&null!=o?{min:l,max:o,size:f||u.length,counts:u}:null,sourceBandIndex:S,statistics:null!=c&&null!=m?{min:c,max:m,avg:d,stddev:p}:null}}function m(e){if(!e)return null;let t=Number(e);if(!isNaN(t)&&0!==t)return new o({wkid:t});if((e=String(e)).startsWith("COMPD_CS")){if(!e.includes("VERTCS")||!e.includes("GEOGCS")&&!e.startsWith("PROJCS"))return null;const n=e.indexOf("VERTCS"),r=e.indexOf("PROJCS"),s=r>-1?r:e.indexOf("GEOGCS");if(-1===s)return null;const a=e.slice(s,e.lastIndexOf("]",n)+1).trim(),i=e.slice(n,e.lastIndexOf("]")).trim();t=d(a);const l=new o(t?{wkid:t}:{wkt:a}),f=d(i);return f&&(l.vcsWkid=f),l}return e.startsWith("GEOGCS")||e.startsWith("PROJCS")?(t=d(e),new o(0!==t?{wkid:t}:{wkt:e})):null}function d(e){const t=e.replace(/\]/g,"[").replace(/\"/g,"").split("[").map((e=>e.trim())).filter((e=>""!==e)),n=t[t.length-1].split(","),r=n[0]?.toLowerCase();if(("epsg"===r||"esri"===r)&&e.endsWith('"]]')){const e=Number(n[1]);if(!isNaN(e)&&0!==e)return e}return 0}function p(s){if("pamdataset"!==s?.documentElement.tagName?.toLowerCase())return{};const a={spatialReference:null,transform:null,metadata:{},rasterBands:[],statistics:null,histograms:null};s.documentElement.childNodes.forEach((e=>{if(1===e.nodeType)if(t(e,"SRS")){if(!a.spatialReference){const t=n(e);a.spatialReference=m(t)}}else if(t(e,"Metadata"))if("xml:ESRI"===e.getAttribute("domain")){const{spatialReference:t,transform:n}=u(e);a.transform=n,a.spatialReference||(a.spatialReference=t)}else{r(e,"MDI").forEach((e=>a.metadata[e.getAttribute("key")]=n(e)))}else if(t(e,"PAMRasterBand")){const t=c(e);null!=t.sourceBandIndex&&null==a.rasterBands[t.sourceBandIndex]?a.rasterBands[t.sourceBandIndex]=t:a.rasterBands.push(t)}}));const i=a.rasterBands;if(i.length){const t=!!i[0].statistics;a.statistics=t?i.map((e=>e.statistics)).filter(e):null;const n=!!i[0].histogram;a.histograms=n?i.map((e=>e.histogram)).filter(e):null}return a}export{p as parsePAMInfo,m as parseSpatialReference};
