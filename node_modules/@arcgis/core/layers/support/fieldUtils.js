/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.25/esri/copyright.txt for details.
*/
import e from"../../core/Error.js";import{isNone as n,isSome as i}from"../../core/maybe.js";import{getDeepValue as t,setDeepValue as r}from"../../core/object.js";import{validateDomainValue as l,getDomainRange as o,DomainValidationError as s}from"./domainUtils.js";import{loadArcade as a}from"../../support/arcadeOnDemand.js";const f=/^([0-9])/,u=/[^A-Za-z0-9_\u0080-\uffff]/g,c=/_{2,}/g,d=/^_/,m=/_$/;function p(e){return e?e.trim().replace(u,"_").replace(c,"_").replace(d,"").replace(m,"").replace(f,"F$1"):null}const y=["field","field2","field3","normalizationField","rotationInfo.field","proportionalSymbolInfo.field","proportionalSymbolInfo.normalizationField","colorInfo.field","colorInfo.normalizationField"],g=["field","normalizationField"];function F(e,n){if(null!=e&&null!=n)for(const i of Array.isArray(e)?e:[e])if(I(y,i,n),"visualVariables"in i&&i.visualVariables)for(const e of i.visualVariables)I(g,e,n)}function I(e,n,i){if(e)for(const l of e){const e=t(l,n),o=e&&"function"!=typeof e&&i.get(e);o&&r(l,o.name,n)}}function x(e,n){if(null!=e&&n?.fields?.length)if("startField"in e){const i=n.get(e.startField),t=n.get(e.endField);e.startField=i?.name??null,e.endField=t?.name??null}else{const i=n.get(e.startTimeField),t=n.get(e.endTimeField);e.startTimeField=i?.name??null,e.endTimeField=t?.name??null}}const b=new Set;function T(e,n){return e&&n?(b.clear(),h(b,e,n),Array.from(b).sort()):[]}function h(e,n,i){if(i)if(n?.fields?.length)if(i.includes("*"))for(const{name:t}of n.fields)e.add(t);else for(const t of i)w(e,n,t);else{if(i.includes("*"))return e.clear(),void e.add("*");for(const n of i)null!=n&&e.add(n)}}function w(e,n,i){if("string"==typeof i)if(n){const t=n.get(i);t&&e.add(t.name)}else e.add(i)}function v(e,i){return n(i)||n(e)?[]:i.includes("*")?(e.fields??[]).map((e=>e.name)):i}function A(e,n,i=1){if(!n||!e)return[];if(n.includes("*"))return["*"];const t=T(e,n);return t.length/e.fields.length>=i?["*"]:t}async function S(e,n,i){if(!i)return;const{arcadeUtils:t}=await a(),r=t.extractFieldNames(i,n?.fields?.map((e=>e.name)));for(const l of r)w(e,n,l)}async function _(n,i,t){if(t&&"1=1"!==t){const r=(await import("../../core/sql/WhereClause.js")).WhereClause.create(t,i);if(!r.isStandardized)throw new e("fieldUtils:collectFilterFields","Where clause is not standardized",{where:t});h(n,i,r.fieldNames)}}function E({displayField:e,fields:n}){return e||(n&&n.length?$(n,"name-or-title")||$(n,"unique-identifier")||$(n,"type-or-category")||N(n):null)}function N(e){for(const n of e){if(!n||!n.name)continue;const e=n.name.toLowerCase();if(e.includes("name")||e.includes("title"))return n.name}return null}function $(e,n){for(const i of e)if(i&&i.valueType&&i.valueType===n)return i.name;return null}async function V(e){if(!e)return[];const n=new Set;return await D(n,e),Array.from(n).sort()}async function D(e,n){if(!n)return;const i=t("elevationInfo.featureExpressionInfo",n);return i?i.collectRequiredFields(e,n.fieldsIndex):void 0}function L(e,n,i){i.onStatisticExpression?S(e,n,i.onStatisticExpression.expression):e.add(i.onStatisticField)}async function O(e,n,i){if(!n||!i||!("fields"in i))return;const t=[],r=i.popupTemplate;t.push(U(e,n,r)),i.fields&&t.push(...i.fields.map((async i=>L(e,n.fieldsIndex,i)))),await Promise.all(t)}async function U(e,n,i){const t=[];i?.expressionInfos&&t.push(...i.expressionInfos.map((i=>S(e,n.fieldsIndex,i.expression))));const r=i?.content;if(Array.isArray(r))for(const l of r)"expression"===l.type&&l.expressionInfo&&t.push(S(e,n.fieldsIndex,l.expressionInfo.expression));await Promise.all(t)}async function j(e,n,t){n&&(n.timeInfo&&i(t)&&t.timeExtent&&h(e,n.fieldsIndex,[n.timeInfo.startField,n.timeInfo.endField]),n.floorInfo&&h(e,n.fieldsIndex,[n.floorInfo.floorField]),i(t)&&i(t.where)&&await _(e,n.fieldsIndex,t.where))}async function z(e,n,i){n&&i&&await Promise.all(i.map((i=>P(e,n,i))))}async function P(e,n,i){n&&i&&(i.valueExpression?await S(e,n.fieldsIndex,i.valueExpression):i.field&&w(e,n.fieldsIndex,i.field))}async function k(e){if(!e)return[];const n="timeInfo"in e&&e.timeInfo;return n?T(e.fieldsIndex,[e.trackIdField,n.startField,n.endField]):[]}function C(e){if(!e)return[];const n="editFieldsInfo"in e&&e.editFieldsInfo;return n?T(e.fieldsIndex,[n&&n.creatorField,n&&n.creationDateField,n&&n.editorField,n&&n.editDateField]):[]}function R(e){if(!e)return[];const n=e.geometryFieldsInfo;return n?T(e.fieldsIndex,[n.shapeAreaField,n.shapeLengthField]):[]}async function G(e){if(!e)return[];const n=new Set;return await W(n,e),Array.from(n).sort()}async function W(e,n){const{labelingInfo:i,fieldsIndex:t}=n;i&&i.length&&await Promise.all(i.map((n=>q(e,t,n))))}async function q(e,n,i){if(!i)return;const t=i.getLabelExpression(),r=i.where;if("arcade"===t.type)await S(e,n,t.expression);else{const i=t.expression.match(/{[^}]*}/g);i&&i.forEach((i=>{w(e,n,i.slice(1,-1))}))}await _(e,n,r)}function M(e){const n=e.defaultValue;return void 0!==n&&Q(e,n)?n:e.nullable?null:void 0}function Y(e){return"number"==typeof e&&!isNaN(e)&&isFinite(e)}function J(e){return null===e||Y(e)}const X="isInteger"in Number?Number.isInteger:e=>"number"==typeof e&&isFinite(e)&&Math.floor(e)===e;function Z(e){return null===e||X(e)}function B(e){return null!=e&&"string"==typeof e}function H(e){return null===e||B(e)}function K(){return!0}function Q(e,n){let i;switch(e.type){case"date":case"integer":case"long":case"small-integer":case"esriFieldTypeDate":case"esriFieldTypeInteger":case"esriFieldTypeLong":case"esriFieldTypeSmallInteger":i=e.nullable?Z:X;break;case"double":case"single":case"esriFieldTypeSingle":case"esriFieldTypeDouble":i=e.nullable?J:Y;break;case"string":case"esriFieldTypeString":i=e.nullable?H:B;break;default:i=K}return 1===arguments.length?i:i(n)}const ee=["integer","small-integer","single","double"],ne=new Set([...ee,"esriFieldTypeInteger","esriFieldTypeSmallInteger","esriFieldTypeSingle","esriFieldTypeDouble"]);function ie(e){return null!=e&&ne.has(e.type)}function te(e){return null!=e&&("string"===e.type||"esriFieldTypeString"===e.type)}function re(e){return null!=e&&("date"===e.type||"esriFieldTypeDate"===e.type)}function le(e,n){return null===fe(e,n)}var oe,se;function ae(e){return null==e||"number"==typeof e&&isNaN(e)?null:e}function fe(e,n){return e.nullable&&null===n?null:ie(e)&&!ue(e.type,Number(n))?oe.OUT_OF_RANGE:Q(e,n)?e.domain?l(e.domain,n):null:se.INVALID_TYPE}function ue(e,n){const i="string"==typeof e?de(e):e;if(!i)return!1;const t=i.min,r=i.max;return i.isInteger?X(n)&&n>=t&&n<=r:n>=t&&n<=r}function ce(e){const n=o(e.domain);return n||(ie(e)?de(e.type):void 0)}function de(e){switch(e){case"esriFieldTypeSmallInteger":case"small-integer":return pe;case"esriFieldTypeInteger":case"integer":return ye;case"esriFieldTypeSingle":case"single":return ge;case"esriFieldTypeDouble":case"double":return Fe}}function me(e){if(!Y(e))return null;if(X(e)){if(e>=pe.min&&e<=pe.max)return"esriFieldTypeSmallInteger";if(e>=ye.min&&e<=ye.max)return"esriFieldTypeInteger"}return e>=ge.min&&e<=ge.max?"esriFieldTypeSingle":"esriFieldTypeDouble"}!function(e){e.OUT_OF_RANGE="numeric-range-validation-error::out-of-range"}(oe||(oe={})),function(e){e.INVALID_TYPE="type-validation-error::invalid-type"}(se||(se={}));const pe={min:-32768,max:32767,isInteger:!0},ye={min:-2147483648,max:2147483647,isInteger:!0},ge={min:-34e37,max:12e37,isInteger:!1},Fe={min:-Number.MAX_VALUE,max:Number.MAX_VALUE,isInteger:!1};function Ie(e,n,i){switch(e){case s.INVALID_CODED_VALUE:return`Value ${i} is not in the coded domain - field: ${n.name}, domain: ${JSON.stringify(n.domain)}`;case s.VALUE_OUT_OF_RANGE:return`Value ${i} is out of the range of valid values - field: ${n.name}, domain: ${JSON.stringify(n.domain)}`;case se.INVALID_TYPE:return`Value ${i} is not a valid value for the field type - field: ${n.name}, type: ${n.type}, nullable: ${n.nullable}`;case oe.OUT_OF_RANGE:{const{min:e,max:t}=de(n.type);return`Value ${i} is out of range for the number type - field: ${n.name}, type: ${n.type}, value range is ${e} to ${t}`}}}function xe(e,n){return!be(e,n,null)}function be(e,n,t){if(!n||!n.attributes||!e){if(i(t))for(const n of e??[])t.add(n);return!0}const r=n.attributes;let l=!1;for(const o of e)if(!(o in r)){if(l=!0,!i(t))break;t.add(o)}return l}async function Te(e,n){const i=new Set;for(const t of n)await S(i,e.fieldsIndex,t);return Array.from(i).sort()}function he(e){return["raster.itempixelvalue","raster.servicepixelvalue"].some((n=>e.toLowerCase().startsWith(n)))}export{oe as NumericRangeValidationError,se as TypeValidationError,S as collectArcadeFieldNames,D as collectElevationFields,O as collectFeatureReductionFields,w as collectField,h as collectFields,j as collectFilterFields,W as collectLabelingFields,z as collectOrderByInfos,U as collectPopupTemplateFields,Fe as doubleRange,xe as featureHasFields,T as fixFields,F as fixRendererFields,x as fixTimeInfoFields,E as getDisplayFieldName,V as getElevationFields,Te as getExpressionFields,C as getFeatureEditFields,R as getFeatureGeometryFields,M as getFieldDefaultValue,ce as getFieldRange,G as getLabelingFields,me as getNumericTypeForValue,k as getTimeFields,ye as integerRange,re as isDateField,ue as isNumberInRange,ie as isNumericField,he as isRasterPixelValueField,te as isStringField,le as isValidFieldValue,Q as isValueMatchingFieldType,p as normalizeFieldName,ee as numericTypes,A as packFields,be as populateMissingFields,y as rendererFields,ae as sanitizeNullFieldValue,ge as singleRange,pe as smallIntegerRange,v as unpackFieldNames,fe as validateFieldValue,Ie as validationErrorToString,g as visualVariableFields};
