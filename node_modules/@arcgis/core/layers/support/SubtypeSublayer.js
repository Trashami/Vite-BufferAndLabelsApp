/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.25/esri/copyright.txt for details.
*/
import{_ as e}from"../../chunks/tslib.es6.js";import r from"../../PopupTemplate.js";import t from"../../renderers/ClassBreaksRenderer.js";import"../../renderers/DictionaryRenderer.js";import"../../renderers/DotDensityRenderer.js";import"../../renderers/HeatmapRenderer.js";import"../../renderers/PieChartRenderer.js";import i from"../../renderers/Renderer.js";import o from"../../renderers/SimpleRenderer.js";import n from"../../renderers/UniqueValueRenderer.js";import"../../renderers/support/jsonUtils.js";import"../../core/has.js";import{HandleOwnerMixin as s}from"../../core/HandleOwner.js";import{IdentifiableMixin as l}from"../../core/Identifiable.js";import{clone as p}from"../../core/lang.js";import a from"../../core/Loadable.js";import{isSome as d}from"../../core/maybe.js";import{MultiOriginJSONMixin as u}from"../../core/MultiOriginJSONSupport.js";import{setDeepValue as m}from"../../core/object.js";import{property as c}from"../../core/accessorSupport/decorators/property.js";import"../../core/accessorSupport/ensureType.js";import{reader as y}from"../../core/accessorSupport/decorators/reader.js";import{subclass as f}from"../../core/accessorSupport/decorators/subclass.js";import{writer as g}from"../../core/accessorSupport/decorators/writer.js";import{OriginId as b}from"../../core/accessorSupport/PropertyOrigin.js";import{createTypeReader as h}from"../../core/accessorSupport/extensions/serializableProperty/reader.js";import v from"../../form/FormTemplate.js";import{labelsVisible as j,legendEnabled as w,minScale as S,maxScale as O,popupEnabled as I}from"./commonProperties.js";import T from"./FeatureTemplate.js";import{defineFieldProperties as F}from"./fieldProperties.js";import{fixRendererFields as x}from"./fieldUtils.js";import R from"./LabelClass.js";import{reader as P}from"./labelingInfo.js";import{createPopupTemplate as C}from"../../support/popupUtils.js";import{defaultPolygonSymbol2D as D,defaultPolylineSymbol2D as E,defaultPointSymbol2D as V}from"../../symbols/support/defaults.js";const L=["charts","editingEnabled","formTemplate","labelsVisible","labelingInfo","legendEnabled","minScale","maxScale","opacity","popupEnabled","popupTemplate","renderer","subtypeCode","templates","title","visible"],N={key:"type",base:i,errorContext:"renderer",typeMap:{simple:o,"unique-value":n,"class-breaks":t}},k=F(),G=h({types:N});let M=0;function U(e){const r=e.json.write;return"object"==typeof r?r.ignoreOrigin=!0:e.json.write={ignoreOrigin:!0},e}function _(e){return new o({symbol:q(e)})}function q(e){switch(e){case"point":case"multipoint":return V.clone();case"polyline":return E.clone();case"polygon":case"multipatch":return D.clone();default:return null}}function B(e,r){return!!r&&("unique-value"===e?.type&&"string"==typeof e.field&&e.field.toLowerCase()===r.toLowerCase()&&!e.field2&&!e.field3&&!e.valueExpression)}function A(e,r){return null==e?null:r.subtypes?.find((r=>r.code===e))}function H(e,r){let t=null;switch(r.geometryType){case"esriGeometryPoint":case"esriGeometryMultipoint":t="point";break;case"esriGeometryPolyline":t="line";break;case"esriGeometryPolygon":case"esriGeometryMultiPatch":t="polygon";break;default:r.type,t=null}const i={},o=A(e,r);if(d(o)){const{defaultValues:e}=o;for(const r in e)i[r]=e[r]}return i[r.subtypeField]=e,new T({name:"New Feature",drawingTool:t,prototype:{attributes:i}})}const $="esri.layers.support.SubtypeSublayer";let z=class extends(s(u(l(a)))){constructor(e){super(e),this.charts=null,this.editingEnabled=!0,this.fieldOverrides=null,this.fieldsIndex=null,this.formTemplate=null,this.id=`${Date.now().toString(16)}-subtype-sublayer-${M++}`,this.type="subtype-sublayer",this.labelsVisible=!0,this.labelingInfo=null,this.layerType="ArcGISFeatureLayer",this.legendEnabled=!0,this.listMode="show",this.minScale=0,this.maxScale=0,this.opacity=1,this.popupEnabled=!0,this.popupTemplate=null,this.subtypeCode=null,this.templates=null,this.title=null,this.visible=!0}writeFieldOverrides(e,r,t){const{fields:i,parent:o}=this;let n;if(i){n=[];let e=0;i.forEach((({name:r,alias:t,editable:i,visible:s})=>{if(!s)return;const l=o?.fields?.find((e=>e.name===r));if(!l)return;const p={name:r};let a=!1;t!==l.alias&&(p.alias=t,a=!0),i!==l.editable&&(p.editable=i,a=!0),n.push(p),a&&e++})),0===e&&n.length===i.length&&(n=null)}else n=p(e);n?.length&&m(t,n,r)}get fields(){const{parent:e,fieldOverrides:r,subtypeCode:t}=this,i=e?.fields;if(!i?.length)return null;const{subtypes:o,subtypeField:n}=e,s=o.find((e=>e.code===t)),l=s?.defaultValues,p=s?.domains,a=[];for(const d of i){const e=d.clone(),{name:i}=e,o=r?.find((e=>e.name===i));if(e.visible=!r||!!o,o){const{alias:r,editable:t}=o;r&&(e.alias=r),!1===t&&(e.editable=!1)}const s=l?.[i]??null;e.defaultValue=i===n?t:s;const u=p?.[i]??null;e.domain=i===n?null:u?"inherited"===u.type?e.domain:u.clone():null,a.push(e)}return a}get effectiveScaleRange(){const{minScale:e,maxScale:r}=this;return{minScale:e,maxScale:r}}get defaultPopupTemplate(){return this.createPopupTemplate()}set renderer(e){x(e,this.fieldsIndex),this._override("renderer",e)}get renderer(){if(this._isOverridden("renderer"))return this._get("renderer");const{parent:e}=this;return e&&!e.isTable&&"mesh"!==e.geometryType?_(e.geometryType):null}readRendererFromService(e,r,t){if("Table"===r.type)return null;const i=r.drawingInfo?.renderer,n=G(i,r,t);let s;const{subtypeCode:l}=this;if(null!=l&&B(n,r.subtypeField)){const e=n.uniqueValueInfos?.find((({value:e})=>(e="number"==typeof e?String(e):e)===String(l)));e&&(s=new o({symbol:e.symbol}))}else"simple"!==n?.type||n.visualVariables?.length||(s=n);return s}readRenderer(e,r,t){const i=r?.layerDefinition?.drawingInfo?.renderer;if(i&&!i.visualVariables?.length)return G(i,r,t)||void 0}readTemplatesFromService(e,r){return[H(this.subtypeCode,r)]}readTitleFromService(e,r){const t=A(this.subtypeCode,r);return d(t)?t.name:null}createPopupTemplate(e){let r=this;const{parent:t,fields:i,title:o}=this;if(t){const{displayField:e,editFieldsInfo:n,objectIdField:s}=t;r={displayField:e,editFieldsInfo:n,fields:i,objectIdField:s,title:o}}return C(r,e)}getField(e){return this.fieldsIndex.get(e)}getFieldDomain(e){return this._getLayerDomain(e)}hasUserOverrides(){return L.some((e=>this.originIdOf(e)===b.USER))}_getLayerDomain(e){const r=this.fieldsIndex.get(e);return r?r.domain:null}};e([c({json:{write:{ignoreOrigin:!0}}})],z.prototype,"charts",void 0),e([c({type:Boolean,nonNullable:!0,json:{name:"enableEditing",write:{ignoreOrigin:!0}}})],z.prototype,"editingEnabled",void 0),e([c({readOnly:!0,json:{name:"layerDefinition.fieldOverrides",origins:{service:{read:!1}},write:{ignoreOrigin:!0,allowNull:!0}}})],z.prototype,"fieldOverrides",void 0),e([g("fieldOverrides")],z.prototype,"writeFieldOverrides",null),e([c({...k.fields,readOnly:!0,json:{read:!1}})],z.prototype,"fields",null),e([c(k.fieldsIndex)],z.prototype,"fieldsIndex",void 0),e([c({type:v,json:{name:"formInfo",write:{ignoreOrigin:!0}}})],z.prototype,"formTemplate",void 0),e([c({type:String,readOnly:!0,json:{origins:{service:{read:!1}},write:{ignoreOrigin:!0}}})],z.prototype,"id",void 0),e([c({readOnly:!0,json:{read:!1}})],z.prototype,"type",void 0),e([c(U(p(j)))],z.prototype,"labelsVisible",void 0),e([c({type:[R],json:{name:"layerDefinition.drawingInfo.labelingInfo",origins:{service:{read:!1}},read:{reader:P},write:{ignoreOrigin:!0}}})],z.prototype,"labelingInfo",void 0),e([c({type:["ArcGISFeatureLayer"],readOnly:!0,json:{read:!1,write:{ignoreOrigin:!0}}})],z.prototype,"layerType",void 0),e([c(U(p(w)))],z.prototype,"legendEnabled",void 0),e([c({type:["show","hide"]})],z.prototype,"listMode",void 0),e([c((()=>{const e=p(S);return e.json.origins.service.read=!1,U(e)})())],z.prototype,"minScale",void 0),e([c((()=>{const e=p(O);return e.json.origins.service.read=!1,U(e)})())],z.prototype,"maxScale",void 0),e([c({readOnly:!0})],z.prototype,"effectiveScaleRange",null),e([c({type:Number,range:{min:0,max:1},nonNullable:!0,json:{write:{ignoreOrigin:!0}}})],z.prototype,"opacity",void 0),e([c()],z.prototype,"parent",void 0),e([c(U(p(I)))],z.prototype,"popupEnabled",void 0),e([c({type:r,json:{name:"popupInfo",write:{ignoreOrigin:!0}}})],z.prototype,"popupTemplate",void 0),e([c({readOnly:!0})],z.prototype,"defaultPopupTemplate",null),e([c({types:N,json:{write:{target:"layerDefinition.drawingInfo.renderer",ignoreOrigin:!0}}})],z.prototype,"renderer",null),e([y("service","renderer",["drawingInfo.renderer","subtypeField","type"])],z.prototype,"readRendererFromService",null),e([y("renderer",["layerDefinition.drawingInfo.renderer"])],z.prototype,"readRenderer",null),e([c({type:Number,json:{origins:{service:{read:!1}},write:{ignoreOrigin:!0}}})],z.prototype,"subtypeCode",void 0),e([c({type:[T],json:{name:"layerDefinition.templates",write:{ignoreOrigin:!0}}})],z.prototype,"templates",void 0),e([y("service","templates",["geometryType","subtypeField","subtypes","type"])],z.prototype,"readTemplatesFromService",null),e([c({type:String,json:{write:{ignoreOrigin:!0}}})],z.prototype,"title",void 0),e([y("service","title",["subtypes"])],z.prototype,"readTitleFromService",null),e([c({type:Boolean,nonNullable:!0,json:{name:"visibility",write:{ignoreOrigin:!0}}})],z.prototype,"visible",void 0),z=e([f($)],z);const J=z;export{J as default};
