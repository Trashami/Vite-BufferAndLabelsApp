/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.25/esri/copyright.txt for details.
*/
import{_ as t}from"../../chunks/tslib.es6.js";import{id as e}from"../../kernel.js";import r from"../../request.js";import{result as s}from"../../core/asyncUtils.js";import o from"../../core/Error.js";import i from"../../core/Logger.js";import{destroyMaybe as a,isNone as l,isSome as p}from"../../core/maybe.js";import{throwIfAborted as n,isAbortError as m,throwIfAbortError as c}from"../../core/promiseUtils.js";import{normalize as u,hasSamePortal as d}from"../../core/urlUtils.js";import{property as h}from"../../core/accessorSupport/decorators/property.js";import"../../core/arrayUtils.js";import"../../core/accessorSupport/ensureType.js";import{reader as f}from"../../core/accessorSupport/decorators/reader.js";import{subclass as y}from"../../core/accessorSupport/decorators/subclass.js";import{writer as g}from"../../core/accessorSupport/decorators/writer.js";import I from"../../portal/Portal.js";import j from"../../portal/PortalItem.js";import w from"../../portal/PortalUser.js";const v=v=>{let U=class extends v{constructor(){super(...arguments),this.resourceReferences={portalItem:null,paths:[]},this.userHasEditingPrivileges=!0}destroy(){this.portalItem=a(this.portalItem)}set portalItem(t){t!==this._get("portalItem")&&(this.removeOrigin("portal-item"),this._set("portalItem",t))}readPortalItem(t,e,r){if(e.itemId)return new j({id:e.itemId,portal:r&&r.portal})}writePortalItem(t,e){t&&t.id&&(e.itemId=t.id)}async loadFromPortal(t,e){if(this.portalItem&&this.portalItem.id)try{const r=await import("../../portal/support/layersLoader.js");return n(e),await r.load({instance:this,supportedTypes:t.supportedTypes,validateItem:t.validateItem,supportsData:t.supportsData,layerModuleTypeMap:t.layerModuleTypeMap},e)}catch(r){throw m(r)||i.getLogger(this.declaredClass).warn(`Failed to load layer (${this.title}, ${this.id}) portal item (${this.portalItem.id})\n  ${r}`),r}}async finishLoadEditablePortalLayer(t){this._set("userHasEditingPrivileges",await this._fetchUserHasEditingPrivileges(t).catch((t=>(c(t),!0))))}async _fetchUserHasEditingPrivileges(t){const r=this.url?e?.findCredential(this.url):null;if(!r)return!0;const s=P.credential===r?P.user:await this._fetchEditingUser(t);return P.credential=r,P.user=s,l(s)||null==s.privileges||s.privileges.includes("features:user:edit")}async _fetchEditingUser(t){const o=this.portalItem?.portal?.user;if(o)return o;const i=e.findServerInfo(this.url??"");if(!i?.owningSystemUrl)return null;const a=`${i.owningSystemUrl}/sharing/rest`,l=I.getDefault();if(l&&l.loaded&&u(l.restUrl)===u(a))return l.user;const n=`${a}/community/self`,m=p(t)?t.signal:null,c=await s(r(n,{authMode:"no-prompt",query:{f:"json"},signal:m}));return c.ok?w.fromJSON(c.value.data):null}read(t,e){e&&(e.layer=this),super.read(t,e)}write(t,e){const r=e&&e.portal,s=this.portalItem&&this.portalItem.id&&(this.portalItem.portal||I.getDefault());return r&&s&&!d(s.restUrl,r.restUrl)?(e.messages&&e.messages.push(new o("layer:cross-portal",`The layer '${this.title} (${this.id})' cannot be persisted because it refers to an item on a different portal than the one being saved to. To save, set layer.portalItem to null or save to the same portal as the item associated with the layer`,{layer:this})),null):super.write(t,{...e,layer:this})}};return t([h({type:j})],U.prototype,"portalItem",null),t([f("web-document","portalItem",["itemId"])],U.prototype,"readPortalItem",null),t([g("web-document","portalItem",{itemId:{type:String}})],U.prototype,"writePortalItem",null),t([h({clonable:!1})],U.prototype,"resourceReferences",void 0),t([h({readOnly:!0})],U.prototype,"userHasEditingPrivileges",void 0),U=t([y("esri.layers.mixins.PortalLayer")],U),U},P={credential:null,user:null};export{v as PortalLayer};
