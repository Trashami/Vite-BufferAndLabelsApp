/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.25/esri/copyright.txt for details.
*/
import e from"../../request.js";import r from"../../core/Error.js";import{isSome as t}from"../../core/maybe.js";import{throwIfAbortError as o}from"../../core/promiseUtils.js";import{normalize as s,removeFile as n}from"../../core/urlUtils.js";import l from"../../portal/Portal.js";import a from"../../portal/PortalQueryParams.js";import{enableWebStyleForceWOSR as m}from"../../support/featureFlags.js";const u={};async function f(e,r){try{return{data:(await b(e,r)).data,baseUrl:n(e),styleUrl:e}}catch(t){return o(t),null}}function i(e,r,o){const s=t(r.portal)?r.portal:l.getDefault();let n;const a=`${s.url} - ${s.user&&s.user.username} - ${e}`;return u[a]||(u[a]=y(e,s,o).then((e=>(n=e,e.fetchData()))).then((r=>({data:r,baseUrl:n.itemUrl??"",styleName:e})))),u[a]}function y(e,t,o){return t.load(o).then((()=>{const r=new a({disableExtraQuery:!0,query:`owner:${j} AND type:${h} AND typekeywords:"${e}"`});return t.queryItems(r,o)})).then((({results:t})=>{let s=null;const n=e.toLowerCase();if(t&&Array.isArray(t))for(const e of t){const r=e.typeKeywords?.some((e=>e.toLowerCase()===n));if(r&&e.type===h&&e.owner===j){s=e;break}}if(!s)throw new r("symbolstyleutils:style-not-found",`The style '${e}' could not be found`,{styleName:e});return s.load(o)}))}function c(e,o,s){return e&&t(e.styleUrl)?f(e.styleUrl,s):e&&t(e.styleName)?i(e.styleName,o,s):Promise.reject(new r("symbolstyleutils:style-url-and-name-missing","Either styleUrl or styleName is required to resolve a style"))}function p(e){return null===e||"CIMSymbolReference"===e.type?e:{type:"CIMSymbolReference",symbol:e}}function d(e,r){if("cimRef"===r)return e.cimRef;if(e.formatInfos&&!m())for(const t of e.formatInfos)if("gltf"===t.type)return t.href;return e.webRef}function b(r,t){const o={responseType:"json",query:{f:"json"},...t};return e(s(r),o)}const j="esri_en",h="Style",w="https://cdn.arcgis.com/sharing/rest/content/items/220936cc6ed342c9937abd8f180e7d1e/resources/styles/cim/{SymbolName}.json?f=json";export{w as Style2DUrlTemplate,c as fetchStyle,p as makeCIMSymbolRef,b as requestJSON,d as symbolUrlFromStyleItem};
