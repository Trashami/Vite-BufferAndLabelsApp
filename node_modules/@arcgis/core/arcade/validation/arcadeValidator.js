/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.25/esri/copyright.txt for details.
*/
import{parse as e}from"../lib/arcade-parser.js";import{DiagnosticCodes as i,DiagnosticMessages as t}from"./diagnosticMessages.js";import{DiagnosticSeverity as n}from"./types.js";import{ParsingErrorMessages as s,Syntax as r,isVariableDeclaration as o,isIdentifier as a,isEmptyStatement as d,isBlockStatement as c}from"../lib/types.js";function l(e,i){return i?e.replace(/\${(.*?)}/g,((e,t)=>i[t]?.toString()??"")):e}function p(e){return!!e&&"dictionary"!==e.type}class f{constructor(e,i=[]){this._apiDefinitions=e,this._profileVariables=i,this._isInBlock=!1,this._recordIdentifierAssignment=!1,this._scriptScopeIdentifiers=new Map,this._diagnostics=new Array,this._undeclaredIdentifiersInFunctions=new Map}validateScript(t){if(!t)return{diagnostics:[],program:null};this._isInBlock=!1,this._recordIdentifierAssignment=!1,this._diagnostics=[],this._scriptScopeIdentifiers.clear(),this._undeclaredIdentifiersInFunctions.clear(),this._functionScopeIdentifiers=void 0;let n=null;try{n=e(t,{tolerant:!0}),this.handleErrors(n.errors),n.body.forEach((e=>this.validateStatement(e))),this.diagnoseIdentifiers(),this._undeclaredIdentifiersInFunctions.size>0&&this._undeclaredIdentifiersInFunctions.forEach((e=>{for(const t of e)this.logDiagnostic(t.node.loc,{code:i.NotDefined,data:{identifier:t.node.name}})}))}catch(s){this.handleException(s)}return{diagnostics:this._diagnostics,program:n}}recordIdentifierAssignment(e,i,t=!0){const n=this._recordIdentifierAssignment;this._recordIdentifierAssignment=t,e.call(this,i),this._recordIdentifierAssignment=n}inBlock(e,i){const t=this._isInBlock;this._isInBlock=!0,e.call(this,i),this._isInBlock=t}get _isInFunctionScope(){return!!this._functionScopeIdentifiers}inFunctionScope(e){this._functionScopeIdentifiers=new Map,e.call(this),this.diagnoseIdentifiers(),this._functionScopeIdentifiers=void 0}logDiagnostic(e,i){const r={severity:n.Error,...i,message:l(t[i.code]??s[i.code],i.data),range:{start:{line:e.start.line-1,character:e.start.column},end:{line:e.end.line-1,character:e.end.column}}};this._diagnostics.push(r)}handleErrors(e){(e??[]).forEach(this.handleException,this)}handleException(e){if(h(e)){const{range:i,code:t,data:n}=e;this.logDiagnostic(i,{code:t,data:n})}else this.logDiagnostic({start:{line:1,column:0},end:{line:1,column:0}},{code:i.ExecutionError,data:{stack:e.stack}})}getIdentifierInfo(e){return this._functionScopeIdentifiers?.get(e)??this._scriptScopeIdentifiers.get(e)}setIdentiferInfo(e,i){this._functionScopeIdentifiers?this._functionScopeIdentifiers.set(e,i):((this._functionScopeIdentifiers??this._scriptScopeIdentifiers).set(e,i),this._functionScopeIdentifiers||this._undeclaredIdentifiersInFunctions.has(e)&&(this._undeclaredIdentifiersInFunctions.delete(e),i.used=!0))}isProfileVariable(e){return(this._profileVariables??[]).some((i=>i.name.toLowerCase()===e))}isApiItem(e){const i=!!this._apiDefinitions?.constantDefinitions?.get(e),t=!!this._apiDefinitions?.functionDefinitions?.get(e);return i||t}validateStatement(e){if(e)switch(e.type){case r.BlockStatement:return void e.body.forEach((e=>this.validateStatement(e)));case r.VariableDeclaration:return void e.declarations.forEach((e=>this.validateVariableDeclarator(e)));case r.FunctionDeclaration:return void this.validateFunctionDeclaration(e);case r.ExportNamedDeclaration:return void this.validateExportDeclaration(e);case r.ImportDeclaration:return void this.validateImportDeclaration(e);case r.WhileStatement:return void this.validateWhileStatement(e);case r.ForStatement:return void this.validateForStatement(e);case r.ForInStatement:return void this.validateForInStatement(e);case r.IfStatement:return void this.validateIfStatement(e);case r.ReturnStatement:return void this.validateExpression(e.argument);case r.ExpressionStatement:return void this.validateExpression(e.expression);case r.BreakStatement:case r.ContinueStatement:case r.EmptyStatement:return}}validateVariableDeclarator(e){this.validateExpression(e.init),this.recordVariableIdentifier(e.id,{initialized:!!e.init})}validateFunctionDeclaration(e){this.recordFunctionIdentifier(e),this.inFunctionScope((()=>{e.params.forEach((e=>this.recordParamAsIdentifier(e))),u(e.body)&&this.logDiagnostic(e.body.loc,{code:i.UnexpectedEmptyFunction,data:{identifier:e.id.name},severity:n.Warning}),this.validateStatement(e.body)}))}validateExportDeclaration(e){this.validateStatement(e.declaration)}validateImportDeclaration(e){this.recordImportIdentifier(e)}validateForStatement(e){o(e.init)?this.inBlock(this.validateStatement,e.init):this.validateExpression(e.init),this.validateExpression(e.update),this.validateExpression(e.test),u(e.body)&&this.logDiagnostic(e.body.loc,{code:i.EmptyBlockStatement,severity:n.Warning}),this.inBlock(this.validateStatement,e.body)}validateWhileStatement(e){this.validateExpression(e.test),u(e.body)&&this.logDiagnostic(e.body.loc,{code:i.EmptyBlockStatement,severity:n.Warning}),this.inBlock(this.validateStatement,e.body)}validateForInStatement(e){a(e.left)?this.validateExpression(e.left):this.recordVariableIdentifier(e.left.declarations[0].id,{initialized:!0,inBlock:!0}),this.validateExpression(e.right),u(e.body)&&this.logDiagnostic(e.body.loc,{code:i.EmptyBlockStatement,severity:n.Warning}),this.validateStatement(e.body)}validateIfStatement(e){this.validateExpression(e.test),u(e.consequent)&&this.logDiagnostic(e.consequent.loc,{code:i.EmptyBlockStatement,severity:n.Warning}),e.alternate&&u(e.alternate)&&this.logDiagnostic(e.alternate.loc,{code:i.EmptyBlockStatement,severity:n.Warning}),this.inBlock(this.validateStatement,e.consequent),this.inBlock(this.validateStatement,e.alternate)}validateExpression(e){if(e)switch(e.type){case r.AssignmentExpression:return void this.validateAssignmentExpression(e);case r.CallExpression:return void this.validateCallExpression(e);case r.Identifier:return void this.validateIdentifier(e);case r.Literal:return;case r.ArrayExpression:return void e.elements.forEach((e=>this.validateExpression(e)));case r.ObjectExpression:return void this.validateObjectExpression(e);case r.UnaryExpression:return void this.validateUnaryExpression(e);case r.UpdateExpression:return void this.validateUpdateExpression(e);case r.BinaryExpression:case r.LogicalExpression:return void this.validateBinaryAndLogicalExpression(e);case r.MemberExpression:return void this.validateMemberExpression(e);case r.TemplateLiteral:return void e.expressions.forEach((e=>this.validateExpression(e)));default:return}}validateAssignmentExpression(e){this.recordIdentifierAssignment(this.validateExpression,e.left),this.validateExpression(e.right)}validateCallExpression(e){if(this.validateExpression(e.callee),a(e.callee)){const i=e.callee.name.toLowerCase(),t=this.getIdentifierInfo(i),n=this._apiDefinitions?.functionDefinitions?.get(i);if(!t&&n){const i=m(n,e.arguments.length);i&&this.logDiagnostic(e.loc,i)}}e.arguments.forEach((e=>this.validateExpression(e)))}validateIdentifier(e){const t=e.name.toLowerCase(),n=this.getIdentifierInfo(t);if(n)return this._recordIdentifierAssignment?void(n.initialized=!0):void(n.used=!0);if(!this.isProfileVariable(t)&&!this.isApiItem(t)){if(this._isInFunctionScope){let i=this._undeclaredIdentifiersInFunctions.get(t);return i||(i=[],this._undeclaredIdentifiersInFunctions.set(t,i)),void i.push({node:e,identifier:t})}this.logDiagnostic(e.loc,{code:i.NotDefined,data:{identifier:e.name}})}}logProfileOrApiConflict(e){const t=e.name.toLowerCase(),s=this.isProfileVariable(t),r=this.isApiItem(t);(s||r)&&this.logDiagnostic(e.loc,{code:s?i.ProfileVariablesConflict:i.ApiConflict,severity:n.Warning,data:{identifier:e.name}})}validateObjectExpression(e){e.properties.forEach((e=>{this.validateExpression(e.value)}))}validateUnaryExpression(e){this.validateExpression(e.argument)}validateUpdateExpression(e){this.validateExpression(e.argument)}validateBinaryAndLogicalExpression(e){this.validateExpression(e.left),this.validateExpression(e.right)}validateMemberExpression(e){const i=this.flattenMemberExpressionAndValidate(e),t=i[0].object;this.recordIdentifierAssignment(this.validateExpression,t,!1),a(t)&&(this.getIdentifierInfo(t.name.toLowerCase())||this.validateMemberExpressionWithProfile(i)||this.validateConstantMemberExpression(i))}flattenMemberExpressionAndValidate(e){return e.type===r.MemberExpression?(a(e.property)&&!e.computed||this.validateExpression(e.property),[...this.flattenMemberExpressionAndValidate(e.object),e]):[]}extractAndValidatePropertyName(e){switch(e.type){case"Identifier":return e.name.toLowerCase();case"Literal":return"string"!=typeof e.value?(this.logDiagnostic(e.loc,{code:i.UnexpectedPropertyIdentifier}),null):e.value.toLowerCase();default:return this.logDiagnostic(e.loc,{code:i.UnexpectedPropertyIdentifier}),null}}validateConstantMemberExpression(e){const t=e[0];if(!a(t.object))return!1;const n=t.object.name.toLowerCase(),s=this._apiDefinitions?.constantDefinitions?.get(n);if(!s)return!1;if("namespace"!==s.type)return this.logDiagnostic(t.property.loc,{code:i.NotADictionary,data:{identifier:n}}),!0;const r=this.extractAndValidatePropertyName(t.property);if(!r)return!0;if(!s.members.some((e=>e.key===r))){const e=s.members.reduce(((e,i)=>`${e}${e?" | ":""}${i.completion.label.split(".").pop()}`),"");this.logDiagnostic(t.property.loc,{code:i.InvalidConstantIdentifier,data:{list:e}})}return e.length>1&&this.logDiagnostic(e[1].property.loc,{code:i.UnexpectedPropertyIdentifier}),!0}validateMemberExpressionWithProfile(e){const t=e[0];if(t.object.type!==r.Identifier)return!1;const s=t.object.name.toLowerCase(),o=this._profileVariables?.find((e=>e.key===s));if(!o)return!1;if(p(o))return this.logDiagnostic(t.object.loc,{code:i.NotADictionary,data:{identifier:o.name}}),!0;if(this._recordIdentifierAssignment)return this.logDiagnostic(t.loc,{code:i.ProfileVariablesAreImmutable}),!0;let a=o;for(let r=0;r<e.length;r++){if(e[r].computed)return!0;if(p(a))return this.logDiagnostic(e[r-1]?.property.loc??e[r].object.loc,{code:i.NotADictionary,data:{identifier:a.name}}),!0;const t=this.extractAndValidatePropertyName(e[r].property);if(!t)return!0;if(0===a.properties.length)return this.logDiagnostic(e[r].property.loc,{code:i.UnknownPropertyIdentifier,data:{identifier:t},severity:n.Warning}),!0;const s=a.properties.find((e=>e.name.toLowerCase()===t));if(!s){const t=a.properties.reduce(((e,i)=>`${e}${e?" | ":""}${i.name.split(".").pop()}`),"");return this.logDiagnostic(e[r].property.loc,{code:i.InvalidPropertyIdentifier,data:{list:t}}),!0}a=s}return!0}recordVariableIdentifier(e,t){this.logProfileOrApiConflict(e);const s=e.name.toLowerCase();let r=this.getIdentifierInfo(s);const o=r&&this._isInFunctionScope&&"function"===r.scope,a=r&&!this._isInFunctionScope&&"script"===r.scope;(o||a)&&this.logDiagnostic(e.loc,{code:i.AlreadyDefined,data:{identifier:e.name},severity:n.Warning});const d=t.inBlock??this._isInBlock,{initialized:c}=t;if(!r||this._isInFunctionScope&&"function"!==r.scope){r={node:e,used:!1,initialized:c,scope:this._isInFunctionScope?"function":d?"block":"script"}}else r.node=e,r.used=!1,r.initialized=c;return"block"!==r.scope||d||(r.scope="script",this.logDiagnostic(e.loc,{code:i.AlreadyDefined,data:{identifier:e.name},severity:n.Warning})),this.setIdentiferInfo(s,r),!1}recordImportIdentifier(e){const t=e.specifiers[0].local;this.logProfileOrApiConflict(t);const s=t.name.toLowerCase();let r=this.getIdentifierInfo(s);r?.scope&&this.logDiagnostic(e.specifiers[0].local.loc,{code:i.AlreadyDefined,data:{identifier:e.specifiers[0].local.name},severity:n.Warning}),r={node:e.specifiers[0].local,used:!1,...r,scope:"script",initialized:!0},this.setIdentiferInfo(s,r)}recordFunctionIdentifier(e){this.logProfileOrApiConflict(e.id);const t=e.id.name.toLowerCase();let s=this.getIdentifierInfo(t);s?.scope&&this.logDiagnostic(e.id.loc,{code:i.AlreadyDefined,data:{identifier:e.id.name},severity:n.Warning}),s={node:e.id,used:!1,...s,scope:"script",initialized:!0},this.setIdentiferInfo(t,s)}recordParamAsIdentifier(e){return this.recordVariableIdentifier(e,{initialized:!0})}diagnoseIdentifiers(){(this._functionScopeIdentifiers??this._scriptScopeIdentifiers).forEach((e=>{e.node&&(e.used?e.initialized||this.logDiagnostic(e.node.loc,{code:i.DefinedNeverAssigned,data:{identifier:e.node.name},severity:n.Warning}):this.logDiagnostic(e.node.loc,{code:e.initialized?i.AssignedNeverUsed:i.DefinedNeverUsed,data:{identifier:e.node.name},severity:n.Warning}))}))}}function h(e){return"ParsingError"===e?.name}function u(e){return d(e)||c(e)&&!e?.body.length}function m(e,t){if(!e||null==t||t<0)return null;let n=null;for(const s of e.overloads){const{min:e,max:r}=s.parametersInfo;if(t<e)n=e>0?{code:i.NotEnoughArguments,data:{min:e}}:{code:i.NoArgumentExpected};else{if(!(r>=0&&t>r))return null;n={code:i.TooManyArguments,data:{max:r}}}}return n}function g(e,i=[],t){if(!e)return{diagnostics:[]};return new f(t,i).validateScript(e)}export{f as ArcadeValidationService,l as format,p as isValueVariable,g as validateScript};
