/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.25/esri/copyright.txt for details.
*/
import{FeatureServiceDatabaseType as e}from"./shared.js";import{WhereClause as r}from"../../../core/sql/WhereClause.js";import{SqlError as t,SqlErrorCodes as n}from"./errorsupport.js";import{DateTime as a}from"luxon";function s(e,r){return u(e?.parseTree,r,e?.parameters)}function o(e,r,t){return u(e,r,t)}function c(t,n,a,s){return r.create(u(t.parseTree,e.Standardised,t.parameters,n,a),s)}function i(t,n,a="AND"){return r.create("(("+s(t,e.Standardised)+")"+a+"("+s(n,e.Standardised)+"))",t.fieldsIndex)}function u(e,r,a,s=null,o=null){let c,i,p,g;switch(e.type){case"interval":return N(u(e.value,r,a,s,o),e.qualifier,e.op);case"case-expression":{let t=" CASE ";"simple"===e.format&&(t+=u(e.operand,r,a,s,o));for(let n=0;n<e.clauses.length;n++)t+=" WHEN "+u(e.clauses[n].operand,r,a,s,o)+" THEN "+u(e.clauses[n].value,r,a,s,o);return null!==e.else&&(t+=" ELSE "+u(e.else,r,a,s,o)),t+=" END ",t}case"parameter":{const t=a[e.value.toLowerCase()];if("string"==typeof t){return"'"+a[e.value.toLowerCase()].toString().replace(/'/g,"''")+"'"}if(t instanceof Date)return f(t,r);if(t instanceof Array){const e=[];for(let n=0;n<t.length;n++)"string"==typeof t[n]?e.push("'"+t[n].toString().replace(/'/g,"''")+"'"):t[n]instanceof Date?e.push(f(t[n],r)):e.push(t[n].toString());return e}return t.toString()}case"expression-list":i=[];for(const t of e.value)i.push(u(t,r,a,s,o));return i;case"unary-expression":return" ( NOT "+u(e.expr,r,a,s,o)+" ) ";case"binary-expression":switch(e.operator){case"AND":return" ("+u(e.left,r,a,s,o)+" AND "+u(e.right,r,a,s,o)+") ";case"OR":return" ("+u(e.left,r,a,s,o)+" OR "+u(e.right,r,a,s,o)+") ";case"IS":if("null"!==e.right.type)throw new t(n.UnsupportedIsRhs);return" ("+u(e.left,r,a,s,o)+" IS NULL )";case"ISNOT":if("null"!==e.right.type)throw new t(n.UnsupportedIsRhs);return" ("+u(e.left,r,a,s,o)+" IS NOT NULL )";case"IN":return c=[],"expression-list"===e.right.type?(c=u(e.right,r,a,s,o)," ("+u(e.left,r,a,s,o)+" IN ("+c.join(",")+")) "):(g=u(e.right,r,a,s,o),g instanceof Array?" ("+u(e.left,r,a,s,o)+" IN ("+g.join(",")+")) ":" ("+u(e.left,r,a,s,o)+" IN ("+g+")) ");case"NOT IN":return c=[],"expression-list"===e.right.type?(c=u(e.right,r,a,s,o)," ("+u(e.left,r,a,s,o)+" NOT IN ("+c.join(",")+")) "):(g=u(e.right,r,a,s,o),g instanceof Array?" ("+u(e.left,r,a,s,o)+" NOT IN ("+g.join(",")+")) ":" ("+u(e.left,r,a,s,o)+" NOT IN ("+g+")) ");case"BETWEEN":return p=u(e.right,r,a,s,o)," ("+u(e.left,r,a,s,o)+" BETWEEN "+p[0]+" AND "+p[1]+" ) ";case"NOTBETWEEN":return p=u(e.right,r,a,s,o)," ("+u(e.left,r,a,s,o)+" NOT BETWEEN "+p[0]+" AND "+p[1]+" ) ";case"LIKE":return""!==e.escape?" ("+u(e.left,r,a,s,o)+" LIKE "+u(e.right,r,a,s,o)+" ESCAPE '"+e.escape+"') ":" ("+u(e.left,r,a,s,o)+" LIKE "+u(e.right,r,a,s,o)+") ";case"NOT LIKE":return""!==e.escape?" ("+u(e.left,r,a,s,o)+" NOT LIKE "+u(e.right,r,a,s,o)+" ESCAPE '"+e.escape+"') ":" ("+u(e.left,r,a,s,o)+" NOT LIKE "+u(e.right,r,a,s,o)+") ";case"<>":case"<":case">":case">=":case"<=":case"=":case"*":case"-":case"+":case"/":return" ("+u(e.left,r,a,s,o)+" "+e.operator+" "+u(e.right,r,a,s,o)+") "}throw new t(n.UnsupportedOperator,{operator:e.operator});case"null":return"null";case"boolean":return!0===e.value?"1":"0";case"string":return"'"+e.value.toString().replace(/'/g,"''")+"'";case"timestamp":case"date":return f(e.value,r);case"number":return e.value.toString();case"current-time":return d("date"===e.mode,r);case"column-reference":return s&&s.toLowerCase()===e.column.toLowerCase()?"("+o+")":e.column;case"function":{const t=u(e.args,r,a,s,o);return l(e.name,t,r)}}throw new t(n.UnsupportedSyntax,{node:e.type})}function l(r,a,s){switch(r.toLowerCase().trim()){case"abs":if(1!==a.length)throw new t(n.InvalidFunctionParameters,{function:"abs"});return"abs("+a[0]+")";case"ceiling":case"ceil":if(1!==a.length)throw new t(n.InvalidFunctionParameters,{function:"ceiling"});switch(s){case e.Standardised:case e.StandardisedNoInterval:}return"CEILING("+a[0]+")";case"floor":if(1!==a.length)throw new t(n.InvalidFunctionParameters,{function:"floor"});return"FLOOR("+a[0]+")";case"log":if(1!==a.length)throw new t(n.InvalidFunctionParameters,{function:"log"});return"LOG("+a[0]+")";case"log10":if(1!==a.length)throw new t(n.InvalidFunctionParameters,{function:"log10"});return"LOG10("+a[0]+")";case"power":if(2!==a.length)throw new t(n.InvalidFunctionParameters,{function:"power"});return"POWER("+a[0]+","+a[1]+")";case"round":if(2===a.length)return"ROUND("+a[0]+","+a[1]+")";if(1===a.length)return"ROUND("+a[0]+")";throw new t(n.InvalidFunctionParameters,{function:"round"});case"truncate":if(a.length<1||a.length>2)throw new t(n.InvalidFunctionParameters,{function:"truncate"});return s===e.SqlServer?"ROUND("+a[0]+(1===a.length?"0":","+a[1])+",1)":"TRUNCATE("+a[0]+(1===a.length?")":","+a[1]+")");case"char_length":case"len":if(1!==a.length)throw new t(n.InvalidFunctionParameters,{function:"char_length"});switch(s){case e.SqlServer:return"LEN("+a[0]+")";case e.Oracle:return"LENGTH("+a[0]+")";default:return"CHAR_LENGTH("+a[0]+")"}case"concat":if(a.length<1)throw new t(n.InvalidFunctionParameters,{function:"concat"});{let e="CONCAT(";for(let r=0;r<a.length;r++)0!==r&&(e+=","),e+=a[r];return e+=")",e}case"lower":case"lcase":if(1!==a.length)throw new t(n.InvalidFunctionParameters,{function:"lower"});return"LOWER("+a[0]+")";case"upper":case"ucase":if(1!==a.length)throw new t(n.InvalidFunctionParameters,{function:"upper"});return"UPPER("+a[0]+")";case"substring":{let r="";switch(s){case e.Oracle:return r="SUBSTR("+a[0]+","+a[1],3===a.length&&(r+=","+a[2]),r+=")",r;case e.SqlServer:return r=3===a.length?"SUBSTRING("+a[0]+","+a[1]+","+a[2]+")":"SUBSTRING("+a[0]+",  "+a[1]+", LEN("+a[0]+") - "+a[1]+")",r;default:return r="SUBSTRING("+a[0]+" FROM "+a[1],3===a.length&&(r+=" FOR "+a[2]),r+=")",r}}case"extract":return"EXTRACT("+a[0].replace(/\'/g,"")+" FROM "+a[1]+")"}throw new t(n.InvalidFunctionParameters,{function:r})}function f(r,t){const n=r instanceof Date?a.fromJSDate(r):a.fromSQL(r),s=0===n.hour&&0===n.minute&&0===n.second&&0===n.millisecond;switch(t){case e.FILEGDB:case e.Standardised:case e.StandardisedNoInterval:return s?`date '${n.toFormat("yyyy-LL-dd")}'`:`date '${n.toFormat("yyyy-LL-dd HH:mm:ss")}'`;case e.Oracle:return s?`TO_DATE('${n.toFormat("yyyy-LL-dd")}','YYYY-MM-DD')`:`TO_DATE('${n.toFormat("yyyy-LL-dd HH:mm:ss")}','YYYY-MM-DD HH24:MI:SS')`;case e.SqlServer:return`'${n.toFormat(s?"yyyy-LL-dd":"yyyy-LL-dd HH:mm:ss")}'`;case e.PGDB:return`#${n.toFormat(s?"LL-dd-yyyy":"LL-dd-yyyy HH:mm:ss")}#`;case e.Postgres:return`TIMESTAMP '${n.toFormat(s?"yyyy-LL-dd":"yyyy-LL-dd HH:mm:ss")}'`;default:return`date '${n.toFormat("yyyy-LL-dd HH:mm:ss")}'`}}function d(r,t){switch(t){case e.FILEGDB:case e.Standardised:case e.StandardisedNoInterval:case e.Oracle:return r?"CURRENT_DATE":"CURRENT_TIMESTAMP";case e.SqlServer:return r?"CAST(GETDATE() AS DATE)":"GETDATE()";case e.PGDB:case e.Postgres:default:return r?"CURRENT_DATE":"CURRENT_TIMESTAMP"}}function p(e,r,t={}){const n={},a={},s={esriFieldTypeSmallInteger:"integer",esriFieldTypeInteger:"integer",esriFieldTypeSingle:"double",esriFieldTypeDouble:"double",esriFieldTypeString:"string",esriFieldTypeDate:"date",esriFieldTypeOID:"integer",oid:"integer",long:"integer","small-integer":"integer",integer:"integer",single:"double",double:"double",date:"date",string:"string"};for(const o of r){const e=o.type?s[o.type]:void 0;n[o.name.toLowerCase()]=void 0===e?"":e}for(const o in t){const e=s[t[o]];a[o.toLowerCase()]=void 0===e?"":e}switch(g(n,e.parseTree,e.parameters,a)){case"double":return"double";case"integer":return"integer";case"date":return"date";case"string":return"string"}return""}function g(e,r,a,s){let o;switch(r.type){case"interval":return"integer";case"case-expression":{const t=[];if("simple"===r.format){for(let n=0;n<r.clauses.length;n++)t.push(g(e,r.clauses[n].value,a,s));null!==r.else&&t.push(g(e,r.else,a,s))}else{for(let n=0;n<r.clauses.length;n++)t.push(g(e,r.else,a,s));null!==r.else&&t.push(g(e,r.else,a,s))}return m(t)}case"parameter":{const e=s[r.value.toLowerCase()];if(void 0===e&&a){const e=a[r.value.toLowerCase()];if(void 0===e)return"";if(null===e)return"";if("string"==typeof e||e instanceof String)return"string";if("boolean"==typeof e)return"boolean";if(e instanceof Date)return"date";if("number"==typeof e)return e%1==0?"integer":"double"}return void 0===e?"":e}case"expression-list":{const t=[];for(const n of r.value)t.push(g(e,n,a,s));return t}case"unary-expression":return"boolean";case"binary-expression":switch(r.operator){case"AND":case"OR":case"IN":case"NOT IN":case"BETWEEN":case"NOTBETWEEN":case"LIKE":case"NOT LIKE":case"<>":case"<":case">":case">=":case"<=":case"=":return"boolean";case"IS":case"ISNOT":if("null"!==r.right.type)throw new t(n.UnsupportedIsRhs);return"boolean";case"*":case"-":case"+":case"/":return m([g(e,r.left,a,s),g(e,r.right,a,s)]);default:throw new t(n.UnsupportedOperator,{operator:r.operator})}case"null":return"";case"boolean":return"boolean";case"string":return"string";case"number":return null===r.value?"":r.value%1==0?"integer":"double";case"date":case"timestamp":case"current-time":return"date";case"column-reference":{const t=e[r.column.toLowerCase()];return void 0===t?"":t}case"function":switch(r.name.toLowerCase()){case"position":case"extract":case"char_length":return"integer";case"round":return o=g(e,r.args,a,s),o instanceof Array?o.length>0?o[0]:"":o;case"sign":return o=g(e,r.args,a,s),o instanceof Array&&(o=m(o)),"integer"===o||"double"===o?o:"double";case"ceiling":case"floor":case"abs":{const t=g(e,r.args,a,s);return t instanceof Array?m(t):t}case"area":case"length":case"log":case"log10":case"sin":case"cos":case"tan":case"asin":case"acos":case"atan":case"power":case"truncate":return"double";case"substring":case"trim":case"concat":case"lower":case"upper":return"string"}return""}throw new t(n.UnsupportedSyntax,{node:r.type})}const h={boolean:1,string:2,integer:3,double:4,date:5};function m(e){if(e){let r="";for(const t of e)""!==t&&(r=""===r||h[r]<h[t]?t:r);return r}return""}function y(e,r){return T(e.parseTree,r)}function w(e){return"column-reference"===e?.parseTree.type}function T(e,r){if(null==e)return!1;switch(e.type){case"when-clause":return T(e.operand,r)||T(e.value,r);case"case-expression":for(const t of e.clauses)if(T(t,r))return!0;return!("simple"!==e.format||!T(e.operand,r))||!(null===e.else||!T(e.else,r));case"parameter":case"null":case"boolean":case"date":case"timestamp":case"string":case"number":return!1;case"expression-list":for(const t of e.value)if(T(t,r))return!0;return!1;case"unary-expression":return T(e.expr,r);case"binary-expression":return T(e.left,r)||T(e.right,r);case"column-reference":return r.toLowerCase()===e.column.toLowerCase();case"function":return T(e.args,r)}return!1}function E(e){let r="";return r+=e.period.toUpperCase(),r}function N(e,r,t){let n="";return n="interval-period"===r.type?E(r):E(r.start)+" TO "+E(r.end),"INTERVAL "+t+" "+e+" "+n}export{i as combine,N as convertIntervalToSql,w as isSingleField,f as makeDateString,d as makeToday,p as predictType,c as reformulateWithoutField,y as scanForField,s as toWhereClause,o as toWhereClauseFromTree,l as translateFunctionToDatabaseSpecific};
