/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.25/esri/copyright.txt for details.
*/
import{isMultiOriginJSONMixin as t}from"../../multiOriginJSONSupportUtils.js";import{isAbsolute as r,isBlobProtocol as e,join as o,getPathExtension as s}from"../../urlUtils.js";import{generateUUID as n}from"../../uuid.js";import{getOwnPropertyMetadata as i}from"../metadata.js";import{nameToId as a}from"../PropertyOrigin.js";import{propertyJSONMeta as p}from"./property.js";import{getResourceContentExtension as u}from"../../../portal/support/resourceExtension.js";import{r as c,t as l,M as m,i as f,p as y,a as d}from"../../../chunks/persistableUrlUtils.js";function g(t){const r=t?.origins??[void 0];return(e,o)=>{const s=h(t,e,o);for(const t of r){const r=p(e,t,o);for(const t in s)r[t]=s[t]}}}function h(t,r,e){if("resource"===t?.type)return v(t,r,e);switch(t?.type??"other"){case"other":return{read:!0,write:!0};case"url":{const{read:t,write:r}=d;return{read:t,write:r}}}}function v(o,s,n){const p=i(s,n);return{type:String,read:(t,r,e)=>{const o=c(t,r,e);return p.type===String?o:"function"==typeof p.type?new p.type({url:o}):void 0},write:{writer(s,i,u,c){if(!c||!c.resources)return"string"==typeof s?void(i[u]=l(s,c)):void(i[u]=s.write({},c));const y=x(s),d=l(y,{...c,verifyItemRelativeUrls:c&&c.verifyItemRelativeUrls?{writtenUrls:c.verifyItemRelativeUrls.writtenUrls,rootPath:void 0}:void 0},m.NO),g=p.type!==String&&(!t(this)||c&&c.origin&&this.originIdOf(n)>a(c.origin)),h={object:this,propertyName:n,value:s,targetUrl:d,dest:i,targetPropertyName:u,context:c,params:o};c&&c.portalItem&&d&&!r(d)?g?w(h):j(h):c&&c.portalItem&&(null==d||null!=f(d)||e(d)||g)?U(h):i[u]=d}}}}function U(t){const{targetUrl:r,params:s,value:i,context:a,dest:p,targetPropertyName:c}=t;if(!a.portalItem)return;const l=y(r),m=l?.filename??n(),f=s?.prefix??l?.prefix,d=N(i,r,a),g=o(f,m),h=`${g}.${u(d)}`,v=a.portalItem.resourceFromPath(h);e(r)&&a.resources&&a.resources.pendingOperations.push(P(r).then((t=>{v.path=`${g}.${u(t)}`,p[c]=v.itemRelativeUrl})).catch((()=>{})));const U=s?.compress??!1;a.resources&&I({...t,resource:v,content:d,compress:U,updates:a.resources.toAdd}),p[c]=v.itemRelativeUrl}function w(t){const{context:r,targetUrl:e,params:o,value:n,dest:i,targetPropertyName:a}=t;if(!r.portalItem)return;const p=r.portalItem.resourceFromPath(e),c=N(n,e,r),l=u(c),m=s(p.path),f=o?.compress??!1;l===m?(r.resources&&I({...t,resource:p,content:c,compress:f,updates:r.resources.toUpdate}),i[a]=e):U(t)}function j({context:t,targetUrl:r,dest:e,targetPropertyName:o}){t.portalItem&&t.resources&&(t.resources.toKeep.push({resource:t.portalItem.resourceFromPath(r),compress:!1}),e[o]=r)}function I({object:t,propertyName:r,updates:e,resource:o,content:s,compress:n}){e.push({resource:o,content:s,compress:n,finish:e=>{O(t,r,e)}})}function N(t,r,e){return"string"==typeof t?{url:r}:new Blob([JSON.stringify(t.toJSON(e))],{type:"application/json"})}async function P(t){const r=(await import("../../../request.js")).default,{data:e}=await r(t,{responseType:"blob"});return e}function x(t){return null==t?null:"string"==typeof t?t:t.url}function O(t,r,e){"string"==typeof t[r]?t[r]=e.url:t[r].url=e.url}export{g as persistable};
