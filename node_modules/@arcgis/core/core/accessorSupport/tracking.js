/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.25/esri/copyright.txt for details.
*/
import"../has.js";import t from"../Logger.js";import{pathToArray as n,getProperties as e}from"./utils.js";import{Flags as r}from"./tracking/Flags.js";const o={onObservableAccessed:()=>{},onTrackingEnd:()=>{}},c=[];let i=o;function s(t){i.onObservableAccessed(t)}let l=!1,a=!1;function f(t,n,e){if(l)return u(t,n,e);p(t);const r=n.call(e);return d(),r}function g(t,n){return f(o,t,n)}function u(n,e,r){const o=l;l=!0,p(n);let c=null;try{c=e.call(r)}catch(i){a&&t.getLogger("esri.core.accessorSupport.tracking").error(i)}return d(),l=o,c}function p(t){i=t,c.push(t)}function d(){const t=c.length;if(t>1){const n=c.pop();i=c[t-2],n.onTrackingEnd()}else if(1===t){const t=c.pop();i=o,t.onTrackingEnd()}else i=o}function m(t,n){if(n.flags&r.DepTrackingInitialized)return;const e=a;a=!1,n.flags&r.AutoTracked?u(n,n.metadata.get,t):y(t,n),a=e}const k=[];function y(t,e){e.flags&r.ExplicitlyTracking||(e.flags|=r.ExplicitlyTracking,u(e,(()=>{const r=e.metadata.dependsOn||k;for(const e of r)if("string"!=typeof e||e.includes(".")){const r=n(e);for(let n=0,e=t;n<r.length&&null!=e&&"object"==typeof e;++n)e=A(e,r[n],n!==r.length-1)}else A(t,e,!1)})),e.flags&=~r.ExplicitlyTracking)}function A(t,n,r){const o="?"===n[n.length-1]?n.slice(0,-1):n;if(null!=t.getItemAt||Array.isArray(t)){const n=parseInt(o,10);if(!isNaN(n))return Array.isArray(t)?t[n]:t.getItemAt(n)}const c=e(t)?.properties.get(o);return c&&(s(c),m(t,c)),r?t[o]:void 0}export{m as initializeDependencyTracking,f as runTracked,u as runTrackedNoThrow,g as runUntracked,s as trackAccess,y as trackExplicitDependencies};
