/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.25/esri/copyright.txt for details.
*/
import r from"../Error.js";import has from"../has.js";import{throwIfAborted as t}from"../promiseUtils.js";import e from"./Connection.js";export{default as Connection}from"./Connection.js";import o from"./RemoteClient.js";export{default as RemoteClient}from"./RemoteClient.js";import n from"./WorkerOwner.js";let i=has("esri-workers-debug")?1:has("esri-mobile")?Math.min(navigator.hardwareConcurrency-1,3):has("host-browser")?navigator.hardwareConcurrency-1:0;i||(i=has("safari")&&has("mac")||has("trident")?7:2);let a=0;const s=[];function l(){d()}function c(r,t){return m(r,{client:t})}async function m(r,t){const o=new e;return await o.open(r,t),o}async function u(e,n={}){if("string"!=typeof e)throw new r("workers:undefined-module","modulePath is missing");let l=n.strategy||"distributed";if(has("host-webworker")&&!has("esri-workers")&&(l="local"),"local"===l){let r=await o.loadWorker(e);r||(r=await import(/* @vite-ignore */ /* webpackIgnore: true */e)),t(n.signal);const i=n.client||r;return m([o.connect(r)],{...n,client:i})}if(await d(),t(n.signal),"dedicated"===l){const r=a++%i;return m([await s[r].open(e,n)],n)}if(n.maxNumWorkers&&n.maxNumWorkers>0){const r=Math.min(n.maxNumWorkers,i);if(r<i){const t=new Array(r);for(let o=0;o<r;++o){const r=a++%i;t[o]=s[r].open(e,n)}return m(t,n)}}return m(s.map((r=>r.open(e,n))),n)}function f(){p&&(w.abort(),p=null);for(let r=0;r<s.length;r++)s[r]&&s[r].terminate();s.length=0}let w,p=null;async function d(){if(p)return p;w=new AbortController;const r=[];for(let t=0;t<i;t++){const e=n.create(t).then((r=>(s[t]=r,r)));r.push(e)}return p=Promise.all(r),p}export{l as initialize,u as open,c as openWithPorts,f as terminate};
