/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.25/esri/copyright.txt for details.
*/
import{Milliseconds as t}from"../../../../../core/time.js";import{AnimatedSymbolRepeatType as e}from"../../../../../symbols/cim/enums.js";import{getMaterialGroup as r,getRandomValue as i}from"../grouping.js";function a(e){return t(e.frameDurations.reduce(((t,e)=>t+e),0))}function n(t){const{width:e,height:r}=t;return{frameDurations:t.frameDurations.reverse(),getFrame:e=>{const r=t.frameDurations.length-1-e;return t.getFrame(r)},width:e,height:r}}function s(e,r){const{width:i,height:n,getFrame:s}=e,o=r/a(e);return{frameDurations:e.frameDurations.map((e=>t(e*o))),getFrame:s,width:i,height:n}}function o(e,r){const{width:i,height:a,getFrame:n}=e,s=e.frameDurations.slice(),o=s.shift();return s.unshift(t(o+r)),{frameDurations:s,getFrame:n,width:i,height:a}}function m(e,r){const{width:i,height:a,getFrame:n}=e,s=e.frameDurations.slice(),o=s.pop();return s.push(t(o+r)),{frameDurations:s,getFrame:n,width:i,height:a}}class h{constructor(t,e,r,i){this._animation=t,this._repeatType=r,this._onFrameData=i,this._direction=1,this._currentFrame=0,this.timeToFrame=this._animation.frameDurations[this._currentFrame];let a=0;for(;e>a;)a+=this.timeToFrame,this.nextFrame();const n=this._animation.getFrame(this._currentFrame);this._onFrameData(n)}nextFrame(){if(this._currentFrame+=this._direction,this._direction>0){if(this._currentFrame===this._animation.frameDurations.length)switch(this._repeatType){case e.None:this._currentFrame-=this._direction;break;case e.Loop:this._currentFrame=0;break;case e.Oscillate:this._currentFrame-=this._direction,this._direction=-1}}else if(-1===this._currentFrame)switch(this._repeatType){case e.None:this._currentFrame-=this._direction;break;case e.Loop:this._currentFrame=this._animation.frameDurations.length-1;break;case e.Oscillate:this._currentFrame-=this._direction,this._direction=1}this.timeToFrame=this._animation.frameDurations[this._currentFrame];const t=this._animation.getFrame(this._currentFrame);this._onFrameData(t)}}function c(c,u,f,l){let _,{repeatType:F}=u;if(null==F&&(F=e.Loop),!0===u.reverseAnimation&&(c=n(c)),null!=u.duration&&(c=s(c,t(1e3*u.duration))),null!=u.repeatDelay){const r=1e3*u.repeatDelay;F===e.Loop?c=m(c,t(r)):F===e.Oscillate&&(c=o(m(c,t(r/2)),t(r/2)))}if(null!=u.startTimeOffset)_=t(1e3*u.startTimeOffset);else if(null!=u.randomizeStartTime){const e=r(f),n=82749913,s=null!=u.randomizeStartSeed?u.randomizeStartSeed:n,o=i(e,s);_=t(o*a(c))}else _=t(0);return new h(c,_,F,l)}function u(t,e,r,i){const a=null==e.playAnimation||e.playAnimation,n=c(t,e,r,i);let s,o=n.timeToFrame;function m(){s=a&&setTimeout((()=>{n.nextFrame(),o=n.timeToFrame,m()}),o)}return m(),{remove:()=>{a&&clearTimeout(s)}}}export{h as Player,s as adjustDuration,m as appendDelay,c as createPlayer,a as getDuration,u as play,o as prependDelay,n as reverse};
