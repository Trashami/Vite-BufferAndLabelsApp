/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.25/esri/copyright.txt for details.
*/
import{_ as e}from"../../../chunks/tslib.es6.js";import t from"../../../Graphic.js";import i from"../../../core/Collection.js";import r from"../../../core/Logger.js";import{isAbortError as s}from"../../../core/promiseUtils.js";import{watch as a}from"../../../core/reactiveUtils.js";import{property as o}from"../../../core/accessorSupport/decorators/property.js";import"../../../core/arrayUtils.js";import"../../../core/accessorSupport/ensureType.js";import{subclass as h}from"../../../core/accessorSupport/decorators/subclass.js";import{BitmapContainer as p}from"../engine/BitmapContainer.js";import{LayerView2DMixin as n}from"./LayerView2D.js";import m from"./graphics/GraphicsView2D.js";import l from"./graphics/HighlightGraphicContainer.js";import g from"./support/ExportStrategy.js";import c from"../../layers/LayerView.js";import d from"../../layers/MapImageLayerView.js";import u from"../../layers/RefreshableLayerView.js";import{createQueryGeometry as y}from"../../support/drapedUtils.js";let f=class extends(d(u(n(c)))){update(e){this.strategy.update(e).catch((e=>{s(e)||r.getLogger(this.declaredClass).error(e)})),e.stationary&&this.updateHighlightedFeatures(e.state.resolution),this._highlightView.processUpdate(e)}attach(){const{imageMaxWidth:e,imageMaxHeight:t,version:i}=this.layer,r=i>=10.3,s=i>=10;this._bitmapContainer=new p,this.container.addChild(this._bitmapContainer),this._highlightView=new m({view:this.view,graphics:this.highlightGraphics,requestUpdateCallback:()=>this.requestUpdate(),container:new l(this.view.featuresTilingScheme)}),this.container.addChild(this._highlightView.container),this.strategy=new g({container:this._bitmapContainer,fetchSource:this.fetchImageBitmap.bind(this),requestUpdate:this.requestUpdate.bind(this),imageMaxWidth:e,imageMaxHeight:t,imageRotationSupported:r,imageNormalizationSupported:s,hidpi:!0}),this.handles.add(a((()=>this.exportImageVersion),(()=>this.requestUpdate())),"exportImageVersion"),this.handles.add(a((()=>this.view?.floors),(()=>this.requestUpdate())),"view.floors"),this.requestUpdate()}detach(){this.handles.remove("exportImageVersion"),this.handles.remove("view.floors"),this.strategy.destroy(),this.container.removeAllChildren(),this._bitmapContainer.removeAllChildren(),this._highlightView.destroy()}moveStart(){}viewChange(){}moveEnd(){this.requestUpdate()}highlight(e){let r=null;if(e instanceof t?r=[e]:i.isCollection(e)&&e.length>0?r=e.toArray():Array.isArray(e)&&e.length>0&&(r=e),r=r?.filter(Boolean),!r||!r.length)return{remove:()=>{}};for(const t of r)"geometryType"in t.sourceLayer&&"point"===t.sourceLayer.geometryType&&(t.visible=!1);return this.highlightGraphics.addMany(r),{remove:()=>{this.highlightGraphics.removeMany(r)}}}supportsSpatialReference(e){return this.layer.serviceSupportsSpatialReference(e)}createFetchPopupFeaturesQueryGeometry(e,t){return y(e,t,this.view)}async doRefresh(){this.requestUpdate()}isUpdating(){return this.strategy.updating||this.updateRequested}highlightGraphicUpdated(e,t){this._highlightView.graphicUpdateHandler({graphic:e,property:t})}fetchImage(e,t,i,r){return this.layer.fetchImage(e,t,i,{timeExtent:this.timeExtent,floors:this.view.floors,...r})}fetchImageBitmap(e,t,i,r){return this.layer.fetchImageBitmap(e,t,i,{timeExtent:this.timeExtent,floors:this.view.floors,...r})}};e([o()],f.prototype,"strategy",void 0),e([o()],f.prototype,"updating",void 0),f=e([h("esri.views.2d.layers.MapImageLayerView2D")],f);const v=f;export{v as default};
