/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.25/esri/copyright.txt for details.
*/
import{_ as e}from"../../../../chunks/tslib.es6.js";import r from"../../../../core/Accessor.js";import{update as t}from"../../../../core/arrayUtils.js";import s from"../../../../core/Handles.js";import has from"../../../../core/has.js";import{someMap as n}from"../../../../core/MapUtils.js";import{clamp as i}from"../../../../core/mathUtils.js";import{destroyMaybe as a,disposeMaybe as h,isSome as d,isNone as o,applySome as _,unwrap as l}from"../../../../core/maybe.js";import{watch as c,syncAndInitial as p,initial as m,sync as g}from"../../../../core/reactiveUtils.js";import{Milliseconds as u}from"../../../../core/time.js";import{property as f}from"../../../../core/accessorSupport/decorators/property.js";import"../../../../core/accessorSupport/ensureType.js";import{subclass as R}from"../../../../core/accessorSupport/decorators/subclass.js";import{h as T,a as E,m as b}from"../../../../chunks/mat4.js";import{I as A,c as P}from"../../../../chunks/mat4f64.js";import{a as S}from"../../../../chunks/boundedPlane.js";import{MINIMUM_IDLE_ANIMATION_FPS_TIME as O,MAXIMUM_IDLE_ANIMATION_FPS_TIME as w,MAXIMUM_ANIMATION_LOAD as C}from"../../support/animationUtils.js";import y from"../../support/debugFlags.js";import{TransparencyMode as D}from"../../terrain/TerrainRenderer.js";import{RenderPassManager as x}from"../core/renderPasses/RenderPassManager.js";import{ShaderOutput as I}from"../core/shaderLibrary/ShaderOutput.js";import{HUDTransparentRenderStyle as H}from"../core/shaderLibrary/hud/HUDUniforms.js";import{Decorations as M,RenderRequestType as L,StencilBits as N}from"./basicInterfaces.js";import{BoundingInfo as v}from"./BoundingInfo.js";import{ZERO as U,union as j}from"./depthRange.js";import{depthRangeFromScene as q}from"./depthRangeUtils.js";import{createEmptyDepthTexture as F}from"./glUtil3D.js";import{Highlight as G}from"./Highlight.js";import{RenderOccludedFlag as V}from"./Material.js";import{OffscreenRendering as B}from"./OffscreenRendering.js";import{RenderContext as k}from"./RenderContext.js";import{splitRenderGeometryChangeSetByMaterial as W}from"./rendererUtils.js";import{RenderPluginManager as Q}from"./RenderPluginManager.js";import{RenderSlot as Y}from"./RenderSlot.js";import{ShadowAccumulator as X}from"./ShadowAccumulator.js";import{ShadowHighlight as z}from"./ShadowHighlight.js";import{ShadowMap as J,SnapshotSlot as K}from"./ShadowMap.js";import Z from"./SliceHelper.js";import{SmaaRenderPass as $}from"./SmaaRenderPass.js";import{SSAOHelper as ee}from"./SSAOHelper.js";import{TransparencyPassType as re}from"./TransparencyPassType.js";import{EdgeView as te}from"./edgeRendering/EdgeView.js";import{Transparency as se}from"./edgeRendering/interfaces.js";import{MergedRenderer as ne}from"../materials/renderers/MergedRenderer.js";import{AlphaMode as ie}from"../shaders/CompositingTechniqueConfiguration.js";import{RendererPerformanceInfo as ae,PerformanceCategory as he}from"../statistics/RendererPerformanceInfo.js";import{ClearBufferBit as de,PixelFormat as oe,PixelType as _e}from"../../../webgl/enums.js";const le=.9;let ce=class extends r{constructor(e,r,t,n,i,a,h,d,o){super({}),this._materialRepository=e,this._shaderTechniqueRepository=t,this._rctx=n,this._compositingHelper=i,this._magnifierHelper=a,this._requestRender=h,this._stage=o,this._materialRenderers=new Map,this._needsTransparentPass=!1,this._hasHUDElements=!1,this._hasHighlights=!1,this._hasWater=!1,this._hasOverlayWater=!1,this._renderOverlay=e=>{},this._content=new Map,this._isRendering=!1,this._fallbackDepthStencilTexture=null,this._sliceHelper=new Z,this._antialiasing=!0,this._oitEnabled=!1,this._multipassTerrain=!0,this._terrainRenderingEnabled=!0,this._terrainTransparency=D.Opaque,this._waterReflectionEnabled=!1,this._hasAnimations=!1,this._animationTimestep=O,this._handles=new s,this._renderHiddenTransparentEdges=()=>{},this._oitUsed=!1,this._smaaPass=new $(this._rctx,t),this._oitEnabled=this._hasOITSupport,this._requestRender(),this._offscreenRendering=new B(this._rctx,this._compositingHelper),this.performanceInfo=new ae(this._rctx),this._shadowMap=new J(this._rctx,o.viewingMode),this._ssaoHelper=new ee(t,this._rctx,(()=>this._requestRender())),this._highlight=new G(t,this._rctx),this._shadowHighlight=new z(this._rctx,o.viewingMode),this._shadowAccumulator=new X(this._rctx,t,o,(e=>{const r=this.shadowsEnabled;this._shadowMap.enabled=!0,this._prepare(e.camera,e.contentCamera),this._renderPlugins.prepareRender(),this._shadowMap.enabled=r}),((e,r,t)=>{e.shadowMap.start(e.camera,r,t),this._renderShadowCascades(I.Shadow,e.shadowMap),e.camera.setGLViewport(this._rctx),this._prepare(e.camera,e.contentCamera)}),(()=>this._requestRender())),this._renderContext=new k(this._rctx,this._offscreenRendering,this._shadowMap,this._ssaoHelper,this._sliceHelper),this._renderPlugins=new Q({renderContext:this._renderContext,shaderTechniqueRepository:t,textureRep:r,materialRep:this._materialRepository,requestRender:this._requestRender,schedule:d}),this.renderPassManager=new x(this._rctx,this._shaderTechniqueRepository),this._renderPlugins.add(this.renderPassManager.slots(),this.renderPassManager),this._handles.add([c((()=>this._stage.state.camera),(()=>this._requestRender()),p),c((()=>y.EDGES_SHOW_HIDDEN_TRANSPARENT_EDGES),(e=>{this._renderHiddenTransparentEdges=e?()=>this._renderEdges(se.TRANSPARENT):()=>{},this._requestRender()}),m)])}get _bindParameters(){return this._renderContext.bindParameters}get hasWater(){return this._hasWater||this._hasOverlayWater}get hasWaterReflection(){return this.hasWater&&this._waterReflectionEnabled}normalizeCtorArgs(){return{}}dispose(){this._handles.destroy(),this._smaaPass.dispose(),this._materialRenderers.forEach((e=>e.dispose())),this._materialRenderers.clear(),this._edgeView=a(this._edgeView),this._offscreenRendering.dispose(),this._fallbackDepthStencilTexture=h(this._fallbackDepthStencilTexture),this._shadowMap.enabled=!1,this._shadowMap.dispose(),this._ssaoHelper.enabled=!1,this._ssaoHelper.dispose(),this._highlight.dispose(),this._shadowHighlight.dispose(),this._shadowAccumulator.dispose(),v.prune(),this._content.clear()}disposeOffscreenBuffers(){this._offscreenRendering.dispose(),this._shadowMap.dispose(),this._smaaPass.disable(),this._ssaoHelper.disposeOffscreenBuffers()}get updating(){return this._antialiasing&&this._smaaPass.updating||d(this._edgeView)&&this._edgeView.updating||this._shadowAccumulator.running||!this.isCameraFinal}ensureEdgeView(){return o(this._edgeView)&&(this._edgeView=new te({rctx:this._rctx,renderSR:this._stage.renderSR,viewingMode:this._stage.viewingMode,techniqueRepository:this._shaderTechniqueRepository,setNeedsRender:()=>this._requestRender(),schedule:e=>this._stage.resourceController.schedule(e)}),this._handles.add(c((()=>_(this._edgeView,(e=>e.updating))),(()=>this._requestRender()),g)),this._requestRender()),this._edgeView}get edgeView(){return this._edgeView}get isCameraFinal(){return T(this._bindParameters.ssr.reprojectionMatrix,A)}set _reprojectionMatrix(e){t(this._bindParameters.ssr.reprojectionMatrix,e)&&this.notifyChange("isCameraFinal")}get shadowsEnabled(){return!!this._shadowMap?.enabled}setRenderParameters(e){const{_shadowMap:r,_ssaoHelper:t,_bindParameters:s}=this;if(void 0!==e.screenSpaceReflectionsEnabled&&s.ssr.enabled!==e.screenSpaceReflectionsEnabled&&(s.ssr.enabled=e.screenSpaceReflectionsEnabled,this._requestRender()),void 0!==e.shadowMap&&r.enabled!==e.shadowMap&&(r.enabled=e.shadowMap,this._requestRender()),void 0!==e.shadowMapMaxCascades&&r.maxCascades!==e.shadowMapMaxCascades&&(r.maxCascades=e.shadowMapMaxCascades,this._requestRender()),d(e.environment)){d(e.environment.weather)&&(this._bindParameters.weather=e.environment.weather,this._bindParameters.weatherVisible=e.weatherVisible),void 0!==e.environment.lighting.ambientOcclusionEnabled&&t.enabled!==e.environment.lighting.ambientOcclusionEnabled&&(t.enabled=e.environment.lighting.ambientOcclusionEnabled,this._requestRender()),void 0!==e.environment.lighting.waterReflectionEnabled&&this._waterReflectionEnabled!==e.environment.lighting.waterReflectionEnabled&&(this._waterReflectionEnabled=e.environment.lighting.waterReflectionEnabled,this._requestRender());const r="virtual"!==e.environment.lighting.type;s.enableFillLights!==r&&(s.enableFillLights=r,this._requestRender())}e.background&&this._offscreenRendering.background!==e.background&&(this._offscreenRendering.background=e.background,this._requestRender()),void 0!==e.antialiasingEnabled&&this._antialiasing!==e.antialiasingEnabled&&(this._antialiasing=e.antialiasingEnabled,this._requestRender()),void 0!==e.highQualityTransparency&&this._multipassTerrain!==e.highQualityTransparency&&(this._multipassTerrain=e.highQualityTransparency,this._oitEnabled=e.highQualityTransparency&&this._hasOITSupport,this._requestRender()),void 0!==e.defaultHighlightOptions&&(this._highlight.setDefaultOptions(e.defaultHighlightOptions),this._shadowHighlight.setDefaultOptions(e.defaultHighlightOptions),this._requestRender()),void 0!==e.overlays&&this._bindParameters.overlays!==e.overlays&&(this._bindParameters.overlays=e.overlays,this._requestRender()),void 0!==e.hasOverlayWater&&this._hasOverlayWater!==e.hasOverlayWater&&(this._hasOverlayWater=e.hasOverlayWater,this._requestRender()),void 0!==e.renderOverlay&&this._renderOverlay!==e.renderOverlay&&(this._renderOverlay=e.renderOverlay,this._requestRender()),void 0!==e.slicePlane&&this._sliceHelper.plane!==e.slicePlane&&(this._sliceHelper.plane=l(e.slicePlane),this._requestRender()),void 0!==e.terrainRenderingEnabled&&this._terrainRenderingEnabled!==e.terrainRenderingEnabled&&(this._terrainRenderingEnabled=e.terrainRenderingEnabled,this._requestRender()),void 0!==e.terrainTransparency&&this._terrainTransparency!==e.terrainTransparency&&(this._terrainTransparency=e.terrainTransparency,this._requestRender()),void 0!==e.shadowCastOptions&&this._shadowAccumulator.setOptions(e.shadowCastOptions)}get hasSlicePlane(){return!!this._sliceHelper.plane}get renderPlugins(){return this._renderPlugins}get _hasOITSupport(){return this._rctx.driverTest.floatBufferBlendWorking}modify(e){this._isRendering&&console.warn("Renderer.modify called while rendering");const{adds:r,removes:t,updates:s}=e;if(0===r.length&&0===t.length&&0===s.length)return;t.forAll((({id:e})=>this._content.delete(e))),r.forAll((e=>this._content.set(e.id,e)));const i=W(e);let a=!1;i.forEach(((e,r)=>{let t=this._materialRenderers.get(r);if(!t){if(!(e.adds.length>0))return;t=new ne(this._rctx,this._materialRepository,r),this._materialRenderers.set(r,t)}t.modify(e),t.isEmpty&&(a=!0)})),a&&this._materialRenderers.forEach(((e,r)=>{e.isEmpty&&(this._materialRenderers.delete(r),e.dispose())})),this._hasHighlights=n(this._materialRenderers,(e=>e.hasHighlights)),this._bindParameters.hasOccludees=n(this._materialRenderers,(e=>e.hasOccludees)),this._hasWater=n(this._materialRenderers,(e=>e.hasWater)),this._hasHUDElements=n(this._materialRenderers,(e=>e.requiresSlot(Y.LINE_CALLOUTS_HUD_DEPTH,I.Color)||e.requiresSlot(Y.HUD_MATERIAL,I.Color)||e.requiresSlot(Y.LABEL_MATERIAL,I.Color))),this._requestRender()}updateAnimation(e){return this._hasAnimations=!1,this._materialRenderers.forEach((r=>this._hasAnimations=r.updateAnimation(e)||this._hasAnimations)),this._hasAnimations=this._renderPlugins.updateAnimation(e)||this._hasAnimations,this._hasAnimations}get animationTimestep(){return this._animationTimestep}render(e,r,t,s,n){this._isRendering=!0;const{camera:i,contentCamera:a}=t;this._renderContext.time=n,this.performanceInfo.startFrame(),this._renderOverlay(n),this.performanceInfo.advance(he.OVERLAY),this._bindParameters.transparencyPassType=re.NONE;const h=this._offscreenRendering;h.setupRenderTarget(this.hasWaterReflection);const _=S(this._sliceHelper.plane);s===M.OFF&&(this._sliceHelper.plane=null),this._rctx.bindFramebuffer(e),i.setGLViewport(this._rctx),this._prepare(i,a),this._renderPlugins.prepareRender(),this.performanceInfo.advance(he.PREPARE);const l=this._computeDepthRange(i);this._renderShadowMap(e,i,this._bindParameters.lighting.mainLight.direction,l),this.performanceInfo.advance(he.SHADOW_MAP),h.initializeFrame(i),this._ensureBindParameters(i,a),this._renderLinearDepth(),this.performanceInfo.advance(he.LINEAR_DEPTH),this._accumulateShadows(l,i,a),this.performanceInfo.advance(he.ACCUMULATED_SHADOWS),this._renderNormal(),this.performanceInfo.advance(he.NORMALS),this._ensureBindParametersSSR(),this._renderSSAO(),this.performanceInfo.advance(he.SSAO),this._renderContext.output=I.Color,h.bindFramebuffer(),this._renderOpaqueGeometry(),this.performanceInfo.advance(he.OPAQUE);const c=this._terrainRenderingEnabled&&this._terrainTransparency!==D.Opaque,p=this._multipassTerrain&&c;this._renderTerrainLinearDepth(p),this._setMultipassEnabled(p),this._setTerrainCulling(p),this._renderEdges(se.OPAQUE),this.performanceInfo.advance(he.OPAQUE_EDGES),this._offscreenRendering.bindTarget(this._offscreenRendering.currentColorTarget,this._offscreenRendering.mainDepth),this._renderSlot(Y.VOXEL),this.performanceInfo.advance(he.VOXEL),this._renderHiddenTransparentEdges();const m=this._needsTransparentPass||this._renderPlugins.needsTransparentPass;m&&(this._oitEnabled?this._renderOrderIndependentTransparency((()=>this._renderTransparentGeometry()),!1):this._renderTransparentGeometry()),this.performanceInfo.advance(he.TRANSPARENT),this._renderGeometryLinearDepth(p);const g=this._renderHUDVisibility(this._multipassTerrain&&c);p||this._renderInternalSlot(Y.LINE_CALLOUTS),this.performanceInfo.advance(he.HUD_VISIBILITY),this._renderObjectAndLayerIdColor(r),this.performanceInfo.advance(he.OBJECT_AND_LAYER_ID_COLOR),this._renderEdges(se.TRANSPARENT,p),this.performanceInfo.advance(he.TRANSPARENT_EDGES),this._renderTransparentTerrain(),c&&g&&(p?this._renderLineCallouts(H.Occluded):h.compositeTransparentTerrainOntoHUDVisibility(this._bindParameters),this._renderHUD(H.Occluded,h.framebuffer),this.performanceInfo.advance(he.HUD_OCCLUDED)),this.performanceInfo.advance(he.TRANSPARENT_TERRAIN),this._setTerrainCulling(!1),c&&(h.compositeTransparentTerrainOntoMain(this._bindParameters),p&&(this._renderEdges(se.OPAQUE),this.performanceInfo.advance(he.OPAQUE_EDGES),m&&(this._oitEnabled?this._renderOrderIndependentTransparency((()=>this._renderTransparentGeometry()),!1):this._renderTransparentGeometry()),this.performanceInfo.advance(he.TRANSPARENT),this._renderEdges(se.TRANSPARENT),this.performanceInfo.advance(he.TRANSPARENT_EDGES))),p&&this._renderLineCallouts(H.NotOccluded),this._setMultipassEnabled(!1),this._shadowAccumulator.render(this._bindParameters),h.renderToTargets((()=>{this._renderInternalSlot(Y.TRANSPARENT_DEPTH_WRITE_DISABLED_MATERIAL),this._renderSlot(Y.POSTPROCESSING_ENVIRONMENT_TRANSPARENT),this._renderSlot(Y.LASERLINES)}),h.currentColorTarget,h.mainDepth),this.performanceInfo.advance(he.ENVIRONMENT),this._renderPlugins.needsLaserlineWithContrastControl&&h.renderTmpAndCompositeToMain((()=>this._renderSlot(Y.LASERLINES_CONTRAST_CONTROL)),this._bindParameters,ie.PremultipliedAlpha),this.performanceInfo.advance(he.LASER_LINE),this._renderOccluded(),this.performanceInfo.advance(he.OCCLUDED);const u=s===M.ON&&this._magnifierHelper.enabled,f=u&&o(e)?this._offscreenRendering.getFramebuffer(this._offscreenRendering.tmpColor,this._offscreenRendering.tmpDepth):e;this._rctx.bindFramebuffer(f);const R=this._offscreenRendering.colorTexture;!this._renderAntiAliasing(R)&&d(R)&&this._compositingHelper.composite(this._bindParameters,R,ie.None),this.performanceInfo.advance(he.ANTIALIASING),this._renderHUD(H.NotOccluded,f),this.performanceInfo.advance(he.HUD_NOT_OCCLUDED),this._renderHighlights(f,this._bindParameters),this.performanceInfo.advance(he.HIGHLIGHTS),u&&this._magnifierHelper.render(this._rctx,this._bindParameters),f!==e&&(this._rctx.bindFramebuffer(e),this._compositingHelper.composite(this._bindParameters,this._offscreenRendering.tmpColorTexture,ie.None)),this._disposeOITBuffers(),this._renderContext.lastFrameCamera.copyFrom(this._bindParameters.camera),this._sliceHelper.plane=_,this._isRendering=!1,this.onPostRender&&this.onPostRender(),this.performanceInfo.finishFrame()}_renderObjectAndLayerIdColor(e){d(e)&&has("enable-feature:objectAndLayerId-rendering")&&(this._rctx.bindFramebuffer(e),this._offscreenRendering.renderToFBO((()=>this._renderGeometryAndTransparentTerrainPass(I.ObjectAndLayerIdColor)),[0,0,0,0],!0,!0),this._rctx.bindFramebuffer(e),this._offscreenRendering.renderToFBO((()=>{this._bindParameters.renderTransparentlyOccludedHUD=H.NotOccluded,this._renderInternalSlot(Y.HUD_MATERIAL)}),null,!0,!0))}finish(e){if(this._hasAnimations||(this._animationTimestep=u(0)),e===L.BACKGROUND){let e=0;this.performanceInfo.gpuSamplingEnabled?e=this.performanceInfo.totalGPUTimeSampler.last:this._rctx.gl.getError();const r=this.performanceInfo.elapsedTime,t=Math.max(r,e),s=i(t/C,w,O);this._animationTimestep=u(this._animationTimestep*le+s*(1-le))}}readDepthPixels(e,r,t){const s=this._offscreenRendering.bindTarget(this._offscreenRendering.linearDepth,this._offscreenRendering.tmpDepth);if(!this._needsLinearDepth){this._ensureBindParameters(e,e),this._bindParameters.camera.setGLViewport(this._rctx),this._rctx.setClearColor(0,0,0,0);const r=de.COLOR_BUFFER_BIT|de.DEPTH_BUFFER_BIT|de.STENCIL_BUFFER_BIT;this._rctx.clearSafe(r),this._renderGeometryAndTransparentTerrainPass(I.Depth)}s.readPixels(r[0],r[1],r[2],r[3],oe.RGBA,_e.UNSIGNED_BYTE,t)}readHUDVisibility(e,r,t,s,n){this._offscreenRendering.bindTarget(this._offscreenRendering.hudVisibility).readPixels(e,r,t,s,oe.RGBA,_e.UNSIGNED_BYTE,n)}readAccumulatedShadow(e,r){return this._shadowAccumulator.readAccumulatedShadow(e,r)}_setMultipassEnabled(e){this._bindParameters.multipassTerrain.enabled=this._bindParameters.multipassGeometry.enabled=e}_setTerrainCulling(e){this._bindParameters.multipassTerrain.cullAboveGround=e}_renderSlot(e){this._bindParameters.slot=e,this._renderPlugins.render()}_renderEdges(e,r=!1){const t=this._edgeView;d(t)&&t.shouldRender()&&this._offscreenRendering.renderTmpAndCompositeToMain((()=>t.render(this._bindParameters,e)),this._bindParameters,ie.Alpha,r)}_renderShadowMap(e,r,t,s){const n=this._shadowMap;n.enabled&&(n.start(r,t,s),this._shadowHighlight.updateParameters(r,t),this._needsShadowHighlight?(this._renderShadowCascades(I.ShadowHighlight,this._shadowMap,(e=>n.takeCascadeSnapshotTo(e,K.Highlight))),n.clear(),this._renderShadowCascades(I.ShadowExludeHighlight,this._shadowMap,(e=>{n.takeCascadeSnapshotTo(e,K.Default),this._renderGeometryAndTransparentTerrainPass(I.ShadowHighlight)}))):this._renderShadowCascades(I.Shadow),n.finish(e),r.setGLViewport(this._rctx))}_renderShadowCascades(e,r=this._shadowMap,t=(e=>{})){for(const s of r.getCascades())s.camera.setGLViewport(this._rctx),this._prepare(s.camera,s.camera),this._renderGeometryAndTransparentTerrainPass(e),t(s)}get _needsLinearDepth(){return this._ssaoHelper.ready||this._renderPlugins.needsLinearDepth||this._hasWater&&this._waterReflectionEnabled||this._needsShadowHighlight||this._needsShadowCast}_renderLinearDepth(){this._needsLinearDepth?this._offscreenRendering.renderToTargets((()=>this._renderGeometryAndTransparentTerrainPass(I.Depth)),this._offscreenRendering.linearDepth,this._offscreenRendering.tmpDepth,[0,0,0,0],!0,!0):this._offscreenRendering.disposeTarget(this._offscreenRendering.linearDepth),this._bindParameters.linearDepthTexture=this._offscreenRendering.linearDepthTexture}_renderTerrainLinearDepth(e){if(e){const e=this._renderContext.output;this._renderContext.output=I.Depth,this._offscreenRendering.renderToTargets((()=>this._renderTransparentTerrain()),this._offscreenRendering.terrainLinearDepth,this._offscreenRendering.tmpDepth,[-1e10,-1e10,-1e10,1],!0,!0),this._renderContext.output=e}else this._offscreenRendering.disposeTarget(this._offscreenRendering.terrainLinearDepth);this._bindParameters.multipassTerrain.linearDepthTexture=this._offscreenRendering.terrainLinearDepthTexture}_renderGeometryLinearDepth(e){if(e){const e=this._renderContext.output;this._offscreenRendering.renderToTargets((()=>this._renderGeometryPass(I.Depth)),this._offscreenRendering.geometryLinearDepth,this._offscreenRendering.tmpDepth,[1,1,1,1],!0,!0),this._renderContext.output=e}else this._offscreenRendering.disposeTarget(this._offscreenRendering.geometryLinearDepth);this._bindParameters.multipassGeometry.linearDepthTexture=this._offscreenRendering.geometryLinearDepthTexture}get _needsNormal(){return this._ssaoHelper.ready}_renderNormal(){this._needsNormal?this._offscreenRendering.renderToTargets((()=>{this._renderGeometryAndTransparentTerrainPass(I.Normal)}),this._offscreenRendering.normal,this._offscreenRendering.tmpDepth,[0,0,0,0],!0,!0):this._offscreenRendering.disposeTarget(this._offscreenRendering.normal)}get _needsDepthRange(){return this._shadowMap.enabled||this._needsShadowCast}_computeDepthRange(e){if(!this._needsDepthRange)return U;const r=q(e,this._content,this._stage.layers);return j(r,this.renderPlugins.queryDepthRange(e)),r.near=Math.max(e.near,r.near),r.far=Math.min(e.far,r.far),r}_renderGeometryAndTransparentTerrainPass(e){this._renderContext.output=e,this._renderGeometryPass(e),this._renderTransparentTerrain()}_renderGeometryPass(e){this._renderContext.output=e,this._renderOpaqueGeometry(),this._renderTransparentGeometry()}_renderSSAO(){this._ssaoHelper.loading?this._requestRender():this._ssaoHelper.computeSSAO(this._bindParameters,this._offscreenRendering.linearDepthTexture,this._offscreenRendering.normalTexture)}_renderOpaqueGeometry(){this._renderSlot(Y.INTEGRATED_MESH),this._renderSlot(Y.OPAQUE_TERRAIN),this._renderInternalSlot(Y.OPAQUE_MATERIAL),this._renderSlot(Y.OPAQUE_MATERIAL),this._renderSlot(Y.POSTPROCESSING_ENVIRONMENT_OPAQUE)}_renderTransparentGeometry(){this._renderInternalSlot(Y.TRANSPARENT_MATERIAL),this._renderSlot(Y.TRANSPARENT_MATERIAL)}_renderTransparentTerrain(){this._renderSlot(Y.TRANSPARENT_TERRAIN)}_renderHUDVisibility(e){let r=!1;return this._renderContext.offscreenRenderingHelper&&this._renderContext.offscreenRenderingHelper.renderHUDVisibility((()=>{this._bindParameters.hudVisibilityTexture=this._renderContext.offscreenRenderingHelper.hudVisibilityTexture,r=this._renderInternalSlot(Y.OCCLUSION_PIXELS)}),e),r}_renderLineCallouts(e){this._bindParameters.renderTransparentlyOccludedHUD=e,e===H.Occluded?this._offscreenRendering.renderToTargets((()=>this._renderInternalSlot(Y.LINE_CALLOUTS)),this._offscreenRendering.currentColorTarget,this._offscreenRendering.tmpDepth,void 0,!0,!0):this._renderInternalSlot(Y.LINE_CALLOUTS)}_renderHUD(e,r){this._hasHUDElements&&(this._oitEnabled?(this._renderOrderIndependentTransparency((()=>this._renderHUDElements(e)),!0),this._rctx.bindFramebuffer(r),this._compositingHelper.composite(this._bindParameters,this._offscreenRendering.hudColorTexture,ie.PremultipliedAlpha)):e===H.Occluded?this._offscreenRendering.renderToTargets((()=>this._renderHUDElements(H.Occluded)),this._offscreenRendering.currentColorTarget,this._offscreenRendering.tmpDepth,void 0,!0,!0):this._renderHUDElements(e))}_renderHUDElements(e){this._bindParameters.renderTransparentlyOccludedHUD=e,this._renderInternalSlot(Y.LINE_CALLOUTS_HUD_DEPTH),this._renderInternalSlot(Y.HUD_MATERIAL),this._renderInternalSlot(Y.LABEL_MATERIAL)}get _needsHighlight(){return this._hasHighlights||this._renderPlugins.needsHighlight}get _needsShadowHighlight(){return this._shadowMap.enabled&&this._shadowHighlight.isVisible&&this._needsHighlight}_renderHighlights(e,r){if(!this._needsHighlight)return void this._offscreenRendering.disposeTarget(this._offscreenRendering.highlight);const t=this._highlight,s=this._offscreenRendering.renderToTargets((()=>{this._renderGeometryAndTransparentTerrainPass(I.Highlight),this._rctx.clearSafe(de.DEPTH_BUFFER_BIT),this._renderHUDElements(H.Both)}),this._offscreenRendering.highlight,this._offscreenRendering.tmpDepth,[0,0,0,0],!0,!0);this._bindParameters.highlightColorTexture=s.colorTexture,this._needsShadowHighlight&&this._shadowHighlight.render(r,e),t.render(this._bindParameters,s,e)}get _needsShadowCast(){return this._shadowAccumulator.isAccumulating}_accumulateShadows(e,r,t){this._needsShadowCast&&this._shadowAccumulator.renderAccumulation(this._offscreenRendering.linearDepthTexture,e,r,t)}_renderOrderIndependentTransparency(e,r){const t=t=>{this._bindParameters.transparencyPassType=t,this._offscreenRendering.renderOITPass((()=>e()),t,r)},s=this._renderContext.output;this._renderContext.output=I.Alpha,t(re.Alpha),this._renderContext.output=I.Color,t(re.Color),t(re.FrontFace),this._offscreenRendering.compositeTransparentOntoOpaque(this._bindParameters,r),this._bindParameters.transparencyPassType=re.NONE,this._renderContext.output=s,this._oitUsed=!0}_disposeOITBuffers(){this._oitUsed||(this._offscreenRendering.disposeTarget(this._offscreenRendering.alphaFloatTarget),this._offscreenRendering.disposeTarget(this._offscreenRendering.colorFloatTarget),this._offscreenRendering.disposeTarget(this._offscreenRendering.frontFaceTarget)),this._oitUsed=!1}_renderOccluded(){let e=0;this._materialRenderers.forEach(((r,t)=>{t&&t.isVisible()&&t.renderOccluded===V.OccludeAndTransparentStencil&&(e|=t.renderOccluded,ge.push(t))}));const r=this._offscreenRendering,t=(t,s,n,i,a)=>{0!=(e&s)&&(r.renderToTargets(n,r.tmpColor,r.mainDepth,[0,0,0,0],i,a),r.compositeOccludedOntoMain(this._bindParameters,t))};0!==ge.length&&(this._renderInternalSlot(Y.OCCLUDER_MATERIAL,ge),t(.5,V.OccludeAndTransparentStencil,(()=>this._renderInternalSlot(Y.TRANSPARENT_OCCLUDER_MATERIAL,ge)),!1,!1),ge.length=0),this._materialRenderers.forEach(((r,t)=>{t&&t.isVisible()&&(t.renderOccluded===V.OccludeAndTransparent||t.renderOccluded===V.Transparent||t.renderOccluded===V.Opaque)&&(e|=t.renderOccluded,me.push(t))}));const s=this._renderPlugins.renderOccludedFlags;if(e|=s,!e)return;const n=e=>{this._renderContext.renderOccludedMask=e,s>V.Occlude&&this._renderSlot(Y.OCCLUDED_TERRAIN),this._renderInternalSlot(Y.OPAQUE_MATERIAL,me),this._renderInternalSlot(Y.TRANSPARENT_MATERIAL,me),this._renderInternalSlot(Y.TRANSPARENT_DEPTH_WRITE_DISABLED_MATERIAL,me),this._renderContext.resetRenderOccludedMask()};this._renderContext.output=I.Color,t(.5,V.OccludeAndTransparent,(()=>n(V.OccludeAndTransparent)),!0,N.OutlineVisualElementMask),t(.5,V.Transparent,(()=>n(V.Transparent)),!0,N.OutlineVisualElementMask),t(1,V.Opaque,(()=>n(V.Opaque)),!0,N.OutlineVisualElementMask),me.length=0}_renderAntiAliasing(e){if(this._antialiasing){if(this._smaaPass.enable((()=>this._requestRender()))&&d(e))return this._smaaPass.render(e),!0}else this._smaaPass.disable();return!1}_prepare(e,r){this._needsTransparentPass=n(this._materialRenderers,(e=>e.requiresSlot(Y.TRANSPARENT_MATERIAL,I.Color))),this._bindParameters.camera=e,this._bindParameters.contentCamera=r}_ensureBindParameters(e,r){this._bindParameters.camera=e,this._bindParameters.contentCamera=r;const t=this._renderContext.offscreenRenderingHelper;this._bindParameters.hudVisibilityTexture=t.hudVisibilityTexture,this._bindParameters.mainColorTexture=t.mainColorTexture,this._bindParameters.highlightDepthTexture=t.depthTexture??this._getFallbackDepthTexture()}_ensureBindParametersSSR(){this.hasWaterReflection?(this._renderContext.lastFrameCamera.equals(this._bindParameters.camera)?this._reprojectionMatrix=A:(E(fe,this._bindParameters.camera.viewMatrix),E(ue,this._bindParameters.camera.projectionMatrix),b(Re,fe,ue),b(Re,this._renderContext.lastFrameCamera.viewMatrix,Re),b(Re,this._renderContext.lastFrameCamera.projectionMatrix,Re),this._reprojectionMatrix=Re),this._bindParameters.ssr.lastFrameColorTexture=this._offscreenRendering.lastFrameColorTexture):this._bindParameters.ssr.lastFrameColorTexture=null,this._bindParameters.ssr.enabled=this.hasWaterReflection}_renderInternalSlot(e,r){let t=!1;return this._bindParameters.slot=e,d(r)?r.forEach((e=>{if(!e.shouldRender(this._renderContext))return;const r=this._materialRenderers.get(e);d(r)&&(t=r.render(this._renderContext.output,this._bindParameters)||t)})):this._materialRenderers.forEach(((e,r)=>{r.shouldRender(this._renderContext)&&e.render(this._renderContext.output,this._bindParameters)&&(t=!0)})),t}_getFallbackDepthTexture(){return this._fallbackDepthStencilTexture||(this._fallbackDepthStencilTexture=F(this._rctx)),this._fallbackDepthStencilTexture}get gpuMemoryUsage(){return{offscreen:this._offscreenRendering?.gpuMemoryUsage??0,highlights:(this._highlight?.gpuMemoryUsage??0)+(this._shadowHighlight?.gpuMemoryUsage??0),shadows:this._shadowMap?.gpuMemoryUsage??0,ssao:this._ssaoHelper?.gpuMemoryUsage??0}}get test(){const e=this;return{offscreen:this._offscreenRendering,shadowMap:this._shadowMap,ssao:this._ssaoHelper,highlight:this._highlight,lighting:this._bindParameters.lighting,materialRenderers:this._materialRenderers,shadowAccumulator:this._shadowAccumulator,weatherIsFading:this._bindParameters.cloudsFade.isFading,getFramebufferTexture:r=>{switch(r){case pe.Color:return e._offscreenRendering.colorTexture;case pe.LinearDepth:return e._offscreenRendering.linearDepthTexture;case pe.Normals:return e._offscreenRendering.normalTexture;case pe.ShadowMap:return e._shadowMap.depthTexture;case pe.HudVisibility:return e._offscreenRendering.hudVisibilityTexture;case pe.Highlight:return e._offscreenRendering.highlightTexture}}}}};var pe;e([f()],ce.prototype,"_shadowAccumulator",void 0),e([f()],ce.prototype,"_smaaPass",void 0),e([f()],ce.prototype,"_antialiasing",void 0),e([f()],ce.prototype,"_edgeView",void 0),e([f()],ce.prototype,"updating",null),e([f()],ce.prototype,"isCameraFinal",null),ce=e([R("esri.views.3d.webgl-engine.lib.Renderer")],ce),function(e){e[e.Color=0]="Color",e[e.LinearDepth=1]="LinearDepth",e[e.Normals=2]="Normals",e[e.ShadowMap=3]="ShadowMap",e[e.HudVisibility=4]="HudVisibility",e[e.Highlight=5]="Highlight"}(pe||(pe={}));const me=[],ge=[],ue=P(),fe=P(),Re=P();export{pe as FramebufferId,ce as Renderer};
