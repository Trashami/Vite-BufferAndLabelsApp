/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.25/esri/copyright.txt for details.
*/
import{_ as e}from"../../../../chunks/tslib.es6.js";import t from"../../../../core/Accessor.js";import{equals as i}from"../../../../core/arrayUtils.js";import r from"../../../../core/Handles.js";import{smoothstep as s}from"../../../../core/mathUtils.js";import{isNone as a,disposeMaybe as n,releaseMaybe as o}from"../../../../core/maybe.js";import{watch as h,syncAndInitial as c}from"../../../../core/reactiveUtils.js";import{property as _}from"../../../../core/accessorSupport/decorators/property.js";import"../../../../core/accessorSupport/ensureType.js";import{subclass as l}from"../../../../core/accessorSupport/decorators/subclass.js";import{F as d,c as u}from"../../../../chunks/vec3.js";import{c as m}from"../../../../chunks/vec3f64.js";import{BindParameters as p}from"./BindParameters.js";import{Camera as g}from"./Camera.js";import{ZERO as f}from"./depthRange.js";import{createQuadVAO as v}from"./glUtil3D.js";import{ShadowCastRenderer as w,shadowCastDisabledElevationThreshold as b,shadowCastDisableElevationMax as C,shadowCastDisableElevationMin as A}from"./ShadowCastRenderer.js";import{ShadowMap as y}from"./ShadowMap.js";import{S as R,s as S}from"../../../../chunks/ShadowCastAccumulate.glsl.js";import{ShadowCastAccumulateTechnique as T}from"../shaders/ShadowCastAccumulateTechnique.js";import{TaskPriority as D}from"../../../support/Scheduler.js";import{TargetType as F,DepthStencilTargetType as j,TextureType as E,PixelFormat as P,PixelType as I,TextureSamplingMode as x,TextureWrapMode as q,ClearBufferBit as M}from"../../../webgl/enums.js";import{FramebufferObject as U}from"../../../webgl/FramebufferObject.js";import{vertexCount as O}from"../../../webgl/Util.js";var L;let B=L=class extends t{constructor(e,t,i,s,n,o){super({}),this._rctx=e,this._stage=i,this._prepareForShadowMapPass=s,this._renderToShadowMap=n,this._requestRender=o,this._progress=0,this._sampleCount=0,this._passParameters=new R,this._enabledInternal=!1,this._cachedLightDirections=[],this._depthRange=f,this._previewingCached=!1,this._handles=new r,this._cameraForcedForScreenshot=!1,this._bindParameters=new p(new y(e,i.viewingMode),null,null),this._bindParameters.shadowMap.enabled=!0,this._bindParameters.camera=new g,this._vao=v(e);const _={colorTarget:F.TEXTURE,depthStencilTarget:j.NONE,width:0,height:0},l={target:E.TEXTURE_2D,pixelFormat:P.RGBA,dataType:I.UNSIGNED_BYTE,samplingMode:x.LINEAR,wrapMode:q.CLAMP_TO_EDGE,width:0,height:0};this._fbo=new U(e,_,l),this._accumulationRenderer=new w(t,e,this,o);const d=this._stage.resourceController.scheduler;this._handles.add(d.registerTask(D.SHADOW_ACCUMULATOR,this)),this._handles.add(h((()=>i.renderView),(e=>{this._handles.remove(L.renderViewHandleKey),a(e)||this._handles.add(e.events.on("force-camera-for-screenshot",(()=>this._cameraForcedForScreenshot=!0)),L.renderViewHandleKey)}),c))}normalizeCtorArgs(){return{}}get computedSamples(){return this._progress}get shadowCastTexture(){return this._fbo.colorTexture}get isAccumulating(){return this._isPreviewing||this._isRefining}get _accumulationTechnique(){if(a(this._accumulationTechniqueCached)){const e={rctx:this._rctx,viewingMode:this._stage.viewingMode};this._accumulationTechniqueCached=new T(e)}return this._accumulationTechniqueCached}get _isRefining(){return this._isActive&&!this._isDoneAccumulating&&!this._previewingCached}get _isPreviewing(){return this._isActive&&this._previewingCached}get _isActive(){return this._enabledInternal&&this._sampleCount>0}get canAccumulate(){return null!==this._passParameters.linearDepthTexture&&this._depthRange!==f&&this._opacityFromElevation>b}get _isDoneAccumulating(){return this._progress>=this._sampleCount}get _lightDirectionsInternal(){return this._cachedLightDirections}set _lightDirectionsInternal(e){const t=this._cachedLightDirections;if(i(t,e,d))return;const r=e.length;t.length=r,this._sampleCount=Math.min(S,r);for(let i=0;i<r;++i){const r=e[i],s=t[i]||m();u(s,r),t[i]=s}this._invalidate()}get _opacityFromElevation(){return this._accumulationRenderer.opacityFromElevation}set _opacityFromElevation(e){this._accumulationRenderer.opacityFromElevation=e}get running(){return this._isRefining&&this.canAccumulate&&this._progress>0}runTask(e){for(this._prepareForShadowMapPass(this._bindParameters);!e.done&&!this._isDoneAccumulating;)this._accumulateShadow(),e.madeProgress();this._requestRender()}renderAccumulation(e,t,i,r){if(this._passParameters.linearDepthTexture=e,this._depthRange=t,this._updateCamera(i),this._bindParameters.contentCamera=r,this.notifyChange("canAccumulate"),!this.isAccumulating||!this.canAccumulate)return;(this._previewingCached||0===this._progress||this._cameraForcedForScreenshot)&&this._clear();const s=this._cameraForcedForScreenshot?this._sampleCount:Math.min(L.previewSamples,this._sampleCount-this._progress);for(let a=0;a<s;++a)this._accumulateShadow();this._cameraForcedForScreenshot=!1}render(e){this._accumulationRenderer.render(e)}dispose(){this._stop(),this._handles.destroy(),this._accumulationRenderer=n(this._accumulationRenderer),this._bindParameters.shadowMap.dispose(),this._fbo=n(this._fbo),this._vao=n(this._vao),this._accumulationTechniqueCached=o(this._accumulationTechniqueCached),this._cachedLightDirections.length=0,this._sampleCount=0}setOptions(e){void 0!==e.enabled&&(this._enabled=e.enabled),void 0!==e.previewing&&(this._previewing=e.previewing),void 0!==e.lightDirections&&(this._lightDirections=e.lightDirections),this._accumulationRenderer.setOptions(e)}set _previewing(e){this._previewingCached!==e&&(this._previewingCached=e,this._requestRenderIfEnabled())}set _lightDirections(e){this._lightDirectionsInternal=e}readAccumulatedShadow(e,t){if(!this._isActive||this._progress<1||e<0||e>this._fbo.width||t<0||t>this._fbo.height)return 0;const i=N;return this._fbo.readPixels(e,t,1,1,P.RGBA,I.UNSIGNED_BYTE,i),i[0]/this._progress}_start(){this._progress=0,this._enabledInternal=!0}_stop(){this._enabledInternal=!1}_invalidate(){this._progress=0,this._requestRenderIfEnabled()}_clear(){this._rctx.bindFramebuffer(this._fbo),this._rctx.setClearColor(0,0,0,0),this._rctx.clearSafe(M.COLOR_BUFFER_BIT),this._progress=0}_accumulateShadow(){const e=this._lightDirectionsInternal[this._progress];this._renderToShadowMap(this._bindParameters,e,this._depthRange),this._passParameters.origin=this._bindParameters.camera.center,this._rctx.bindFramebuffer(this._fbo);const t=this._accumulationTechnique;this._rctx.bindTechnique(t,this._passParameters,this._bindParameters),this._rctx.bindVAO(this._vao),this._rctx.drawArrays(t.primitiveType,0,O(this._vao,"geometry")),this._progress++}_updateCamera(e){e.equals(this._bindParameters.camera)||(this._bindParameters.camera.copyFrom(e),this._fbo.resize(e.fullWidth,e.fullHeight),this._opacityFromElevation=1-s(A,C,e.relativeElevation))}set _enabled(e){e!==this._enabledInternal&&(e?this._start():this._stop())}_requestRenderIfEnabled(){this._enabledInternal&&this._requestRender()}get test(){const e=this;return{lightDirections:this._lightDirectionsInternal,get isDone(){return e._isDoneAccumulating},get isActive(){return e._isActive}}}};B.previewSamples=6,B.renderViewHandleKey="renderView",e([_()],B.prototype,"_progress",void 0),e([_()],B.prototype,"_sampleCount",void 0),e([_()],B.prototype,"_enabledInternal",void 0),e([_()],B.prototype,"_depthRange",void 0),e([_()],B.prototype,"_previewingCached",void 0),e([_()],B.prototype,"_accumulationRenderer",void 0),e([_()],B.prototype,"_isRefining",null),e([_()],B.prototype,"_isActive",null),e([_()],B.prototype,"canAccumulate",null),e([_()],B.prototype,"_isDoneAccumulating",null),e([_()],B.prototype,"_opacityFromElevation",null),e([_()],B.prototype,"running",null),B=L=e([l("esri.views.3d.webgl-engine.lib.ShadowAccumulator")],B);const N=new Uint8Array(4);export{B as ShadowAccumulator};
