/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.25/esri/copyright.txt for details.
*/
import{disposeMaybe as e,applySome as s,isSome as t,isNone as r}from"../../../../core/maybe.js";import{s as i}from"../../../../chunks/vec2.js";import{requestImage as a}from"../../../../support/requestImageUtils.js";import{createQuadVAO as h}from"./glUtil3D.js";import{SSAOBlurTechnique as _}from"./SSAOBlurTechnique.js";import{SSAOTechnique as o}from"./SSAOTechnique.js";import{SSAOPassParameters as u,BlurDrawParameters as l}from"../shaders/SSAOParameters.js";import{PrimitiveType as n,TextureType as m,PixelFormat as d,PixelType as b,TextureSamplingMode as O,TextureWrapMode as p,TargetType as c,DepthStencilTargetType as B}from"../../../webgl/enums.js";import{FramebufferObject as F}from"../../../webgl/FramebufferObject.js";import{Texture as T}from"../../../webgl/Texture.js";import{vertexCount as g}from"../../../webgl/Util.js";const w=2;class P{constructor(e,s,t){this._techniqueRepository=e,this._rctx=s,this._requestRender=t,this._enabled=!1,this._quadVAO=null,this._passParameters=new u,this._drawParameters=new l}dispose(){this._quadVAO=e(this._quadVAO)}disposeOffscreenBuffers(){s(this._ssaoFBO,(e=>e.resize(0,0))),s(this._blur0FBO,(e=>e.resize(0,0))),s(this._blur1FBO,(e=>e.resize(0,0)))}set enabled(e){e?this._enable():this._disable()}get enabled(){return this._enabled}get ready(){return this.enabled&&t(this._passParameters.noiseTexture)&&t(this._ssaoFBO)&&t(this._blur0FBO)&&t(this._blur1FBO)}get loading(){return this.enabled&&!this.ready}get colorTexture(){return t(this._blur1FBO)?this._blur1FBO.colorTexture:null}get width(){return t(this._ssaoFBO)?this._ssaoFBO.width:-1}get height(){return t(this._ssaoFBO)?this._ssaoFBO.height:-1}computeSSAO(e,s,t){if(!this.enabled||r(s)||r(t)||r(this._passParameters.noiseTexture)||r(this._ssaoFBO)||r(this._blur0FBO)||r(this._blur1FBO))return;const a=this._rctx,_=e.camera;this._passParameters.normalTexture=t,this._passParameters.depthTexture=s,this._passParameters.projScale=1/_.computeRenderPixelSizeAtDist(1);const o=_.fullViewport,u=o[2],l=o[3],m=u/w,d=l/w;this._ssaoFBO.resize(u,l),this._blur0FBO.resize(m,d),this._blur1FBO.resize(m,d),r(this._quadVAO)&&(this._quadVAO=h(this._rctx)),a.bindFramebuffer(this._ssaoFBO),a.setViewport(0,0,u,l);a.bindTechnique(this._ssaoTechnique,this._passParameters,e).bindDraw(this._drawParameters,e,this._passParameters),a.bindVAO(this._quadVAO),a.drawArrays(n.TRIANGLE_STRIP,0,g(this._quadVAO,"geometry"));const b=a.bindTechnique(this._blurTechnique,this._passParameters,e);a.setViewport(0,0,m,d),a.bindFramebuffer(this._blur0FBO),this._drawParameters.colorTexture=this._ssaoFBO.colorTexture,i(this._drawParameters.blurSize,0,w/l),b.bindDraw(this._drawParameters,e,this._passParameters),a.setViewport(0,0,m,d),a.drawArrays(n.TRIANGLE_STRIP,0,g(this._quadVAO,"geometry")),a.bindFramebuffer(this._blur1FBO),this._drawParameters.colorTexture=this._blur0FBO.colorTexture,i(this._drawParameters.blurSize,w/u,0),b.bindDraw(this._drawParameters,e,this._passParameters),a.drawArrays(n.TRIANGLE_STRIP,0,g(this._quadVAO,"geometry")),a.setViewport(o[0],o[1],o[2],o[3])}_selectPrograms(){r(this._ssaoTechnique)&&(this._ssaoTechnique=this._techniqueRepository.acquire(o)),r(this._blurTechnique)&&(this._blurTechnique=this._techniqueRepository.acquire(_))}_enable(){this.enabled||(this._enabled=!0,this._loadResources((()=>{this._enabled&&this._initialize()})))}_loadResources(e){this._data?e():import("./SSAOHelperData.js").then((s=>{this._data=s,e()}))}_initialize(){const e={target:m.TEXTURE_2D,pixelFormat:d.RGBA,dataType:b.UNSIGNED_BYTE,samplingMode:O.LINEAR,wrapMode:p.CLAMP_TO_EDGE,width:0,height:0},s={colorTarget:c.TEXTURE,depthStencilTarget:B.NONE};a(this._data.noiseTexture).then((t=>{this._enabled&&(this._ssaoFBO=new F(this._rctx,s,e),this._blur0FBO=new F(this._rctx,s,e),this._blur1FBO=new F(this._rctx,s,e),this._passParameters.noiseTexture=new T(this._rctx,{target:m.TEXTURE_2D,pixelFormat:d.RGBA,dataType:b.UNSIGNED_BYTE,hasMipmap:!0,width:t.width,height:t.height},t),this._requestRender())})),this._selectPrograms()}_disable(){this._enabled=!1,this._passParameters.noiseTexture=e(this._passParameters.noiseTexture),this._blur1FBO=e(this._blur1FBO),this._blur0FBO=e(this._blur0FBO),this._ssaoFBO=e(this._ssaoFBO)}get gpuMemoryUsage(){return(t(this._blur0FBO)?this._blur0FBO.gpuMemoryUsage:0)+(t(this._blur1FBO)?this._blur1FBO.gpuMemoryUsage:0)+(t(this._ssaoFBO)?this._ssaoFBO.gpuMemoryUsage:0)}get test(){return{ssao:this._ssaoFBO,blur:this._blur1FBO}}}export{P as SSAOHelper,w as blurSizePixels};
