/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.25/esri/copyright.txt for details.
*/
import{isNone as e,destroyMaybe as t,isSome as a}from"../../../../../core/maybe.js";import{isAborted as s,throwIfAborted as n}from"../../../../../core/promiseUtils.js";import{c as i}from"../../../../../chunks/mat4f64.js";import{b as r,e as o,m as l}from"../../../../../chunks/vec3.js";import{c}from"../../../../../chunks/vec3f64.js";import{c as h,f as d}from"../../../../../chunks/vec4f64.js";import u from"../../../support/debugFlags.js";import{glLayout as _}from"../../../support/buffer/glUtil.js";import{ShaderOutput as m}from"../../core/shaderLibrary/ShaderOutput.js";import{Camera as f}from"../Camera.js";import{Default3D as p}from"../DefaultVertexAttributeLocations.js";import{IntersectorType as g}from"../IntersectorInterfaces.js";import C from"../Octree.js";import{RenderSlot as I}from"../RenderSlot.js";import{assert as D}from"../Util.js";import{InstanceData as y,StateFlags as v}from"./InstanceData.js";import{InstanceOctree as b}from"./InstanceOctree.js";import{LevelSelector as R}from"./LevelSelector.js";import{LodLevel as E}from"./LodLevel.js";import{RenderInstanceData as A}from"./RenderInstanceData.js";import{getInstanceBufferLayout as T}from"../../materials/DefaultMaterial.js";import{colorMixModes as L}from"../../materials/internal/MaterialUtil.js";import{encodeDoubleVec3 as S}from"../../materials/renderers/utils.js";import{DefaultMaterialDrawParameters as O}from"../../shaders/DefaultMaterialTechnique.js";import{bindVertexBufferLayout as U,unbindVertexBufferLayout as j}from"../../../../webgl/Util.js";const x=e=>{const t=e.baseBoundingSphere.radius,a=e.levels.map((e=>e.minScreenSpaceRadius));return new R(t,a)};class M{constructor(e,t,a,s){this.type=g.LOD,this.isGround=!1,this._levels=[],this._defaultRenderInstanceData=[],this._highlightRenderInstanceData=[],this._instanceIndex=0,this._slicePlane=!1,this._lastCamera=new f,this._updateCyclesWithStaticCamera=-1,this._needFullCycle=!1,this.slots=[I.OPAQUE_MATERIAL,I.TRANSPARENT_MATERIAL],this.canRender=!0,this._symbol=e,this._optionalFields=t,this._metadata=a,this._instanceBufferLayout=T({instancedDoublePrecision:!0,instanced:t}),this._glInstanceBufferLayout=_(this._instanceBufferLayout,1),this._instanceData=new y(this._optionalFields,s),this._instanceData.on("instance-added",(()=>this._requestUpdateCycle())),this._instanceData.on("instance-removed",(()=>this._requestUpdateCycle())),this._instanceData.on("instance-transform-changed",(e=>{this._requestUpdateCycle(),this._metadata.notifyGraphicGeometryChanged(e.index)})),this._instanceData.on("instance-visibility-changed",(e=>{this._requestUpdateCycle(!0),this._metadata.notifyGraphicVisibilityChanged(e.index)})),this._instanceData.on("instance-highlight-changed",(()=>this._requestUpdateCycle(!0))),this._enableLevelSelection=this._symbol.levels.length>1}get levels(){return this._levels}get baseBoundingBox(){return this._levels[this._levels.length-1].boundingBox}get baseBoundingSphere(){return this._levels[this._levels.length-1].boundingSphere}get baseMaterial(){return this._levels[this._levels.length-1].components[0].material}get slicePlaneEnabled(){return this._slicePlane}set slicePlaneEnabled(e){this._slicePlane=e}get layerUid(){return this._metadata.layerUid}get instanceData(){return this._instanceData}get memoryUsage(){const e={cpu:0,gpu:0};return this._defaultRenderInstanceData.forEach((t=>{const a=t.memoryUsage;e.cpu+=a.cpu,e.gpu+=a.gpu})),this._highlightRenderInstanceData.forEach((t=>{const a=t.memoryUsage;e.cpu+=a.cpu,e.gpu+=a.gpu})),e}get renderStats(){const e=this._instanceData.size,t=[];return this._levels.forEach(((e,a)=>{const s=this._defaultRenderInstanceData[a],n=this._highlightRenderInstanceData[a],i=s.size+n.size,r=e.triangleCount;t.push({renderedInstances:i,renderedTriangles:i*r,trianglesPerInstance:r})})),{totalInstances:e,renderedInstances:t.reduce(((e,t)=>e+t.renderedInstances),0),renderedTriangles:t.reduce(((e,t)=>e+t.renderedTriangles),0),levels:t}}async initializeRenderContext(e,t){this._context=e;const a=e.renderContext.rctx,i=await Promise.allSettled(this._symbol.levels.map((s=>(this._defaultRenderInstanceData.push(new A(a,this._instanceBufferLayout)),this._highlightRenderInstanceData.push(new A(a,this._instanceBufferLayout)),E.create(e,s,t))))),r=i.map((e=>"fulfilled"===e.status?e.value:null)).filter((e=>e));if(s(t)||r.length!==i.length){r.forEach((e=>e.destroy())),n(t);for(const e of i)if("rejected"===e.status)throw e.reason}this._levels=r,this._levelSelector=x(this)}uninitializeRenderContext(){this._invalidateOctree(),this._levels.forEach((e=>e.destroy())),this._defaultRenderInstanceData.forEach((e=>e.destroy())),this._highlightRenderInstanceData.forEach((e=>e.destroy()))}get needsTransparentPass(){return this._levels.some((e=>e.components.some((e=>e.material.requiresSlot(I.TRANSPARENT_MATERIAL,m.Color)))))}get needsHighlight(){return this._highlightRenderInstanceData.some((e=>e.size>0))}prepareRender(e){if(u.LOD_INSTANCE_RENDERER_DISABLE_UPDATES)return;if(this._enableLevelSelection){const t=e.bindParameters.contentCamera.equals(this._lastCamera);this._lastCamera.copyFrom(e.bindParameters.contentCamera),t||this._requestUpdateCycle()}const t=this._needFullCycle?this._instanceData.size:2e3;this._needFullCycle=!1,this._updateInstances(e.bindParameters.contentCamera,t),this._needsUpdates&&this._context.requestRender()}render(e){if(!this.baseMaterial.isVisible()||!this.baseMaterial.isVisibleForOutput(e.output))return;e.rctx.bindVAO();e.output!==m.Highlight&&e.output!==m.ShadowHighlight&&this._renderComponents(e,this._defaultRenderInstanceData);e.output!==m.ShadowExludeHighlight&&this._renderComponents(e,this._highlightRenderInstanceData)}intersect(e,t,a,s){if(!this.baseMaterial.isVisible())return;const n=c();r(n,s,a);const i=n=>{this._instanceData.getCombinedModelTransform(n,q),e.transform.set(q),l(H,a,e.transform.inverse),l(B,s,e.transform.inverse);const i=this._instanceData.getState(n),r=this._instanceData.getLodLevel(n),o=this._levels.length;D(i&v.ACTIVE,"invalid instance state"),D(r>=0&&r<o,"invaid lod level"),this._levels[r].intersect(e,t,H,B,n,this._metadata,o)};this.baseMaterial.parameters.verticalOffset?this._octree.forEach(i):this._octree.forEachAlongRay(a,n,i)}queryDepthRange(e){return this._queryDepthRangeOctree(e)}notifyShaderTransformationChanged(){this._invalidateOctree()}_requestUpdateCycle(e=!1){this._updateCyclesWithStaticCamera=-1,e&&(this._needFullCycle=!0),this._needsUpdates&&this._context.requestRender()}get _needsUpdates(){return this._instanceData.size>0&&this._updateCyclesWithStaticCamera<1}get _octree(){return e(this._octreeCached)&&(this._octreeCached=this._buildOctree()),this._octreeCached}_invalidateOctree(){this._octreeCached=t(this._octreeCached)}_buildOctree(){const e=new b(this._instanceData,this.baseBoundingSphere),t=this._instanceData,a=t.view?t.view.state:null;for(let s=0;s<this._instanceData.capacity;++s){a.get(s)&v.ACTIVE&&e.addInstance(s)}return e}_queryDepthRangeOctree(e){const t=e.eye,a=e.viewForward,s=this._octree.findClosest(a,C.DepthOrder.FRONT_TO_BACK,e.frustum),n=this._octree.findClosest(a,C.DepthOrder.BACK_TO_FRONT,e.frustum);if(null!=s&&null!=n){this._instanceData.view.boundingSphere.getVec(s,N),r(N,N,t);const i=o(N,a)-N[3];this._instanceData.view.boundingSphere.getVec(n,N),r(N,N,t);const l=o(N,a)+N[3];return{near:Math.max(e.near,i),far:Math.min(e.far,l)}}return{near:1/0,far:-1/0}}_startUpdateCycle(){this._updateCyclesWithStaticCamera++,this._defaultRenderInstanceData.forEach((e=>{e.startUpdateCylce()})),this._highlightRenderInstanceData.forEach((e=>{e.startUpdateCylce()})),this._needsUpdates&&this._context.requestRender()}_updateInstances(e,t){const s=this._enableLevelSelection,n=this._levelSelector;n.updateCamera(e),this._defaultRenderInstanceData.forEach((e=>e.beginUpdate())),this._highlightRenderInstanceData.forEach((e=>e.beginUpdate()));const i=this._instanceData,r=this._instanceData.view,o=i.size,l=i.capacity;let c=this._instanceIndex;t=Math.min(o,t);for(let h=0;h<t;++h){0===c&&this._startUpdateCycle();const e=r.state.get(c);let o=0;if(!(e&v.ALLOCATED)){c=c+1===l?0:c+1,t++;continue}const h=r.lodLevel.get(c);if(e&v.DEFAULT_ACTIVE&&this._defaultRenderInstanceData[h].freeTail(),e&v.HIGHLIGHT_ACTIVE&&this._highlightRenderInstanceData[h].freeTail(),e&v.REMOVE)i.freeInstance(c);else if(e&v.VISIBLE){let t=0;s&&(r.modelOrigin.getVec(c,w),t=n.selectLevel(w,i.getCombinedMedianScaleFactor(c))),o=e&~(v.ACTIVE|v.TRANSFORM_CHANGED),t>=0&&(e&v.HIGHLIGHT?(V(this._highlightRenderInstanceData[t],r,c),o|=v.HIGHLIGHT_ACTIVE):(V(this._defaultRenderInstanceData[t],r,c),o|=v.DEFAULT_ACTIVE)),r.state.set(c,o),r.lodLevel.set(c,t)}else o=e&~(v.ACTIVE|v.TRANSFORM_CHANGED),r.state.set(c,o);if(a(this._octreeCached)){const t=!!(e&v.ACTIVE),a=!!(o&v.ACTIVE);!t&&a?this._octreeCached.addInstance(c):t&&!a?this._octreeCached.removeInstance(c):t&&a&&e&v.TRANSFORM_CHANGED&&(this._octreeCached.removeInstance(c),this._octreeCached.addInstance(c))}c=c+1===l?0:c+1}this._instanceIndex=c,this._defaultRenderInstanceData.forEach((e=>e.endUpdate())),this._highlightRenderInstanceData.forEach((e=>e.endUpdate()))}_renderComponents(e,t){this.levels.forEach(((a,s)=>{a.components.forEach((a=>{this._renderComponent(e,t[s],a,s)}))}))}_renderComponent(t,a,s,n){const{bindParameters:i,rctx:r,output:o}=t;if(0===a.size||!s.material.requiresSlot(i.slot,t.output))return;const l=s.glMaterials.load(r,i.slot,o);if(e(l))return;const c=l.beginSlot(i),h=r.bindTechnique(c,s.material.parameters,i);r.bindVAO(s.vao),c.ensureAttributeLocations(s.vao),h.bindDraw(G,i,s.material.parameters),u.LOD_INSTANCE_RENDERER_COLORIZE_BY_LEVEL&&t.output===m.Color&&(h.setUniform4fv("externalColor",P[Math.min(n,P.length-1)]),h.setUniform1i("colorMixMode",L.replace));const d=r.capabilities.instancing,_=a.capacity,f=a.headIndex,g=a.tailIndex,C=a.firstIndex,I=this._glInstanceBufferLayout,y=(e,t)=>{U(r,p,a.buffer,I,e),d.drawArraysInstanced(c.primitiveType,0,s.vertexCount,t-e),j(r,p,a.buffer,I)};s.material.parameters.transparent&&null!=C?f>g?(D(C>=g&&C<=f,"invalid firstIndex"),y(C,f),y(g,C)):f<g&&(C<=f?(D(C>=0&&C<=f,"invalid firstIndex"),y(C,f),y(g,_),y(0,C)):(D(C>=g&&C<=_,"invalid firstIndex"),y(C,_),y(0,f),y(g,C))):f>g?y(g,f):f<g&&(y(0,f),y(g,_)),r.bindVAO(null)}}function V(e,t,a){const s=e.allocateHead();F(t,a,e.view,s)}function F(e,t,a,s){S(e.modelOrigin,t,a.modelOriginHi,a.modelOriginLo,s),a.model.copyFrom(s,e.model,t),a.modelNormal.copyFrom(s,e.modelNormal,t),e.color&&a.color&&a.color.copyFrom(s,e.color,t),e.objectAndLayerIdColor&&a.objectAndLayerIdColor&&a.objectAndLayerIdColor.copyFrom(s,e.objectAndLayerIdColor,t),e.featureAttribute&&a.featureAttribute&&a.featureAttribute.copyFrom(s,e.featureAttribute,t)}const w=c(),N=h(),q=i(),H=c(),B=c(),P=[d(1,0,1,1),d(0,0,1,1),d(0,1,0,1),d(1,1,0,1),d(1,0,0,1)],G=new O;export{M as LodRenderer};
