/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.25/esri/copyright.txt for details.
*/
import{_ as e}from"../../../../chunks/tslib.es6.js";import t from"../../../../core/Accessor.js";import{someMap as r}from"../../../../core/MapUtils.js";import{isSome as o,unwrapOr as s}from"../../../../core/maybe.js";import{NullUID as d}from"../../../../core/uid.js";import{property as i}from"../../../../core/accessorSupport/decorators/property.js";import"../../../../core/arrayUtils.js";import"../../../../core/accessorSupport/ensureType.js";import{subclass as c}from"../../../../core/accessorSupport/decorators/subclass.js";import{GeometryRecord as a}from"./GeometryRecord.js";import{DirtyOperation as n,DirtyState as m}from"./ModelDirtyTypes.js";import{assert as y}from"./Util.js";class h{constructor(e,t){this.geometryRecord=e,this.renderGeometry=t}}class l{constructor(e,t,r){this.operation=e,this.geometryRecord=t,this.states=r}}let R=class extends t{constructor(e){super(e),this._residentGeomRecords=new Map,this._dirtyGeomRecords=new Map,this.dirty=!1}commit(e){this.dirty=!1,this._dirtyGeomRecords.forEach(((t,r)=>this.commitLayer(r,e)))}commitLayer(e,t){const r=this._dirtyGeomRecords.get(e);r&&(r.forEach(((r,s)=>{const d=this._ensureGeomRecord(e,s);r.forEach((({geometryRecord:e,operation:r,states:i},c)=>{let l=!1;if(r===n.UPDATE){const r=d.get(c);if(r){const o=r.renderGeometry;if(i&m.TRANSFORMATION){const t=this.model.getObject(s);this.model.updateRenderGeometryTransformation(t,e,o)&&(l=!0)}l||t.updates.push({renderGeometry:o,updateType:i})}else y(!1,"ModelDirtySet.getAddRemoveListFilteredByLayers: invalid update")}if(r===n.REMOVE||l){const e=d.get(c);e?(t.removes.push(e.renderGeometry),d.delete(c),e.geometryRecord.disposed&&a.pool.release(e.geometryRecord)):r===n.REMOVE&&y(!1,"ModelDirtySet.getAddRemoveListFilteredByLayers: invalid remove")}if(r===n.ADD||l){const r=this.model.getObject(s);if(o(r)){const o=this.model.getRenderGeometry(r,e),s=new h(e,o);t.adds.push(o),d.set(c,s)}}})),0===d.size&&this._residentGeomRecords.get(e).delete(s)})),0===this._residentGeomRecords.get(e).size&&this._residentGeomRecords.delete(e),this._dirtyGeomRecords.delete(e))}getResidentRenderGeometries(e,t){const r=this._residentGeomRecords.get(e);r&&r.forEach((e=>e.forEach((e=>t.push(e.renderGeometry)))))}_objectStateChanged(e,t){for(const r of t.geometryRecords)this._updateOrCreateDirtyRecord(t,r,null,n.UPDATE,e)}visibilityChanged(e){this._objectStateChanged(m.VISIBILITIES,e)}highlightChanged(e){this._objectStateChanged(m.HIGHLIGHTS,e)}occlusionChanged(e){this._objectStateChanged(m.OCCLUDEES,e)}vertexAttrsUpdated(e){this._updateOrCreateDirtyRecord(e.object,e.record,null,n.UPDATE,m.VERTEXATTRS)}layerAdded(e){e.objects.forAll((t=>this._layerObjectAdded(e,t)))}layerRemoved(e){e.objects.forAll((t=>this._layerObjectRemoved(e,t)))}layerObjectAdded(e){this._layerObjectAdded(e.layer,e.object)}_layerObjectAdded(e,t){const r=e.id;for(const o of t.geometryRecords)this._objectGeometryAdded(t,o,r)}layerObjectRemoved(e){this._layerObjectRemoved(e.layer,e.object)}layerObjectsAdded(e){for(const t of e.objects)this._layerObjectAdded(e.layer,t)}layerObjectsRemoved(e){for(const t of e.objects)this._layerObjectRemoved(e.layer,t)}_layerObjectRemoved(e,t){const r=e.id;for(const o of t.geometryRecords)this._objectGeometryRemoved(t,o,r)}shaderTransformationChanged(e){const t=this._residentGeomRecords.get(e.id);t&&t.forEach(((e,t)=>{const r=this.model.getObject(t);r&&r.hasVolativeTransformation()&&e.forEach((e=>{e.renderGeometry.shaderTransformationChanged()}))}))}objectTransformation(e){const t=this._getParentLayerId(e),r=e.id;this._ensureGeomRecord(t,r).forEach((r=>{this._updateOrCreateDirtyRecord(e,r.geometryRecord,t,n.UPDATE,m.TRANSFORMATION)}))}objectGeometryAdded(e){this._objectGeometryAdded(e.object,e.record)}_objectGeometryAdded(e,t,r=null){this._updateOrCreateDirtyRecord(e,t,r,n.ADD)}objectGeometryRemoved(e){this._objectGeometryRemoved(e.object,e.record)}_objectGeometryRemoved(e,t,r=null){this._updateOrCreateDirtyRecord(e,t,r,n.REMOVE)}_updateOrCreateDirtyRecord(e,t,r,o,d=m.NONE){r=s(r,this._getParentLayerId(e));const i=e.id,c=t.id,h=this._ensureDirtyRecord(r,i),R=h.get(c);if(R){const e=R.operation;e===n.REMOVE&&o===n.ADD&&R.states!==m.NONE?R.operation=n.UPDATE:e===n.REMOVE&&o===n.ADD||e===n.ADD&&o===n.REMOVE?(h.delete(c),R.geometryRecord.disposed&&a.pool.release(R.geometryRecord)):e!==n.UPDATE||o!==n.REMOVE&&o!==n.UPDATE?(y((e===n.REMOVE||e===n.ADD)&&o===n.UPDATE,"ModelDirtySet.objectGeometryAdded: inconsistent state"),R.states|=d):(R.operation=o,R.states|=d)}else h.set(c,new l(o,t,d));this.dirty=this._hasDirtyGeometryRecords}_ensureGeomRecord(e,t){let r=this._residentGeomRecords.get(e);r||(r=new Map,this._residentGeomRecords.set(e,r));let o=r.get(t);return o||(o=new Map,r.set(t,o)),o}get _hasDirtyGeometryRecords(){return r(this._dirtyGeomRecords,(e=>r(e,(e=>e&&e.size>0))))}_ensureDirtyRecord(e,t){let r=this._dirtyGeomRecords.get(e);r||(r=new Map,this._dirtyGeomRecords.set(e,r));let o=r.get(t);return o||(o=new Map,r.set(t,o)),o}_getParentLayerId(e){return o(e.parentLayer)?e.parentLayer.id:d}formatDebugInfo(){const e=["ADD","UPD",void 0,"REM"];let t="";return this._dirtyGeomRecords.forEach(((r,o)=>{r.forEach(((r,s)=>{t.length>0&&(t+="\n"),t+=o+"."+s;const d=[];r.forEach((e=>{const t=e.operation;d[t]||(d[t]=[]),d[t].push(e.geometryRecord.geometry.id)}));for(let o=0;o<d.length;o++)if(d[o]){t+=" "+e[o-1]+": ";for(let e=0;e<d[o].length;e++)t+=d[o][e]+", "}}))})),t}get test(){const e=this;return{get residentLayerCount(){return e._residentGeomRecords.size},get residentObjectCount(){return Array.from(e._residentGeomRecords.values()).reduce(((e,t)=>e+t.size),0)}}}};e([i({constructOnly:!0})],R.prototype,"model",void 0),e([i()],R.prototype,"dirty",void 0),R=e([c("esri.views.3d.webgl-engine.lib.ModelDirtySet")],R);const p=R;export{p as default};
