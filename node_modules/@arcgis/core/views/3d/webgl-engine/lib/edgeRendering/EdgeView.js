/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.25/esri/copyright.txt for details.
*/
import{_ as e}from"../../../../../chunks/tslib.es6.js";import t from"../../../../../core/Accessor.js";import{equals as r,binaryIndexOf as s}from"../../../../../core/arrayUtils.js";import o from"../../../../../core/Logger.js";import{clamp as n}from"../../../../../core/mathUtils.js";import{disposeMaybe as i,destroyMaybe as a,isNone as c,isSome as d}from"../../../../../core/maybe.js";import{property as l}from"../../../../../core/accessorSupport/decorators/property.js";import"../../../../../core/accessorSupport/ensureType.js";import{subclass as h}from"../../../../../core/accessorSupport/decorators/subclass.js";import{f as u,t as m,e as g}from"../../../../../chunks/mat3.js";import{c as p}from"../../../../../chunks/mat3f64.js";import{c as f}from"../../../../../chunks/mat4f64.js";import{s as _,c as y,y as b,e as j}from"../../../../../chunks/vec3.js";import{c as O}from"../../../../../chunks/vec3f64.js";import{WatchUpdatingTracking as w}from"../../../../../core/support/WatchUpdatingTracking.js";import{g as v,a as x}from"../../../../../chunks/sphere.js";import{c as R}from"../../../../../chunks/vec33.js";import{ViewingMode as E}from"../../../../ViewingMode.js";import{encodeElevationOffset as T}from"../../collections/Component/Material/shader/ComponentData.glsl.js";import{TwoVectorPosition as C}from"../../core/util/TwoVectorPosition.js";import{GridLocalOriginFactory as M}from"../GridLocalOriginFactory.js";import{applyToModelMatrix as P}from"../localOriginHelper.js";import{LocalOriginManager as S}from"../LocalOriginManager.js";import{Object3D as D}from"../Object3D.js";import{VertexArrayObject as A}from"../VertexArrayObject.js";import{VertexAttribute as B}from"../VertexAttribute.js";import{VertexLayout as k,EdgeShaderAttributeLocations as I,glVertexLayout as U,EdgeInputBufferLayout as L}from"./bufferLayouts.js";import{RegularEdgeBufferWriter as V,SilhouetteEdgeBufferWriter as H}from"./edgeBufferWriters.js";import{EdgeType as N}from"./edgePreprocessing.js";import{EdgeRenderer as z,LINE_WIDTH_FRACTION_FACTOR as W,EXTENSION_LENGTH_OFFSET as q}from"./EdgeRenderer.js";import{EdgePassParameters as G}from"./EdgeShaderParameters.js";import{EdgeWorkerHandle as K}from"./EdgeWorkerHandle.js";import{Transparency as F}from"./interfaces.js";import{generateStrokesTexture as Q}from"./strokes.js";import{determineRendererType as J,determineEdgeTransparency as X,determineObjectTransparency as Y,fillComponenBufferIndices as Z}from"./util.js";import{BufferManager as $}from"../TextureBackedBuffer/BufferManager.js";import{BufferObject as ee}from"../../../../webgl/BufferObject.js";import{Usage as te}from"../../../../webgl/enums.js";let re=class extends t{constructor(e){super(e),this._updatingHandles=new w,this._perObjectData=new Map,this._perObjectDataEvictionCache=new Set,this._renderers=new Map,this._gpuMemoryUsage=0,this._workerAbort=new AbortController,this._tmpModelPosition=O(),this._localOrigins=new S(new M(e.renderSR))}initialize(){this._worker=new K(this.schedule),this._componentColorManager=new $(this.rctx,3);const e=k.createBuffer(4);for(let t=0;t<4;t++)e.sideness.set(t,0,0===t||3===t?0:1),e.sideness.set(t,1,0===t||1===t?0:1);this._verticesBufferObject=ee.createVertex(this.rctx,te.STATIC_DRAW,e.buffer)}destroy(){this.destroyed||(this._perObjectData.forEach((e=>this._discardObjectEntry(e))),this._perObjectData.clear(),this._strokesTexture=i(this._strokesTexture),this._componentColorManager=a(this._componentColorManager),this._workerAbort.abort(),this._worker.destroy(),this._verticesBufferObject=i(this._verticesBufferObject),this._renderers.clear(),this._updatingHandles.destroy())}get updating(){return this._updatingHandles.updating}get usedMemory(){return this._gpuMemoryUsage}shouldRender(){return this._renderers.size>0}async addComponentObject(e,t,r,s,o,n,i,a){if(this.hasObject(e))return this.getObjectMemoryUsage(e);let c;const d=new ne(new Promise((e=>c=e)),r.center,r.radius);this._perObjectData.set(e,d);const l=await this._updatingHandles.addPromise(this._addComponentGeometry(t,d,s,o,n,i,a));return this.setNeedsRender(),c(),l}async addOrUpdateObject3D(e,t,r,s){if(this.destroyed)return void o.getLogger(this.declaredClass).warn("Attempt to add an object to a destroyed instance");const n=this._perObjectData.get(e);let i;n?.renderables.length>0&&this._perObjectDataEvictionCache.add(n);const a=e.boundingVolumeWorldSpace.bounds,c=new ne(new Promise((e=>i=e)),v(a),x(a));this._perObjectData.set(e,c);const d=new Array;if(r.mergeGeometries&&e.geometries.length>1&&oe(e))d.push(this._addObjectMergedGeometries(e,c,t,r,s));else for(let o=0;o<e.geometries.length;o++){const n=e.geometryRecords[o];if(!n.material.supportsEdges)continue;const i=e.geometries[o];d.push(this._addGeometry(e,c,i,n,t[0],r,s))}await this._updatingHandles.addPromise(Promise.all(d)),this._perObjectDataEvictionCache.delete(c),this._discardObjectEntry(n),this.setNeedsRender(),i()}_discardObjectEntry(e){e&&(e.renderables.length&&(e.renderables.forEach((e=>this._removeRenderable(e))),this.setNeedsRender()),e.loaded=null)}hasObject(e){return this._perObjectData.has(e)}async updateAllComponentOpacities(e,t){const r=await this._updatingHandles.addPromise(this._getObjectEntry(e));if(c(r))return;const s=t instanceof Array?e=>t[e]:()=>t;r.renderables.forEach((e=>{const t=e.components.meta.length;for(let r=0;r<t;r++){const t=s(r),o=e.components.meta[r],n=o.index;o.material.opacity=t,e.components.buffer.textureBuffer.setDataElement(n,1,3,255*t)}this._updateTransparency(e)})),this.setNeedsRender()}async getObjectMemoryUsage(e){const t=await this._getObjectEntry(e);return d(t)?t.renderables.reduce(((e,t)=>e+t.statistics.gpuMemoryUsage),0):0}async updateAllComponentMaterials(e,t,r,s){const o=e instanceof D,n=!!r.hasSlicePlane,i=J(t),a=z.getKey(i,n,o),d=await this._updatingHandles.addPromise(this._getObjectEntry(e));c(d)||(d.renderables.forEach((e=>{if(a!==e.rendererKey){const t=this._renderers.get(e.rendererKey),r=this._acquireRenderer(i,n,o);t.removeRenderable(e),--t.refCount,e.rendererKey=a,r.addRenderable(e)}for(let r=0;r<t.length;r++)e.components.meta[r].material=t[r];s&&this._updateComponentBuffer(e.components),this._updateTransparency(e)})),this.setNeedsRender())}async updateAllVerticalOffsets(e,t){const r=await this._updatingHandles.addPromise(this._getObjectEntry(e));c(r)||(r.renderables.forEach((e=>{const r=e.components.meta;for(let s=0;s<r.length;s++)e.components.meta[s].verticalOffset=t?.[s]??0;this._updateComponentBuffer(e.components)})),this.setNeedsRender())}async updateObjectVisibility(e,t){const r=await this._updatingHandles.addPromise(this._getObjectEntry(e));d(r)&&(r.renderables.forEach((e=>e.visible=t)),this.setNeedsRender())}removeObject(e){const t=this._perObjectData.get(e);t&&(this._perObjectData.delete(e),this._discardObjectEntry(t))}async _getObjectEntry(e){const t=this._perObjectData.get(e);if(!t)throw"no object";return await t.loaded,null==t.loaded?null:t}render(e,t){if(c(this._componentColorManager))return;this._localOrigins.updateViewMatrices(e.camera.viewMatrix);const r=e.camera.viewInverseTransposeMatrix,s=O(),o=new C;let n=0,i=0;if(this._renderers.forEach((r=>{if(0===r.refCount)this._renderers.delete(r.key),r.dispose();else{let s=!0,o=!0;r.forEachRenderable((t=>{t.visible&&(n+=t.statistics.averageEdgeLength,i++,s&&t.regular&&(r.updateTechnique(e,!1),s=!1),o&&t.silhouette&&(r.updateTechnique(e,!0),o=!1))}),t)}})),this._componentColorManager.garbageCollect(),this._componentColorManager.updateTextures(),0===i)return;const a=new G(40*n/i,t);_(s,r[3],r[7],r[11]),o.set(s),y(a.transformWorldFromViewTH,o.high),y(a.transformWorldFromViewTL,o.low),u(a.transformViewFromCameraRelativeRS,e.camera.viewMatrix),m(fe,a.transformViewFromCameraRelativeRS),g(a.transformNormalViewFromGlobal,fe),a.transformProjFromView=e.camera.projectionMatrix,this._updateObjectCameraDistances(e),this._renderers.forEach((t=>{this._renderRegularEdges(t,e,a),this._renderSilhouetteEdges(t,e,a)}))}_updateTransparency(e){const t=X(e.components.meta),r=Y(e.components.meta);t===e.edgeTransparency&&r===e.objectTransparency||(e.edgeTransparency=t,e.objectTransparency=r,this._renderers.get(e.rendererKey).setRenderablesDirty())}_computeModelTransformWithLocalOrigin(e,t,r){e.getCombinedStaticTransformation(t,r);const s=d(t.origin)?this._localOrigins.register(t.origin):this._localOrigins.acquire(_(this._tmpModelPosition,r[12],r[13],r[14]));return t.origin=s.origin,P(s.origin.vec3,r),s}_updateComponentBuffer(e){const{meta:t,buffer:r}=e,s=new Uint8Array(4);for(let o=0;o<t.length;o++){const e=t[o].material,i=t[o].index,a=n(Math.round(e.size*W),0,255),c=n(e.extensionLength,-q,255-q)+q,d="solid"===e.type?N.SOLID:N.SKETCH,l=255*e.opacity,h=e.color,u=255*h[0],m=255*h[1],g=255*h[2],p=255*h[3];r.textureBuffer.setData(i,0,u,m,g,p),r.textureBuffer.setData(i,1,a,c,d,l),T(t[o].verticalOffset,s),r.textureBuffer.setData(i,2,s[0],s[1],s[2],s[3])}}_createComponentBuffers(e){if(c(this._componentColorManager))return null;const t=new Array,r=this._componentColorManager.getBuffer(e.length);for(let o=0;o<e.length;o++){const s=e[o],n=r.acquireIndex();t.push({index:n,verticalOffset:0,material:s})}const s=new ie(r,t);return this._updateComponentBuffer(s),s}_extractEdges(e,t,r,s,o,n=o.length){return this._worker.process({data:t,indices:o,indicesLength:n,writerSettings:e,skipDeduplicate:r},this._workerAbort.signal,s)}_createRenderable(e,t,r,s,o){const n=d(this._verticesBufferObject)&&e.regular.lodInfo.lengths.length>0?new ae(new A(this.rctx,I,{vertices:U,instances:V.glLayout},{vertices:this._verticesBufferObject,instances:ee.createVertex(this.rctx,te.STATIC_DRAW,e.regular.instancesData.buffer)}),e.regular.lodInfo):null,i=d(this._verticesBufferObject)&&e.silhouette.lodInfo.lengths.length>0?new ae(new A(this.rctx,I,{vertices:U,instances:H.glLayout},{vertices:this._verticesBufferObject,instances:ee.createVertex(this.rctx,te.STATIC_DRAW,e.silhouette.instancesData.buffer)}),e.silhouette.lodInfo):null,a=(d(n)?n.vao.size:0)+(d(i)?i.vao.size:0);return new de(n,i,{gpuMemoryUsage:a,externalMemoryUsage:o,averageEdgeLength:e.averageEdgeLength},r,X(t.meta),Y(t.meta),t,s)}async _addGeometry(e,t,r,s,o,n,i){const a=r.vertexAttributes.get(B.POSITION),c=r.indices.get(B.POSITION),d=f(),l=this._computeModelTransformWithLocalOrigin(e,s,d),h=new pe(a,c,d,l);return this._addPositionData(t,h,r.edgeIndicesLength,o,n,i)}async _addPositionData(e,t,r,s,o,n=!1){if(null==e.loaded)return;const i=this._createComponentBuffers([s]);if(c(i)||r<=0)return;const a=this._acquireRenderer(s.type,!!o.hasSlicePlane,!0),{modelTransform:d,origin:l}=t,h=t.indices,u=t.position,m=u.data.length/u.size,g=L.createBuffer(m);for(let c=0;c<m;c++)g.position.set(c,0,u.data[c*u.size+0]),g.position.set(c,1,u.data[c*u.size+1]),g.position.set(c,2,u.data[c*u.size+2]);Z(i.meta,[0,g.componentIndex.count],g.componentIndex);const p=await this._updatingHandles.addPromise(this._extractEdges(a.writerSettings,g,!1,n,h,r));if(null==e.loaded)return;const f=this._createRenderable(p,i,new ce(d,l),a.key,!1);e.renderables.push(f),a.addRenderable(f),this._gpuMemoryUsage+=f.statistics.gpuMemoryUsage}async _addComponentGeometry(e,t,r,s,o,n,i){if(null==t.loaded)return 0;const a=this._createComponentBuffers(n);if(c(a))return 0;const d=J(n),l=this._acquireRenderer(d,i.hasSlicePlane||!1,!1),h=L.createBuffer(r.count);R(h.position,r),Z(a.meta,o,h.componentIndex,s);const u=!0,m=l.writerSettings,g=await this._updatingHandles.addPromise(this._extractEdges(m,h,u,!1,s));if(null==t.loaded)return 0;const p=this._createRenderable(g,a,e,l.key,!0);return t.renderables.push(p),l.addRenderable(p),p.statistics.gpuMemoryUsage}async _addObjectMergedGeometries(e,t,r,s,o){const n=new Map;let i=0,a=null,c=0;for(let f=0;f<e.geometries.length;f++){const t=e.geometries[f],r=e.geometryRecords[f];if(!r.material.supportsEdges)continue;!a&&r.origin&&(a=r);const s=t.vertexAttributes.get(B.POSITION);c+=s.data.length/s.size,i+=t.edgeIndicesLength}const d=c>=65536?Uint32Array:Uint16Array,l=i?new d(i):null,h=[];let u=0;for(let f=0;f<e.geometries.length;f++){const t=e.geometries[f];if(!e.geometryRecords[f].material.supportsEdges)continue;const r=t.vertexAttributes.get(B.POSITION),s=t.indices.get(B.POSITION);let o=n.get(r.data);if(null==o){o=h.length/3;for(let e=0;e<r.data.length;e+=r.size)h.push(r.data[e+0]),h.push(r.data[e+1]),h.push(r.data[e+2]);n.set(r.data,o)}if(s)for(let e=0;e<t.edgeIndicesLength;e++)l[u++]=o+s[e]}const m=a||e.geometryRecords[0],g=f(),p=this._computeModelTransformWithLocalOrigin(e,m,g);for(let f=0;f<e.geometryRecords.length;f++)e.geometryRecords[f].origin=p.origin;const _=new pe({data:h,size:3},l,g,p);await this._updatingHandles.addPromise(this._addPositionData(t,_,l.length,r[0],s,o))}_acquireRenderer(e,t,r){const s=z.getKey(e,t,r);let o=this._renderers.get(s);return c(this._strokesTexture)&&(this._strokesTexture=Q(this.rctx)),o||(o=new z(this.rctx,this.techniqueRepository,{type:e,hasSlicePlane:t,strokesTexture:this._strokesTexture,legacy:r,spherical:this.viewingMode===E.Global}),this._renderers.set(s,o)),++o.refCount,o}_removeRenderable(e){se(e);const t=this._renderers.get(e.rendererKey);if(t){t.removeRenderable(e),--t.refCount,"origin"in e.transform&&this._localOrigins.release(e.transform.origin),this._gpuMemoryUsage-=e.statistics.externalMemoryUsage?0:e.statistics.gpuMemoryUsage;for(const t of e.components.meta)e.components.buffer.releaseIndex(t.index)}}_updateObjectCameraDistances(e){const t=e.camera.eye,r=e.camera.viewForward,s=O(),o=e=>{b(s,e.center,t);const o=j(s,r),n=e.radius,i=o<-n?1/0:o<n?0:o-n;e.renderables.forEach((e=>e.distanceToCamera=i))};this._perObjectData.forEach(o),this._perObjectDataEvictionCache.forEach(o)}_renderRegularEdges(e,t,r){const s=e.bindRegularEdges(r,t),o=r.transparency,n=t.camera.perScreenPixelRatio;e.forEachRenderable((o=>{if(!he(o)||!o.visible)return;const i=ge(o.regular.lod.lengths,o.distanceToCamera,n);e.renderRegularEdges(s,o,r,t,i)}),o)}_renderSilhouetteEdges(e,t,r){const s=e.bindSilhouetteEdges(r,t),o=r.transparency,n=t.camera.perScreenPixelRatio;e.forEachRenderable((o=>{if(!me(o)||!o.visible)return;const i=ge(o.silhouette.lod.lengths,o.distanceToCamera,n);e.renderSilhouetteEdges(s,o,r,t,i)}),o)}get test(){return{hasRenderedPrimitives:e=>{let t=!1;const r=e.perScreenPixelRatio,s=(e,s)=>e.forEachRenderable((e=>{e.visible&&!t&&(he(e)&&(t=ge(e.regular.lod.lengths,e.distanceToCamera,r)>0),!t&&me(e)&&(t=ge(e.silhouette.lod.lengths,e.distanceToCamera,r)>0))}),s);return this._renderers.forEach((e=>{t||(s(e,F.OPAQUE),s(e,F.TRANSPARENT))})),t}}}};function se(e){d(e.regular)&&(e.regular.vao.vertexBuffers.instances.dispose(),e.regular.vao.dispose(!1),e.regular.vao=null),d(e.silhouette)&&(e.silhouette.vao.vertexBuffers.instances.dispose(),e.silhouette.vao.dispose(!1),e.silhouette.vao=null)}function oe(e){let t=null,s=null;for(let o=0;o<e.geometries.length;o++){const n=e.geometryRecords[o];if(n.material.supportsEdges){if(t){if(!r(t,n.transformation))return!1}else t=n.transformation;if(!s&&d(n.origin))s=n;else if(d(s?.origin)&&d(n.origin)&&s.origin.id!==n.origin.id)return!1}}return!0}e([l({constructOnly:!0})],re.prototype,"rctx",void 0),e([l({constructOnly:!0})],re.prototype,"renderSR",void 0),e([l({constructOnly:!0})],re.prototype,"viewingMode",void 0),e([l({constructOnly:!0})],re.prototype,"techniqueRepository",void 0),e([l({constructOnly:!0})],re.prototype,"setNeedsRender",void 0),e([l({constructOnly:!0})],re.prototype,"schedule",void 0),e([l({readOnly:!0})],re.prototype,"_updatingHandles",void 0),e([l({readOnly:!0})],re.prototype,"updating",null),re=e([h("esri.views.3d.webgl-engine.lib.edgeRendering.EdgeView")],re);class ne{constructor(e,t,r){this.center=t,this.radius=r,this.renderables=new Array,this.loaded=e,this.loaded.then((()=>{null!=this.loaded&&(this.loaded=!0)}))}}class ie{constructor(e,t){this.buffer=e,this.meta=t}}class ae{constructor(e,t){this.vao=e,this.lod=t}}class ce{constructor(e,t){this.modelMatrix=e,this.origin=t}}class de{constructor(e,t,r,s,o,n,i,a){this.regular=e,this.silhouette=t,this.statistics=r,this.transform=s,this.edgeTransparency=o,this.objectTransparency=n,this.components=i,this.rendererKey=a,this.distanceToCamera=0,this.visible=!0}}class le extends de{}function he(e){return d(e.regular)}class ue extends de{}function me(e){return d(e.silhouette)}function ge(e,t,r){const o=t*r,n=s(e,o,!0);return-1===n?o<e[0]?e.length:0:e.length-n}class pe{constructor(e,t,r,s){this.position=e,this.indices=t,this.modelTransform=r,this.origin=s}}const fe=p();export{re as EdgeView,ce as LegacyTransform,le as RegularRenderable,de as Renderable,ue as SilhouetteRenderable};
