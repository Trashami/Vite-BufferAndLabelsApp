/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.25/esri/copyright.txt for details.
*/
import{releaseMaybe as e}from"../../../../../core/maybe.js";import r from"../../../../../core/PooledArray.js";import{t,e as i}from"../../../../../chunks/mat3.js";import{c as s}from"../../../../../chunks/mat3f32.js";import{s as n}from"../../../../../chunks/vec3.js";import a from"../../../support/debugFlags.js";import{doublePrecisionRequiresObfuscation as o}from"../../core/shaderLibrary/util/DoublePrecision.glsl.js";import{TwoVectorPosition as d}from"../../core/util/TwoVectorPosition.js";import{EdgeDrawParameters as h}from"./EdgeShaderParameters.js";import{EdgeShaderTechnique as l}from"./EdgeShaderTechnique.js";import{EdgeShaderTechniqueConfiguration as c}from"./EdgeShaderTechniqueConfiguration.js";import{Transparency as u}from"./interfaces.js";import{EdgeUtilMode as _}from"../../shaders/sources/edgeRenderer/EdgeUtil.glsl.js";import{PrimitiveType as m}from"../../../../webgl/enums.js";const g=8,f=128,b={type:"uber",hasSlicePlane:!1,strokesTexture:null,legacy:!0,spherical:!0},T={solid:_.SOLID,sketch:_.SKETCH,uber:_.MIXED};class R{constructor(e,t,i){this._rctx=e,this._shaderTechniqueRepository=t,this._configuration=new c,this.refCount=0,this._renderables=new Set,this._sortedRenderables={[u.TRANSPARENT]:{[u.TRANSPARENT]:new r,[u.OPAQUE]:new r},[u.OPAQUE]:{[u.TRANSPARENT]:new r,[u.OPAQUE]:new r}},this._renderablesDirty=!1,this._drawParameters=new h,this._settings={...b,...i},this.key=R.getKey(this._settings.type,this._settings.hasSlicePlane,this._settings.legacy);const s=this._settings.strokesTexture.variants;this.writerSettings={variants:s,reducedPrecision:a.TESTS_DISABLE_OPTIMIZATIONS},this._configuration.legacy=this._settings.legacy,this._configuration.mode=T[this._settings.type],this._configuration.silhouette=!1,this._configuration.antialiasing=!!this._rctx.capabilities.blendMinMax,this._configuration.hasSlicePlane=this._settings.hasSlicePlane,this._configuration.doublePrecisionRequiresObfuscation=o(e),this._configuration.spherical=i.spherical}dispose(){this._technique=e(this._technique)}addRenderable(e){this._renderables.add(e),this._renderablesDirty=!0}removeRenderable(e){this._renderables.delete(e),this._renderablesDirty=!0}setRenderablesDirty(){this._renderablesDirty=!0}forEachRenderable(e,r){this._renderablesDirty&&this._sortRenderables(),this._sortedRenderables[r][u.TRANSPARENT].forAll(e),this._sortedRenderables[r][u.OPAQUE].forAll(e)}updateTechnique(e,r){return this._configuration.hasMultipassTerrain=!!e.multipassTerrain.enabled,this._configuration.cullAboveGround=!!e.multipassTerrain.cullAboveGround,this._configuration.silhouette=r,this._technique=this._shaderTechniqueRepository.releaseAndAcquire(l,this._configuration,this._technique),this._technique}bindRegularEdges(e,r){return this._lastOriginId=null,this._rctx.bindTechnique(this.updateTechnique(r,!1),e,r)}bindSilhouetteEdges(e,r){return this._lastOriginId=null,this._rctx.bindTechnique(this.updateTechnique(r,!0),e,r)}renderRegularEdges(e,r,t,i,s){this._render(e,r,r.regular.vao,t,i,s)}renderSilhouetteEdges(e,r,t,i,s){this._render(e,r,r.silhouette.vao,t,i,s)}_render(e,r,t,i,s,n){n>0&&(this._bindDraw(e,r,i,s),this._rctx.bindVAO(t),this._rctx.capabilities.instancing.drawArraysInstanced(m.TRIANGLE_FAN,0,4,n))}_bindDraw(e,r,s,a){if(this._drawParameters.componentDataTexture=r.components.buffer.textureBuffer.texture,this._drawParameters.strokesTexture=this._settings.strokesTexture,"origin"in r.transform)this._lastOriginId!==r.transform.origin.origin.id&&(e.setUniformMatrix4fv("localView",r.transform.origin.viewMatrix),this._lastOriginId=r.transform.origin.origin.id),e.setUniformMatrix4fv("model",r.transform.modelMatrix),this._drawParameters.slicePlaneLocalOrigin=r.transform.origin.origin.vec3;else{const e=new d(r.transform.position),s=t(A,i(A,r.transform.rotationScale));this._drawParameters.transformWorldFromModelTL=e.low,this._drawParameters.transformWorldFromModelTH=e.high,this._drawParameters.transformWorldFromModelRS=r.transform.rotationScale,this._drawParameters.transformNormalGlobalFromModel=s;const o=a.camera.viewInverseTransposeMatrix;n(this._drawParameters.slicePlaneLocalOrigin,o[3],o[7],o[11])}e.bindDraw(this._drawParameters,a,s)}_sortRenderables(){this._renderablesDirty=!1,this._sortedRenderables[u.TRANSPARENT][u.TRANSPARENT].clear(),this._sortedRenderables[u.TRANSPARENT][u.OPAQUE].clear(),this._sortedRenderables[u.OPAQUE][u.TRANSPARENT].clear(),this._sortedRenderables[u.OPAQUE][u.OPAQUE].clear(),this._renderables.forEach((e=>{e.objectTransparency!==u.INVISIBLE&&e.edgeTransparency!==u.INVISIBLE&&this._sortedRenderables[e.objectTransparency][e.edgeTransparency].push(e)}));const e=(e,r)=>"origin"in e.transform?"origin"in r.transform?e.transform.origin.origin.id<r.transform.origin.origin.id?-1:e.transform.origin.origin.id>r.transform.origin.origin.id?1:0:1:0;this._sortedRenderables[u.TRANSPARENT][u.TRANSPARENT].sort(e),this._sortedRenderables[u.TRANSPARENT][u.OPAQUE].sort(e),this._sortedRenderables[u.OPAQUE][u.TRANSPARENT].sort(e),this._sortedRenderables[u.OPAQUE][u.OPAQUE].sort(e)}static getKey(e,r,t){return`edges-t:${e}:${r}:${t}`}}const A=s();export{f as EXTENSION_LENGTH_OFFSET,R as EdgeRenderer,g as LINE_WIDTH_FRACTION_FACTOR};
