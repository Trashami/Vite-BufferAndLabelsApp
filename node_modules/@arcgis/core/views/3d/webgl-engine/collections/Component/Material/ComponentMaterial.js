/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.25/esri/copyright.txt for details.
*/
import{_ as e}from"../../../../../../chunks/tslib.es6.js";import{releaseMaybe as t,isSome as r,isNone as s}from"../../../../../../core/maybe.js";import{e as o,t as a}from"../../../../../../chunks/mat3.js";import{a as i}from"../../../../../../chunks/mat3f32.js";import{G as n}from"../../../../../../chunks/vec3.js";import{f as l}from"../../../../../../chunks/vec3f32.js";import{v as h}from"../../../../../../chunks/vec4.js";import{f as u}from"../../../../../../chunks/vec4f32.js";import{ColorMixModeEnum as p}from"../../../../layers/support/symbolColorUtils.js";import c from"../../../../support/debugFlags.js";import{OverlayIndex as d,RenderTargetType as m}from"../../../../terrain/interfaces.js";import{ComponentTechnique as g}from"./ComponentTechnique.js";import{ComponentTechniqueConfiguration as y,IntegratedMeshMode as T}from"./ComponentTechniqueConfiguration.js";import{ComponentDataType as x}from"./shader/ComponentData.glsl.js";import{g as b}from"../../../../../../chunks/ComponentShader.glsl.js";import{VertexDiscardMode as f}from"./shader/VertexDiscardByOpacity.glsl.js";import{MaterialBase as v,parameter as M,parameterBlock as C,MaterialParameterBlock as O}from"../../../core/material/MaterialBase.js";import{RenderPassIdentifier as w,MaterialSubPass as P}from"../../../core/renderPasses/AllRenderPasses.js";import{ShaderOutput as S}from"../../../core/shaderLibrary/ShaderOutput.js";import{NormalAttributeType as A}from"../../../core/shaderLibrary/attributes/NormalAttribute.glsl.js";import{NormalsDoubleSidedMode as N}from"../../../core/shaderLibrary/shading/Normals.glsl.js";import{PBRMode as j}from"../../../core/shaderLibrary/shading/PhysicallyBasedRenderingParameters.glsl.js";import{defaultMaskAlphaCutoff as q}from"../../../core/shaderLibrary/util/AlphaCutoff.js";import{EllipsoidMode as D}from"../../../core/shaderLibrary/util/EllipsoidMode.js";import{TwoVectorPosition as R}from"../../../core/util/TwoVectorPosition.js";import{AlphaDiscardMode as I,CullFaceOptions as F}from"../../../lib/basicInterfaces.js";import{TransparencyPassType as _}from"../../../lib/TransparencyPassType.js";class E extends v{constructor(e,t){super(),this.toMapSpace=t,this.baseColor=u(1,1,1,1),this.usePBR=!1,this.hasParametersFromSource=!1,this.mrrFactors=l(1,1,.5),this.emissiveFactor=l(0,0,0),this.baseColorTexture=null,this.metallicRoughnessTexture=null,this.emissionTexture=null,this.occlusionTexture=null,this.normalTexture=null,this.objectOpacity=1,this.commonMaterialParameters=new W,this.componentParameters=new B,this.textureAlphaCutoff=q,this.alphaDiscardMode=I.Opaque,this.isIntegratedMesh=!1,this.polygonOffsetEnabled=!1,this.ellipsoidMode=D.Earth,this.hasOccludees=!1,this._techniqueConfiguration=new y;const r=new R(e.position),s=i(e.rotationScale);o(s,s),this.transformNormalGlobalFromModel=a(s,s),this.transformWorldFromModelTL=r.low,this.transformWorldFromModelTH=r.high,this.transformWorldFromModelRS=e.rotationScale}dispose(){this._technique=t(this._technique),this.baseColorTexture=null,this.metallicRoughnessTexture=null,this.emissionTexture=null,this.occlusionTexture=null,this.normalTexture=null}get texture(){return r(this.baseColorTexture)?this.baseColorTexture.glTexture:null}get textureMetallicRoughness(){return r(this.metallicRoughnessTexture)?this.metallicRoughnessTexture.glTexture:null}get textureEmissive(){return r(this.emissionTexture)?this.emissionTexture.glTexture:null}get textureOcclusion(){return r(this.occlusionTexture)?this.occlusionTexture.glTexture:null}get textureNormal(){return r(this.normalTexture)?this.normalTexture.glTexture:null}prepareTechnique(e,t,o,a){const i=this._techniqueConfiguration;i.hasVertexColors=a.colors,i.hasNormals=a.normals,i.textureCoordinateType=a.textureCoordinates,i.hasMetallicRoughnessTexture=r(this.metallicRoughnessTexture),i.hasEmissionTexture=r(this.emissionTexture),i.hasOcclusionTexture=r(this.occlusionTexture),i.hasNormalTexture=r(this.normalTexture),i.transparencyPassType=t.identifier===w.Material&&null!=o.transparencyPassType?o.transparencyPassType:_.NONE,i.hasMultipassTerrain=t.identifier===w.Material&&null!=o.multipassTerrain&&o.multipassTerrain.enabled,i.cullAboveGround=t.identifier===w.Material&&null!=o.multipassTerrain&&o.multipassTerrain.cullAboveGround,i.ellipsoidMode=this.ellipsoidMode,i.componentData=this.componentParameters.type,i.cullFace=this.commonMaterialParameters.cullFace,i.doubleSidedMode=this.commonMaterialParameters.doubleSided?N.View:N.None,i.hasBaseColorTexture=r(this.baseColorTexture);const n=this._computeWhichMaterialPass();i.blendingEnabled=n===k.Transparent||n===k.OpaqueAndTransparent,i.alphaDiscardMode=this.alphaDiscardMode,i.integratedMeshMode=this.isIntegratedMesh?U(o)?b(o)?T.ColorOverlayWithWater:T.ColorOverlay:T.NoOverlay:T.None,i.useLegacyTerrainShading=this.isIntegratedMesh&&c.TERRAIN_USE_LEGACY_SHADING,i.hasPolygonOffset=this.polygonOffsetEnabled;const l=this.hasParametersFromSource&&s(this.baseColorTexture);return i.pbrMode=i.integratedMeshMode===T.ColorOverlayWithWater?j.WaterOnIntegratedMesh:this.usePBR?l?j.Schematic:j.Normal:j.Disabled,i.normalType=i.integratedMeshMode===T.None?i.hasNormals?A.CompressedAttribute:A.ScreenDerivative:A.Ground,i.hasSlicePlane=r(o.slicePlane)&&this.commonMaterialParameters.hasSlicePlane,t.identifier===w.ShadowMap?(i.output=S.Shadow,i.vertexDiscardMode=f.None):t.identifier===w.Highlight?(i.output=S.Highlight,i.vertexDiscardMode=f.None):(this._computeWhichMaterialPass()===k.OpaqueAndTransparent?i.vertexDiscardMode=t.transparent?f.Opaque:f.Transparent:i.vertexDiscardMode=f.None,i.output=V(t.subPass),t.subPass===P.Alpha&&(i.hasOccludees=o.hasOccludees),t.subPass===P.Color?(i.receiveAmbientOcclusion=o.ssaoHelper.ready,i.hasOccludees=o.hasOccludees,i.receiveShadows=o.shadowMap.ready,i.hasScreenSpaceReflections=o.ssr.enabled,i.hasCloudsReflections=r(o.cloudsFade.data)):(i.receiveAmbientOcclusion=!1,i.receiveShadows=!1),i.snowCover=this.hasSnowCover(o),t.subPass===P.ObjectAndLayerIdColor&&(i.objectAndLayerIdColor=!0)),this._technique=e.releaseAndAcquire(g,i,this._technique),this._setClean(),this._technique}hasSnowCover(e){return r(e.weather)&&e.weatherVisible&&"snowy"===e.weather.type&&"enabled"===e.weather.snowCover}submit(e,t,s){if(0===this.objectOpacity)return;const o=s.renderable.geometry,a=s.components,i=s.renderable.meta.cameraDepthSquared,n=a.geometryRanges,l=a.highlightRanges,h=a.defaultShadowMapRanges;switch(this._computeWhichMaterialPass()){case k.Opaque:e.materialOpaque.submitDraw(this,o,n,i);break;case k.Transparent:e.materialTransparent.submitDraw(this,o,n,i);break;case k.OpaqueAndTransparent:e.materialOpaque.submitDraw(this,o,n,i),e.materialTransparent.submitDraw(this,o,n,i);break;case k.IntegratedMesh:e.materialIntegratedMesh.submitDraw(this,o,n,i),H(t)&&e.highlightIntegratedMesh.submitDraw(this,o,n,i)}const u=this.componentParameters.castShadows!==L.None;u&&e.shadowMap.submitDraw(this,o,n,i),r(l)&&(e.highlight.submitDraw(this,o,l,i),u&&e.highlightShadowMap.submitDraw(this,o,l,i)),u&&r(h)&&e.defaultShadowMap.submitDraw(this,o,h,i)}_computeWhichMaterialPass(){return this.isIntegratedMesh?k.IntegratedMesh:this.objectOpacity<1?k.Transparent:this.componentParameters.opaqueOverride===L.All?k.Opaque:this.baseColor[3]<1||this.alphaDiscardMode===I.Blend||this.alphaDiscardMode===I.MaskBlend?k.Transparent:this.componentParameters.transparent===L.None?k.Opaque:this.componentParameters.transparent===L.All?k.Transparent:k.OpaqueAndTransparent}}var k,L;e([M({vectorOps:h})],E.prototype,"baseColor",void 0),e([M()],E.prototype,"usePBR",void 0),e([M()],E.prototype,"hasParametersFromSource",void 0),e([M({vectorOps:n})],E.prototype,"mrrFactors",void 0),e([M({vectorOps:n})],E.prototype,"emissiveFactor",void 0),e([M({dispose:!0})],E.prototype,"baseColorTexture",void 0),e([M({dispose:!0})],E.prototype,"metallicRoughnessTexture",void 0),e([M({dispose:!0})],E.prototype,"emissionTexture",void 0),e([M({dispose:!0})],E.prototype,"occlusionTexture",void 0),e([M({dispose:!0})],E.prototype,"normalTexture",void 0),e([M()],E.prototype,"objectOpacity",void 0),e([C()],E.prototype,"commonMaterialParameters",void 0),e([C()],E.prototype,"componentParameters",void 0),e([M()],E.prototype,"textureAlphaCutoff",void 0),e([M()],E.prototype,"alphaDiscardMode",void 0),e([M()],E.prototype,"isIntegratedMesh",void 0),e([M()],E.prototype,"polygonOffsetEnabled",void 0),e([M()],E.prototype,"ellipsoidMode",void 0),e([M()],E.prototype,"hasOccludees",void 0),function(e){e[e.Opaque=0]="Opaque",e[e.Transparent=1]="Transparent",e[e.OpaqueAndTransparent=2]="OpaqueAndTransparent",e[e.IntegratedMesh=3]="IntegratedMesh"}(k||(k={}));class W extends O{constructor(){super(...arguments),this.doubleSided=!1,this.cullFace=F.Back,this.hasSlicePlane=!0}}e([M()],W.prototype,"doubleSided",void 0),e([M()],W.prototype,"cullFace",void 0),e([M()],W.prototype,"hasSlicePlane",void 0);class B extends O{constructor(){super(...arguments),this.externalColor=u(1,1,1,1),this.externalColorMixMode=p.Multiply,this.castShadows=L.All}get transparent(){return this.externalColor[3]<1?L.All:L.None}get opaqueOverride(){return this.externalColorMixMode===p.Replace&&1===this.externalColor[3]?L.All:L.None}get visible(){return this.externalColor[3]>0?L.All:L.None}get type(){return x.Uniform}}e([M({vectorOps:h})],B.prototype,"externalColor",void 0),e([M()],B.prototype,"externalColorMixMode",void 0),e([M()],B.prototype,"castShadows",void 0),function(e){e[e.All=0]="All",e[e.Some=1]="Some",e[e.None=2]="None"}(L||(L={}));class G extends O{constructor(){super(...arguments),this.texture=null,this.transparent=L.None,this.opaqueOverride=L.None,this.castShadows=L.None}get type(){return x.Varying}}function V(e){switch(e){case P.Color:return S.Color;case P.Alpha:return S.Alpha;case P.Depth:return S.Depth;case P.Normal:return S.Normal;case P.ObjectAndLayerIdColor:return S.ObjectAndLayerIdColor}}function H(e){return 0!==e.overlays.length&&r(e.overlays[d.INNER].getValidTexture(m.Highlight))}function U(e){return 0!==e.overlays.length&&r(e.overlays[d.INNER].getColorTextureNoRasterImage())}e([M()],G.prototype,"texture",void 0),e([M()],G.prototype,"transparent",void 0),e([M()],G.prototype,"opaqueOverride",void 0),e([M()],G.prototype,"castShadows",void 0);export{W as CommonMaterialParameters,E as ComponentMaterial,L as ComponentParameterSummary,B as ComponentParametersUniform,G as ComponentParametersVarying};
