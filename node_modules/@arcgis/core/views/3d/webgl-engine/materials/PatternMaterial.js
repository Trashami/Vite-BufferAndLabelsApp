/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.25/esri/copyright.txt for details.
*/
import{f as t}from"../../../../chunks/vec4f64.js";import{BufferViewMat3f as e,BufferViewVec4f as r,BufferViewVec4u8 as i,BufferViewVec3f as s}from"../../../../geometry/support/buffer/BufferView.js";import{newLayout as a}from"../../support/buffer/InterleavedLayout.js";import{ShaderOutput as o}from"../core/shaderLibrary/ShaderOutput.js";import{CullFaceOptions as n}from"../lib/basicInterfaces.js";import c from"../lib/GLMaterial.js";import{Material as h,MaterialParameters as l}from"../lib/Material.js";import{OITPolygonOffsetLimit as u}from"../lib/OrderIndependentTransparency.js";import{RenderSlot as p}from"../lib/RenderSlot.js";import{assert as f}from"../lib/Util.js";import{VertexAttribute as m}from"../lib/VertexAttribute.js";import{Style as d}from"./PatternStyle.js";import{writeBufferVec4 as g,writeColor as _,writePosition as A}from"./internal/bufferWriterUtils.js";import{DefaultBufferWriter as b}from"./internal/DefaultBufferWriter.js";import{intersectTriangleGeometry as O}from"./internal/MaterialUtil.js";import{vertexAttributeLocations as T,PatternTechniqueConfiguration as P,PatternTechnique as S}from"../shaders/PatternTechnique.js";class y extends h{constructor(t){super(t,new j),this.supportsEdges=!0,this._vertexAttributeLocations=T,this._configuration=new P}getConfiguration(t,e){return this._configuration.output=t,this._configuration.cullFace=this.parameters.cullFace,this._configuration.hasVertexColors=this.parameters.hasVertexColors,this._configuration.hasSlicePlane=this.parameters.hasSlicePlane,this._configuration.polygonOffset=this.parameters.polygonOffset,this._configuration.writeDepth=this.parameters.writeDepth,this._configuration.style=this.parameters.style,this._configuration.patternSpacing=this.parameters.patternSpacing,this._configuration.lineWidth=this.parameters.lineWidth,this._configuration.draped=this.parameters.draped,this._configuration.transparencyPassType=e.transparencyPassType,this._configuration.enableOffset=e.camera.relativeElevation<u,this._configuration.hasMultipassTerrain=e.multipassTerrain.enabled,this._configuration.cullAboveGround=e.multipassTerrain.cullAboveGround,this._configuration}intersect(t,e,r,i,s,a,o){O(t,e,i,s,a,void 0,o)}requiresSlot(t,e){if(e===o.Color||e===o.Alpha||e===o.Highlight||e===o.Depth&&this.parameters.writeLinearDepth){if(t===p.DRAPED_MATERIAL)return!0;if(e===o.Highlight)return t===p.OPAQUE_MATERIAL;return t===(this.parameters.writeDepth?p.TRANSPARENT_MATERIAL:p.TRANSPARENT_DEPTH_WRITE_DISABLED_MATERIAL)}return!1}createGLMaterial(t){return new E(t)}createBufferWriter(){const t=a().vec3f(m.POSITION).vec4u8(m.COLOR).vec4f(m.UVMAPSPACE);return this.parameters.draped||t.mat3f(m.BOUNDINGRECT),new R(t)}}class E extends c{_updateParameters(t){return this.ensureTechnique(S,t)}_updateOccludeeState(t){t.hasOccludees!==this._material.parameters.hasOccludees&&this._material.setParameters({hasOccludees:t.hasOccludees})}beginSlot(t){return this._output!==o.Color&&this._output!==o.Alpha||this._updateOccludeeState(t),this._updateParameters(t)}}class R extends b{write(t,a,o,n,c){for(const h of this.vertexBufferLayout.fieldNames){const a=o.vertexAttributes.get(h),l=o.indices.get(h);if(a&&l)switch(h){case m.POSITION:{f(3===a.size);const e=n.getField(h,s);e&&A(l,a.data,t,e,c);break}case m.COLOR:{f(3===a.size||4===a.size);const t=n.getField(h,i);t&&_(l,a.data,a.size,t,c);break}case m.UVMAPSPACE:{f(4===a.size);const t=n.getField(h,r);t&&g(l,a.data,t,c);break}case m.BOUNDINGRECT:{f(9===a.size);const r=n.getField(h,e);r&&this.writeBoundingRect(l,a.data,t,r,c);break}}}}writeBoundingRect(t,e,r,i,s){const a=r,o=i.typedBuffer,n=i.typedBufferStride,c=t.length;s*=n;for(let h=0;h<c;++h){const r=9*t[h],i=e[r],c=e[r+1],l=e[r+2];o[s]=a[0]*i+a[4]*c+a[8]*l+a[12],o[s+1]=a[1]*i+a[5]*c+a[9]*l+a[13],o[s+2]=a[2]*i+a[6]*c+a[10]*l+a[14];for(let t=3;t<9;++t)o[s+t]=e[r+t];s+=n}}}class j extends l{constructor(){super(...arguments),this.color=t(1,1,1,1),this.writeDepth=!0,this.writeLinearDepth=!1,this.hasVertexColors=!1,this.polygonOffset=!1,this.hasSlicePlane=!1,this.cullFace=n.None,this.hasOccludees=!1,this.style=d.Cross,this.patternSpacing=10,this.lineWidth=1,this.draped=!0}}export{j as Parameters,y as PatternMaterial};
