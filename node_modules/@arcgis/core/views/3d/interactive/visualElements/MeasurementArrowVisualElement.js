/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.25/esri/copyright.txt for details.
*/
import e from"../../../../Color.js";import{getAccentColor as r,getContrastColor as t}from"../../../../core/analysisThemeUtils.js";import s from"../../../../core/Handles.js";import{applyOpacity as i}from"../../../../core/mathUtils.js";import{isNone as o,isSome as a}from"../../../../core/maybe.js";import{watch as n}from"../../../../core/reactiveUtils.js";import{c as h}from"../../../../chunks/mat4f64.js";import{b as l}from"../../../../chunks/vec3.js";import{c as d}from"../../../../chunks/vec3f64.js";import{c}from"../../../../chunks/vec4f64.js";import{sv3d as p}from"../../../../geometry/support/vectorStacks.js";import{Object3DVisualElement as m}from"./Object3DVisualElement.js";import{createPolylineGeometry as _}from"../../webgl-engine/lib/GeometryUtil.js";import{RenderOccludedFlag as w}from"../../webgl-engine/lib/Material.js";import{MeasurementArrowMaterial as g}from"../../webgl-engine/materials/MeasurementArrowMaterial.js";class u extends m{constructor(s){super(s),this._parameters={arrowWidth:16,arrowOutlineColor:e.toUnitRGBA(r()),arrowStripeEvenColor:e.toUnitRGBA(t()),arrowStripeOddColor:e.toUnitRGBA(r()),arrowSubdivisions:128},this._handles=null,this._origin=d(),this._originTransform=h(),this._arrowCenter=d(),this._renderOccluded=w.OccludeAndTransparent,this._geometry=null,this._stripeLength=1,this._stripesEnabled=!0,this._opacity=1,this.applyProps(s)}get renderOccluded(){return this._renderOccluded}set renderOccluded(e){e!==this._renderOccluded&&(this._renderOccluded=e,this._arrowMaterial&&this._arrowMaterial.setParameters({renderOccluded:e}))}get geometry(){return this._geometry}set geometry(e){this._geometry=e,this._geometryChanged()}get stripeLength(){return this._stripeLength}set stripeLength(e){this._stripeLength=e,this.attached&&this._arrowMaterial.setParameters({stripeLength:this._stripeLength})}get stripesEnabled(){return this._stripesEnabled}set stripesEnabled(e){if(this._stripesEnabled=e,this.attached){const e=this.opacity,{arrowStripeEvenColor:r,arrowStripeOddColor:t}=this._parameters,s=i(y,this._stripesEnabled?r:t,e);this._arrowMaterial.setParameters({stripeEvenColor:s})}}get opacity(){return this._opacity}set opacity(e){e!==this._opacity&&(this._opacity=e,this._updateArrowOpacity())}createExternalResources(){const{arrowStripeEvenColor:e,arrowStripeOddColor:r,arrowOutlineColor:t}=this._parameters,i=this._stripesEnabled?e:r;this._arrowMaterial=new g({outlineColor:t,stripeEvenColor:i,stripeOddColor:r,renderOccluded:this.renderOccluded,polygonOffset:!0}),this._handles=new s,this._handles.add(n((()=>this.view.state.camera),(()=>{this._viewChanged()})))}destroyExternalResources(){this._arrowMaterial=null,this._handles.destroy(),this._handles=null}forEachExternalMaterial(e){e(this._arrowMaterial)}createGeometries(e){if(o(this._geometry)||o(this._geometry.startRenderSpace)||o(this._geometry.endRenderSpace))return;const r=this._createArrowGeometry(this._geometry.startRenderSpace,this._geometry.endRenderSpace,this._origin,this._geometry);e.addGeometry(r,this._arrowMaterial,this._originTransform),this._viewChanged()}_createArrowGeometry(e,r,t,s){const i=this.view.renderCoordsHelper,o=[],a=[],n=(e,r)=>{const s=p.get();l(s,e,t),o.push(s),a.push(r)};if("euclidean"===s.type){s.eval(.5,this._arrowCenter);const t=p.get();i.worldUpAtPosition(this._arrowCenter,t),n(e,t),n(r,t)}else{s.eval(.5,this._arrowCenter);const e=this._parameters.arrowSubdivisions+1&-2;for(let r=0;r<e;++r){const t=r/(e-1),o=p.get(),a=p.get();s.eval(t,o),i.worldUpAtPosition(o,a),n(o,a)}}return _(o,a)}_geometryChanged(){this.recreateGeometry()}_viewChanged(){if(this.view.ready&&this.attached&&a(this._geometry)){const e=this.view.state.camera.computeScreenPixelSizeAt(this._arrowCenter);this._arrowMaterial.setParameters({width:this._parameters.arrowWidth*e})}}_updateArrowOpacity(){const e=this.opacity,{arrowStripeEvenColor:r,arrowStripeOddColor:t,arrowOutlineColor:s}=this._parameters,o=i(y,this._stripesEnabled?r:t,e),a=i(C,s,e),n=i(f,t,e);this._arrowMaterial.setParameters({stripeEvenColor:o,outlineColor:a,stripeOddColor:n})}}const y=c(),C=c(),f=c();export{u as MeasurementArrowVisualElement};
