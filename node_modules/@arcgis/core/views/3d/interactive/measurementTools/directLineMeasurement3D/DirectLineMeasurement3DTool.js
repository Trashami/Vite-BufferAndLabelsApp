/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.25/esri/copyright.txt for details.
*/
import{_ as t}from"../../../../../chunks/tslib.es6.js";import"../../../../../geometry.js";import e from"../../../../../core/Handles.js";import{destroyMaybe as i,isNone as s,isSome as n,unwrapOr as a,unwrap as r}from"../../../../../core/maybe.js";import{watch as o,syncAndInitial as l}from"../../../../../core/reactiveUtils.js";import{screenPointObjectToArray as c}from"../../../../../core/screenUtils.js";import{property as h}from"../../../../../core/accessorSupport/decorators/property.js";import"../../../../../core/arrayUtils.js";import"../../../../../core/accessorSupport/ensureType.js";import{subclass as u}from"../../../../../core/accessorSupport/decorators/subclass.js";import{c as p}from"../../../../../chunks/vec3f64.js";import{clonePoint as d}from"../../../../../layers/graphics/hydratedFeatures.js";import{isPrimaryPointerAction as m}from"../../../analysis/support/measurementUtils.js";import{SurfaceType as y,screenToMap3D as v,hideManipulatorWhileDragging as P}from"../../editingTools/dragEventPipeline3D.js";import{DirectLineMeasurement3DView as w}from"./DirectLineMeasurement3DView.js";import{PickRequest as _,PickResult as f}from"../support/PickRequest.js";import{getElevationAtPoint as g}from"../../../support/ElevationProvider.js";import{newIntersector as M}from"../../../webgl-engine/lib/Intersector.js";import{StoreResults as b}from"../../../webgl-engine/lib/IntersectorInterfaces.js";import{AnalysisToolBase as S}from"../../../../interactive/AnalysisToolBase.js";import{createManipulatorDragEventPipeline as j,resetProperties as k}from"../../../../interactive/dragEventPipeline.js";import{createScreenPointFromEvent as D}from"../../../../support/screenUtils.js";import R from"../../../../../geometry/Point.js";let T=class extends S{constructor(t){super(t),this._handles=new e,this._cachedPickRequest=null,this._isAnyPointerDown=!1,this.lineState="initial",this.analysisViewData=null,this.startPointSurfaceLocation=null,this.endPointSurfaceLocation=null,this.startManipulator=null,this.endManipulator=null}initialize(){const{view:t,analysis:e,analysisViewData:i,cursorPoint:s,visible:n}=this;this.measurementView=new w({toolState:this,view:t,analysis:e,analysisViewData:i,cursorPoint:s,visible:n}),this._intersector=M(this.view.state.viewingMode),this._intersector.options.store=b.MIN;const{start:a,end:c}=this.measurementView.createManipulators(),h=(t,e,i)=>j(t,((t,s,n)=>{const a=P(t);s.next(a).next(v(this.view)).next((t=>"start"!==t.action?t:null)).next((s=>{const n=d(s.mapEnd,new R);this.analysis[e]=n,t.location=n,this[i]=this._surfaceLocation(n,s.surfaceType)})),n.next(a).next(k(this.analysis,[e])).next(k(this,[i])).next((()=>{t.location=r(this.analysis[e])}))})),u=t=>t.events.on("grab-changed",(()=>{const t=a.grabbing||c.grabbing;this.lineState=t?"editing":"measured"}));this._handles.add([h(a,"startPoint","startPointSurfaceLocation"),h(c,"endPoint","endPointSurfaceLocation"),u(a),u(c)]),this.manipulators.add(a),this.manipulators.add(c),this.startManipulator=a,this.endManipulator=c,this._handles.add(o((()=>this.state),(t=>{"measured"===t&&this.finishToolCreation()}),l))}destroy(){this.measurementView=i(this.measurementView),this._handles=i(this._handles)}get state(){return s(this.analysis.startPoint)&&s(this.analysis.endPoint)?"ready":this.validMeasurement&&"editing"!==this.lineState&&"drawing"!==this.lineState?"measured":"measuring"}get cursor(){return"ready"===this.state||"drawing"===this.lineState?"crosshair":null}set cursorPoint(t){this._set("cursorPoint",t),this.measurementView.cursorPoint=t}get validMeasurement(){return n(this.analysis.startPoint)&&n(this.analysis.endPoint)}onShow(){this.measurementView.show(),this._updateManipulatorAvailability()}onHide(){this.measurementView.hide()}onInputEvent(t){switch(t.type){case"immediate-click":this._handleImmediateClick(t);break;case"pointer-move":this._handlePointerMove(t);break;case"pointer-down":this._handlePointerDown();break;case"pointer-up":this._handlePointerUp()}this._updateManipulatorAvailability()}_handlePointerMove(t){this._clearCachedPickRequest();const e=D(t);"mouse"===t.pointerType&&(this._hoverAt(e),"drawing"===this.lineState&&(this.endManipulator.events.emit("drag",{action:"update",start:e,screenPoint:e}),t.stopPropagation()))}_handlePointerDown(){this._isAnyPointerDown=!0}_handlePointerUp(){this._isAnyPointerDown=!1}_handleImmediateClick(t){if(this._clearCachedPickRequest(),!m(t))return;const e=D(t),i=t.pointerType;let s=!1;if(this.active)switch(this.lineState){case"initial":this.startManipulator.events.emit("drag",{action:"start",pointerType:i,start:e,screenPoint:e}),this.startManipulator.events.emit("drag",{action:"end",start:e,screenPoint:e}),n(this.analysis.startPoint)&&(this.startManipulator.interactive=!1,this.endManipulator.interactive=!1,this.lineState="drawing",this.endManipulator.events.emit("drag",{action:"start",pointerType:i,start:e,screenPoint:e}),s=!0);break;case"drawing":this.endManipulator.events.emit("drag",{action:"update",start:e,screenPoint:e}),n(this.analysis.endPoint)&&(this.endManipulator.events.emit("drag",{action:"end",start:e,screenPoint:e}),this.startManipulator.interactive=!0,this.endManipulator.interactive=!0,this.lineState="measured",s=!0)}s&&t.stopPropagation(),"mouse"===t.pointerType&&this._hoverAt(e)}_hoverAt(t){const e=this._isAnyPointerDown&&"drawing"!==this.lineState&&"editing"!==this.lineState;if((s(this.analysis.startPoint)||s(this.analysis.endPoint))&&this.active&&!e){const e=this._pick(t);n(e)&&(this.cursorPoint=e)}else this.cursorPoint=null}_pick(t){if(n(this._cachedPickRequest)&&n(this._cachedPickRequest.result)){const e=this._cachedPickRequest.screenPoint;if(e.x===t.x&&e.y===t.y)return this._cachedPickRequest.result.mapPoint}else this._cachedPickRequest=new _(t);const e=c(t);this.view.sceneIntersectionHelper.intersectToolIntersectorScreen(e,this._intersector);const i=this._intersector.results.min,s=V;if(!i.getIntersectionPoint(s))return null;const a=this.view.renderCoordsHelper.fromRenderCoords(s,this.view.spatialReference);return this._cachedPickRequest.result=new f(s,a),a}_clearCachedPickRequest(){this._cachedPickRequest=null}_surfaceLocation(t,e){return e===y.GROUND?"on-the-surface":t.z>=this._getElevation(t)?"above-the-surface":"below-the-surface"}_updateManipulatorAvailability(){this.startManipulator.available=n(this.analysis.startPoint),this.endManipulator.available=n(this.analysis.endPoint)}_getElevation(t){return this.view.basemapTerrain.ready?a(g(this.view.elevationProvider,t),0):0}};t([h({readOnly:!0})],T.prototype,"state",null),t([h()],T.prototype,"lineState",void 0),t([h({readOnly:!0})],T.prototype,"cursor",null),t([h()],T.prototype,"cursorPoint",null),t([h({constructOnly:!0})],T.prototype,"analysis",void 0),t([h({constructOnly:!0})],T.prototype,"analysisViewData",void 0),t([h()],T.prototype,"measurementView",void 0),t([h({constructOnly:!0})],T.prototype,"view",void 0),t([h({readOnly:!0})],T.prototype,"validMeasurement",null),t([h({value:null})],T.prototype,"startPointSurfaceLocation",void 0),t([h({value:null})],T.prototype,"endPointSurfaceLocation",void 0),T=t([u("esri.views.3d.interactive.measurementTools.directLineMeasurement3D.DirectLineMeasurement3DTool")],T);const V=p(),q=T;export{q as default};
