/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.25/esri/copyright.txt for details.
*/
import e from"../../../Camera.js";import{Cyclical as t}from"../../../core/Cyclical.js";import n from"../../../core/Logger.js";import{deg2rad as r,rad2deg as i}from"../../../core/mathUtils.js";import{isNone as o,unwrapOr as a,isSome as s}from"../../../core/maybe.js";import{createResolver as c}from"../../../core/promiseUtils.js";import{g as l,a as f,j as u,i as m,c as p}from"../../../chunks/vec3.js";import{a as d,c as h}from"../../../chunks/vec3f64.js";import v from"../../../geometry/Point.js";import{projectPointToVector as g,projectVectorToVector as y,projectVectorToPoint as R,project as x}from"../../../geometry/projection.js";import{getReferenceEllipsoid as M}from"../../../geometry/projectionEllipsoid.js";import j from"../../../geometry/SpatialReference.js";import{ViewingMode as w}from"../../ViewingMode.js";import{cameraOnContentAlongViewDirection as S}from"../camera/intersectionUtils.js";import{t as T,c as C}from"../../../chunks/cameraUtilsPlanar.js";import{t as z,c as b}from"../../../chunks/cameraUtilsSpherical.js";import{getGreatCircleSpanAt as U}from"./earthUtils.js";import{getElevationAtPoint as A}from"./ElevationProvider.js";import{isSpatialReferenceSupported as D}from"../../support/spatialReferenceSupport.js";const H=n.getLogger("esri.views.3d.support.cameraUtils"),P=39.37,L=96,E=1,G=8,O=5,k=1,I=h(),q=h(),J={heading:0,tilt:0},F=new v,W=new t(-20037508.342788905,20037508.342788905),X=new t(-180,180);var K;function Y(e){return e.spatialReference||j.WGS84}function N(e){return"global"===e.viewingMode?b:C}function V(e,t,n,r,i){return N(e).headingTiltToDirectionUp(t,n,r,i)}function Z(e,t){if(o(t))return null;const n=e.renderSpatialReference,i=N(e).headingTiltToDirectionUp,a=h();if(!g(t.position,a,n))return null;const s=i(a,t.heading,t.tilt);l(s.direction,s.direction,e.state.camera.distance),f(s.direction,s.direction,a);const c=S(e,a,s.direction,s.up);return c.fov=r(t.fov),c}!function(e){e[e.LOCKED=0]="LOCKED",e[e.ADJUST=1]="ADJUST"}(K||(K={}));const B=h();function Q(t,n,r){const a=t.renderSpatialReference,s=ne(t,n.eye,n.viewForward,n.up,J);let c=Y(t);return y(n.eye,a,B,c)||(c=j.WGS84,y(n.eye,a,B,c)),o(r)?new e(new v(B,c),s.heading,s.tilt,i(n.fov)):(r.position.x=B[0],r.position.y=B[1],r.position.z=B[2],r.position.spatialReference=c,r.heading=s.heading,r.tilt=s.tilt,r.fov=i(n.fov),r)}function $(e,t,n){const i=e.state.camera,o=i.width/2/i.pixelRatio;e.renderCoordsHelper.viewingMode===w.Global&&null!=n&&(t*=Math.cos(r(n))),t/=e.renderCoordsHelper.unitInMeters;return o/(L*P/t)/Math.tan(i.fovX/2)}function _(e,t,n){const i=e.state.camera,o=t*Math.tan(i.fovX/2),a=i.width/2/i.pixelRatio;let s=L*P/(a/o);return e.renderCoordsHelper.viewingMode===w.Global&&(s/=Math.cos(r(n))),s*=e.renderCoordsHelper.unitInMeters,s}function ee(e,t,n,r,i,o){return te(e,t,$(e,n,t.latitude),r,i,o)}function te(e,t,n,r,i,a){if(we(a)){const s=new je(a.signal);return se(e,r.heading,r.tilt,t,n,i,s),void s.resolver.promise.then((t=>{const n=ye(e,t,r.fov);if(!o(n))return a.resolver.resolve(n);a.resolver.reject()}),(e=>a.resolver.reject(e)))}const s=se(e,r.heading,r.tilt,t,n,i);return ye(e,s,r.fov,a)}function ne(e,t,n,r,i){return N(e).directionToHeadingTilt(t,n,r,i)}function re(e,t){return!!(e.basemapTerrain&&e.renderCoordsHelper.fromRenderCoords(t,F,e.spatialReference)&&a(A(e.elevationProvider,F),0)>F.z-k)}async function ie(e,t,n){if(!e.renderCoordsHelper.fromRenderCoords(t,F,e.spatialReference))return!1;const r=await e.elevationProvider.queryElevation(F.x,F.y,F.z,F.spatialReference,"ground",n);return a(r,0)>F.z-k}async function oe(e,t,n){const r=h();if(t)if(t instanceof v){if(g(t,r,e.renderSpatialReference),null==t.z&&null!=e.basemapTerrain){const i=await e.elevationProvider.queryElevation(t.x,t.y,t.z,t.spatialReference,"ground",n);return s(i)&&e.renderCoordsHelper.setAltitude(r,i),r}}else p(r,t);else p(r,e.state.camera.center);return r}function ae(e,t){const n=h();if(t&&t instanceof v){if(g(t,n,e.renderSpatialReference),null==t.z&&null!=e.basemapTerrain){const r=A(e.elevationProvider,t);s(r)&&e.renderCoordsHelper.setAltitude(n,r)}}else p(n,t||e.state.camera.center);return n}function se(e,t,n,r,i,o,a){const s=r&&r instanceof v?r:null;if(we(a))return oe(e,r,a.signal).then((r=>{ce(e,t,n,s,r,i,o,a)}),(e=>a.resolver.reject(e))),null;const c=ae(e,r);return ce(e,t,n,s,c,i,o,a)}function ce(e,t,n,r,i,a,s,c){if(o(r)){const t=e.renderSpatialReference;if(r=R(i,t,Y(e)),o(r))return null}a=Math.max(a,e.state.constraints.minimumPoiDistance);const l=me(e,t,n,i,a,s),f=(0,N(e).eyeForCenterWithHeadingTilt)(i,a,l.heading,l.tilt);if(s===K.ADJUST&&"global"===e.viewingMode&&n>0){const o=()=>{const o=ve(e,i,a,he(e,a,n,i));return s=n-o<1?K.LOCKED:K.ADJUST,ce(e,t,o,r,i,a,s,c)},l=e.map.ground.navigationConstraint;if(!l||"stay-above"===l.type){if(re(e,f.eye))return o();if(we(c))return ie(e,f.eye,c.signal).then((e=>e?o():(c.resolver.resolve({eye:f.eye,up:f.up,center:d(i),heading:f.heading,tilt:f.tilt}),null))),null}}const u=!c||we(c)?{center:h(),eye:h(),up:h(),tilt:0,heading:0}:c;return u.eye=f.eye,u.up=f.up,u.center=d(i),u.heading=f.heading,u.tilt=f.tilt,we(c)&&c.resolver.resolve(u),u}function le(e,t,n,r,i,s=null){const c=null!=t.zmax&&null!=t.zmin;let l,f,u;if(e.state.isGlobal){if(!D(t.spatialReference,w.Global))return we(s)&&s.resolver.reject(),null;const e=new v(t.xmin,t.ymin,t.spatialReference),n=new v(t.xmax,t.ymax,t.spatialReference),r=t.spatialReference.isGeographic?X:W;l=new v({x:r.center(e.x,n.x),y:(n.y+e.y)/2,z:c?(t.zmax+t.zmin)/2:null,spatialReference:t.spatialReference});const i=M(t.spatialReference),o=U(l,e,n);f=o.lon,u=o.lat,r.diff(e.x,n.x)>r.range/2&&(f+=i.halfCircumference),f=Math.min(f,i.halfCircumference),u=Math.min(u,i.halfCircumference)}else{const n=a(e.renderSpatialReference,t.spatialReference);n.equals(t.spatialReference)||(t=x(t,n)),f=t.xmax-t.xmin,u=t.ymax-t.ymin;const r=c?(t.zmax+t.zmin)/2:null;l=new v({x:t.xmin+.5*f,y:t.ymin+.5*u,z:r,spatialReference:n})}const m=c?t.zmax-t.zmin:0,p=e.state.camera,d=1/Math.tan(p.fovX/2),h=1/Math.tan(p.fovY/2),g=1/Math.tan(p.fov/2),y=Math.max(.5*f*d,.5*u*h,.5*m*g)/E;if(we(s)){const t=new je(s.signal);return se(e,n,r,l,y,i,t),void t.resolver.promise.then((t=>{const n=ye(e,t,e.camera.fov);if(!o(n))return s.resolver.resolve(n);s.resolver.reject()}),(e=>s.resolver.reject(e)))}const R=se(e,n,r,l,y,i);return ye(e,R,e.camera.fov,s)}function fe(e,t,n){const r=e.renderSpatialReference,i=R(n,r,Y(e));if(o(i))return null;const a=Math.tan(t.fovX/2),s=Math.tan(t.fovY/2),c=u(t.eye,n),l=2*c*a*E,f=2*c*s*E;return"global"===e.viewingMode?z(e,i,l,f):T(e,i,l,f)}function ue(e,t,n){const r=e.pointsOfInterest.centerOnSurfaceFrequent.distance;if(Math.log(n/r)/Math.LN2>G)return!0;const i=e.renderSpatialReference,a=Y(e),s=R(t,i,a),c=R(e.pointsOfInterest.centerOnSurfaceFrequent.renderLocation,i,a);if(o(s)||o(c))return!1;const l=Math.tan(.5*e.state.camera.fov)*r;return c.distance(s)/l>O}function me(e,t,n,r,i,o){let a=0;return o===K.ADJUST&&ue(e,r,i)?(t=0,a=de(e,i,n,r)):a=ge(e,r,i,n),a=e.state.constraints.clampTilt(i,a),{heading:t,tilt:n=ve(e,r,i,a)}}const pe=.7;function de(e,t,n,r){const i=e.state.constraints.tilt(t);i.max=Math.min(i.max,.5*Math.PI);const o=i.min*(1-pe)+i.max*pe,a=ge(e,r,t,n);return Math.min(a,o)}function he(e,t,n,r){const i=e.state.constraints.tilt(t);let o=ge(e,r,t,n);return o=Math.min(o,.5*Math.PI),i.min*(1-pe)+o*pe}function ve(e,t,n,r){return N(e).lookAtTiltToEyeTilt(r,t,n)}function ge(e,t,n,r){return N(e).eyeTiltToLookAtTilt(r,t,n)}function ye(t,n,r,i){if(o(n))return null;const a=t.renderSpatialReference,c=R(n.eye,a,Y(t));return o(c)?null:s(i)?(i.position=c,i.heading=n.heading,i.tilt=n.tilt,i.fov=r,i):new e(c,n.heading,n.tilt,r)}function Re(e,t){const n=e.basemapTerrain?.tilingScheme;if(n)return n.levelAtScale(t);H.error("#scaleToZoom()","Cannot compute zoom from scale without a tiling scheme")}function xe(e,t){const n=e.basemapTerrain?.tilingScheme;if(n)return n.scaleAtLevel(t);H.error("#zoomToScale()","Cannot compute scale from zoom without a tiling scheme")}function Me(t,n,r){const i=t.renderSpatialReference;let o,a;n||(n=t.state.camera);const s=j.WGS84;return n instanceof e?(o=n.position.latitude,g(n.position,I,i),g(r,q,i),a=m(I,q)):(y(n.center,i,q,s),o=q[1],a=n.distance),_(t,a,o)}class je{constructor(e){this.signal=e,this.resolver=c()}}function we(e){return e&&"resolver"in e}export{je as AsyncContext,K as OrientationMode,Me as computeScale,ne as directionToHeadingTilt,_ as distanceToScale,Z as externalToInternal,te as fromCenterDistance,ee as fromCenterScale,le as fromExtent,se as getObserverForPointAtDistance,V as headingTiltToDirectionUp,Q as internalToExternal,ye as observerToCamera,$ as scaleToDistance,Re as scaleToZoom,fe as toExtent,xe as zoomToScale};
