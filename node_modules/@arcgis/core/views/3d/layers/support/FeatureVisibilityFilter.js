/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.25/esri/copyright.txt for details.
*/
import{_ as e}from"../../../../chunks/tslib.es6.js";import{createTask as t}from"../../../../core/asyncUtils.js";import{HandleOwner as r}from"../../../../core/HandleOwner.js";import i from"../../../../core/Logger.js";import{isNone as s,abortMaybe as a,removeMaybe as l,destroyMaybe as o,isSome as u}from"../../../../core/maybe.js";import{throwIfAbortError as n}from"../../../../core/promiseUtils.js";import{initial as p}from"../../../../core/reactiveUtils.js";import{property as h}from"../../../../core/accessorSupport/decorators/property.js";import"../../../../core/arrayUtils.js";import"../../../../core/accessorSupport/ensureType.js";import{subclass as c}from"../../../../core/accessorSupport/decorators/subclass.js";import _ from"../../../../layers/support/FeatureFilter.js";import{getFloorFilterClause as d}from"../../../../layers/support/floorFilterUtils.js";import{QueryEngine as y}from"../graphics/QueryEngine.js";import{TaskPriority as m}from"../../../support/Scheduler.js";let f=class extends r{constructor(e){super(e),this._updateTask=null,this._frameTask=null,this._queryEngine=null,this._updateRequested=!0,this._updateVisibility=async e=>{if(s(this._compositedFeatureFilter)&&s(this._sceneFilter)||0===this.context.getFeatureCount())return this._frameTask.schedule((()=>this.clear()),e);try{const t=await this._queryEngine.executeQueryForIdSet(this._compositedFeatureFilter,this._sceneFilter,e);return this._frameTask.schedule((()=>{this.context.updateFeatureVisibilities((e=>t.has(e)))}),e)}catch(t){return n(t),i.getLogger(this.declaredClass).warn(`FeatureFilter query failed: ${t}`,{error:t}),this._frameTask.schedule((()=>{this.context.setAllFeaturesVisibility(!0)}),e)}}}initialize(){const e=m.FILTER_VISIBILITY,{layer:t,view:r}=this._layerView,{featureStore:i}=this.context,s="hasZ"in this._layerView&&this._layerView.hasZ,a="hasM"in this._layerView&&this._layerView.hasM;this._queryEngine=new y({context:{spatialReference:r.spatialReference,layer:t,scheduler:r.resourceController.scheduler,featureStore:i,hasM:a,hasZ:s},priority:e}),this._frameTask=this._layerView.view.resourceController.scheduler.registerTask(e,this),this.updatingHandles.add((()=>[this._compositedFeatureFilter,this._sceneFilter]),(()=>this.reapply()),p)}destroy(){this._updateRequested=!1,this.handles.removeAll(),this.updatingHandles.removeAll(),this.clear(),this._updateTask=a(this._updateTask),this._frameTask=l(this._frameTask),this._queryEngine=o(this._queryEngine),this._set("context",null)}get updating(){return this.running||this.updatingHandles.updating||u(this._updateTask)&&!this._updateTask.finished}get running(){return this._updateRequested||this._frameTask.updating}get defaultVisibility(){return s(this._compositedFeatureFilter)&&s(this._sceneFilter)}get _featureFilter(){return"filter"in this._layerView?this._layerView.filter:null}get _sceneFilter(){return"layerFilter"in this._layerView?this._layerView.layerFilter:null}get _floorFilter(){return d(this._layerView)}get _timeExtent(){return"timeExtent"in this._layerView?this._layerView.timeExtent:null}get _compositedFeatureFilter(){const{_featureFilter:e,_timeExtent:t,_floorFilter:r}=this;if(s(t)&&s(r))return e;const i=u(e)?e.clone():new _;if(u(t)&&(i.timeExtent=u(i.timeExtent)?i.timeExtent.intersection(t):t),u(r)){const e=s(i.where)||""===i.where;i.where=e?r:`(${i.where}) AND (${r})`}return i}get _layerView(){return this.context.layerView}reapply(){this._updateRequested=!0}clear(){this._queryEngine.clear(),this.context.clearFeaturesVisibility()}runTask(e){this._updateRequested&&(this._updateTask=a(this._updateTask),this._updateTask=t(this._updateVisibility),this._updateRequested=!1,e.madeProgress()),this._frameTask.processQueue(e)}};e([h({constructOnly:!0})],f.prototype,"context",void 0),e([h()],f.prototype,"updating",null),e([h()],f.prototype,"running",null),e([h()],f.prototype,"defaultVisibility",null),e([h()],f.prototype,"_featureFilter",null),e([h()],f.prototype,"_sceneFilter",null),e([h()],f.prototype,"_floorFilter",null),e([h()],f.prototype,"_timeExtent",null),e([h()],f.prototype,"_compositedFeatureFilter",null),e([h()],f.prototype,"_layerView",null),e([h()],f.prototype,"_updateTask",void 0),e([h()],f.prototype,"_updateRequested",void 0),f=e([c("esri.views.3d.layers.support.FeatureVisibilityFilter")],f);export{f as FeatureVisibilityFilter};
