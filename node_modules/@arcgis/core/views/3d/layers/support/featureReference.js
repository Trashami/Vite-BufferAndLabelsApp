/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.25/esri/copyright.txt for details.
*/
import"../../../../layers/graphics/dehydratedFeatures.js";import{equals as e}from"../../../../layers/graphics/dehydratedFeatureComparison.js";class s{constructor(e,s){this._highestResolutionVersion=null,this.versions=[],this.ref(e,s)}get isReferenced(){return 0!==this.versions.length}get isSingle(){return 1===this.versions.length&&1===this.versions[0].refCount}ref(s,t){const r=this.feature;i.oldVersion=r,this.feature&&Object.defineProperty(s,"uid",{value:this.feature.uid,configurable:!0});for(const o of this.versions)if(o.resolution===t){o.refCount++;const t=this._highestResolutionVersion===o&&!e(s,o.feature);return(t||this._highestResolutionVersion!==o)&&(o.feature=s),i.newVersion=t?s:r,i}const n={feature:s,resolution:t,refCount:1};return this.versions.push(n),!this._highestResolutionVersion||t<this._highestResolutionVersion.resolution?(i.newVersion=s,this._highestResolutionVersion=n):i.newVersion=r,i}unref(e){for(let s=0;s<this.versions.length;s++){const t=this.versions[s];if(t.resolution===e)return t.refCount--,i.oldVersion=this.feature,0===t.refCount&&(this.versions[s]=this.versions[this.versions.length-1],this.versions.length--,this._highestResolutionVersion===t&&(this._recalculateHighestResolutionVersion(),i.oldVersion=t.feature)),i.newVersion=this.feature,i}return null}get feature(){return this._highestResolutionVersion?this._highestResolutionVersion.feature:null}_recalculateHighestResolutionVersion(){if(0===this.versions.length)return void(this._highestResolutionVersion=null);let e=this.versions[0];for(let s=1;s<this.versions.length;s++){const t=this.versions[s];t.resolution<e.resolution&&(e=t)}this._highestResolutionVersion=e}}class t{constructor(e){this._feature=e,this._refCount=1}get isReferenced(){return 0!==this._refCount}get isSingle(){return 1===this._refCount}ref(s){return++this._refCount,i.oldVersion=this._feature,this.feature&&Object.defineProperty(s,"uid",{value:this.feature.uid,configurable:!0}),e(this._feature,s)||(this._feature=s),i.newVersion=this._feature,i}unref(){return i.oldVersion=this._feature,this._refCount>0&&(this._refCount--,!this.isReferenced)?(i.newVersion=null,i):(i.newVersion=this._feature,i)}get feature(){return this._feature}}const i={oldVersion:null,newVersion:null};export{s as MultiFeatureReference,t as SingleFeatureReference};
