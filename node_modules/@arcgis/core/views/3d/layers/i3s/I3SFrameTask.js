/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.25/esri/copyright.txt for details.
*/
import{removeUnordered as t}from"../../../../core/arrayUtils.js";import{removeMaybe as r}from"../../../../core/maybe.js";import{TaskPriority as e}from"../../../support/Scheduler.js";class s{constructor(t){this.referenceCount=0,this.callbacks=[],this.runIndex=0,this.handle=t.registerTask(e.I3S_CONTROLLER,this)}destroy(){this.handle=r(this.handle)}get running(){for(const t of this.callbacks)if(t.needsUpdate())return!0;return!1}runTask(t){this._sort();const r=this.callbacks,e={numIndexLoading:0,numNodesLoading:0};for(let s=0;s<r.length&&!t.done;++s)r[s].priority=r[s].update(t,e),this.runIndex=s}_sort(){const t=this.callbacks;let r=t.length;for(let e=this.runIndex;e>0;e--){const s=t[e-1];let n=e;for(;n<t.length&&s.priority<=t[n].priority&&(n!==r||s.priority<t[n].priority);)t[n-1]=t[n],n++;t[n-1]=s,r=n-1}this.runIndex=0}add(t){this._sort(),t.priority=1/0,this.callbacks.unshift(t)}remove(r){t(this.callbacks,r),this.runIndex=this.callbacks.length,this._sort()}}const n=new Map;function i(t,r){let e=n.get(t);return null==e&&(e=new s(t),n.set(t,e)),e.add(r),{remove:()=>{if(null==e)return;e.remove(r);e.callbacks.length>0||(n.delete(t),e.destroy()),e=null}}}export{i as addTask};
