/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.25/esri/copyright.txt for details.
*/
import e from"../../../../Color.js";import{isSome as t,get as r,isNone as i,unwrap as o}from"../../../../core/maybe.js";import{pt2px as n}from"../../../../core/screenUtils.js";import{e as a}from"../../../../chunks/earcut.js";import{I as s}from"../../../../chunks/mat4f64.js";import{s as l}from"../../../../chunks/vec4.js";import{create as c,empty as h,expandWithBuffer as p,intersectsClippingArea as u,expandWithAABB as d}from"../../../../geometry/support/aaBoundingBox.js";import{BufferViewMat3f64 as m,BufferViewVec3f64 as y,BufferViewVec4f as _}from"../../../../geometry/support/buffer/BufferView.js";import{SymbolUpdateType as g,elevationModeChangeUpdateType as f,needsElevationUpdates2D as b}from"./elevationAlignmentUtils.js";import{ElevationContext as x}from"./ElevationContext.js";import v from"./Graphics3DDrapedGraphicLayer.js";import{Graphics3DObject3DGraphicLayer as A}from"./Graphics3DObject3DGraphicLayer.js";import{Graphics3DSymbolLayer as O}from"./Graphics3DSymbolLayer.js";import{mixinColorAndOpacity as E}from"./graphicUtils.js";import{parseCapType as M}from"./lineUtils.js";import{geometryAsPolygon as S,createColorGeometry as C,PolygonCreationDataBase as D}from"./polygonUtils.js";import{createMaterial as U,uvElevationAligner as j}from"../support/patternUtils.js";import{createMapSpaceUVCoords as P,createMapSpaceUVCoordsDraped as w}from"../support/uvUtils.js";import{createGeometry as L}from"../../support/engineContent/line.js";import{geometryToRenderInfo as G,geometryToRenderInfoDraped as T}from"../../support/renderInfoUtils/polygon.js";import{Object3D as R}from"../../webgl-engine/lib/Object3D.js";import{RenderGeometry as I}from"../../webgl-engine/lib/RenderGeometry.js";import{VertexAttribute as V}from"../../webgl-engine/lib/VertexAttribute.js";import{getStipplePatternForLinePattern as B}from"../../webgl-engine/materials/lineStippleUtils.js";import{PatternMaterial as F}from"../../webgl-engine/materials/PatternMaterial.js";import{RibbonLineMaterial as N}from"../../webgl-engine/materials/RibbonLineMaterial.js";const H=["polyline","polygon","extent"];class W extends O{constructor(e,t,r,i){super(e,t,r,i),this._needsUV=!1,this._hasOutline=!1}async doLoad(){}_ensureMaterials(){this._ensureFillMaterial(),this._ensureOutlineMaterial()}_ensureFillMaterial(){if(t(this._material))return;const e=r(this.symbolLayer,"material","color"),i=this._getCombinedOpacityAndColor(e);this._material=U(this.symbolLayer,{color:i,transparent:i[3]<1||this.needsDrivenTransparentPass,polygonOffset:!1,hasVertexColors:!0,writeLinearDepth:!0,hasSlicePlane:this._context.slicePlaneEnabled},{isDraped:this.draped}),this._needsUV=this._material instanceof F,this._context.stage.add(this._material)}_ensureOutlineMaterial(){const e=this.symbolLayer.outline;if(t(this._outlineMaterial)||!this._isValidOutline(e))return;this._hasOutline=!0;const r=t=>{const r=B(e.pattern);return new N({width:t,color:this._getOutlineColor(),hasPolygonOffset:!0,hasSlicePlane:this._context.slicePlaneEnabled,isClosed:!0,stipplePattern:r,stippleScaleWithLineWidth:!0,cap:M(e.patternCap||"butt")})};this._outlineMaterial=r(n(e.size)),this._context.stage.add(this._outlineMaterial)}_isValidOutline(e){return t(e)&&e.size&&e.size>0&&t(e.color)&&(i(e.pattern)||"style"!==e.pattern.type||"none"!==e.pattern.style)}destroy(){super.destroy(),this._context.stage.remove(this._material),this._material=null,this._context.stage.remove(this._outlineMaterial),this._outlineMaterial=null}createGraphics3DGraphic(e){const t=e.graphic;if(!this._validateGeometry(t.geometry,H,this.symbolLayer.type))return null;const r=this._getVertexOpacityAndColor(e.renderingInfo,255),i=this.setGraphicElevationContext(t,new x);return this.ensureDrapedStatus("on-the-ground"===i.mode),this._ensureMaterials(),this.draped?this._createAsOverlay(t,r):this._createAs3DShape(t,r,i)}layerOpacityChanged(){if(t(this._material)){const e=this._material.parameters.color,t=r(this.symbolLayer,"material","color"),i=this._getCombinedOpacity(t);this._material.setParameters({color:[e[0],e[1],e[2],i],transparent:i<1||this.needsDrivenTransparentPass})}if(t(this._outlineMaterial)){const e=this._outlineMaterial.parameters.color;this._outlineMaterial.setParameters({color:[e[0],e[1],e[2],this._getOutlineOpacity()]})}}layerElevationInfoChanged(e,t,r){const i=this._elevationContext.mode,o=f(W.elevationModeChangeTypes,r,i);if(o!==g.UPDATE)return o;const n=b(i);return this.updateGraphics3DGraphicElevationInfo(e,t,(()=>n))}slicePlaneEnabledChanged(){if(t(this._material)&&this._material.setParameters({hasSlicePlane:this._context.slicePlaneEnabled}),t(this._outlineMaterial)){const e={hasSlicePlane:this._context.slicePlaneEnabled};this._outlineMaterial.setParameters(e)}return!0}physicalBasedRenderingChanged(){return!0}pixelRatioChanged(){return!0}_createAs3DShape(e,t,r){const o=S(e.geometry);if(i(o))return null;const n=G(o,this._context.elevationProvider,this._context.renderCoordsHelper,r),a=new z(n,t,this._context.layer.uid,e.uid),s=a.renderData.position.length/3;if(this._needsUV&&(a.uvMapSpace=new Float32Array(4*s),a.boundingRect=new Float64Array(9*s)),a.objectAndLayerIdColor=this._context.stage.renderView?._getObjectAndLayerIdColor({graphicUid:a.graphicsUid,layerUid:a.layerUid}),this._createAs3DShapeFill(a),this._hasOutline&&this._createAs3DShapeOutline(a),this._logGeometryCreationWarnings(a.renderData,o.rings,"rings","FillSymbol3DLayer"),0===a.outGeometries.length)return null;this._needsUV&&P(_.fromTypedArray(a.uvMapSpace),y.fromTypedArray(a.renderData.position),this._context.renderCoordsHelper,m.fromTypedArray(a.boundingRect));const l=new R({geometries:a.outGeometries,materials:a.outMaterials,transformations:a.outTransforms,castShadow:!1,metadata:{layerUid:this._context.layer.uid,graphicUid:e.uid}}),c=new A(this,l,a.outGeometries,null,null,j,r);return c.alignedSampledElevation=a.renderData.sampledElevation,c.needsElevationUpdates=b(r.mode),c}_createAs3DShapeFill(e){const r=e.renderData.polygons;for(const{position:i,mapPosition:n,holeIndices:l,index:c,count:d}of r){if(t(this._context.clippingExtent)&&(h(k),p(k,n),!u(k,this._context.clippingExtent)))continue;const r=a(n,l,3);if(0===r.length)continue;const m=C({indices:r,attributeData:{position:i,color:e.color,mapPosition:n,uvMapSpace:this._needsUV?new Float32Array(e.uvMapSpace.buffer,4*c*e.uvMapSpace.BYTES_PER_ELEMENT,4*d):null,boundingRect:this._needsUV?new Float64Array(e.boundingRect.buffer,9*c*e.boundingRect.BYTES_PER_ELEMENT,9*d):null,objectAndLayerIdColor:e.objectAndLayerIdColor}});e.outGeometries.push(m),e.outMaterials.push(o(this._material)),e.outTransforms.push(s)}}_createAs3DShapeOutline(e){if(!this._hasOutline)return;const r=e.renderData.outlines;for(let i=0;i<r.length;++i){const{mapPosition:n,position:a}=r[i];if(t(this._context.clippingExtent)&&(h(k),p(k,n),!u(k,this._context.clippingExtent)))continue;const l=L({overlayInfo:null,removeDuplicateStartEnd:!0,attributeData:{position:a,mapPosition:n}},e.objectAndLayerIdColor),c=l.vertexAttributes.get(V.POSITION);c.data===a&&(c.data=new Float64Array(a)),e.outGeometries.push(l),e.outMaterials.push(o(this._outlineMaterial)),e.outTransforms.push(s)}}_createAsOverlay(e,r){const n=S(e.geometry);if(i(n))return null;o(this._material).renderPriority=this._renderPriority+this._renderPriorityStep/2,t(this._outlineMaterial)&&(this._outlineMaterial.renderPriority=this._renderPriority);const a=T(n,this._context.overlaySR),s=new Y(a,r,this._context.layer.uid,e.uid),l=s.renderData.position.length/3;return this._needsUV&&(s.uvMapSpace=new Float32Array(4*l)),s.outBoundingBox=h(),s.objectAndLayerIdColor=this._context.stage.renderView?._getObjectAndLayerIdColor({graphicUid:s.graphicsUid,layerUid:s.layerUid}),this._createAsOverlayFill(s),this._hasOutline&&this._createAsOverlayOutline(s),this._logGeometryCreationWarnings(s.renderData,n.rings,"rings","FillSymbol3DLayer"),0===s.outGeometries.length?null:(this._needsUV&&w(_.fromTypedArray(s.uvMapSpace),y.fromTypedArray(s.renderData.position),this._context.overlaySR,this._context.graphicsCoreOwner.view.state.viewingMode),new v(this,s.outGeometries,s.outBoundingBox,this._context.drapeSourceRenderer))}_createAsOverlayFill(e){const t=e.renderData.polygons;for(const{position:r,holeIndices:i,index:n,count:s}of t){if(h(k),p(k,r),!u(k,this._context.clippingExtent))continue;const t=a(r,i,3);if(0===t.length)continue;d(e.outBoundingBox,k);const c=C({indices:t,attributeData:{position:r,color:e.color,uvMapSpace:this._needsUV?new Float32Array(e.uvMapSpace.buffer,4*n*e.uvMapSpace.BYTES_PER_ELEMENT,4*s):null,objectAndLayerIdColor:e.objectAndLayerIdColor}}),m=new I(c,o(this._material),{layerUid:e.layerUid,graphicUid:e.graphicsUid}),y=k;l(m.boundingSphere,.5*(y[0]+y[3]),.5*(y[1]+y[4]),0,.5*Math.sqrt((y[3]-y[0])*(y[3]-y[0])+(y[4]-y[1])*(y[4]-y[1]))),e.outGeometries.push(m)}}_createAsOverlayOutline(e){if(!this._hasOutline)return;const t=e.renderData.outlines;for(let r=0;r<t.length;++r){const{position:i}=t[r];if(h(k),p(k,i),!u(k,this._context.clippingExtent))continue;d(e.outBoundingBox,k);const n=L({overlayInfo:{spatialReference:this._context.overlaySR,renderCoordsHelper:this._context.renderCoordsHelper},removeDuplicateStartEnd:!0,attributeData:{position:i}},e.objectAndLayerIdColor),a=new I(n,o(this._outlineMaterial),{layerUid:e.layerUid,graphicUid:e.graphicsUid}),s=k;l(a.boundingSphere,.5*(s[0]+s[3]),.5*(s[1]+s[4]),0,.5*Math.sqrt((s[3]-s[0])*(s[3]-s[0])+(s[4]-s[1])*(s[4]-s[1]))),e.outGeometries.push(a)}}_getOutlineOpacity(){const e=r(this.symbolLayer,"outline","color");return(this.draped?1:this._getLayerOpacity())*(t(e)?e.a:0)}_getOutlineColor(){const i=r(this.symbolLayer,"outline","color"),o=this._getOutlineOpacity();return E(t(i)?e.toUnitRGB(i):null,o)}test(){return{...super.test(),createAsOverlay:(e,t)=>this._createAsOverlay(e,t),createAs3DShape:(e,t,r)=>this._createAs3DShape(e,t,r)}}}W.elevationModeChangeTypes={definedChanged:g.RECREATE,staysOnTheGround:g.NONE,onTheGroundChanged:g.RECREATE};const k=c();class z extends D{constructor(e,t,r,i){super(e,r,i),this.color=t}}class Y extends D{constructor(e,t,r,i){super(e,r,i),this.color=t}}export{W as Graphics3DPolygonFillSymbolLayer};
