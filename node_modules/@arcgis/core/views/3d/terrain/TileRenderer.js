/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.25/esri/copyright.txt for details.
*/
import{nextHighestPowerOfTwo as e}from"../../../core/mathUtils.js";import{disposeMaybe as t,releaseMaybe as r,isNone as s,isSome as o}from"../../../core/maybe.js";import{s as a,c as i}from"../../../chunks/vec2.js";import{Z as n}from"../../../chunks/vec2f64.js";import{isBaseLayer as c}from"../../../layers/support/layerUtils.js";import{ImageWithType as u}from"../support/StreamDataLoader.js";import{BlendLayersPassParameters as l}from"./BlendLayersTechnique.js";import{TextureUpdate as p}from"./interfaces.js";import{LayerClass as h}from"./LayerClass.js";import{isBlendableLayerView as d,isGroupLayer as m,isVectorTileLayerView as _,isVectorTileRenderInfo as f,isImageryTileRenderInfo as y,isRasterTileRenderInfo as T,isTextureTileRenderInfo as g}from"./terrainUtils.js";import{ActivationTime as b}from"./TextureFader.js";import{TextureReference as x}from"./TextureReference.js";import{TileCompositor as k}from"./TileCompositor.js";import I from"./TileTexture.js";import{TileUpdate as w}from"./TileUpdate.js";import{blendModeFromString as P}from"../webgl-engine/core/shaderLibrary/output/BlendOptions.js";import{BaseOpacityMode as D,BlendLayersOutput as A}from"../webgl-engine/core/shaderLibrary/terrain/TileBackground.glsl.js";import{createColorTexture as E,createEmptyTexture as R}from"../webgl-engine/lib/glUtil3D.js";import{TextureSamplingMode as M,TextureType as L,PixelFormat as j,PixelType as C,TextureWrapMode as N}from"../../webgl/enums.js";import{Texture as O}from"../../webgl/Texture.js";class U{constructor(e,t,r,s){this.start=e,this.end=t,this.blendMode=r,this.opacity=s}}class B{constructor(e,t,r){this._rctx=e,this.tileSize=t,this._techniqueRepository=r,this._passParameters=new l,this._backgroundTexture=null,this._backgroundColor=null,this._backgroundDirty=!1,this._blackTex=null,this._maxAnisotropy=this._rctx.parameters.maxMaxAnisotropy,this._composition=new k(this._rctx,this._techniqueRepository),this._blackTex=new I(E(this._rctx,[0,0,0,1])),this._ensureBackgroundTexture(this.tileSize)}dispose(){this._composition=t(this._composition),this._backgroundTexture=r(this._backgroundTexture),this._blackTex=r(this._blackTex)}get backgroundIsGrid(){return s(this._backgroundColor)}get backgroundColor(){return this._backgroundColor}updateTileTexture(e,t){if(!e.renderData)return;const r=e.surface,s=r.baseOpacity;let a=0,i=0,n=this.tileSize,u=!1;const l=r.view.state.pixelRatio;let p=!1;Y.clear(),Z.length=0;const f=e.layerInfo[h.MAP];let y=f.length,T=0;for(;T<f.length;T++){const t=r.layerViewByIndex(T,h.MAP),g=t.layer.opacity;X[T]=g;const b=t.fullOpacity;if(v[T]=b,c(t.layer)&&y>=f.length&&(y=T),d(t)){V[T]=t.layer.blendMode;let e="normal"!==t.layer.blendMode;if(m(t.layer.parent)){const r=S(t.layer.parent);o(r)&&""!==r&&(e=q(t.layer.parent)||e)}e&&(p=e,u=!1)}if(0===g&&!p){f[T].pendingUpdates&=~(w.TEXTURE_NOFADING&w.TEXTURE_FADING);continue}++i;const x=F(e,T);if(x){if(f[T].pendingUpdates&=~(w.TEXTURE_NOFADING&w.TEXTURE_FADING),m(t.layer.parent)){const e=S(t.layer.parent);o(e)&&""!==e&&z(t.layer.parent,T)}_(t)?n=Math.max(n,this.tileSize*l):1===s&&1===b&&(t.isOpaque||this._dataToTexture(x)&&x.sourceLayerInfo.data.descriptor.isOpaque)&&(u=!0),++a}}n=G(n);const g=n/this.tileSize,b=T-1;this._ensureBackgroundTexture(this.tileSize),0!==a?1===a&&!p&&this._useLayerTexture(e,b,y,v[b])||this._composeMapLayers(e,t,b,y,X,V,n,g,!u||p,Y,p):this._useBackgroundTexture(e,i)}_ensureBackgroundTexture(e){s(this._backgroundTexture)&&(this._backgroundTexture=this._buildTexture(e),this._backgroundDirty=!0),this._backgroundDirty&&(this._composition.bind(e),this._passParameters.offset=n,this._passParameters.scale=1,this._passParameters.opacity=1,o(this.backgroundColor)&&(this._passParameters.backgroundColor=this.backgroundColor),this._composition.drawBackground(this._passParameters,o(this.backgroundColor)),this._composition.copyFBOToTexture(this._backgroundTexture),this._composition.unbind(),this._backgroundDirty=!1)}_useBackgroundTexture(e,t){let r=b.Immediate;(e.surface.view.layerViewManager.updating||t>0)&&(r=b.Delayed),this._backgroundTexture&&s(e.renderData.textureReference)&&(r=b.Immediate),e.renderData.setTextureReference(o(this._backgroundTexture)?new x(this._backgroundTexture,p.FADING,J,e.surface.baseOpacity,0,1):null,r)}_useLayerTexture(e,t,r,s){const o=t<r,a=o?1:e.surface.baseOpacity,i=o?e.surface.baseOpacity:1,n=F(e,t);return!!this._dataToTexture(n)&&(e.renderData.setTextureReference(new x(n.sourceLayerInfo.data,p.FADING,n,a,i,s)),!0)}_composeMapLayers(e,t,r,s,o,a,i,c,u,l,p){this._composition.ensureBuffer(i);const h=e.surface.baseOpacity;let d=!1,m=M.LINEAR_MIPMAP_LINEAR,_=!1,T=0;for(let b=r;b>=0;b--){const t=F(e,b);if(!t)continue;if(0===o[b]&&!p)continue;const r=b<s&&h<1&&!d;this._passParameters.baseOpacity=r?h:1;const g=this._passParameters.baseOpacity<1?D.Required:D.NotRequired;r&&(d=!0);let x=!1;l.forEach((e=>{e.start===b&&(Z.push(e),this._composition.openGroup(i),x=!0)}));const k=0===T,I=x?A.GroupBackgroundComposite:u&&k?this.backgroundIsGrid?A.GridComposite:A.ColorComposite:A.Composite,w=P[a[b]];for(f(t)?(this._passParameters.opacity=o[b],_=this._composition.drawVectorData(this._passParameters,I,i,w,g,t,c,this.tileSize,_)):y(t)?(this._passParameters.opacity=o[b],this._composition.drawImageryTileData(this._passParameters,I,i,w,g,t),this._hasNearestInterpolation(t)&&(m=M.NEAREST)):this._dataToTexture(t)&&(this._passParameters.texture=t.sourceLayerInfo.data.texture,this._passParameters.offset=t.offset,this._passParameters.scale=t.scale,this._passParameters.opacity=o[b],this._composition.drawRasterData(this._passParameters,I,i,w,g));Z.length>0&&Z[Z.length-1].end===b;){const e=Z.pop();this._passParameters.opacity=e.opacity,this._passParameters.offset=n,this._passParameters.scale=1;const t=u&&k?this.backgroundIsGrid?A.GridComposite:A.ColorComposite:A.Composite;this._composition.drawGroup(this._passParameters,t,i,P[e.blendMode],g)}T++}const g=e.renderData.ensureTexture(i,(()=>this._buildTexture(i,m)));this._composition.copyFBOToTexture(g),this._composition.unbind(),e.renderData.setTextureReference(new x(g,t,J,d?1:h,0,1))}_hasNearestInterpolation(e){const t=e.sourceLayerInfo.data;return!!t.source&&"nearest"===t.interpolation}_dataToTexture(e){if(T(e)){const t=e.sourceLayerInfo;t.data=this._buildTexture(t.data),e.tile.setMemoryDirty()}return g(e)}setBackground(e){this._backgroundColor!==e&&(this._backgroundColor=e,this._backgroundDirty=!0)}_buildTexture(e,t=M.LINEAR_MIPMAP_LINEAR){if(s(e))return null;const r={target:L.TEXTURE_2D,pixelFormat:j.RGBA,dataType:C.UNSIGNED_BYTE,wrapMode:N.CLAMP_TO_EDGE,samplingMode:t,maxAnisotropy:this._maxAnisotropy,flipped:!0,hasMipmap:!0},o=this._rctx;let a;if("number"==typeof e)r.width=r.height=e,a=new I(new O(o,r));else if(e instanceof u)r.isOpaque=e.isOpaque,a=new I(new O(o,r,e.image)),e.release();else try{r.width=e.width,r.height=e.height,a=new I(new O(o,r,e))}catch(n){a=new I(R(o)),console.warn("TileRenderer: failed to execute 'texImage2D', cross-origin image may not be loaded.")}const i=o.bindTexture(a.texture,O.TEXTURE_UNIT_FOR_UPDATES);return a.generateMipmap(),o.bindTexture(i,O.TEXTURE_UNIT_FOR_UPDATES),a}get test(){return{backgroundTexture:this._backgroundTexture}}}function G(t){const r=e(t),s=r*r,o=t*t;if(s===o)return t;const a=r/2;return s-o<o-a*a?r:a}function F(e,t){H.layerIndex=t;const r=e.layerInfo[h.MAP][t];if(o(r.data))return a(H.offset,0,0),H.tile=e,H.scale=1,H.sourceLod=e.lij,H.sourceLayerInfo=r,H;const s=r.upsampleInfo;if(o(s)){const e=s.tile.layerInfo[h.MAP][t];return H.tile=s.tile,i(H.offset,s.offset),H.scale=s.scale,H.sourceLod=s.tile.lij,H.sourceLayerInfo=e,H}return null}function S(e){return e.get("uid")}function q(e){let t="normal"!==e.blendMode;return m(e.parent)&&(t=q(e.parent)||t),t}function z(e,t){m(e.parent)&&z(e.parent,t);const r=S(e);o(r)&&""!==r&&(Y.has(r)?Y.get(r).start=t:Y.set(r,new U(t,t,e.blendMode,e.opacity)))}const X=new Array,v=new Array,V=new Array,Y=new Map,Z=new Array,H={tile:null,sourceLayerInfo:null,sourceLod:null,offset:[0,0],scale:1,layerIndex:0},J={offset:[0,0],scale:1};export{U as GroupInfo,B as TileRenderer};
