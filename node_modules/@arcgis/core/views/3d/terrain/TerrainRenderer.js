/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.25/esri/copyright.txt for details.
*/
import{_ as e}from"../../../chunks/tslib.es6.js";import t from"../../../Color.js";import i from"../../../core/Accessor.js";import{isSome as r,disposeMaybe as s,isNone as n}from"../../../core/maybe.js";import a from"../../../core/ObjectPool.js";import{property as o}from"../../../core/accessorSupport/decorators/property.js";import"../../../core/arrayUtils.js";import"../../../core/accessorSupport/ensureType.js";import{subclass as l}from"../../../core/accessorSupport/decorators/subclass.js";import{I as h}from"../../../chunks/mat4f64.js";import{b as d,s as c,e as u}from"../../../chunks/vec3.js";import{Z as p,f as g,c as _}from"../../../chunks/vec3f64.js";import{Z as f}from"../../../chunks/vec4f64.js";import{create as m,set as b}from"../../../geometry/support/aaBoundingBox.js";import{BufferViewVec3f as y}from"../../../geometry/support/buffer/BufferView.js";import{ViewingMode as T}from"../../ViewingMode.js";import{TextureUpdate as R}from"./interfaces.js";import{LayerClass as v}from"./LayerClass.js";import{OverlaySource as O}from"./Overlay.js";import{overlayRenderOccludedFlag as C}from"./OverlayRenderer.js";import{clearCaches as x}from"./PatchGeometry.js";import{PatchRenderData as D}from"./PatchRenderData.js";import{RenderOrder as P}from"./RenderOrder.js";import{ScaleRangeQueries as S}from"./ScaleRangeQueries.js";import{ENABLE_TERRAIN_INTERNAL_CHECKS as q}from"./terrainUtils.js";import{TileRenderer as E}from"./TileRenderer.js";import{TileUpdate as A}from"./TileUpdate.js";import{IteratorPreorder as N,sortTiles as w,compareTiles as j}from"./tileUtils.js";import{componentMinimalSizeForIntersectionData as I,ComponentIntersectionData as G}from"../webgl-engine/collections/Component/ComponentIntersectionData.js";import{ShaderOutput as L}from"../webgl-engine/core/shaderLibrary/ShaderOutput.js";import{OverlayMode as F}from"../webgl-engine/core/shaderLibrary/terrain/Overlay.glsl.js";import{T as U}from"../../../chunks/Terrain.glsl.js";import{TileBlendInput as k}from"../webgl-engine/core/shaderLibrary/terrain/TileBlendInput.js";import{RenderRequestType as B}from"../webgl-engine/lib/basicInterfaces.js";import{createEmptyTexture as M}from"../webgl-engine/lib/glUtil3D.js";import{newIntersectorResult as z}from"../webgl-engine/lib/Intersector.js";import{IntersectorType as V,StoreResults as H}from"../webgl-engine/lib/IntersectorInterfaces.js";import{RenderOccludedFlag as Q}from"../webgl-engine/lib/Material.js";import{RenderSlot as W}from"../webgl-engine/lib/RenderSlot.js";import{getSettings as Y}from"../webgl-engine/lib/screenSizePerspectiveUtils.js";import{VertexAttribute as X}from"../webgl-engine/lib/VertexAttribute.js";import{TERRAIN_ID as Z,getVerticalOffsetTerrain as K}from"../webgl-engine/lib/verticalOffsetUtils.js";import{DrawParameters as J}from"../webgl-engine/materials/DrawParameters.js";import{intersectAabbInvDirBefore as $,intersectTriangles as ee}from"../webgl-engine/materials/internal/MaterialUtil.js";import{TerrainTechnique as te}from"../webgl-engine/shaders/TerrainTechnique.js";import{TerrainTechniqueConfiguration as ie}from"../webgl-engine/shaders/TerrainTechniqueConfiguration.js";import{PrimitiveType as re}from"../../webgl/enums.js";const se=7,ne=10,ae=m();var oe;!function(e){e[e.Opaque=0]="Opaque",e[e.Semitransparent=1]="Semitransparent",e[e.Invisible=2]="Invisible"}(oe||(oe={}));let le=class extends i{constructor(e){super(e),this.type=V.TERRAIN,this.isGround=!0,this._tileSize=256,this._techniqueConfiguration=new ie,this._passParameters=new U,this._rctx=null,this._scaleRangeQueries=new S,this._renderDataPool=new a(D),this._patchGroups=new Map,this._patchGroupsDirty=!0,this._patchSortingDirty=!0,this._tileIterator=new N,this._highestVisibleLODTile=null,this._visible=!0,this._transparencyState=oe.Opaque,this._velvetOverground=!0,this._castShadows=!0,this._emptyTex=null,this._tileRenderer=null,this._stencilEnabledLayerExtents=new Array,this._numTilesRendered=0,this._numTilesCulled=0,this._numOriginsRendered=0,this.needsHighlight=!1,this.renderOccludedFlags=Q.Occlude}get _isGlobal(){return this._stage.viewingMode===T.Global}get shading(){return this._techniqueConfiguration.shading}set shading(e){this._techniqueConfiguration.shading=e}initialize(){const e=[W.OPAQUE_TERRAIN,W.TRANSPARENT_TERRAIN,W.OCCLUDED_TERRAIN];this._stage.addRenderPlugin(e,this)}destroy(){this._stage.removeRenderPlugin(this),x()}get canRender(){return this._visible&&!!this._rootTiles&&!this.renderingDisabled}set renderingDisabled(e){this._set("renderingDisabled",!!e),this.setDirty()}set transparency(e){this._transparencyState!==e&&(this._techniqueConfiguration.transparent=e===oe.Invisible,this._transparencyState=e,this.setNeedsRender())}get transparency(){return this._transparencyState}get needsLinearDepth(){return this._overlayRenderer.hasWater}get renderPatchBorders(){return!!this._techniqueConfiguration.tileBorders}set renderPatchBorders(e){this._techniqueConfiguration.tileBorders!==e&&(this._techniqueConfiguration.tileBorders=e,this.setNeedsRender(),this.notifyChange("renderPatchBorders"))}get visualizeNormals(){return!!this._techniqueConfiguration.visualizeNormals}set visualizeNormals(e){this._techniqueConfiguration.visualizeNormals!==e&&(this._techniqueConfiguration.visualizeNormals=e,this.setNeedsRender(),this.notifyChange("visualizeNormals"))}get cullBackFaces(){return this._techniqueConfiguration.backfaceCullingEnabled}set cullBackFaces(e){this._techniqueConfiguration.backfaceCullingEnabled!==e&&(this._techniqueConfiguration.backfaceCullingEnabled=e,this.notifyChange("cullBackFaces"),this.setNeedsRender())}set renderOrder(e){this._set("renderOrder",e),this._setSortingDirty()}set velvetOverground(e){this._velvetOverground!==e&&(this._velvetOverground=e,this.setNeedsRender())}get layerUid(){return Z}get slicePlaneEnabled(){return this._techniqueConfiguration.hasSlicePlane}set slicePlaneEnabled(e){this._techniqueConfiguration.hasSlicePlane!==e&&(this._techniqueConfiguration.hasSlicePlane=e,this.setNeedsRender())}set textureFadingEnabled(e){this._techniqueConfiguration.textureFadingEnabled!==e&&(this._techniqueConfiguration.textureFadingEnabled=e,this.setNeedsRender())}setDebugScreenSizePerspective(e){this._techniqueConfiguration.screenSizePerspective!==e&&(this._techniqueConfiguration.screenSizePerspective=e,this.setNeedsRender())}setRootTiles(e){this._rootTiles=e,this.setDirty()}setNeedsHighlight(e){this.needsHighlight=e,this.setNeedsRender()}setRenderOccludedOverlay(e){this.renderOccludedFlags=e?C:Q.Occlude,this.setNeedsRender()}setStencilEnabledLayerExtents(e){this._stencilEnabledLayerExtents=e,this._setSortingDirty()}setTileSize(e){this._tileSize=e,r(this._tileRenderer)&&(this._tileRenderer.tileSize=e),this.setDirty()}_prepareTileForLoading(e){e.renderData||(e.renderData=this._renderDataPool.acquire(),e.renderData.init(e),e.renderData.localOrigin=this._getLocalOriginOfTile(e))}loadTile(e){this._prepareTileForLoading(e),this.updateTileGeometryState(e),this.updateTileTexture(e,A.TEXTURE_FADING)}queryVisibleLevelRange(e,t,i,r){this._scaleRangeQueries.queryVisibleLevelRange(e,t,i,r),this.setNeedsRender()}updateTileTexture(e,t){r(this._tileRenderer)&&(this._tileRenderer.updateTileTexture(e,t===A.TEXTURE_FADING?R.FADING:R.UNFADED),this.setNeedsRender(),e.resetPendingUpdate(t))}updateTileGeometryState(e){for(const i of e.layerInfo[v.ELEVATION])i.pendingUpdates&=~A.GEOMETRY;e.resetPendingUpdate(A.GEOMETRY);const t=e.renderData.updateGeometryState();return t&&this.setDirty(),t}updateGeometryIfNeeded(e){e.isLoaded&&e.renderData.updateGeometryIfNeeded(this._rctx)}unloadTile(e){const t=e.renderData;t&&(t.releaseGeometry(),this._renderDataPool.release(t),t.clear(),e.renderData=null,e.setMemoryDirty(),this.setDirty())}_getLocalOriginOfTile(e){const t=ne-se,i=Math.max(0,Math.floor((e.level-t)/se)*se);if(this._isGlobal&&0===i)return p;for(;e.parent&&e.level>i;)e=e.parent;return e.centerAtSeaLevel}setVisibility(e){this._visible=e,this.setDirty()}getStats(){return{numTilesRendered:this._numTilesRendered,numTilesCulled:this._numTilesCulled,numOriginsRendered:this._numOriginsRendered}}set wireframe(e){this._get("wireframe")!==e&&(this._set("wireframe",e),this.setNeedsRender())}setDirty(e=B.UPDATE){this._patchGroupsDirty=!0,this._context.requestRender(e)}_setSortingDirty(e=B.UPDATE){this._patchSortingDirty=!0,this._context.requestRender(e)}setNeedsRender(e=B.UPDATE){this._context.requestRender(e)}initializeRenderContext(e){this._context=e,this._rctx=e.renderContext.rctx,this._techniqueRepository=e.shaderTechniqueRepository,this._tileRenderer=new E(this._rctx,this._tileSize,this._techniqueRepository),this.updateTileBackground(),this._emptyTex=M(this._rctx)}uninitializeRenderContext(){this._emptyTex=s(this._emptyTex),this._tileRenderer=s(this._tileRenderer)}intersect(e,t,i,s){if(!this._rootTiles||e.options.selectOpaqueTerrainOnly&&e.options.selectionMode&&this.transparency!==oe.Opaque)return;const a=he,o=de;d(a,s,i),c(o,1/a[0],1/a[1],1/a[2]);const l=e.results.min,p=e.results.max,g=e.results.ground,_=e.options.store===H.MIN,f=!!e.results.ground.target,m=K(e.verticalOffset),T=e.tolerance;let R,v=_&&r(l.dist)?l.dist:1/0;const O=c=>{const f=c.renderData;if(!f?.vao)return;const O=f.geometryInfo;b(ae,O.boundingBox);const C=f.localOrigin;r(m)&&(m.localOrigin=C,m.applyToAabb(ae));const x=ae;if(ce[0]=i[0]-C[0],ce[1]=i[1]-C[1],ce[2]=i[2]-C[2],!$(x,ce,o,T,v))return;const D=(e,t,i)=>{e.set(this.type,c,t,i,h),v=_&&r(l.dist)?l.dist:1/0},P=(o,h)=>{if(r(h)&&o>=0&&(e.options.backfacesTerrain||u(h,a)<0)&&(e.options.invisibleTerrain||!e.options.selectionMode||null==t||t(i,s,o))){if((null==g.dist||o<g.dist)&&D(g,o,h),e.options.isFiltered)return;e.options.store===H.ALL&&(n(R)?(R=z(e.ray),D(R,o,h),e.results.all.push(R)):o<R.dist&&D(R,o,h)),(null==l.dist||o<l.dist)&&D(l,o,h),e.options.store!==H.MIN&&(null==p.dist||o>p.dist)&&D(p,o,h)}},S=ue;d(S,s,C);const q=O.indices,E=O.vertexAttributes,A={data:E.getField(X.POSITION,y).typedBuffer,size:3,stride:E.stride/4},N=O.indexCount/3;if(n(m)&&N>I){const e=c.renderData;n(e.intersectionData)&&(e.intersectionData=new G(q,0,N,A)),e.intersectionData.intersectRay({r0:ce,r1:S},P)}else ee(ce,S,0,N,q,A,null,m,P)},C=this._rootTiles;if(r(C)){(()=>{const t=this._tileIterator;t.reset(C);const s=e.options.invisibleTerrain;for(;!t.done;){const e=t.next();!(e.visible||s&&e.intersectsClippingArea)||!r(m)&&!e.intersectsRay(i,a,T,v)||f&&this._useStencilForTile(e)?t.skipSubtree():O(e)}})()}}prepareTechnique(e){if(e.bindParameters.slot===W.OCCLUDED_TERRAIN){if(0==(e.renderOccludedMask&C))return null}else{const t=this.transparency===oe.Opaque?W.OPAQUE_TERRAIN:W.TRANSPARENT_TERRAIN;if(e.bindParameters.slot!==t)return null}switch(e.output){case L.Color:{this._techniqueConfiguration.hasScreenSpaceReflections=e.bindParameters.ssr.enabled,this._techniqueConfiguration.hasCloudsReflections=r(e.bindParameters.cloudsFade.data),this._techniqueConfiguration.receiveShadows=e.bindParameters.shadowMap.ready,this._techniqueConfiguration.receiveAmbientOcclusion=e.bindParameters.ssaoHelper.ready,this._techniqueConfiguration.overlayMode=this._overlayRenderer.isEmpty()?F.Disabled:this._overlayRenderer.hasWater?F.EnabledWithWater:F.Enabled;const t=e.bindParameters.slot===W.OCCLUDED_TERRAIN?O.Occluded:O.ColorAndWater;return this._updateTechnique(L.Color,t===O.Occluded)}case L.Shadow:case L.ShadowExludeHighlight:return this._castShadows&&1===e.bindParameters.lighting.globalFactor?(this._techniqueConfiguration.receiveShadows=this._techniqueConfiguration.receiveAmbientOcclusion=!1,this._updateTechnique(L.Shadow,!1)):null;case L.Depth:return this.transparency===oe.Invisible&&this._overlayRenderer.isEmpty()?null:(this._techniqueConfiguration.receiveShadows=this._techniqueConfiguration.receiveAmbientOcclusion=!1,this._updateTechnique(L.Depth,!1));case L.Normal:return this._techniqueConfiguration.receiveShadows=this._techniqueConfiguration.receiveAmbientOcclusion=!1,this._updateTechnique(L.Normal,!1);case L.ObjectAndLayerIdColor:return this._updateTechnique(L.ObjectAndLayerIdColor,!1);case L.Highlight:return this.needsHighlight?(this._techniqueConfiguration.receiveShadows=this._techniqueConfiguration.receiveAmbientOcclusion=!1,this._updateTechnique(L.Highlight,!1)):null}return null}render(e,t){const i=1===e.bindParameters.lighting.globalFactor;switch(this._updatePatchGroups(),t.useStencil=!1,e.output){case L.Color:{const i=e.bindParameters.slot===W.OCCLUDED_TERRAIN?O.Occluded:O.ColorAndWater;this.transparency===oe.Opaque?this._renderMaterialPass(e,t,i):e.offscreenRenderingHelper.renderToTargets((()=>this._renderMaterialPass(e,t,i)),e.offscreenRenderingHelper.tmpColor,e.offscreenRenderingHelper.mainDepth,[0,0,0,0]);break}case L.Shadow:case L.ShadowExludeHighlight:this._castShadows&&i&&this._renderAuxiliaryPass(e,t,O.None);break;case L.Depth:this.transparency===oe.Invisible&&this._overlayRenderer.isEmpty()||this._renderAuxiliaryPass(e,t,O.None);break;case L.Normal:this._renderAuxiliaryPass(e,t,O.None);break;case L.ObjectAndLayerIdColor:this._renderAuxiliaryPass(e,t,O.ObjectAndLayerIdColor);break;case L.Highlight:this.needsHighlight&&this._renderAuxiliaryPass(e,t,O.Highlight)}this._scaleRangeQueries.hasPendingQueries()&&this.setNeedsRender()}_renderMaterialPass(e,t,i){const{rctx:r}=e;this._passParameters.overlaySource=i,r.bindTechnique(t,this._passParameters,e.bindParameters),this._numTilesRendered=0,this._numTilesCulled=0,this._numOriginsRendered=0,this._scaleRangeQueries.prepareQueries(),this._renderPatchGroups(e,t,i),this._scaleRangeQueries.processQueries()}_renderAuxiliaryPass(e,t,i){const r=e.rctx;this._passParameters.overlaySource=i,r.bindTechnique(t,this._passParameters,e.bindParameters),this._renderPatchGroupsAuxiliary(e,t,i)}updateTileBackground(e=null){if(n(this._tileRenderer))return;const i=this._tileRenderer;let s=null;if(r(e)){const i=t.toUnitRGBA(e);s=g(i[0]||0,i[1]||0,i[2]||0)}i.setBackground(s),this._allTiles.forAll((e=>i.updateTileTexture(e,R.FADING))),this._techniqueConfiguration.tileBlendInput=i.backgroundIsGrid?k.GridComposite:r(i.backgroundColor)?k.ColorComposite:k.LayerOnly,this.setNeedsRender()}_updatePatchGroups(){if(this._patchGroupsDirty&&(this._highestVisibleLODTile=null,this._rebuildPatchGroups(),this._patchGroupsDirty=!1,this._patchSortingDirty=!0),this._patchSortingDirty&&this.renderOrder!==P.NONE){const e=Array.from(this._patchGroups.values());e.forEach((e=>w(this.renderOrder,e,this._stencilEnabledLayerExtents))),e.sort(((e,t)=>j(e[0],t[0],this.renderOrder))),this._patchGroups=new Map(e.map((e=>[e[0].renderData.localOrigin,e]))),this._patchSortingDirty=!1}}_rebuildPatchGroups(){const e=this._rootTiles;if(!n(e)){e[0]?.surface.checkAllTilesWaterproofness(),this._patchGroups.clear();for(const t of e)this._rebuildPatchGroupsForRootTile(t)}}_rebuildPatchGroupsForRootTile(e){const t=this._tileIterator;for(t.resetOne(e);!t.done;){const e=t.next(),i=e.renderData;if(!i||e.visible)if(e.rendered){if(i){const r=this._patchGroups.get(i.localOrigin)||new Array;this._patchGroups.set(i.localOrigin,r),r.push(e),(!this._highestVisibleLODTile||e.vlevel>this._highestVisibleLODTile.vlevel)&&(this._highestVisibleLODTile=e),t.skipSubtree()}}else this._numTilesCulled++;else this._numTilesCulled++,t.skipSubtree()}}_useStencilForTile(e){for(const t of this._stencilEnabledLayerExtents)if(e.intersectsExtent(t))return!0;return!1}_renderPatchGroupsAuxiliary(e,t,i){const r=this._stencilEnabledLayerExtents.length>0;this._patchGroups.forEach((s=>{const n=s[0].renderData.localOrigin;t.program.bindDraw(new J(n),e.bindParameters,this._passParameters);for(let a=0;a<s.length;a++)this._renderPatch(e,t,s[a],re.TRIANGLES,r,i)})),e.rctx.bindVAO(null)}_renderPatchGroups(e,t,i){const s=e.bindParameters.camera,a=t.program;if(this._techniqueConfiguration.screenSizePerspective&&this.pointsOfInterest){const e=Y(this._stage.viewingMode,this._ellipsoidRadius),t=this.pointsOfInterest.centerOnSurfaceFrequent.distance;e.update({distance:t,fovY:s.fovY})}const o=this._stencilEnabledLayerExtents.length>0,l=i===O.Occluded;l&&(a.bindTexture("tex",this._emptyTex),a.setUniform1f("blend",1),a.setUniform4fv("texOffsetAndScale",f));const h=r(this._tileRenderer)&&r(this._tileRenderer.backgroundColor)?this._tileRenderer.backgroundColor:p;this._techniqueConfiguration.tileBlendInput===k.ColorComposite&&a.setUniform3fv("backgroundColor",h);const d=this.wireframe?re.LINES:re.TRIANGLES;this._techniqueConfiguration.textureFadingEnabled&&a.bindTexture("texNext",this._emptyTex),this._patchGroups.forEach((s=>{const h=s[0].renderData.localOrigin;t.program.bindDraw(new J(h),e.bindParameters,this._passParameters),this._numOriginsRendered++;for(let c=0;c<s.length;c++){const h=s[c],u=h.renderData.textureReference;if(!n(u)){if(!l){this._scaleRangeQueries.scaleQueriesForTile(h),a.setUniform4fv("texOffsetAndScale",u.offsetAndScale),a.bindTexture("tex",u.texture.texture);const e=h.renderData.textureFadeFactor,t=e<1?h.renderData.nextTextureReference:null;this._techniqueConfiguration.textureFadingEnabled&&r(t)&&e<1?(a.setUniform1f("fadeFactor",e),a.setUniform4fv("nextTexOffsetAndScale",t.offsetAndScale),a.setUniform3fv("nextTexOpacities",t.opacities),a.bindTexture("texNext",t.texture.texture)):a.setUniform1f("fadeFactor",1),h.renderData.textureIsFading&&this.setNeedsRender(),a.setUniform3fv("textureOpacities",u.opacities)}this._renderPatch(e,t,h,d,o,i),h.renderOrder=this._numTilesRendered,this._numTilesRendered++}}})),e.rctx.bindVAO(null)}_renderPatch(e,t,i,r,s,a){const o=i.renderData,l=o.vao,h=l.indexBuffer;if(n(h))return void(q&&console.error("Rendered tile with no indices: ",i.lij," : ",o));const d=t.program;a!==O.None&&this._bindOverlayPatchData(d,o.overlay),s&&(t.useStencil=this._useStencilForTile(i),t.bindPipelineState(e.rctx,e.bindParameters.slot));const c=o.geometryInfo.indexCount;e.rctx.bindVAO(l),d.assertCompatibleVertexAttributeLocations(l),e.rctx.drawElements(r,c,h.indexType,0)}_bindOverlayPatchData(e,t){e.setUniform4fv("overlayTexOffset",t.offsets),e.setUniform4fv("overlayTexScale",t.scales)}_updateTechnique(e,t){return this._techniqueConfiguration.output=e,e===L.Color&&(this._techniqueConfiguration.atmosphere=this._isGlobal&&this._velvetOverground),this._techniqueConfiguration.renderOccluded=t,this._techniqueConfiguration.stencilEnabled=!1,this._shaderTechnique=this._techniqueRepository.releaseAndAcquire(te,this._techniqueConfiguration,this._shaderTechnique),this._shaderTechnique}get test(){return{tileRenderer:this._tileRenderer}}};e([o({constructOnly:!0})],le.prototype,"_overlayRenderer",void 0),e([o({constructOnly:!0})],le.prototype,"_stage",void 0),e([o({readOnly:!0})],le.prototype,"_isGlobal",null),e([o({constructOnly:!0})],le.prototype,"_allTiles",void 0),e([o({constructOnly:!0})],le.prototype,"_ellipsoidRadius",void 0),e([o({value:!1})],le.prototype,"renderingDisabled",null),e([o()],le.prototype,"renderPatchBorders",null),e([o()],le.prototype,"visualizeNormals",null),e([o()],le.prototype,"cullBackFaces",null),e([o({value:P.FRONT_TO_BACK})],le.prototype,"renderOrder",null),e([o()],le.prototype,"wireframe",null),le=e([l("esri.views.3d.terrain.TerrainRenderer")],le);const he=_(),de=_(),ce=_(),ue=_();export{le as TerrainRenderer,oe as TransparencyMode};
