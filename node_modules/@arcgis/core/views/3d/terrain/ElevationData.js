/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.25/esri/copyright.txt for details.
*/
import{clamp as t}from"../../../core/mathUtils.js";import{isNone as a}from"../../../core/maybe.js";import{ElevationSamplerData as o}from"../../../layers/support/ElevationSamplerData.js";import{bilerp as s}from"../support/mathUtils.js";import{ELEVATION_NODATA_VALUE as e}from"./TerrainConst.js";class r{constructor(t,a,s){this.type="elevation",this.level=t[0],this.i=t[1],this.j=t[2],this.extent=a;const e=s.noDataValue,r=s.values;let i=1/0,l=-1/0,n=!0,h=!1;for(let o=0;o<r.length;o++){const t=r[o];t!==e?(i=t<i?t:i,l=t>l?t:l,n=!1):h=!0}n&&(i=0,l=0),l=l>-3e38?l:0,this.samplerData=new o(s,a),this.bounds=[i,l],this.hasNoDataValues=h}release(){this.samplerData=null,this.bounds=null}computeMinMaxValue(t,a,o,r){r.min=1/0,r.max=-1/0,r.hasNoDataValues=!1;const i=t-this.level;if(i<=0)return r;const l=2**i;if(!(Math.floor(a/l)===this.i&&Math.floor(o/l)===this.j))return r;let n=1/0,h=-1/0;const m=this.samplerData.width,f=this.samplerData.pixelData,u=.5*e;let c=(m-1)/l,p=(o-this.j*l)*c,M=(a-this.i*l)*c;if(c<1){const t=Math.floor(p),a=Math.floor(M),o=t+a*m,e=f[o],i=f[o+1],l=f[o+m],n=f[o+m+1];if(e+i+l+n<u){const o=p-t,h=M-a,m=s(e,i,l,n,o,h),f=s(e,i,l,n,o+c,h),u=s(e,i,l,n,o,h+c),x=s(e,i,l,n,o+c,h+c);return r.min=Math.min(m,f,u,x),r.max=Math.max(m,f,u,x),r}p=t,M=a,c=1}else p=Math.floor(p),M=Math.floor(M),c=Math.ceil(c);for(let s=p;s<=p+c;s++)for(let t=M;t<=M+c;t++){const a=f[s+t*m];a<u?(n=Math.min(n,a),h=Math.max(h,a)):r.hasNoDataValues=!0}return r.min=n,r.max=h,r}}const i=.5*e;function l(o,s,e){if(a(e))return null;for(const a of e){if(!a)continue;const e=a.safeWidth;let r=t(a.dy*(a.y1-s),0,e),l=t(a.dx*(o-a.x0),0,e);const n=Math.floor(r),h=Math.floor(l),m=a.width,f=n*m+h,u=a.pixelData,c=u[f],p=u[f+1],M=f+m,x=u[M],D=u[M+1];if(c+x+p+D<i){r-=n,l-=h;const t=c+(p-c)*l;return t+(x+(D-x)*l-t)*r}}return null}export{r as ElevationData,l as sampleElevation};
