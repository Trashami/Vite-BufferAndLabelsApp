/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.25/esri/copyright.txt for details.
*/
import{_ as t}from"../../../../../chunks/tslib.es6.js";import{isSome as e}from"../../../../../core/maybe.js";import{Milliseconds as i}from"../../../../../core/time.js";import"../../../../../core/Logger.js";import"../../../../../core/accessorSupport/ensureType.js";import"../../../../../core/arrayUtils.js";import"../../../../../core/Error.js";import"../../../../../core/has.js";import{subclass as o}from"../../../../../core/accessorSupport/decorators/subclass.js";import{c as r,b as s,n as a,e as n,l as m,a as c,g as p,h}from"../../../../../chunks/vec3.js";import{c as l,f as _}from"../../../../../chunks/vec3f64.js";import{applyAll as y}from"../../../camera/constraintUtils.js";import{ConstraintTypes as C}from"../../../camera/constraintUtils/ConstraintTypes.js";import{InteractionType as f}from"../../../camera/constraintUtils/InteractionType.js";import{TiltMode as j}from"../../../camera/constraintUtils/TiltMode.js";import{PointToPointAnimationController as u}from"../PointToPointAnimationController.js";import{Camera as g}from"../../../webgl-engine/lib/Camera.js";import{newIntersector as w}from"../../../webgl-engine/lib/Intersector.js";import{TERRAIN_ID as b}from"../../../webgl-engine/lib/verticalOffsetUtils.js";import{outExpo as v}from"../../../../animation/easing.js";const L=.6,d=4,M=60,z=14,S=200;let F=class extends u{constructor(){super(...arguments),this._zoomLocation=l(),this._tmpCamera=new g,this._tmpRayDir=l(),this._tmpCenter=l(),this._constraintOptions={selection:C.ALL,interactionType:f.ZOOM,interactionFactor:null,interactionStartCamera:new g,interactionDirection:null,tiltMode:j.TUMBLE}}zoomStep(t,i){if(!this.active)return;const o=this.view.state,{interactionStartCamera:h}=this._constraintOptions;this.animation.finished?h.copyFrom(o.camera):this.animation.cameraAt(1,h),this._tmpCamera.copyFrom(o.camera);const _=w(this.view.state.viewingMode);t>0?(0===this.view.map.ground.opacity?this.intersectionHelper.intersectScreenFreePointFallback(i,this._zoomLocation,T):this.intersectionHelper.intersectScreenFreePointFallback(i,this._zoomLocation),this.intersectionHelper.intersectRay(this._tmpCamera.ray,_,this._tmpCenter)&&(this._tmpCamera.center=this._tmpCenter)):this.intersectionHelper.intersectRay(this._tmpCamera.ray,_,this._zoomLocation)?this._tmpCamera.center=this._zoomLocation:r(this._zoomLocation,this._tmpCamera.center);const y=L**t;let C=this.view._stage.renderView.getMinimalDepthForArea(this.view.voxelWasm,i[0],i[1],this.view.state.camera,M);s(x,this._tmpCamera.eye,this._zoomLocation),a(x,x);const f=Math.max(Math.min(z,1/Math.abs(n(R,x)))*Math.abs(this.view.camera.position.z),S);if(C=e(C)?Math.min(C,f):f,C){const t=l();s(t,this._zoomLocation,this._tmpCamera.eye),C<m(t)&&(a(t,t),c(this._zoomLocation,this._tmpCamera.eye,p(t,t,C)))}this._updateCamera(this._tmpCamera,y,this._zoomLocation),this.begin(this._tmpCamera)}animationSettings(){return{apex:null,duration:i(600),easing:v}}_updateCamera(t,e,i){s(this._tmpRayDir,i,t.eye);const o=m(this._tmpRayDir);let r=o*e;const a=e<=1,n=Math.max(d,1.01*t.nearFar[0]);0!==r&&(a&&r<n&&(r=n,e=r/o),Math.abs(o-r)<1e-6||(p(this._tmpRayDir,this._tmpRayDir,e),t.eye=s(D,i,this._tmpRayDir),t.center=h(D,t.center,i,1-e),y(this.view,t,this._constraintOptions)))}};F=t([o("esri.views.3d.state.controllers.local.ZoomStepController")],F);const D=l(),R=_(0,0,1),x=l(),T={exclude:new Set([b])};export{F as ZoomStepController};
