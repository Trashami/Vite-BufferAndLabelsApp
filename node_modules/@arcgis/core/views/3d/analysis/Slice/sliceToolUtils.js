/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.25/esri/copyright.txt for details.
*/
import"../../../../geometry.js";import t from"../../../../analysis/SlicePlane.js";import"../../../../core/has.js";import e from"../../../../core/Logger.js";import{rad2deg as i,deg2rad as n}from"../../../../core/mathUtils.js";import{isNone as r,isSome as s}from"../../../../core/maybe.js";import{castRenderScreenPointArray3 as o}from"../../../../core/screenUtils.js";import{o as a,b as c,k as l,m as u,r as d,i as m,v as p,D as g}from"../../../../chunks/mat4.js";import{c as f}from"../../../../chunks/mat4f64.js";import{r as b}from"../../../../chunks/quat.js";import{g as h,c as T,e as E,f as O,n as I,a as R,l as w,b as A,s as j,p as y,y as M}from"../../../../chunks/vec3.js";import{a as L,c as _,f as k}from"../../../../chunks/vec3f64.js";import{tryProjectWithZConversion as C}from"../../../../geometry/projection.js";import{Axis as N}from"../../../../geometry/support/Axis.js";import{r as P,f as v,i as U,a as V,n as S,u as F}from"../../../../chunks/boundedPlane.js";import{fromVectorsAndPoint as H,fromPositionAndNormal as x}from"../../../../geometry/support/plane.js";import{create as G}from"../../../../geometry/support/ray.js";import{angleAroundAxis as D}from"../../../../geometry/support/vector.js";import{sv3d as X,sm4d as Y,sq4d as Z}from"../../../../geometry/support/vectorStacks.js";import{VERTICAL_DOT_THRESHOLD as W,SMALL_ANGLE_DOT_THRESHOLD as B,PLANE_MIN_BASIS_SCREEN_LEN2 as q,INITIAL_PLANE_HALF_SIZE_VIEW_PROPORTION as z,SHIFT_RESTART_OFFSET_DISTANCE as $,RESIZE_HANDLE_EDGE_PADDING_FRAC as J,SHIFT_RESTART_ARROW_TIP_COLOR as K,SHIFT_RESTART_ARROW_CAP_COLOR as Q,SHIFT_RESTART_TUBE_COLOR as tt,SHIFT_RESTART_OUTLINE_COLOR as et,SHIFT_RESTART_CALLOUT_COLOR as it,SHIFT_RESTART_TIP_RADIUS as nt,PLANE_OUTLINE_COLOR as rt,PLANE_OUTLINE_WIDTH as st,PLANE_BACKGROUND_COLOR as ot,GRID_COLOR as at,RESIZE_HANDLE_CORNER_INPUT_RADIUS as ct,RESIZE_HANDLE_EDGE_INPUT_RADIUS as lt,SHIFT_RESTART_TIP_LENGTH as ut,SHIFT_RESTART_ARROW_LENGTH as dt,SHIFT_RESTART_TUBE_RADIUS as mt,SHIFT_RESTART_TUBE_FOCUS_MULTIPLIER as pt,SHIFT_RESTART_TIP_FOCUS_MULTIPLIER as gt,SHIFT_RESTART_ARROW_OUTLINE_WIDTH as ft,RESIZE_HANDLE_CORNER_WIDTH as bt,RESIZE_HANDLE_EDGE_WIDTH as ht,DISPLAY_FOCUS_MULTIPLIER as Tt,RESIZE_HANDLE_COLOR as Et}from"./sliceToolConfig.js";import{applyProjectionAndElevationAlignment as Ot}from"../support/projectionUtils.js";import{Manipulator3D as It}from"../../interactive/Manipulator3D.js";import{calculateTranslateRotateFromBases as Rt,createRotateManipulator as wt,worldScaledManipulatorSettings as At}from"../../interactive/manipulatorUtils.js";import{LineVisualElement as jt}from"../../interactive/visualElements/LineVisualElement.js";import{SlicePlaneVisualElement as yt}from"../../interactive/visualElements/SlicePlaneVisualElement.js";import{RenderCoordsHelper as Mt}from"../../support/RenderCoordsHelper.js";import{fromRender as Lt}from"../../support/geometryUtils/ray.js";import{CullFaceOptions as _t}from"../../webgl-engine/lib/basicInterfaces.js";import{createPolylineGeometry as kt,createExtrudedTriangle as Ct,createConeGeometry as Nt,createPathExtrusionGeometry as Pt}from"../../webgl-engine/lib/GeometryUtil.js";import{RenderOccludedFlag as vt}from"../../webgl-engine/lib/Material.js";import{ColorMaterial as Ut}from"../../webgl-engine/materials/ColorMaterial.js";import{NativeLineMaterial as Vt}from"../../webgl-engine/materials/NativeLineMaterial.js";import{RibbonLineMaterial as St}from"../../webgl-engine/materials/RibbonLineMaterial.js";import{ManipulatorStateCustomFlags as Ft,ManipulatorStateFlags as Ht}from"../../../interactive/interfaces.js";import xt from"../../../../geometry/Extent.js";function Gt(t,e,i,n,r,s,o,a){return Dt(e,o.worldUpAtPosition(t,X.get()),r,s,a.basis1,a.basis2),h(a.basis1,a.basis1,i),h(a.basis2,a.basis2,n),T(a.origin,t),H(a.basis2,a.basis1,a.origin,a.plane),a}function Dt(t,e,i,n,r,s){const o=E(t,e),a=X.get(),c=X.get();switch(n===we.HORIZONTAL_OR_VERTICAL?Math.abs(o)>W?we.HORIZONTAL:we.VERTICAL:n){case we.VERTICAL:{const n=Math.abs(o)<=B?t:i.viewUp;O(a,n,e),T(c,e);break}case we.HORIZONTAL:O(a,i.viewUp,e),O(c,e,a);break;case we.TILTED:{const n=Math.abs(o)<=B?e:i.viewUp;O(a,n,t),O(c,t,a);break}}const l=O(X.get(),a,c);E(l,i.viewForward)>0&&h(c,c,-1),I(r,a),I(s,c)}function Xt(t,e,i){const n=e.worldUpAtPosition(t.origin,X.get()),r=t.basis1,s=be(t,n),o=Math.round(s/ye)*ye;return P(t,o-s,r,i)}function Yt(t,e,i,n,r,s){const o=T(X.get(),r.origin);R(o,o,h(X.get(),r.basis1,t.direction[0]<0?1:-1)),R(o,o,h(X.get(),r.basis2,t.direction[1]<0?1:-1));const a=w(r.basis1),c=w(r.basis2),l=A(X.get(),i,o),u=A(X.get(),e,o);let d=0,m=0;if(se(t)){const e=re(r),i=re(s);d=a-.5*t.direction[0]*E(r.basis1,u)/a,m=c-.5*t.direction[1]*E(r.basis2,u)/c;const n=i/e;d*=n,m*=n}const p=d+.5*t.direction[0]*E(r.basis1,l)/a,g=m+.5*t.direction[1]*E(r.basis2,l)/c,f=h(X.get(),r.basis1,p/a),b=h(X.get(),r.basis2,g/c);(p<=0||ie(s.origin,f,n)<=q)&&T(f,s.basis1),(g<=0||ie(s.origin,b,n)<=q)&&T(b,s.basis2);const O=T(X.get(),o);return R(O,O,h(X.get(),f,t.direction[0]<0?-1:1)),R(O,O,h(X.get(),b,t.direction[1]<0?-1:1)),v(O,f,b,s)}function Zt(t,e){return z*Math.min(e.width,e.height)*e.computeRenderPixelSizeAt(t)}function Wt(t,e,i,n){const r=O(X.get(),e,i);return O(r,r,e),x(t,r,n)}function Bt(t,e){return Rt(t.basis1,t.basis2,t.origin,e)}function qt(t,e,i,n){const r=e.worldUpAtPosition(t.origin,X.get()),s=X.get();switch(i){case Re.HEADING:T(s,r);break;case Re.TILT:T(s,t.basis1)}return x(t.origin,s,n)}function zt(t,e,i,n){const r=ee(i,te.NEGATIVE_X),s=Y.get();a(s,e,r.edge*Math.PI/2);const c=I(X.get(),r.basis);let l=h(X.get(),c,r.direction*n.computeScreenPixelSizeAt(r.position)*$);R(l,l,r.position);const u=n.projectToRenderScreen(l,o(X.get())),d=$t(n,u);Lt(n,u,je),I(je.direction,je.direction);const m=X.get();!d&&U(i,je,m)&&(l=m),s[12]=0,s[13]=0,s[14]=0,t.modelTransform=s,t.renderLocation=L(l),d?t.state|=Ae:t.state&=~Ae}function $t(t,e){const[i,n,r,s]=t.viewport,o=Math.min(r,s)/16;let a=!0;return e[0]<i+o?(e[0]=i+o,a=!1):e[0]>i+r-o&&(e[0]=i+r-o,a=!1),e[1]<n+o?(e[1]=n+o,a=!1):e[1]>n+s-o&&(e[1]=n+s-o,a=!1),a}function Jt(t,e,i,n){const r=w(n.basis1),s=w(n.basis2),o=ne(n),a=re(n),d=j(X.get(),0,0,0);R(d,h(X.get(),n.basis1,e.direction[0]),h(X.get(),n.basis2,e.direction[1])),R(d,n.origin,d);let m=0,p=1;if(se(e))1===e.direction[0]&&-1===e.direction[1]?m=ye:1===e.direction[0]&&1===e.direction[1]?m=Math.PI:-1===e.direction[0]&&1===e.direction[1]&&(m=3*Math.PI/2),p=a;else{const t=0!==e.direction[0]?1:2;m=1===t?ye:0,p=(1===t?s:r)-o}const g=c(Y.get(),m);l(g,g,j(X.get(),p,p,p)),u(g,i,g),g[12]=0,g[13]=0,g[14]=0,t.modelTransform=g,t.renderLocation=d}function Kt(t,e,i,n){const r=n.worldUpAtPosition(i.origin,X.get()),s=ee(i,te.POSITIVE_X),o=c(Y.get(),s.edge*Math.PI/2);d(o,o,-be(i,r)),u(o,e,o),o[12]=0,o[13]=0,o[14]=0,t.modelTransform=o,t.renderLocation=s.position}function Qt(t,e,i){const n=ee(i,te.POSITIVE_Y),r=c(Y.get(),n.edge*Math.PI/2);d(r,r,ye),u(r,e,r),r[12]=0,r[13]=0,r[14]=0,t.modelTransform=r,t.renderLocation=n.position}var te;function ee(t,e){switch(e){case te.POSITIVE_X:return{basis:t.basis1,direction:1,position:R(X.get(),t.origin,t.basis1),edge:e};case te.POSITIVE_Y:return{basis:t.basis2,direction:1,position:R(X.get(),t.origin,t.basis2),edge:e};case te.NEGATIVE_X:return{basis:t.basis1,direction:-1,position:A(X.get(),t.origin,t.basis1),edge:e};case te.NEGATIVE_Y:return{basis:t.basis2,direction:-1,position:A(X.get(),t.origin,t.basis2),edge:e}}}function ie(t,e,i){const n=i.projectToRenderScreen(R(X.get(),t,e),o(X.get())),r=i.projectToRenderScreen(A(X.get(),t,e),o(X.get()));return y(A(n,n,r))}function ne(t){const e=w(t.basis1),i=w(t.basis2);return J*Math.min(e,i)}function re(t){return ne(t)}function se(t){return 0!==t.direction[0]&&0!==t.direction[1]}function oe(t,e=_e.CENTER_ON_ARROW){const i=e===_e.CENTER_ON_CALLOUT?$:0,n=[k(i,0,-dt/2),k(i,0,dt/2)],r=pe(n,!0),s=(t,e)=>de(n,n,{tubeRadius:mt,tipRadius:nt,tipLength:ut,tubeFocusMultiplier:pt,tipFocusMultiplier:gt,padding:t,bothEnds:!0,flat:null,focusTipLength:!0,addCap:e}),o=s(0,!1),a=s(ft,!0),c=new Ut({color:K,cullFace:_t.Back,renderOccluded:vt.Opaque}),l=new Ut({color:Q,cullFace:_t.Back,renderOccluded:vt.Opaque}),u=new Ut({color:tt,cullFace:_t.Back,renderOccluded:vt.Opaque}),d=new Ut({color:et,transparent:!0,writeDepth:!1,cullFace:_t.Front,renderOccluded:vt.Transparent}),m=kt([[i,0,0],[i-$,0,0]]),p=kt([[i,0,0],[i-$,0,0]]),g=new Vt({color:it,renderOccluded:vt.OccludeAndTransparent});return new It({view:t,renderObjects:[...o.normal.map((({part:t,geometry:e,transform:i})=>({geometry:e,material:"tip"===t?c:"cap"===t?l:u,transform:i,stateMask:Ht.Unfocused|Ie}))),...a.normal.map((({geometry:t,transform:e})=>({geometry:t,material:d,transform:e,stateMask:Ht.Unfocused|Ie}))),{geometry:m,material:g,stateMask:Ht.Unfocused|Ie|Ae},...o.focused.map((({part:t,geometry:e,transform:i})=>({geometry:e,material:"tip"===t?c:"cap"===t?l:u,transform:i,stateMask:Ht.Focused|Ie}))),...a.focused.map((({geometry:t,transform:e})=>({geometry:t,material:d,transform:e,stateMask:Ht.Focused|Ie}))),{geometry:p,material:g,stateMask:Ht.Focused|Ie|Ae}],autoScaleRenderObjects:!1,collisionType:{type:"line",paths:[r]},collisionPriority:1,radius:nt,state:Ie})}function ae(t,e){const i=wt(t,{customStateMask:Ie,texture:e});return i.state=Ie,i}function ce(t){const e=[[-1,-1,0],[1,-1,0],[1,1,0],[-1,1,0],[-1,-1,0]];return new jt({view:t,attached:!1,color:rt,width:st,writeDepthEnabled:!1,renderOccluded:vt.OccludeAndTransparent,geometry:[e]})}function le(t){return new yt({view:t,attached:!1,backgroundColor:[...ot],gridColor:at,gridWidth:4,renderOccluded:vt.OccludeAndTransparent})}function ue(t,e){const i=se(e),n=i?[k(1,0,0),k(0,0,0),k(0,1,0)]:[k(1,0,0),k(-1,0,0)],r=kt(n),s=Et,o=t=>new St({color:s,width:t,renderOccluded:vt.OccludeAndTransparent}),a=()=>new Vt({color:s,renderOccluded:vt.OccludeAndTransparent}),c=i?bt:ht,l=c*Tt,u=ht,d=t=>t>1?o(t):a(),m=[{geometry:r,material:d(c),stateMask:Ht.Unfocused|Me},{geometry:r,material:d(l),stateMask:Ht.Focused|Me},{geometry:r,material:d(u),stateMask:Le}],p=new It({view:t,renderObjects:m,collisionType:{type:"line",paths:[n]},radius:i?ct:lt,...At});return p.state=Me,p}function de(t,e,i){const n=n=>{const r=(n?e:t).slice(0),o=A(X.get(),r[0],r[1]);I(o,o);const a=A(X.get(),r[r.length-1],r[r.length-2]);if(I(a,a),i.padding>0){const t=h(_(),a,-i.padding);if(r[r.length-1]=R(t,t,r[r.length-1]),i.bothEnds){const t=h(_(),o,-i.padding);r[0]=R(t,t,r[0])}}const c=n?i.tipFocusMultiplier:1,d=i.tipLength*(i.focusTipLength?c:1),T=i.tipRadius*c,E=m(Y.get());if(i.padding>0){const t=d/4,e=j(X.get(),0,t,0),n=1+i.padding/t;p(E,E,e),l(E,E,j(X.get(),n,n,n)),p(E,E,h(e,e,-1/n))}const O=m(f()),w=k(0,1,0),y=g(f(),b(Z.get(),w,a));y[12]=r[r.length-1][0],y[13]=r[r.length-1][1],y[14]=r[r.length-1][2],u(y,y,E);const M=[{part:"tube",geometry:me(i.tubeRadius*(n?i.tubeFocusMultiplier:1)+i.padding,i.flat,r),transform:O}];let L,C;if(s(i.flat)?L=Ct(d,T,T,i.flat.thickness):(L=Nt(d,T,24,!1,!1,!0),C=Nt(d,T,24,!1,!0,!1)),M.push({part:"tip",geometry:L,transform:y}),C&&M.push({part:"cap",geometry:C,transform:y}),i.bothEnds){const t=g(f(),b(Z.get(),w,o));t[12]=r[0][0],t[13]=r[0][1],t[14]=r[0][2],u(t,t,E),M.push({part:"tip",geometry:L,transform:t}),C&&M.push({part:"cap",geometry:C,transform:t})}return M};return{normal:n(!1),focused:n(!0)}}function me(t,e,i){const n=[];if(s(e))n.push([t,e.thickness/2],[-t,e.thickness/2],[-t,-e.thickness/2],[t,-e.thickness/2]);else{const e=12;for(let i=0;i<e;i++){const r=i/e*2*Math.PI;n.push([Math.cos(r)*t,Math.sin(r)*t])}}return Pt(n,i,[],[],!1)}function pe(t,e){const i=A(_(),t[t.length-1],t[t.length-2]);if(I(i,i),h(i,i,ut),R(i,i,t[t.length-1]),e){const e=A(_(),t[0],t[1]);return I(e,e),h(e,e,ut),R(e,e,t[0]),[e,...t,i]}return[...t,i]}function ge(e,n,s,o=new t){if(r(e))return null;const{renderCoordsHelper:a}=n,c=a.fromRenderCoords(e.origin,n.spatialReference);if(r(c))return null;const l=C(c,s);if(r(l))return null;o.position=l;const u=2*w(e.basis1),d=2*w(e.basis2),m=Mt.renderUnitScaleFactor(n.spatialReference,s);o.width=u*m,o.height=d*m;const p=a.worldUpAtPosition(e.origin,X.get());return o.tilt=i(be(e,p)),o.heading=a.headingAtPosition(e.origin,e.basis1)-90,o}function fe(t,e,i){if(r(t))return null;const n=t.origin,s=X.get(),o=X.get(),a=X.get(),c=X.get();let l,u,d,m,p,g;R(s,n,t.basis1),R(s,s,t.basis2),R(o,n,t.basis1),M(o,o,t.basis2),M(a,n,t.basis1),M(a,a,t.basis2),M(c,n,t.basis1),R(c,c,t.basis2);for(const f of[s,o,a,c]){const t=e.fromRenderCoords(f,f,i);if(r(t))return null;l=null==l?t[0]:Math.min(l,t[0]),u=null==u?t[0]:Math.max(u,t[0]),d=null==d?t[1]:Math.min(d,t[1]),m=null==m?t[1]:Math.max(m,t[1]),p=null==p?t[2]:Math.min(p,t[2]),g=null==g?t[2]:Math.max(g,t[2])}return new xt({xmin:l,xmax:u,ymin:d,ymax:m,zmin:p,zmax:g,spatialReference:i})}function be(t,e){return D(e,t.basis2,t.basis1)+ye}function he(t,i,r,s,o,a,c=V()){return a.toRenderCoords(t,c.origin)?(a.worldBasisAtPosition(c.origin,N.X,c.basis1),a.worldBasisAtPosition(c.origin,N.Y,c.basis2),H(c.basis2,c.basis1,c.origin,c.plane),P(c,-n(i),S(c),c),P(c,n(r),c.basis1,c),h(c.basis1,c.basis1,s/2),h(c.basis2,c.basis2,o/2),F(c),c):(e.getLogger("esri.views.3d.analysis.Slice.sliceToolUtils").error(`Failed to project slice plane position, projection from ${t.spatialReference.wkid} is not supported`),null)}function Te(t,e){if(r(t)||r(t.position))return null;const i=Ot(t.position,e.spatialReference,e.elevationProvider);if(r(i))return null;const n=Mt.renderUnitScaleFactor(t.position.spatialReference,e.spatialReference),s=t.width*n,o=t.height*n;return{position:i,heading:t.heading,tilt:t.tilt,renderWidth:s,renderHeight:o}}function Ee(t,e,i,n=V()){const s=Te(t,e);return r(s)?null:Oe(s,e,i,n)}function Oe(t,e,i,n=V()){if(r(t))return null;const o=he(t.position,t.heading,t.tilt,t.renderWidth,t.renderHeight,e.renderCoordsHelper,n);return!i.tiltEnabled&&s(o)&&Xt(o,e.renderCoordsHelper,o),o}!function(t){t[t.POSITIVE_X=0]="POSITIVE_X",t[t.POSITIVE_Y=1]="POSITIVE_Y",t[t.NEGATIVE_X=2]="NEGATIVE_X",t[t.NEGATIVE_Y=3]="NEGATIVE_Y"}(te||(te={}));const Ie=Ft.Custom1;var Re,we;!function(t){t[t.HEADING=1]="HEADING",t[t.TILT=2]="TILT"}(Re||(Re={})),function(t){t[t.HORIZONTAL_OR_VERTICAL=0]="HORIZONTAL_OR_VERTICAL",t[t.HORIZONTAL=1]="HORIZONTAL",t[t.VERTICAL=2]="VERTICAL",t[t.TILTED=3]="TILTED"}(we||(we={}));const Ae=Ft.Custom2,je=G(),ye=Math.PI/2,Me=Ft.Custom1,Le=Ft.Custom2;var _e;function ke(t){const e="building-scene-3d"===t.type?t:null;return s(e)}!function(t){t[t.CENTER_ON_CALLOUT=0]="CENTER_ON_CALLOUT",t[t.CENTER_ON_ARROW=1]="CENTER_ON_ARROW"}(_e||(_e={}));export{Ie as DidPointerMoveRecentlyFlag,Ae as IsShiftEdgeOnScreenFlag,_e as OffsetMode,Re as RotationAxis,we as SliceOrientation,pe as addArrowTips,Bt as calculateBoundedPlaneTranslateRotate,re as calculateDiagonalResizeHandleScale,Zt as calculatePlaneHalfSize,ne as calculateResizeHandlePadding,ie as calculateScreenSpaceBasisLength2,de as createArrowGeometry,le as createGridVisualElement,ce as createOutlineVisualElement,Gt as createPlane,ue as createResizeManipulator,ae as createRotateManipulator,qt as createRotatePlane,oe as createShiftManipulator,Wt as createShiftPlane,Xt as forceHorizontalOrVertical,se as isDiagonalResizeHandle,ke as isIBuildingSceneLayerView3D,Dt as normalToBases,fe as planeToExtent,ge as planeToShape,Te as projectAndElevationAlignShape,Oe as projectedShapeToPlane,Me as resizeNormal,Le as resizeOutlineOnly,Yt as resizePlane,Ee as shapeToPlane,Jt as updateResizeHandle,Kt as updateRotateHeadingHandle,Qt as updateRotateTiltHandle,zt as updateShiftRestartHandle};
