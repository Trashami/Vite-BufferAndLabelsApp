/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.25/esri/copyright.txt for details.
*/
import{_ as t}from"../../../../chunks/tslib.es6.js";import e from"../../../../Color.js";import"../../../../geometry.js";import{LengthDimensionMeasureType as i}from"../../../../analysis/dimensionUtils.js";import a from"../../../../analysis/LengthDimension.js";import{HandleOwner as n}from"../../../../core/HandleOwner.js";import s from"../../../../core/Handles.js";import{equals as o}from"../../../../core/lang.js";import{isNone as r,isSome as p,destroyMaybe as l,applySome as d}from"../../../../core/maybe.js";import{ignoreAbortErrors as u}from"../../../../core/promiseUtils.js";import{watch as c,sync as m,syncAndInitial as h,initial as g,when as f}from"../../../../core/reactiveUtils.js";import{property as _}from"../../../../core/accessorSupport/decorators/property.js";import"../../../../core/accessorSupport/ensureType.js";import{subclass as M}from"../../../../core/accessorSupport/decorators/subclass.js";import{c as y}from"../../../../chunks/vec3f64.js";import{clonePoint as v}from"../../../../layers/graphics/hydratedFeatures.js";import{computeConstraint as S,LengthDimensionConstraint as w,applyConstraint as C}from"./lengthDimensionConstraintUtils.js";import{LengthDimensionManipulators as b,createPointManipulator as P,pointManipulatorHandles as D,createOffsetManipulator as O,offsetManipulatorHandles as H,createOrientationManipulator as j,headingManipulatorHandles as T,rotationManipulatorHandles as G,createMeasureTypeManipulator as I,measureTypeManipulatorHandles as z,updateOffsetManipulatorTransform as x,updateHeadingManipulatorTransform as V,updateRotationManipulatorTransform as U,updateMeasureTypeManipulatorTransform as R,unfocusedOffsetWidth as k,focusedOffsetWidth as E,updateOrientationManipulator as A}from"./lengthDimensionManipulatorUtils.js";import{isValidComputation as F,arePointsVerticallyAligned as L,computeGeometryFromDimension as q,computationToGeometryDependencies as B}from"./lengthDimensionUtils.js";import{settings as N}from"./settings.js";import{getRotateHeadingTexture as J}from"../Slice/images/Factory.js";import{SnappingVisualizer3D as K}from"../../interactive/SnappingVisualizer3D.js";import{LineVisualElement as Q}from"../../interactive/visualElements/LineVisualElement.js";import{VerticesVisualElement as W}from"../../interactive/visualElements/VerticesVisualElement.js";import{RenderOccludedFlag as X}from"../../webgl-engine/lib/Material.js";import{ImageMaterial as Y}from"../../webgl-engine/materials/ImageMaterial.js";import{createStipplePatternSimple as Z}from"../../webgl-engine/materials/lineStippleUtils.js";import{RibbonLineMaterial as $}from"../../webgl-engine/materials/RibbonLineMaterial.js";import{createCoordinateHelper as tt}from"../../../interactive/coordinateHelper.js";import{EditGeometry as et}from"../../../interactive/editGeometry/EditGeometry.js";import{EditGeometryOperations as it}from"../../../interactive/editGeometry/EditGeometryOperations.js";import{acquire as at}from"../../../interactive/snapping/SceneSnappingManagerPool.js";import{SnappingContext as nt}from"../../../interactive/snapping/SnappingContext.js";import{SnappingPipeline as st}from"../../../interactive/snapping/SnappingDragPipelineStep.js";import{SnappingOperation as ot}from"../../../interactive/snapping/SnappingOperation.js";import rt from"../../../../geometry/Point.js";let pt=class extends n{constructor(t){super(t),this._stagedDimension=null,this._computationManipulators=new Map,this._computationHandles=new s,this._snappingPipeline=new st,this._snappingManagerResult=at(t.view),this.addHandles(this._snappingManagerResult),this._unfocusedOffsetManipulatorMaterial=lt(),this._focusedOffsetManipulatorMaterial=lt(),this._thinOffsetManipulatorMaterial=lt(),this._thinOffsetManipulatorMaterial.setParameters({stipplePattern:Z(2)}),this._constraintSnappingIndicator=new Q({view:t.view,attached:!0,width:1,color:e.toUnitRGBA(N.constraint.color),renderOccluded:X.OccludeAndTransparent,stipplePattern:Z(5)});const i=e.toUnitRGBA(N.disabledPointIndicator.color);i[3]*=N.disabledPointIndicator.opacity,this._stagedStartIndicator=new W({view:t.view,attached:!1,color:i,size:2*N.disabledPointIndicator.radius,elevationInfo:{mode:"absolute-height",offset:0},spatialReference:t.view.renderCoordsHelper.spatialReference,outlineSize:0,renderOccluded:X.OccludeAndTransparent})}initialize(){this._snappingOperation=new ot({view:this.view}),this._orientationManipulatorTexture=J(this.view.toolViewManager.textures),this._orientationManipulatorMaterial=new Y({transparent:!0,writeDepth:!1,textureId:this._orientationManipulatorTexture.texture.id,renderOccluded:X.Opaque});const{computations:t}=this.analysisViewData;for(const e of t)this._addComputation(e);this.addHandles([t.on("after-add",(t=>this._addComputation(t.item))),t.on("after-remove",(t=>this._removeComputation(t.item)))]),this.addHandles([c((()=>({stagedPoint:this._snappingOperation.stagedPoint,stagedComputation:this._stagedComputation})),(({stagedPoint:t,stagedComputation:e})=>{if(r(e)||r(t))return;const i=v(t,new rt);this._applyPointUpdate(e,{endPoint:i})}),m),c((()=>({stagedDimension:this._stagedDimension,selectedComputation:this.analysisViewData.selectedComputation,firstGrabbedManipulator:this.firstGrabbedManipulator})),((t,e)=>{const{stagedDimension:i,selectedComputation:a,firstGrabbedManipulator:n}=t;if(i===e.stagedDimension&&n===e.firstGrabbedManipulator){for(const s of[a,e.selectedComputation])if(p(s)){const e=this._computationManipulators.get(s);this._updateManipulators(s,e,t)}}else for(const[s,o]of this._computationManipulators)this._updateManipulators(s,o,t)}),h),c((()=>this.analysis.style.lineSize),(t=>{this._updateManipulatorStyle(t)}),g),c((()=>this.view.state.camera),(()=>{p(this._stagedComputation)&&this._updateStagedDimensionOffset(this._stagedComputation)})),c((()=>d(this._stagedComputation,(t=>{const e=t.elevationAlignedStartPoint,i=y();return p(e)&&this.view.renderCoordsHelper.toRenderCoords(e,i)?i:null}))),(t=>{p(t)?(this._stagedStartIndicator.vertices=[t],this._stagedStartIndicator.attached=!0):this._stagedStartIndicator.attached=!1}))]),this.addHandles(this._constraintHandles),this.addHandles(this._snappingIndicatorHandles)}destroy(){this._snappingOperation=l(this._snappingOperation),this._computationHandles.destroy(),this._constraintSnappingIndicator.destroy(),this._stagedStartIndicator.destroy(),this._orientationManipulatorMaterial.dispose(),this._orientationManipulatorTexture.release()}get updating(){return this.updatingHandles.updating||this._snappingManager.updating}get firstGrabbedManipulator(){return this.parentTool.firstGrabbedManipulator}get hasGrabbedManipulators(){return this.parentTool.hasGrabbedManipulators}get _snappingManager(){return this._snappingManagerResult.snappingManager}get _activeComputation(){if(p(this._stagedComputation))return this._stagedComputation;const{selectedComputation:t}=this.analysisViewData;return this.hasGrabbedManipulators&&p(t)?t:null}get _stagedComputation(){const t=this._stagedDimension,e=this.analysisViewData.computations.at(-1);return r(t)||r(e)||e.dimension!==t?null:e}get _constraintHandles(){return[f((()=>this.analysisViewData.selectedComputation),(t=>{t.previousConstraint=S(t,this.view)}),{...h,equals:o}),c((()=>{const t=this._activeComputation;if(r(t))return null;const{measureType:e,orientation:i}=t.dimension;return{measureType:e,orientation:i,computation:t}}),((t,e)=>{if(p(t)&&r(e)){const{measureType:e,orientation:a,computation:n}=t;switch(n.previousConstraint){case w.Horizontal:n.preConstraintProperties={measureType:i.Horizontal,orientation:0};break;case w.Vertical:n.preConstraintProperties={measureType:i.Vertical,orientation:0};break;case w.Direct:n.preConstraintProperties={measureType:i.Direct,orientation:a};break;default:n.preConstraintProperties={measureType:e,orientation:a}}}r(t)&&p(e)&&(e.computation.preConstraintProperties=null)}),m)]}get _snappingIndicatorHandles(){const t="snapping-indicator-event-handles";return[c((()=>({stagedComputation:this._stagedComputation,activeComputation:this._activeComputation})),(({stagedComputation:e,activeComputation:i})=>{const a=this._constraintSnappingIndicator;if(this.removeHandles(t),r(i))a.attached=!1;else if(i===e)a.attached=!0;else{const{start:e,end:n}=this._computationManipulators.get(i),s=()=>{a.attached=e.grabbing||n.grabbing};s(),this.addHandles([e.events.on("grab-changed",s),n.events.on("grab-changed",s)],t)}})),c((()=>{const t=this._activeComputation;return p(t)?{geometry:t.geometry,constraint:t.previousConstraint}:{}}),(({geometry:t,constraint:e})=>{const i=this._constraintSnappingIndicator;p(t)&&p(e)&&e!==w.Direct?(i.visible=!0,i.setGeometryFromSegment(t.directSegment)):i.visible=!1}))]}removeStaged(){return!!p(this._stagedDimension)&&(this.analysis.dimensions.remove(this._stagedDimension),this._stagedDimension=null,!0)}onDeactivate(){this.removeStaged(),this._resetSnappingState()}onClick(t){const{_stagedDimension:e}=this;if(r(e)){const e=this._onUnstagedClick(t);return this.analysis.dimensions.add(e),null}return this._onStagedClick(t),e}onPointerMove({mapPoint:t,pointerType:e}){if("touch"===e)return;const i=this._snappingContext(e);this.updatingHandles.addPromise(u(this._snappingOperation.snap({point:t},this._snappingManager,i)))}onManipulatorSelectionChanged(){if(p(this.analysisViewData.selectedComputation)){this._computationManipulators.get(this.analysisViewData.selectedComputation).offset.selected||(this.analysisViewData.selectedDimension=null)}}_onUnstagedClick({mapPoint:t,pointerType:e}){let n=t;if("mouse"===e){const i=this._snappingContext(e);n=this._snappingManager.update({point:t,context:i})}const s=new a({startPoint:v(n,new rt),endPoint:null,measureType:i.Horizontal});return this._stagedDimension=s,this._resetSnappingState(),s}_onStagedClick({mapPoint:t,pointerType:e}){const i=this._stagedComputation;if(r(i))return;let a=t;if("mouse"===e){const i=this._snappingContext(e);a=this._snappingManager.update({point:t,context:i})}const n=v(a,new rt);this._applyPointUpdate(i,{endPoint:n}),this._stagedDimension=null,this._resetSnappingState()}_resetSnappingState(){this._snappingManager.doneSnapping(),this._snappingOperation.abort(),this._snappingOperation.stagedPoint=null}_addComputation(t){if(this._computationManipulators.has(t))return;const e=this._setupPointManipulator(t,{isStart:!0}),a=this._setupPointManipulator(t,{isStart:!1}),n=this._setupOffsetManipulator(t),s=this._setupHeadingManipulator(t),o=this._setupRotationManipulator(t),r=this._setupMeasureTypeManipulator(t,i.Direct),p=this._setupMeasureTypeManipulator(t,i.Horizontal),l=this._setupMeasureTypeManipulator(t,i.Vertical),d=new b({start:e,end:a,offset:n,heading:s,rotation:o,direct:r,horizontal:p,vertical:l});this._setupComputationToManipulatorsSync(t,d),this._computationManipulators.set(t,d),this.manipulators.addMany(d.values())}_removeComputation(t){const e=this._computationManipulators.get(t);if(!r(e)){this._computationHandles.remove(t),this._computationManipulators.delete(t);for(const t of e.values())this.manipulators.remove(t)}}_setupComputationToManipulatorsSync(t,e){this._computationHandles.add([c((()=>t.geometry),(()=>this._updateManipulators(t,e)),{...h,equals:o})],t)}_setupPointManipulator(t,e){const{view:i}=this,{dimension:a}=t,n=P(i,{metadata:a}),s=D(n,{isStart:e.isStart,createSnappingPipelineStep:(t,e)=>this._snappingPipeline.createSnapDragEventPipelineStep({snappingContext:this._snappingContext(e),snappingManager:this._snappingManager,updatingHandles:this.updatingHandles,cancel:t}),dimension:a,onUpdate:e=>{this._applyPointUpdate(t,e)},snappingPipeline:this._snappingPipeline,view:i});return this._computationHandles.add(s,t),n}_setupOffsetManipulator(t){const{view:e}=this,i=O(e,{lineSizePt:this.analysis.style.lineSize,unfocusedMaterial:this._unfocusedOffsetManipulatorMaterial,focusedMaterial:this._focusedOffsetManipulatorMaterial,metadata:t.dimension}),a=H(i,{computation:t,view:e});return this._computationHandles.add(a,t),i}_setupHeadingManipulator(t){const{view:e}=this,i=j(e,{lineSizePt:this.analysis.style.lineSize,material:this._orientationManipulatorMaterial,metadata:t.dimension}),a=T(i,{computation:t,view:e});return this._computationHandles.add(a,t),i}_setupRotationManipulator(t){const{view:e}=this,i=j(e,{lineSizePt:this.analysis.style.lineSize,material:this._orientationManipulatorMaterial,metadata:t.dimension}),a=G(i,{computation:t,view:e});return this._computationHandles.add(a,t),i}_setupMeasureTypeManipulator(t,e){const{view:i}=this,a=I(i,{lineSizePt:this.analysis.style.lineSize,unfocusedMaterial:this._unfocusedOffsetManipulatorMaterial,focusedMaterial:this._focusedOffsetManipulatorMaterial,thinOffsetManipulatorMaterial:this._thinOffsetManipulatorMaterial,metadata:t.dimension}),n=z(a,{computation:t,manipulatorMeasureType:e,view:i});return this._computationHandles.add(n,t),a}_updateManipulators(t,e,a={stagedDimension:this._stagedDimension,selectedComputation:this.analysisViewData.selectedComputation,firstGrabbedManipulator:this.firstGrabbedManipulator}){const{stagedDimension:n,selectedComputation:s,firstGrabbedManipulator:o}=a,{start:l,end:d,offset:u,heading:c,rotation:m}=e,h=s===t,g=F(t),{dimension:f}=t;for(const i of e.values()){const t=g&&r(n)&&(r(o)||i===o);i===u?(i.available=t,i.selected=h):i.available=t&&h}if(!g)return;p(S(t,this.view))?e.forEachMeasureTypeManipulator((t=>t.available=!1)):e.manipulatorForMeasureType(f.measureType).available=!1;for(const r of[c,m])f.measureType===i.Direct&&0!==f.offset||(r.available=!1);L(t)?m.available=!1:c.available=!1;const{geometry:_}=t;l.renderLocation=_.directSegment.startRenderSpace,d.renderLocation=_.directSegment.endRenderSpace;const{renderCoordsHelper:M}=this.view;x(u,_,M),c.available&&V(c,t,M),m.available&&U(m,t,M),e.forEachMeasureTypeManipulator(((e,i)=>{e.available&&R(e,t,i,M)}))}_updateManipulatorStyle(t){const e=k(t),i=E(t),a={lineSizePt:t,material:this._orientationManipulatorMaterial};for(const{offset:n,heading:s,rotation:o}of this._computationManipulators.values())n.radius=i/2,A(s,a),A(o,a);this._unfocusedOffsetManipulatorMaterial.setParameters({width:e}),this._focusedOffsetManipulatorMaterial.setParameters({width:i})}_snappingContext(t){return new nt({elevationInfo:{mode:"absolute-height",offset:0},pointer:t,editGeometryOperations:new it(new et("point",tt(!0,!1,this.view.spatialReference))),visualizer:new K})}_applyPointUpdate(t,e){const{view:i}=this,a=B(t);"startPoint"in e&&(a.elevationAlignedStartPoint=e.startPoint),"endPoint"in e&&(a.elevationAlignedEndPoint=e.endPoint);const n=q(a,i.renderCoordsHelper);if(r(n))return;const s=S({...a,geometry:n},i);C(t,e,{...a,constraint:s,unconstrainedGeometry:n,view:i}),t===this._stagedComputation&&this._updateStagedDimensionOffset(t)}_updateStagedDimensionOffset(t){if(r(t.geometry))return;t.geometry.directSegment.eval(.5,dt);const e=this.view.state.camera.computeRenderPixelSizeAt(dt);t.dimension.offset=N.initialOffsetPx*e}get testInfo(){const t=t=>this.analysisViewData.computations.find((e=>e.dimension===t));return{getManipulatorsForDimension:e=>this._computationManipulators.get(t(e)),getComputationForDimension:e=>t(e),getConstraintForDimension:e=>{const i=t(e);return p(i)?S(i,this.view):null},stagedDimension:this._stagedDimension,stagedStartIndicator:this._stagedStartIndicator,constraintSnappingIndicator:this._constraintSnappingIndicator,snappingManager:this._snappingManager}}};function lt(){const{color:t,opacity:i}=N.offsetManipulator;return new $({color:[...e.toUnitRGB(t),i],width:1,renderOccluded:X.OccludeAndTransparent,writeDepth:!1,hasPolygonOffset:!0})}t([_({constructOnly:!0})],pt.prototype,"analysis",void 0),t([_({constructOnly:!0})],pt.prototype,"analysisViewData",void 0),t([_({constructOnly:!0})],pt.prototype,"manipulators",void 0),t([_({constructOnly:!0})],pt.prototype,"parentTool",void 0),t([_({constructOnly:!0,nonNullable:!0})],pt.prototype,"view",void 0),t([_({readOnly:!0})],pt.prototype,"updating",null),t([_()],pt.prototype,"firstGrabbedManipulator",null),t([_()],pt.prototype,"hasGrabbedManipulators",null),t([_()],pt.prototype,"_stagedDimension",void 0),t([_()],pt.prototype,"_activeComputation",null),t([_()],pt.prototype,"_stagedComputation",null),pt=t([M("esri.views.3d.analysis.Dimension.LengthDimensionSubTool")],pt);const dt=y();export{pt as LengthDimensionSubTool};
