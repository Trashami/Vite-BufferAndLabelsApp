/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.25/esri/copyright.txt for details.
*/
import e from"../../../../Color.js";import"../../../../geometry.js";import{lengthDimensionMeasureType as t,LengthDimensionMeasureType as n}from"../../../../analysis/dimensionUtils.js";import{cyclicalDegrees as r}from"../../../../core/Cyclical.js";import{rad2deg as o}from"../../../../core/mathUtils.js";import{isNone as i,unwrapOr as a}from"../../../../core/maybe.js";import{pt2px as s}from"../../../../core/screenUtils.js";import{i as c,k as m}from"../../../../chunks/mat4.js";import{c as d}from"../../../../chunks/mat4f64.js";import{g as l,c as u,b as p,f,e as g,k as h,l as y,s as v,y as S}from"../../../../chunks/vec3.js";import{c as M,Z as x,f as j}from"../../../../chunks/vec3f64.js";import{fromPositionAndNormal as P,create as H,signedDistance as w,normal as T}from"../../../../geometry/support/plane.js";import{sv3d as k}from"../../../../geometry/support/vectorStacks.js";import{clonePoint as C}from"../../../../layers/graphics/hydratedFeatures.js";import{isValidComputation as b,computeGeometryFromDimension as O,computationToGeometryDependencies as z,headingFromGeometry as U,computeOffsetForPoint as D,computeSegmentForMeasureType as F,computeOffsetAxis as R,directUp as E,directStartToEnd as L,dimensionStartToEnd as A}from"./lengthDimensionUtils.js";import{settings as G}from"./settings.js";import{Manipulator3D as I}from"../../interactive/Manipulator3D.js";import{createSphereManipulator as W,worldScaledManipulatorSettings as B,createRotateManipulator as N,updateRotateManipulator as V,calculateInputRotationTransform as Z,calculateTranslateRotateFromBases as q}from"../../interactive/manipulatorUtils.js";import{screenToMap3D as J,screenToRenderPlane as K,hideManipulatorWhileDragging as Q}from"../../interactive/editingTools/dragEventPipeline3D.js";import{EuclideanSegment as X}from"../../interactive/visualElements/support/Segment.js";import{MARKER_SIZE_PER_LINE_WIDTH as Y}from"../../support/engineContent/marker.js";import{createPolylineGeometry as $}from"../../webgl-engine/lib/GeometryUtil.js";import{createManipulatorDragEventPipeline as _,resetProperties as ee,EventPipeline as te}from"../../../interactive/dragEventPipeline.js";import{ManipulatorStateCustomFlags as ne,ManipulatorStateFlags as re}from"../../../interactive/interfaces.js";import oe from"../../../../geometry/Point.js";class ie{constructor(e){this.start=e.start,this.end=e.end,this.offset=e.offset,this.heading=e.heading,this.rotation=e.rotation,this.direct=e.direct,this.horizontal=e.horizontal,this.vertical=e.vertical}manipulatorName(e){return Object.keys(this).find((t=>this.hasOwnProperty(t)&&e===this[t]))}values(){return[this.start,this.end,this.offset,this.heading,this.rotation,this.direct,this.horizontal,this.vertical]}forEachMeasureTypeManipulator(e){for(const n of t)e(this.manipulatorForMeasureType(n),n)}manipulatorForMeasureType(e){switch(e){case n.Direct:return this.direct;case n.Horizontal:return this.horizontal;case n.Vertical:return this.vertical}}}function ae(t,n){const r=W(t,e.toUnitRGB(G.pointManipulators.color),G.pointManipulators.opacity,Ee);return r.available=!1,r.grabCursor="crosshair",r.radius=G.pointManipulators.radius,r.metadata=n.metadata,r.collisionPriority=1,r}function se(e,t){const n=[j(-.5,0,0),j(.5,0,0)],{lengthFraction:r}=G.offsetManipulator,o=$(n.map((e=>l(M(),e,r))));return new I({view:e,renderObjects:[{geometry:o,material:t.unfocusedMaterial,stateMask:re.Unfocused|re.Selected|Ee},{geometry:o,material:t.focusedMaterial,stateMask:re.Focused|Ee}],collisionType:{type:"line",paths:[n]},radius:Re(t.lineSizePt)/2,metadata:t.metadata,available:!1,...B})}function ce(e,{lineSizePt:t,material:n}){const{calloutOffsetPx:r,calloutOpacity:o,calloutWidth:i,discScale:a,focusMultiplier:c}=G.orientationManipulator;return{calloutLength:.25*Y*G.markers.lineSizeFraction*s(t)+r,calloutOpacity:o,calloutWidth:i,customStateMask:Ee,discScale:a,focusMultiplier:c,material:n,metadata:e}}function me(e,t){return N(e,ce(t.metadata,t))}function de(e,t){V(e,ce(e.metadata,t))}function le(e,t){const n=[j(-.5,0,0),j(.5,0,0)],{lengthFraction:r}=G.offsetManipulator,o=$(n),i=$(n.map((e=>l(M(),e,r))));return new I({view:e,renderObjects:[{geometry:i,material:t.unfocusedMaterial,stateMask:re.Unfocused|Ee},{geometry:i,material:t.focusedMaterial,stateMask:re.Focused|Ee},{geometry:o,material:t.thinOffsetManipulatorMaterial,stateMask:Ee}],collisionType:{type:"line",paths:[n]},radius:Re(t.lineSizePt)/2,available:!1,metadata:t.metadata,...B})}function ue(e,{isStart:t,createSnappingPipelineStep:n,dimension:r,onUpdate:o,snappingPipeline:i,view:a}){const s=t?"startPoint":"endPoint",c=_(e,((e,t,c,m)=>{const d=Q(e);c=c.next(d).next(ee(r,[s,"measureType","orientation"])),t.next(d).next(J(a)).next(n(c,m),i.next).next((e=>{const t=C(e.mapEnd,new oe);o("startPoint"===s?{startPoint:t}:{endPoint:t})}))}));return[c]}function pe(e,{computation:t,view:n}){return[_(e,((e,r,o)=>{if(!b(t)||!e.selected)return;const{geometry:i,dimension:a}=t,s=Q(e);r.next(s).next(Me(n,a,i.dimensionSegment,i.primaryOffsetAxis)),o.next(s).next(ee(a,["offset"]))}))]}function fe(e,{computation:t,view:n}){return[_(e,((e,r,o)=>{ye({cancel:o,computation:t,settingHeading:!0,steps:r,view:n})}))]}function ge(e,{computation:t,view:n}){return[_(e,((e,r,o)=>{ye({cancel:o,computation:t,settingHeading:!1,steps:r,view:n})})),e.events.on("immediate-click",(e=>{he(e,t,n)}))]}function he(e,t,n){const{dimension:o,geometry:a}=t;if(90===o.orientation||270===o.orientation)return o.orientation=0,void e.stopPropagation();if(i(a))return;const{renderCoordsHelper:s}=n,c=O({...z(t),orientation:90},s),m=O({...z(t),orientation:270},s);if(i(c)||i(m))return;const d=U(c,s),l=U(m,s),u=xe(a,n),p=r.shortestSignedDiff(u,d),f=r.shortestSignedDiff(u,l);o.orientation=Math.abs(p)<Math.abs(f)?90:270,e.stopPropagation()}function ye(e){const{cancel:t,computation:n,settingHeading:r,steps:i,view:s}=e;if(!b(n))return;const{renderCoordsHelper:c}=s,{dimension:m,geometry:d}=n,l=M(),p=be(M(),d,d.directSegment,c),f=Oe(k.get(),{forHeading:r,geometry:d,renderCoordsHelper:c}),g=P(p,f,H()),h=a(m.orientation,r?()=>U(d,s.renderCoordsHelper):0);i.next(K(s,g)).next((e=>{"start"===e.action&&u(l,e.renderStart);const t=T(g),n=Z(l,e.renderEnd,p,t);let i=h-o(n);r||(i=ve(i)),m.orientation=i})),t.next(ee(m,["orientation"]))}function ve(e){const t=r.normalize(e)%90;return t<G.orientationSnapThresholdDegrees?e-t:90-t<G.orientationSnapThresholdDegrees?e+(90-t):e}function Se(e,{computation:t,manipulatorMeasureType:r,view:o}){let i=n.Direct,a=0,s=0;return[e.events.on("grab-changed",(n=>{if("start"!==n.action||!b(t))return;const{dimension:c,geometry:m}=t;i=c.measureType,a=c.offset,s=c.orientation;const d=u(k.get(),e.renderLocation);c.measureType=r,c.offset=D(d,r,m,o.renderCoordsHelper),c.orientation=0})),_(e,((e,n,c)=>{if(!b(t))return;const{geometry:m,dimension:d}=t,{renderCoordsHelper:l}=o,u=F(Ie,r,t,l),p=R(k.get(),{measureType:r,directSegment:m.directSegment,renderCoordsHelper:l}),f=Q(e);n.next(f).next(Me(o,d,u,p)),c.next(f).next((e=>(d.measureType=i,d.offset=a,d.orientation=s,e)))}))]}function Me(e,t,n,r){const o=p(k.get(),n.endRenderSpace,n.startRenderSpace);f(o,o,r);const i=P(n.startRenderSpace,o,H()),a=P(n.startRenderSpace,r,H()),s=t.offset;let c,m=0;const d=new te;return d.next(K(e,i)).next((n=>{"start"===n.action&&(m=w(a,n.renderStart));const r=(w(a,n.renderEnd)-m)*e.renderCoordsHelper.unitInMeters;t.offset=s+r,c=n})),e=>(d.execute(e),c)}function xe(e,t){const{directSegment:n}=e,{renderCoordsHelper:r}=t,o=E(k.get(),e,r),i=L(k.get(),e),a=f(k.get(),i,o),{viewForward:s}=t.state.camera;g(a,s)>0&&l(a,a,-1);const c=n.eval(.5,k.get());return r.headingAtPosition(c,a)}function je(e,t,n){const{dimensionSegment:r,primaryOffsetAxis:o}=t,i=A(Le,t),a=h(i,x)?c(Ge):q(i,o,x,Ge),s=Math.max(y(i),G.offsetManipulator.minLengthMeters/n.unitInMeters);m(a,a,v(Le,s,s,s)),e.modelTransform=a,e.renderLocation=r.eval(.5,Le)}function Pe(e,t,n){we(e,t,n,{forHeading:!0})}function He(e,t,n){we(e,t,n,{forHeading:!1})}function we(e,t,n,{forHeading:r}){const{dimension:o,geometry:i}=t,{primaryOffsetAxis:a}=i,s=l(Te,a,o.offset>=0?1:-1),c=Oe(ke,{forHeading:r,geometry:i,renderCoordsHelper:n});f(c,c,s);const m=q(s,c,x,Ge);e.modelTransform=m,e.renderLocation=be(Le,i,i.dimensionSegment,n)}const Te=M(),ke=M();function Ce(e,t,n,r){const{geometry:o}=t,i=F(Ie,n,t,r),a=R(Le,{measureType:n,directSegment:o.directSegment,renderCoordsHelper:r}),s=S(Ae,i.endRenderSpace,i.startRenderSpace),c=q(s,a,x,Ge),d=y(s);m(c,c,v(Ae,d,d,d)),e.modelTransform=c,e.renderLocation=i.eval(.5,Ae)}function be(e,t,n,r){const{startRenderSpace:o,endRenderSpace:i}=n,a=ze(t,r)?o:i;return u(e,a)}function Oe(e,{forHeading:t,geometry:n,renderCoordsHelper:r}){return t?E(e,n,r):A(e,n,{invert:!0})}function ze(e,t){const n=L(Ue,e),r=E(De,e,t);return g(n,r)>0}const Ue=M(),De=M();function Fe(e){return s(e)+G.offsetManipulator.linePaddingPx}function Re(e){return s(e)+G.offsetManipulator.focusedLinePaddingPx}const Ee=ne.Custom1,Le=M(),Ae=M(),Ge=d(),Ie=new X;export{Ee as DidPointerMoveRecentlyFlag,ie as LengthDimensionManipulators,xe as automaticHeadingFromCamera,le as createMeasureTypeManipulator,se as createOffsetManipulator,me as createOrientationManipulator,ae as createPointManipulator,Re as focusedOffsetWidth,fe as headingManipulatorHandles,Se as measureTypeManipulatorHandles,pe as offsetManipulatorHandles,ue as pointManipulatorHandles,ge as rotationManipulatorHandles,ve as snapOrientationToNearestRightAngle,Fe as unfocusedOffsetWidth,Pe as updateHeadingManipulatorTransform,Ce as updateMeasureTypeManipulatorTransform,je as updateOffsetManipulatorTransform,de as updateOrientationManipulator,He as updateRotationManipulatorTransform};
