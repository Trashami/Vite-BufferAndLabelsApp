/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.25/esri/copyright.txt for details.
*/
import"../../../intl.js";import{binaryFindClosest as i}from"../../../core/arrayUtils.js";import{handlesGroup as e,makeHandle as t}from"../../../core/handleUtils.js";import{isNone as o,applySome as n,isSome as a,unwrapOr as s}from"../../../core/maybe.js";import{throwIfAborted as r}from"../../../core/promiseUtils.js";import{formatDecimal as l,unitName as d}from"../../../core/unitFormatUtils.js";import{convertUnit as c}from"../../../core/unitUtils.js";import{CHART_CSS as m}from"../css.js";import{getConfig as x,NOT_AVAILABLE as p}from"./constants.js";import{getTranslatedLineTitle as u}from"./intlUtils.js";import{niceScale as g}from"./niceScale.js";import{loadChartsModule as f}from"../../support/chartUtils.js";import{isRTL as h}from"../../support/widgetUtils.js";import{isDarkTheme as b}from"../../../support/themeUtils.js";import{substitute as v}from"../../../intl/substitute.js";import{formatNumber as T}from"../../../intl/number.js";const A="#f8f8f8",C="#a9a9a9",y="#323232",L="line",z="fill",k=15,P=12,S=30,F=.001,w=.5,M=.5,Y=30,X=.02,I=.02,W={sideSpacing:k,paddingBottom:0,paddingLeft:0,paddingRight:0,paddingTop:0,axisFontSize:9,axisFontWeight:"400",axisGridStroke:"#f4f4f4",axisLabelsFontSize:9,axisLabelsFontWeight:"400",axisLabelsColor:C,axisTooltipFontSize:12,axisTooltipBackgroundColor:y,axisTooltipLabelColor:A,axisTooltipPaddingTop:Math.round(P/4),axisTooltipPaddingBottom:Math.round(P/4),axisTooltipPaddingHorizontal:Math.round(k/4),xAxisMinGridDistance:50,xAxisLabelsSpacing:Math.round(P/2),xAxisMinLabelPosition:.05,xAxisMaxLabelPosition:.9,yAxisMinGridDistance:30,yAxisLabelSpacing:Math.round(k/4),yAxisMinLabelPosition:0,yAxisMaxLabelPosition:.8,seriesTooltipFontSize:12,seriesTooltipBackgroundColor:A,seriesTooltipLabelColor:y,seriesFillLighten:.9,seriesTooltipSpacing:P/2,seriesTooltipPaddingVertical:Math.round(k/4),seriesTooltipPaddingHorizontal:Math.round(k/4),tooltipBorderRadius:0},j={...W,axisGridStroke:y,axisLabelsColor:C,axisTooltipBackgroundColor:y,axisTooltipLabelColor:A,seriesTooltipBackgroundColor:y,seriesTooltipLabelColor:A,seriesFillLighten:-.75},H={minX:void 0,maxX:void 0,minY:void 0,maxY:void 0};async function O(i){const t=await f(),{am4core:n,am4charts:a}=t;r(i.abortOptions);const{options:s}=n;s.minPolylineStep=w,s.autoSetClassName=!0,s.animationsEnabled=!1;const l=b(),d=l?j:W;l&&n.useTheme(t.am4themes_dark);const c=n.create(i.container,a.XYChart);c.arrangeTooltips=!1,c.preloader.disabled=!0,c.zoomOutButton.disabled=!0;const m=h(i.container);c.rtl=m,c.padding(d.paddingTop,m?d.paddingLeft:d.paddingRight,d.paddingBottom,m?d.paddingRight:d.paddingLeft);const x=c.plotContainer.background;x.strokeWidth=0,x.strokeOpacity=0,x.stroke=null;const p=c.xAxes.push(new a.ValueAxis),u=c.yAxes.push(new a.ValueAxis),g={params:i,amCharts4Index:t,amChart:c,xAxis:p,yAxis:u,series:new Map,data:null,messages:null,theme:d,zooming:!1,pointerIsOver:!1};c.cursor=U(g),B(g),D(g),E(g);const v=[Q(g,i.onRangeChange),ei(g,i.onCursorPositionChange),ii(g)];let T=null,A=!1;const C=()=>{o(T)||("undefined"!=typeof window&&"cancelIdleCallback"in window?window.cancelIdleCallback(T):clearTimeout(T),T=null)};return{...g,destroy(){A=!0,C(),e(v).remove(),c.dispose()},update(i){if(i.data===g.data&&i.messages===g.messages)return;if(C(),A)return;const e=()=>{A||(T=null,G(g,i))};T="undefined"!=typeof window&&"requestIdleCallback"in window?window.requestIdleCallback(e,{timeout:Y}):setTimeout(e,Y)},zoomOut(){A||(g.yAxis.zoom({start:0,end:1},!1,!0),g.xAxis.zoom({start:0,end:1},!1,!0))}}}function U(i){const e=new i.amCharts4Index.am4charts.XYCursor;return e.trackable=!0,e.lineY.disabled=!0,e.behavior="zoomXY",e}function B(i){const e=i.theme,t=i.amChart.tooltip,{am4core:o}=i.amCharts4Index;t.id="series-tooltip",t.fitPointerToBounds=!0,t.pointerOrientation="vertical",t.zIndex=-1,t.getFillFromObject=!1,t.label.fontSize=e.seriesTooltipFontSize,t.label.fill=o.color(e.seriesTooltipLabelColor),t.label.padding(e.seriesTooltipPaddingVertical,e.seriesTooltipPaddingHorizontal,e.seriesTooltipPaddingVertical,e.seriesTooltipPaddingHorizontal),t.background.cornerRadius=e.tooltipBorderRadius,t.background.stroke=null,t.background.fill=o.color(e.seriesTooltipBackgroundColor),t.background.padding(0,0,0,0),t.adapter.add("dy",(()=>e.seriesTooltipSpacing*(t.background.pointerY<=0?1:-1))),h(i.params.container)&&(t.label.textAlign="middle")}function D(i){const{xAxis:e,theme:t}=i,{am4core:o}=i.amCharts4Index;e.numberFormatter=ri(i,"distance"),e.strictMinMax=!0,e.cursorTooltipEnabled=!1,e.title.visible=!1;const n=e.renderer;n.line.visible=!1,n.minGridDistance=t.xAxisMinGridDistance,n.minLabelPosition=t.xAxisMinLabelPosition,n.maxLabelPosition=t.xAxisMaxLabelPosition,n.fontWeight=t.axisFontWeight,n.fontSize=t.axisFontSize,n.baseGrid.disabled=!0;const a=n.labels.template;a.fontSize=t.axisLabelsFontSize,a.fontWeight=t.axisLabelsFontWeight,a.fill=o.color(t.axisLabelsColor),a.paddingTop=t.xAxisLabelsSpacing,a.horizontalCenter="left",a.paddingLeft=0;const s=e.tooltip;s.id="axis-tooltip",s.background.fill=o.color(t.axisTooltipBackgroundColor),s.background.stroke=null,s.background.padding(0,0,0,0),s.label.fontSize=t.axisTooltipFontSize,s.label.fill=o.color(t.axisTooltipLabelColor),s.label.padding(t.axisTooltipPaddingTop,t.axisTooltipPaddingHorizontal,t.axisTooltipPaddingBottom,t.axisTooltipPaddingHorizontal);const r=n.grid.template;r.strokeOpacity=1,r.stroke=o.color(t.axisGridStroke)}function E(i){const{yAxis:e,theme:t}=i,{am4core:o}=i.amCharts4Index;e.numberFormatter=ri(i,"elevation"),e.title.visible=!1,e.cursorTooltipEnabled=!1,e.strictMinMax=!0,e.baseValue=x().noDataValue;const n=e.renderer;n.inside=!0,n.line.opacity=0,n.line.visible=!1,n.minGridDistance=t.yAxisMinGridDistance,n.minLabelPosition=t.yAxisMinLabelPosition,n.maxLabelPosition=t.yAxisMaxLabelPosition,n.fontWeight=t.axisFontWeight,n.fontSize=t.axisFontSize,n.baseGrid.disabled=!0;const a=n.labels.template;a.fontSize=t.axisLabelsFontSize,a.fontWeight=t.axisLabelsFontWeight,a.fill=o.color(t.axisLabelsColor),a.verticalCenter="bottom",a.paddingLeft=t.yAxisLabelSpacing,a.paddingBottom=0;const s=n.grid.template;s.strokeOpacity=1,s.stroke=o.color(t.axisGridStroke),h(i.params.container)&&(n.opposite=!0,a.textAlign="middle",a.paddingLeft=0,a.paddingRight=t.yAxisLabelSpacing)}function G(i,{data:e,messages:t}){const{htmlContainer:o}=i.amChart;if(!o)return;const s=a(e)&&e.refined;i.amChart.cursor.disabled=!s,o.classList.toggle(m.cursorEnabled,s);const r=i.data!==e,l=n(i.data,(i=>i.effectiveUnits))!==n(e,(i=>i.effectiveUnits));i.data=e,i.messages=t,r&&(R(i),q(i)),l&&(i.yAxis.invalidateLabels(),i.xAxis.invalidateLabels()),ti(i)}function R(i){const{xAxis:e,yAxis:t}=i,{minX:o,maxX:n,minY:a,maxY:s}=V({data:i.data,pixelWidth:e.pixelWidth,pixelHeight:t.pixelHeight});e.min=o,e.max=n,t.min=a,t.max=s}function V({data:i,pixelWidth:e,pixelHeight:t}){if(o(i))return H;const a=i.statistics,s=0,r=n(a,(i=>i.maxDistance));let l=n(a,(i=>i.minElevation)),d=n(a,(i=>i.maxElevation));if(o(r)||o(l)||o(d))return H;const m=Math.max(r-s,F);let p=Math.max(d-l,F);const u=i.effectiveUnits;if(i.dynamicElevationRange){const i=c(m,u.distance,u.elevation);p=Math.max(p,i/x().maxChartRatio)}return l-=I*p,d=l+p+X*p,[l,d]=g(l,d,10),p=d-l,i.uniformScaling?$({data:i,bounds:{minX:s,maxX:r,minY:l,maxY:d},pixelWidth:e,pixelHeight:t,centered:!0}):{minX:s,maxX:s+m,minY:l,maxY:l+p}}function $({data:i,bounds:e,pixelWidth:t,pixelHeight:n,centered:a}){if(o(i))return e;let{minX:s,maxX:r,minY:l,maxY:d}=e;const m=r-s,x=d-l,p=i.effectiveUnits,u=c(x,p.elevation,p.distance)/n/(m/t);return u>=1?[s,r]=Z([s,r],u,a):[l,d]=Z([l,d],1/u,a),{minX:s,maxX:r,minY:l,maxY:d}}function Z([i,e],t,o){const n=(e-i)*t;if(o){const t=(i+e)/2-n/2;return[t,t+n]}return[i,i+n]}function q(i){const{amChart:e,data:t}=i;if(o(t)||0===t.lines.length)return void e.series.clear();const a=new Map,s=new Set(e.series.values),r=t.lines.length;for(let o=0;o<r;o++){const l=t.lines[o];let d=i.series.get(l.id);d?(n(d.fill,(i=>s.delete(i))),s.delete(d.line)):(d=J(i,l),n(d.fill,(i=>e.series.push(i))),e.series.push(d.line)),a.set(d.id,d);const c=r-o-1;n(d.fill,(i=>i.zIndex=c)),d.line.zIndex=r+c,N(i,d,l)}i.series=a;for(const o of s)e.series.removeValue(o)}function N(i,{line:e,fill:t},o){const{theme:r}=i,{am4core:l}=i.amCharts4Index,{r:d,g:c,b:m,a:x}=o.color,p=l.color({r:d,g:c,b:m,a:x}),u=s(o.samples,new Array),g=u.length>0;e.stroke=p,e.visible=g,n(t,(i=>{i.visible=g,i.fill=p.lighten(r.seriesFillLighten)}));const f=u.length,h=e.data;if(h.length===f){let i=!1;for(let e=0;e<f;++e){const t=h[e],o=u[e];i=i||a(t.elevation)!==a(o.elevation),_(t,o)}i?(e.invalidateData(),n(t,(i=>i.invalidateData()))):(e.invalidateRawData(),n(t,(i=>i.invalidateRawData())))}else e.data=u,n(t,(i=>i.data=u))}function _(i,e){i.x=e.x,i.y=e.y,i.z=e.z,i.distance=e.distance,i.elevation=e.elevation}function J(i,e){const{id:t}=e,o=K(i,`${L}-${t}`);o.strokeWidth=e.chartStrokeWidth,o.dy=e.chartStrokeOffsetY;let n=null;return e.chartFillEnabled&&(n=K(i,`${z}-${t}`),n.fillOpacity=1),{id:t,line:o,fill:n}}function K(i,e){const t=new i.amCharts4Index.am4charts.LineSeries;t.id=e,t.showOnInit=!1,t.simplifiedProcessing=!0,t.minDistance=M,t.excludeFromTotal=!0,t.clickable=!1,t.contextMenuDisabled=!0,t.cursorHoverEnabled=!1,t.cursorTooltipEnabled=!1,t.connect=!1,t.fill=null,t.stroke=null;const o="distance";t.dataFields.valueX=o;const n="elevation";return t.dataFields.valueY=n,t}function Q(i,e){const{amChart:n,xAxis:a,yAxis:s}=i;let r=!1;const l=()=>{const{data:e}=i;if(!r||o(e)||!e.uniformScaling)return;r=!1;const{minX:t,maxX:l,minY:d,maxY:c}=$({data:i.data,bounds:{minX:a.minZoomed,maxX:a.maxZoomed,minY:s.minZoomed,maxY:s.maxZoomed},pixelWidth:a.pixelWidth,pixelHeight:s.pixelHeight,centered:!0});a.zoomToValues(t,l,!0),s.zoomToValues(d,c,!0),n.validate(),ti(i)},d=()=>{e(i.xAxis.zoomFactor,i.yAxis.zoomFactor)},c=e=>{i.zooming=e,ti(i)},m=[n.events.on("down",(()=>c(!0))),n.events.on("up",(()=>c(!1))),n.cursor.events.on("zoomended",(()=>{r=!0})),a.events.on("startendchanged",l),s.events.on("startendchanged",l),a.events.on("rangechangeended",d),s.events.on("rangechangeended",d)];return t((()=>{m.forEach((i=>i.dispose()))}))}function ii({xAxis:i,yAxis:e}){const o=i=>()=>{i.renderer.grid.each((i=>{i.visible="none"!==i.dataItem.label.dom.getAttribute("display")}))},n=[i.events.on("rangechangeended",o(i)),i.events.on("validated",o(i)),e.events.on("rangechangeended",o(e)),e.events.on("validated",o(e))];return t((()=>{n.forEach((i=>i.dispose()))}))}function ei(i,e){const{amChart:o,xAxis:n,yAxis:a}=i,{cursor:s,events:r}=o,l=e=>{i.pointerIsOver=e,ti(i)},d=()=>{l(!1),e(null,null)},c=[s.events.on("cursorpositionchanged",(()=>{if(!i.pointerIsOver)return;ti(i);const t=n.toAxisPosition(s.xPosition),o=a.toAxisPosition(s.yPosition);e(t,o)})),r.on("over",(()=>l(!0))),r.on("out",d),r.on("blur",d)];return t((()=>{c.forEach((i=>i.dispose()))}))}function ti(i){const{amChart:e,xAxis:t,data:n,theme:s,zooming:r,pointerIsOver:l}=i;if(i.amChart.tooltip.hide(),i.xAxis.hideTooltip(),!l)return;if(r)return;if(o(n)||!n.refined)return;const d=oi(i);if(a(d)){const{cursor:o,tooltip:n}=e;o.show(0),o.validate(),n.text=d.text,n.show(0),n.validate();const a=d.y-n.contentHeight-s.seriesTooltipSpacing;n.pointerOrientation=a<S?"up":"down",n.pointTo(d,!0),n.validate();const r=t.tooltip;r.text=si(i),r.show(0),r.validate()}}function oi(i){const{amChart:e,yAxis:t,data:a}=i;if(o(a))return null;const s=a.lines.map((e=>({line:e,y:n(li(i,e),(i=>i.elevation))}))).sort(ni),r=s.length?s[0].y:null;if(o(r))return null;const l=e.cursor,d=t.measuredHeight,c=d+e.pixelPaddingTop;return{text:s.map((({y:e,line:t})=>ai(i,t,e))).join("\n"),x:l.point.x+l.parent.pixelX+e.pixelPaddingLeft,y:c-t.valueToPosition(r)*d}}function ni({y:i},{y:e}){return o(i)?1:o(e)?-1:e-i}function ai(i,e,t){const{data:n,messages:s}=i;if(o(n)||o(s))return"";const r=x().formatPrecision,d=v(s.chartTooltip,{name:u(e,s),elevation:a(t)?l(s,t,n.effectiveUnits.elevation,r):p});return`[${e.color.toHex()}]●[/] ${d}`}function si(i){const{data:e,messages:t}=i;if(o(e)||o(t))return"";const n=e.lines[0],s=n?li(i,n):null,r=x().formatPrecision;return a(s)?l(t,s.distance,e.effectiveUnits.distance,r):"-"}function ri(i,e){const t=i.xAxis.numberFormatter.clone();return t.format=(t,n,a)=>{const{messages:s,data:r}=i;if(o(s)||o(r)||"string"==typeof t)return"";return`${T(t,{maximumFractionDigits:a})} ${d(s,r.effectiveUnits[e],"abbr")}`},t}function li({amChart:e,xAxis:t},o){const n=s(o.samples,[]);if(0===n.length)return null;const a=t.toAxisPosition(e.cursor.xPosition),r=t.positionToValue(a);return i(n,r,(i=>i.distance))}export{O as createChart,V as getAdjustedBounds};
