/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.25/esri/copyright.txt for details.
*/
import{_ as t}from"../../../chunks/tslib.es6.js";import e from"../../../Graphic.js";import o from"../../../core/Accessor.js";import{HandleOwnerMixin as r}from"../../../core/HandleOwner.js";import{watch as n,initial as s}from"../../../core/reactiveUtils.js";import{throttle as i}from"../../../core/throttle.js";import{property as l}from"../../../core/accessorSupport/decorators/property.js";import"../../../core/arrayUtils.js";import"../../../core/accessorSupport/ensureType.js";import{subclass as p}from"../../../core/accessorSupport/decorators/subclass.js";import"../../../popup/content/AttachmentsContent.js";import"../../../popup/content/Content.js";import"../../../popup/content/CustomContent.js";import"../../../popup/content/ExpressionContent.js";import a from"../../../popup/content/FieldsContent.js";import c from"../../../popup/content/MediaContent.js";import"../../../popup/content/RelationshipContent.js";import m from"../../../popup/content/TextContent.js";import h from"../../../popup/ElementExpressionInfo.js";import u from"../FeatureContent/FeatureContentViewModel.js";import d from"../FeatureFields/FeatureFieldsViewModel.js";import f from"../FeatureMedia/FeatureMediaViewModel.js";import{loadArcadeUtils as y,createCompiledExpression as _}from"../support/arcadeFeatureUtils.js";const w=1;let j=class extends(r(o)){constructor(t){super(t),this._abortController=null,this.expressionInfo=null,this.graphic=null,this.contentElement=null,this.contentElementViewModel=null,this.interceptor=null,this.view=null,this._cancelQuery=()=>{const{_abortController:t}=this;t&&t.abort(),this._abortController=null},this._createVM=()=>{const t=this.contentElement?.type;this.contentElementViewModel?.destroy();const e="fields"===t?new d:"media"===t?new f:"text"===t?new u:null;this._set("contentElementViewModel",e)},this._compile=async()=>{this._cancelQuery();const t=new AbortController;this._abortController=t,await this._compileExpression(),this._abortController===t&&(this._abortController=null)},this._compileThrottled=i(this._compile,w,this),this._compileExpression=async()=>{const{expressionInfo:t,graphic:e,interceptor:o,spatialReference:r,map:n,view:s,_abortController:i}=this;if(!(t&&e&&r&&n))return void this._set("contentElement",null);const l=await y();if(i!==this._abortController)return;const p=await _({arcadeUtils:l,expressionInfo:t,graphic:e,interceptor:o,map:n,spatialReference:r,view:s});if(!p||"esri.arcade.Dictionary"!==p.declaredClass)return void this._set("contentElement",null);const h=await p.castAsJsonAsync(i.signal),u=h?.type,d="media"===u?c.fromJSON(h):"text"===u?m.fromJSON(h):"fields"===u?a.fromJSON(h):null;this._set("contentElement",d)},this.handles.add([n((()=>[this.expressionInfo,this.graphic,this.map,this.spatialReference,this.view]),(()=>this._compileThrottled()),s),n((()=>[this.contentElement]),(()=>this._createVM()),s)])}destroy(){this._cancelQuery(),this.contentElementViewModel?.destroy(),this._set("contentElementViewModel",null),this._set("contentElement",null)}get spatialReference(){return this.view?.spatialReference??null}set spatialReference(t){this._override("spatialReference",t)}get state(){const{_abortController:t,contentElement:e,contentElementViewModel:o}=this;return t?"loading":e||o?"ready":"disabled"}get map(){return this.view?.map??null}set map(t){this._override("map",t)}};t([l()],j.prototype,"_abortController",void 0),t([l({type:h})],j.prototype,"expressionInfo",void 0),t([l({type:e})],j.prototype,"graphic",void 0),t([l({readOnly:!0})],j.prototype,"contentElement",void 0),t([l({readOnly:!0})],j.prototype,"contentElementViewModel",void 0),t([l()],j.prototype,"interceptor",void 0),t([l()],j.prototype,"spatialReference",null),t([l({readOnly:!0})],j.prototype,"state",null),t([l()],j.prototype,"map",null),t([l()],j.prototype,"view",void 0),j=t([p("esri.widgets.Feature.FeatureExpression.FeatureExpressionViewModel")],j);const C=j;export{C as default};
