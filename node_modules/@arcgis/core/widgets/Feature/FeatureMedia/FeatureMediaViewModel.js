/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.25/esri/copyright.txt for details.
*/
import{_ as t}from"../../../chunks/tslib.es6.js";import e from"../../../core/Accessor.js";import{property as i}from"../../../core/accessorSupport/decorators/property.js";import"../../../core/arrayUtils.js";import{cast as o}from"../../../core/accessorSupport/decorators/cast.js";import{subclass as r}from"../../../core/accessorSupport/decorators/subclass.js";import a from"../../../popup/FieldInfo.js";import s from"../../../popup/content/support/ChartMediaInfoValueSeries.js";import{substituteFieldsInLinksAndAttributes as l,fixTokens as n,substituteAttributes as p,getFixedFieldNames as d,getFixedFieldName as u,isRelatedField as f,isExpressionField as c,getFieldInfo as m,getFieldInfoLabel as h}from"../support/featureUtils.js";import{getRelatedFieldInfo as b}from"../support/relatedFeatureUtils.js";const y={chartAnimation:!0};let I=class extends e{constructor(t){super(t),this.abilities={...y},this.activeMediaInfoIndex=0,this.attributes=null,this.description=null,this.fieldInfoMap=null,this.formattedAttributes=null,this.expressionAttributes=null,this.layer=null,this.mediaInfos=null,this.popupTemplate=null,this.relatedInfos=null,this.title=null}castAbilities(t){return{...y,...t}}get activeMediaInfo(){return this.formattedMediaInfos[this.activeMediaInfoIndex]||null}get formattedMediaInfos(){return this._formatMediaInfos()||[]}get formattedMediaInfoCount(){return this.formattedMediaInfos.length}setActiveMedia(t){this._setContentElementMedia(t)}next(){this._pageContentElementMedia(1)}previous(){this._pageContentElementMedia(-1)}_setContentElementMedia(t){const{formattedMediaInfoCount:e}=this,i=(t+e)%e;this.activeMediaInfoIndex=i}_pageContentElementMedia(t){const{activeMediaInfoIndex:e}=this,i=e+t;this._setContentElementMedia(i)}_formatMediaInfos(){const{attributes:t,mediaInfos:e,formattedAttributes:i,expressionAttributes:o,fieldInfoMap:r,layer:a}=this;return e?.map((e=>{const s=e?.clone();if(!s)return null;if(s.title=l({attributes:t,fieldInfoMap:r,globalAttributes:i,expressionAttributes:o,layer:a,text:s.title}),s.caption=l({attributes:t,fieldInfoMap:r,globalAttributes:i,expressionAttributes:o,layer:a,text:s.caption}),s.altText=l({attributes:t,fieldInfoMap:r,globalAttributes:i,expressionAttributes:o,layer:a,text:s.altText}),"image"===s.type){const{value:t}=s;return this._setImageValue({value:t,formattedAttributes:i,layer:a}),s.value.sourceURL?s:void 0}if("pie-chart"===s.type||"line-chart"===s.type||"column-chart"===s.type||"bar-chart"===s.type){const{value:e}=s;return this._setChartValue({value:e,chartType:s.type,attributes:t,formattedAttributes:i,layer:a,expressionAttributes:o}),s}return null})).filter(Boolean)}_setImageValue(t){const{fieldInfoMap:e}=this,{value:i,formattedAttributes:o,layer:r}=t,{linkURL:a,sourceURL:s}=i;if(s){const t=n(s,r);i.sourceURL=p({formattedAttributes:o,template:t,fieldInfoMap:e})}if(a){const t=n(a,r);i.linkURL=p({formattedAttributes:o,template:t,fieldInfoMap:e})}}_setChartValue(t){const{value:e,attributes:i,formattedAttributes:o,chartType:r,layer:a,expressionAttributes:s}=t,{popupTemplate:l,relatedInfos:n}=this,{fields:p,normalizeField:c}=e;e.fields=d(p,a),c&&(e.normalizeField=u(c,a));if(!p.some((t=>!!(null!=o[t]||f(t)&&n.size))))return;const m=l?.fieldInfos;p.forEach((t=>{if(f(t))return void(e.series=[...e.series,...this._getRelatedChartInfos({fieldInfos:m,fieldName:t,formattedAttributes:o,chartType:r,value:e})]);const a=this._getChartOption({value:e,attributes:i,chartType:r,formattedAttributes:o,expressionAttributes:s,fieldName:t,fieldInfos:m});e.series.push(a)}))}_getRelatedChartInfos(t){const{fieldInfos:e,fieldName:i,formattedAttributes:o,chartType:r,value:a}=t,s=[],l=b(i),{layerId:n,fieldName:p}=l,d=this.relatedInfos?.get(n.toString());if(!d)return s;const{relatedFeatures:u,relation:f}=d;if(!f||!u)return s;const{cardinality:c}=f;u.forEach((t=>{const{attributes:l}=t;l&&Object.keys(l).forEach((t=>{t===p&&s.push(this._getChartOption({value:a,attributes:l,formattedAttributes:o,fieldName:i,chartType:r,relatedFieldName:t,fieldInfos:e}))}))}));return"one-to-many"===c||"many-to-many"===c?s:[s[0]]}_getTooltip({label:t,value:e,chartType:i}){return"pie-chart"===i?`${t}`:`${t}: ${e}`}_getChartOption(t){const{value:e,attributes:i,formattedAttributes:o,expressionAttributes:r,fieldName:l,relatedFieldName:n,fieldInfos:p,chartType:d}=t,{layer:y,fieldInfoMap:I}=this,{normalizeField:v,tooltipField:M}=e,A=v?f(v)?i[b(v).fieldName]:i[v]:null,g=c(l)&&r&&void 0!==r[l]?r[l]:n&&void 0!==i[n]?i[n]:void 0!==i[l]?i[l]:o[l],x=new s({fieldName:l,value:void 0===g?null:g&&A?g/A:g});if(f(l)){const t=I.get(l.toLowerCase()),e=I.get(M.toLowerCase()),i=t?.fieldName??l,r=o[e?.fieldName??M]??t?.label??t?.fieldName??n,a=o[i];return x.tooltip=this._getTooltip({label:r,value:a,chartType:d}),x}const _=m(p,l),C=u(l,y),T=M&&void 0!==o[M]?o[M]:h(_||new a({fieldName:C}),this.popupTemplate?.expressionInfos),N=o[C];return x.tooltip=this._getTooltip({label:T,value:N,chartType:d}),x}};t([i()],I.prototype,"abilities",void 0),t([o("abilities")],I.prototype,"castAbilities",null),t([i()],I.prototype,"activeMediaInfoIndex",void 0),t([i({readOnly:!0})],I.prototype,"activeMediaInfo",null),t([i()],I.prototype,"attributes",void 0),t([i()],I.prototype,"description",void 0),t([i()],I.prototype,"fieldInfoMap",void 0),t([i()],I.prototype,"formattedAttributes",void 0),t([i()],I.prototype,"expressionAttributes",void 0),t([i({readOnly:!0})],I.prototype,"formattedMediaInfos",null),t([i()],I.prototype,"layer",void 0),t([i({readOnly:!0})],I.prototype,"formattedMediaInfoCount",null),t([i()],I.prototype,"mediaInfos",void 0),t([i()],I.prototype,"popupTemplate",void 0),t([i()],I.prototype,"relatedInfos",void 0),t([i()],I.prototype,"title",void 0),I=t([r("esri.widgets.Feature.FeatureMedia.FeatureMediaViewModel")],I);const v=I;export{v as default};
