/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.25/esri/copyright.txt for details.
*/
import"../../../intl.js";import e from"../../../core/Error.js";import{clone as t}from"../../../core/lang.js";import r from"../../../core/Logger.js";import{isSome as i}from"../../../core/maybe.js";import{getMetersPerUnitForSR as n}from"../../../core/unitUtils.js";import o from"../../../geometry/Polygon.js";import s from"../../../rest/support/FullTextSearch.js";import{createExtentFromGeometry as l,scaleExtent as u}from"./geometryUtils.js";import{substitute as a}from"../../../intl/substitute.js";import{formatDate as c}from"../../../intl/date.js";const d=/https?:\/\/services.*\.arcgis\.com/i,f=/(?:\{([^}]+)\})/g,p=r.getLogger("esri.widgets.Search.support.layerSearchUtils");function m(t,r){const{exactMatch:i=!1,location:o,maxResults:l,spatialReference:u,source:a,sourceIndex:c,suggestResult:d,view:f}=t,{layer:m,filter:g,zoomScale:T}=a,L=f&&f.scale,S=y(a,f),q=r&&r.signal;return F(m).then((()=>{const e=m.popupTemplate;return e?e.getRequiredFields(m.fieldsIndex):null})).then((t=>{const{objectIdField:r,returnZ:y}=m,F=b(a);if(!I(m,F))throw p.error("invalid-field: displayField is invalid."),new e("getResults():invalid-field","displayField is invalid.");const C=t&&t.length?t:[F],E=a.outFields||C,M=h(E);E.includes(r)||M||E.push(r),m.floorInfo?.floorField&&E.push(m.floorInfo.floorField);if(!(M||j(m,E)))throw p.error("invalid-field: outField is invalid."),new e("getResults():invalid-field","outField is invalid.");const N=m.createQuery(),{orderByFields:k}=a;if(k&&(N.orderByFields=k),u){N.outSpatialReference=u;const e=1/n(u);e&&(N.maxAllowableOffset=e)}const O="mesh"===m.geometryType||"multipatch"===m.geometryType,A=m.capabilities?.data?.supportsZ&&!O;if(N.returnZ=A&&!1!==y,N.returnGeometry=!0,N.multipatchOption=O?"xyFootprint":null,E&&(N.outFields=E),o)N.geometry=o;else if(d.key)N.objectIds=[d.key];else{const t=a.searchFields||[F];if(!j(m,t))throw p.error("invalid-field: search field is invalid."),new e("getResults():invalid-field","search field is invalid.");$(m)&&(N.num=l),S&&(N.geometry=S);if(!d.text.trim())return[];const r=d.text,{prefix:n="",suffix:o=""}=a,u=R(`${n}${r}${o}`);v(m)&&w(m,t)&&!i&&r&&(N.fullText=[new s({onFields:t,searchTerm:r,searchType:"prefix"})]);const c=D({searchTerm:u,layer:m,searchFields:t,filter:g,exactMatch:i,query:N,type:"search"});if(N.where=c,!x(N))return[]}return m.queryFeatures(N,{signal:q}).then((e=>U(e,f,a,c,F,L,T)))}))}function g(t,r){const{source:i,spatialReference:n,view:o,suggestTerm:l,maxSuggestions:u,sourceIndex:a,exactMatch:c}=t,{layer:d,filter:m}=i,g=r&&r.signal,T=y(i,o);return F(d).then((()=>{if(!$(d))return[];const t=b(i),r=i.searchFields||[t],o=[];i.suggestionTemplate?i.suggestionTemplate.replace(f,((e,t)=>(o.push(t),e))):o.push(t);const y=h(o);o.includes(d.objectIdField)||y||o.push(d.objectIdField);const F=I(d,t),L=y||j(d,o),S=j(d,r);if(!F)throw p.error("invalid-field: displayField is invalid."),new e("getSuggestions():invalid-field","displayField is invalid.");if(!L)throw p.error("invalid-field: outField is invalid."),new e("getSuggestions():invalid-field","outField is invalid.");if(!S)throw p.error("invalid-field: search field is invalid."),new e("getSuggestions():invalid-field","search field is invalid.");const q=d.createQuery(),{orderByFields:C}=i;C&&(q.orderByFields=C),q.outSpatialReference=n,q.returnGeometry=!1,q.num=u,q.outFields=o,T&&(q.geometry=T);if(!l.trim())return[];const{prefix:E="",suffix:M=""}=i,N=R(`${E}${l}${M}`);v(d)&&w(d,r)&&!c&&l&&(q.fullText=[new s({onFields:r,searchTerm:l,searchType:"prefix"})]);const k=D({searchTerm:N,layer:d,searchFields:r,filter:m,exactMatch:c,query:q,type:"suggest"});return q.where=k,x(q)?d.queryFeatures(q,{signal:g}).then((e=>A(e,i,a,t))):[]}))}function y(e,t){const{filter:r,withinViewEnabled:i}=e,n=t&&t.extent;return r&&r.geometry||(i&&n?n:void 0)}function h(e){return e&&e.includes("*")}async function F(e){e&&await e.load()}function x(e){return!(!e.fullText&&!e.where)}function w(e,t){const r=e?.indexes;if(!r||!t?.length)return!1;return r.filter((e=>"FullText"===e.indexType)).some((e=>{const r=e.fields?.split(",").map((e=>e.trim().toLowerCase()))||[];return t.every((e=>r.includes(e.toLowerCase())))}))}function v(e){return e?.capabilities?.query?.supportsFullTextSearch??!1}function $(e){return e?.capabilities?.query?.supportsPagination??!1}function T(e){return e?.fieldsIndex?.fields?.find((e=>"string"===e.type))?.name??""}function b(e){return e.displayField||e.layer.displayField||T(e.layer)}function j(e,t){return!(!e||!t?.length)&&t.every((t=>I(e,t)))}function I(e,t){return!!e.getField(t)}function L(e){for(let t=0;t<e.length;t++)if(e.charCodeAt(t)>255)return!0;return!1}function S(e,t,r){let i=null;const{codedValues:n}=e;return n&&n.some((e=>{const n=e.name,o=r?n:n.toLowerCase();return(r?t:t.toLowerCase())===o&&(i=e.code.toString(),!0)})),i}function R(e){return e.replace(/\'/g,"''")}function q(e,t){const r=t&&t.where;return r?`(${e}) AND (${r})`:e}function C({currentTerm:e,field:t,filter:r,exactMatch:i,url:n,type:o}){const s=t.type,l=t.name;if("string"===s||"date"===s||"global-id"===s){const t=d.test(n),s=t&&L(e)?"N":"";if(i&&"search"===o)return q(`${l} = ${s}'${e}'`,r);if(t){return q(`${l} LIKE ${s}${`'${e}%'`}`,r)}return q(`${`LOWER(${l})`} LIKE ${s}${`'${e.toLowerCase()}%'`}`,r)}if("oid"===s||"small-integer"===s||"integer"===s||"single"===s||"double"===s){const t=Number(e);return isNaN(t)?null:q(`${l} = ${t}`,r)}return q(`${l} = ${e}`,r)}function E(e,t){return e?` OR (${t})`:`(${t})`}function D({searchTerm:e,layer:t,searchFields:r,filter:i,exactMatch:n,query:o,type:s}){const{definitionExpression:l,url:u}=t;let a="";return!o.fullText&&e&&r&&r.forEach((r=>{const o=t.getField(r),l="function"==typeof t.getFieldDomain&&t.getFieldDomain(r),c=(l&&"coded-value"===l.type?S(l,e,n):null)||e||null;if(null!==c){const e=C({currentTerm:c,field:o,filter:i,exactMatch:n,url:u,type:s});e&&(a+=E(a,e))}})),l&&a?`(${l}) AND (${a})`:l||a}function M(e,t){let r=null;const{codedValues:i}=e;return i&&i.length&&i.some((e=>e.code===t&&(r=e.name,!0))),r}function N(e,t){return e[Object.keys(e).find((e=>e.toLowerCase()===t.toLowerCase()))]}function k(e,t,r){const i=e.sourceLayer,{attributes:n}=e,o="function"==typeof i.getFieldDomain&&i.getFieldDomain(r);if(t)return a(t,n);if(r&&n){const e=i.getField(r),t=N(n,r);return null==t?"":o&&"coded-value"===o.type?M(o,t):"date"===e?.type?c(new Date(t)):"number"==typeof t?t.toString():"string"!=typeof t?"":t.trim()}return""}function O(e,t,r,i){const n=e.sourceLayer,{attributes:o}=e,{objectIdField:s}=n,l=o[s];return{text:k(e,t.suggestionTemplate,i),key:l,sourceIndex:r}}function A(e,t,r,i){return e.features.map((e=>O(e,t,r,i)))}function B(e,r,n,s,a,c,d){const f=e.clone(),p=e.sourceLayer,m=p&&p.objectIdField,g=m&&e.attributes[m],y=k(e,n.searchTemplate,a),h=l(f.geometry,r,c),F="number"==typeof d?u(t(h),r,d):h,x=e.clone();return i(F)&&(x.geometry=o.fromExtent(F)),{extent:F,target:x,feature:f,key:g,name:y,sourceIndex:s}}function U(e,t,r,i,n,o,s){return e.features.map((e=>B(e,t,r,i,n,o,s)))}export{m as getResults,g as getSuggestions};
