/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.25/esri/copyright.txt for details.
*/
import{_ as e}from"../chunks/tslib.es6.js";import"../intl.js";import{eventKey as t}from"../core/events.js";import{watch as i}from"../core/reactiveUtils.js";import{property as s}from"../core/accessorSupport/decorators/property.js";import"../core/arrayUtils.js";import"../core/accessorSupport/ensureType.js";import{subclass as l}from"../core/accessorSupport/decorators/subclass.js";import o from"./Widget.js";import n from"./FloorFilter/FloorFilterViewModel.js";import{Heading as r,incrementHeadingLevel as a}from"./support/Heading.js";import{isRTL as c,storeNode as d}from"./support/widgetUtils.js";import{messageBundle as h}from"./support/decorators/messageBundle.js";import{tsx as u}from"./support/jsxFactory.js";import{substitute as v}from"../intl/substitute.js";const f={esriWidget:"esri-widget",esriWidgetButton:"esri-widget--button",esriWidgetButtonActive:"esri-widget--button-active",esriButtonDisabled:"esri-button--disabled",esriDisabled:"esri-disabled",esriIcon:"esri-icon",esriInteractive:"esri-interactive",esriWidgetContentEmpty:"esri-widget__content--empty",floorFilter:"esri-floor-filter",floorFilterLayout:"esri-floor-filter__layout--",floorFilterPosition:"esri-floor-filter__position--",buttonContainer:"esri-floor-filter__button-container",buttonContainerLevels:"esri-floor-filter__button-container--levels",buttonInfo:"esri-floor-filter__button-info",buttonLabel:"esri-floor-filter__button-label",browseButton:"esri-floor-filter__browse-button",closeLevelsButton:"esri-floor-filter__close-levels-button",zoomButton:"esri-floor-filter__zoom-button",zoomButtonLevels:"esri-floor-filter__zoom-button--levels",minimizeToggleButton:"esri-floor-filter__minimize-toggle-button",levelsContainer:"esri-floor-filter__levels-container",levelButton:"esri-floor-filter__level-button",levelButtonActive:"esri-floor-filter__level-button--active",separator:"esri-floor-filter__separator",filterMenu:"esri-floor-filter__filter-menu",filterMenuHeader:"esri-floor-filter__filter-menu-header",filterMenuHeaderTextGroup:"esri-floor-filter__filter-menu-header-text-group",filterMenuHeaderText:"esri-floor-filter__filter-menu-header-text",filterMenuHeaderSubtext:"esri-floor-filter__filter-menu-header-subtext",filterMenuHeaderBack:"esri-floor-filter__filter-menu-header-back",filterMenuSearch:"esri-floor-filter__filter-menu-search",filterMenuSearchInput:"esri-floor-filter__filter-menu-search-input",filterMenuItems:"esri-floor-filter__filter-menu-items",filterMenuItemName:"esri-floor-filter__filter-menu-item-name",filterMenuSelectedItem:"esri-floor-filter__filter-menu-item-name--selected",filterMenuSite:"esri-floor-filter__filter-menu-site",filterMenuFacility:"esri-floor-filter__filter-menu-facility",selectedItemCircle:"esri-floor-filter__selected-item-circle",urbanIcon:"esri-icon-urban-model",zoomToIcon:"esri-icon-zoom-to-object",collapseIconRight:"esri-icon-collapse",collapseIconLeft:"esri-icon-expand",expandIconRight:"esri-icon-expand",expandIconLeft:"esri-icon-collapse",closeIcon:"esri-icon-close",searchIcon:"esri-icon-search",rightIcon:"esri-icon-right",leftIcon:"esri-icon-left"},m=["ArrowUp","ArrowDown","End","Home"];let g=class extends o{constructor(e,t){super(e,t),this._activeMenu=null,this._activeMenuIndex={levels:-1,menuItems:-1},this._baseNode=null,this._facilitiesListNode=null,this._levelsListNode=null,this._sitesListNode=null,this._searchInput=null,this.viewModel=new n,this.messages=null,this.messagesCommon=null,this.headingLevel=2,this._resizeObserver=new ResizeObserver((()=>this.scheduleRender())),this.addHandles(i((()=>this._searchInput),(()=>this._focusSearch())))}destroy(){this._resizeObserver.disconnect()}get enabled(){return this.viewModel.enabled}set enabled(e){this.viewModel.enabled=e}get longNames(){return this.viewModel.longNames}set longNames(e){this.viewModel.longNames=e}get minimized(){return this.viewModel.minimized}set minimized(e){this.viewModel.minimized=e}get pinnedLevels(){return this.viewModel.pinnedLevels}set pinnedLevels(e){this.viewModel.pinnedLevels=e}get site(){return this.viewModel.site}set site(e){this.viewModel.site=e}get facility(){return this.viewModel.facility}set facility(e){this.viewModel.facility=e}get level(){return this.viewModel.level}set level(e){this.viewModel.level=e}get view(){return this.viewModel.view}set view(e){this.viewModel.view=e}get goToOverride(){return this.viewModel.goToOverride}set goToOverride(e){this.viewModel.goToOverride=e}updateWebDocument(e){return this.viewModel.updateWebDocument(e)}render(){const{longNames:e}=this,t=e&&this.viewModel.isNormalMode?"expanded":"collapsed",i=this.renderButtons(),s=this.renderFilterMenu(),l=u("div",{class:this.classes(f.separator)}),o=this._getComponentPosition(),n=this._getPosition(o),r="top-right"===o||"bottom-right"===o,a="top-left"===o||"bottom-left"===o,d=c(this.container),h=d&&a||!d&&r?s:i,v=d&&a||!d&&r?i:s;return u("div",{afterCreate:this._afterBaseNodeCreate,key:"floor-filter-menu",class:this.classes(f.floorFilter,f.esriWidget,`${f.floorFilterLayout}${t}`,`${f.floorFilterPosition}${n}`)},h,this.viewModel?.filterMenuOpen&&l,v)}renderButtons(){const e=this._getComponentPosition(),t=[];return"top"===this._getPosition(e)?(t.push(this.renderBrowseButton()),t.push(this.renderLevelButtons()),t.push(this.renderCloseLevelsButton()),t.push(this.renderZoomButton()),t.push(this.renderCollapseToggleButton())):(t.push(this.renderCollapseToggleButton()),t.push(this.renderZoomButton()),t.push(this.renderCloseLevelsButton()),t.push(this.renderLevelButtons()),t.push(this.renderBrowseButton())),u("div",{key:"button-container",class:this.classes(f.esriWidget,f.buttonContainer)},t)}renderBrowseButton(){const{longNames:e,messages:t}=this;return u("button",{key:"browse-button",title:t.buttons.browse,bind:this,class:this.classes(f.esriWidget,f.esriWidgetButton,f.esriInteractive,("loading"===this.viewModel.state||"disabled"===this.viewModel.state)&&f.esriButtonDisabled,f.browseButton,this.viewModel?.filterMenuOpen&&f.esriWidgetButtonActive),"aria-expanded":this.viewModel.filterMenuOpen.toString(),"aria-label":t.buttons.browse,onclick:this._toggleFilterMenu,type:"button"},u("div",{class:this.classes(f.buttonInfo)},u("span",{class:this.classes(f.esriIcon,f.urbanIcon)}),u("span",{class:this.classes(f.buttonLabel)},e&&this.viewModel.isNormalMode&&t.buttons.browse)))}renderLevelButtons(){if(!this.viewModel?.filterFeatures?.levels?.levelsInfo||!this.facility)return null;const{facility:e,messagesCommon:t,messages:i}=this,s=this.viewModel?.getFacility(e),l=this.viewModel?.getFacilityLevels(e),o=l.map((e=>this.renderLevelButton(e)));if(!o.length)return null;const n=s&&v(i.selector.levelsLabel,{name:`"${s.name}"`});if(this._isWebScene(this.view.map)&&o?.length>1){const i={id:`all--${e}`,facilityId:e,shortName:t.all,longName:t.all,levelNumber:null,verticalOrder:null},s=this.renderLevelButton(i);o.push(s)}return u("ul",{key:"levels-button-container",class:this.classes(f.levelsContainer),bind:this,"data-id":"levels",afterCreate:d,"data-node-ref":"_levelsListNode","aria-label":n,onkeydown:this._handleListKeydown},o)}renderLevelButton(e){const{longNames:t}=this,{shortName:i,longName:s,id:l}=e,o=`levels--${l}`,n=this.level===l,r=t&&this.viewModel.isNormalMode?s:i;return this.viewModel.isNormalMode||n||this.viewModel.levelsExpanded?u("li",{key:o},u("button",{"data-id":l,"data-list-id":"levels",bind:this,class:this.classes(f.esriWidgetButton,n?f.esriWidgetButtonActive:null,f.esriInteractive,f.levelButton),onclick:this._levelSelected,onfocus:this._onItemFocus,type:"button"},r)):null}renderCloseLevelsButton(){if(!this.level||this.viewModel.isNormalMode||!this.viewModel.levelsExpanded)return null;const{messagesCommon:e}=this;return u("button",{key:"close-levels-button",title:e.close,bind:this,class:this.classes(f.esriWidget,f.esriWidgetButton,f.esriInteractive,f.closeLevelsButton),"aria-label":e.close,onclick:this._closeLevels,type:"button"},u("div",{class:this.classes(f.buttonInfo)},u("span",{class:this.classes(f.esriIcon,f.closeIcon)})))}renderZoomButton(){const{longNames:e,messages:t,facility:i,site:s}=this,l=this.viewModel?.filterMenuType,o=this.viewModel?.filterMenuOpen,n=this.viewModel?.getSite(s),r=this.viewModel?.getFacility(i),a="site"===l&&o?!n:!r;return u("button",{key:"zoom-button",title:t.buttons.zoomTo,bind:this,class:this.classes(f.esriWidget,f.esriWidgetButton,a&&f.esriButtonDisabled,f.esriInteractive,this.viewModel?.getFacilityLevels(i).length>0?f.zoomButtonLevels:f.zoomButton),"aria-label":t.buttons.zoomTo,onclick:this._zoomToClicked,type:"button"},u("div",{class:this.classes(f.buttonInfo)},u("span",{class:this.classes(f.esriIcon,f.zoomToIcon)}),u("span",{class:this.classes(f.buttonLabel)},e&&this.viewModel.isNormalMode&&t.buttons.zoomTo)))}renderCollapseToggleButton(){const{longNames:e,messagesCommon:t}=this,i=e?f.collapseIconRight:f.expandIconRight,s=this.classes(f.esriIcon,i),l=e?t.collapse:t.expand;return u("button",{key:"minimize-toggle-button",title:l,bind:this,class:this.classes(f.esriWidget,f.esriWidgetButton,f.esriInteractive,f.minimizeToggleButton),"aria-label":l,onclick:this._toggleCollapsed,type:"button"},u("div",{class:this.classes(f.buttonInfo)},u("span",{class:s}),u("span",{class:this.classes(f.buttonLabel)},e&&this.viewModel.isNormalMode&&t.collapse)))}renderFilterMenu(){return this.viewModel?.filterMenuOpen?"site"===this.viewModel?.filterMenuType?this.renderSiteFilterMenu():"facility"===this.viewModel?.filterMenuType?this.renderFacilityFilterMenu():null:null}renderSiteFilterMenu(){const{messages:e,messagesCommon:t}=this,i=this.site?this.viewModel?.getSite(this.site)?.name:e.selector.selectSite,s=u("div",{key:"filter-menu-site-header",class:this.classes(`${f.filterMenuHeader}`)},u("div",{class:this.classes(f.filterMenuHeaderTextGroup)},u(r,{level:this.headingLevel,class:this.classes(f.filterMenuHeaderText)},i)),u("button",{bind:this,title:t.close,class:this.classes(f.esriIcon,f.closeIcon),onclick:this._closeClicked,type:"button"})),l=this.renderSearchInput(),o=this.renderSiteItems();return u("div",{key:"filter-menu-site",class:this.classes(f.filterMenu)},s,l,o)}renderFacilityFilterMenu(){const{messages:e,messagesCommon:t,site:i}=this,s=this.viewModel?.getSite(i)?.name,l=this.facility&&this.viewModel?.getFacility(this.facility)?.name||e.selector.selectFacility,o=this.viewModel.hasMultipleSites?u("button",{bind:this,title:t.back,class:this.classes(f.filterMenuHeaderBack),onclick:this._backClicked,type:"button"},u("span",{class:this.classes(c(this.container)?f.rightIcon:f.leftIcon)})):null,n=this.viewModel.hasMultipleSites?u(r,{level:a(this.headingLevel),class:this.classes(f.filterMenuHeaderSubtext)},s):null,d=u("div",{key:"filter-menu-site-header",class:this.classes(f.filterMenuHeader)},o,u("div",{class:this.classes(f.filterMenuHeaderTextGroup)},u(r,{level:this.headingLevel,class:this.classes(f.filterMenuHeaderText)},l),n),u("button",{bind:this,title:t.close,class:this.classes(f.esriIcon,f.closeIcon),onclick:this._closeClicked,type:"button"})),h=this.renderSearchInput(),v=this.renderFacilityItems();return u("div",{key:"filter-menu-facility",class:this.classes(f.filterMenu)},d,h,v)}renderSearchInput(){const{messagesCommon:e}=this;return u("div",{key:"filter-menu-search",class:this.classes(f.filterMenuSearch)},u("span",{class:this.classes(f.esriIcon,f.searchIcon)}),u("input",{bind:this,key:"filter-menu-search__input",afterCreate:d,"data-node-ref":"_searchInput",class:this.classes(f.filterMenuSearchInput),placeholder:e.search,oninput:this._onSearchChange,onpaste:this._onSearchChange,value:this.viewModel.searchTerm}))}renderBlueCircle(){return u("span",{key:"floor-filter__selected-item-circle",class:this.classes(f.selectedItemCircle)})}renderSiteItems(){if(!this.viewModel?.filterFeatures?.sites?.sitesInfo)return null;const{messages:e}=this,t=this.viewModel.filterFeatures.sites.sitesInfo,i=this.viewModel.filterSites(t).map((e=>this.renderSiteItem(e))),s=0===i.length&&this.viewModel?.searchTerm&&u("div",{class:this.classes(f.esriWidgetContentEmpty)},e.noResults);return u("ul",{key:"filter-menu-items--sites",class:this.classes(f.filterMenuItems),bind:this,afterCreate:d,"data-node-ref":"_sitesListNode","data-id":"sites",onkeydown:this._handleListKeydown,tabIndex:-1,"aria-label":e.selector.sitesLabel},i,s)}renderSiteItem(e){const{name:t,id:i}=e,s=`filter-menu-site--${i}`,l=this.site===i;return u("li",{key:s},u("button",{"data-id":i,"data-list-id":"sites",bind:this,class:this.classes(f.filterMenuSite),onclick:this._siteSelected,onfocus:this._onItemFocus,type:"button"},l&&this.renderBlueCircle(),u("span",{class:this.classes(l?f.filterMenuSelectedItem:f.filterMenuItemName)},t),u("span",{class:this.classes(c(this.container)?f.leftIcon:f.rightIcon)})))}renderFacilityItems(){if(!this.viewModel?.filterFeatures?.facilities?.facilitiesInfo)return null;const{messages:e,site:t}=this,i=this.viewModel.getSite(t),s=this.viewModel.filterFeatures.facilities.facilitiesInfo,l=this.viewModel.filterFacilities(s).map((e=>this.renderFacilityItem(e))),o=0===l.length&&this.viewModel?.searchTerm&&u("div",{class:this.classes(f.esriWidgetContentEmpty)},e.noResults),n=i?v(e.selector.siteFacilitiesLabel,{name:`"${i.name}"`}):e.selector.facilitiesLabel;return u("ul",{key:"filter-menu-items--facilities",class:this.classes(f.filterMenuItems),bind:this,afterCreate:d,"data-node-ref":"_facilitiesListNode","data-id":"facilities",onkeydown:this._handleListKeydown,tabIndex:-1,"aria-label":n},l,o)}renderFacilityItem(e){const{name:t,id:i}=e,s=`filter-menu-facility--${i}`,l=this.facility===i;return u("li",{key:s},u("button",{"data-id":i,"data-list-id":"facilities",bind:this,class:this.classes(f.filterMenuFacility),onclick:this._facilitySelected,onfocus:this._onItemFocus,type:"button"},l&&this.renderBlueCircle(),u("span",{class:this.classes(l?f.filterMenuSelectedItem:f.filterMenuItemName)},t)))}_afterBaseNodeCreate(e){this._baseNode&&this._resizeObserver?.unobserve(this._baseNode),this._baseNode=e,this._resizeObserver?.observe(this._baseNode)}_toggleCollapsed(){this.longNames=!this.longNames}_toggleFilterMenu(){const e=this.viewModel?.filterMenuOpen??!1;this.viewModel.filterMenuOpen=!e}_setFilterMenuType(e){this.viewModel.filterMenuType=e}_zoomToClicked(){if(this.site&&"site"===this.viewModel?.filterMenuType&&this.viewModel?.filterMenuOpen){const e=this.viewModel?.getSite(this.site);this.viewModel.goTo(e)}else if(this.facility){const e=this.viewModel?.getFacility(this.facility);this.viewModel.goTo(e)}else if(this.site){const e=this.viewModel?.getSite(this.site);this.viewModel.goTo(e)}}_onSearchChange(e){const t=e.target;""===t.value?this.viewModel.searchTerm=null:t.value&&this.viewModel?.searchTerm!==t.value&&(this.viewModel.searchTerm=t.value.toLowerCase().trim())}_closeClicked(){this.viewModel.searchTerm=null,this.viewModel.filterMenuOpen=!1}_backClicked(){this._setFilterMenuType("site"),this.viewModel.searchTerm=null}_siteSelected(e){const t=e.currentTarget.getAttribute("data-id"),i=this.viewModel.getSite(t);let s=!1;this.site!==t&&(this.facility=null,this.level=null,s=!0,this.viewModel.levelsExpanded=!1),this.site=t,this.viewModel.searchTerm=null,this._setFilterMenuType("facility"),this.viewModel.goTo(i),s&&this.viewModel.setFloors(null)}_facilitySelected(e){const t=e.currentTarget.getAttribute("data-id"),i=this.viewModel.getFacility(t);let s=!1;if(this.facility!==t){if("base-floors"===this.viewModel.filterMode){const e=this.viewModel?.getBaseLevel(i);this.level=e?e.id:null}else this.level=null;s=!0,this.viewModel.levelsExpanded=!1}if(this.facility=t,this.viewModel.goTo(i),s){const e=this.viewModel.getLevel(this.level);this.viewModel.setFloors(e)}if(!this.viewModel.isNormalMode){this.viewModel.getFacilityLevels(t)?.length>1&&(this.viewModel.levelsExpanded=!0)}setTimeout((()=>this._focusActiveLevel()),50)}_levelSelected(e){const t=e.currentTarget.getAttribute("data-id");this.level=t}_closeLevels(){this.viewModel.levelsExpanded=!1}_isWebScene(e){return"esri.WebScene"===e.declaredClass}_getComponentPosition(){return this.view?.ui?.getPosition(this.container)}_getPosition(e){switch(e){case"bottom-right":case"bottom-left":return"bottom";default:return"top"}}_handleListKeydown(e){const i=e.currentTarget.getAttribute("data-id");let s=null;"sites"===i||"facilities"===i?(this._activeMenu!==i&&(this._activeMenuIndex.menuItems=-1),this._activeMenu=i,s="menuItems"):"levels"===i&&(s="levels");const l="sites"===i?this._sitesListNode:"facilities"===i?this._facilitiesListNode:"levels"===i?this._levelsListNode:null,o=t(e),n="Tab"===o,r=m.includes(o);r&&e.preventDefault();const a=l?.getElementsByTagName("li");a&&0!==a.length&&(r||n)&&this._handleItemNavigation(o,e.shiftKey,a,n,s)}_handleItemNavigation(e,t,i,s,l){if(!l)return;this._activeMenuIndex[l]===i.length&&this._activeMenuIndex[l]--,-1===this._activeMenuIndex[l]&&this._activeMenuIndex[l]++;const o=this._activeMenuIndex[l];switch(e){case"Home":this._activeMenuIndex[l]=0;break;case"End":this._activeMenuIndex[l]=i.length-1;break;case"ArrowUp":this._activeMenuIndex[l]=this._activeMenuIndex[l]<=0?i.length-1:this._activeMenuIndex[l]-1;break;case"ArrowDown":this._activeMenuIndex[l]=this._activeMenuIndex[l]===i.length-1?0:this._activeMenuIndex[l]+1}if("Tab"===e&&t&&this._activeMenuIndex[l]>=0&&this._activeMenuIndex[l]--,"Tab"===e&&!t&&this._activeMenuIndex[l]<i.length&&this._activeMenuIndex[l]++,o!==this._activeMenuIndex[l]&&this._activeMenuIndex[l]>-1&&this._activeMenuIndex[l]<i.length&&!s){const e=i[this._activeMenuIndex[l]].getElementsByTagName("button");(1===e?.length&&e[0])?.focus()}}_focusSearch(){this._searchInput?.focus()}_focusActiveLevel(){const{level:e}=this,t=this._levelsListNode,i=t?.getElementsByTagName("li");if(!e||!t||!i)return;const s=this._facilitiesListNode?.getElementsByTagName("li");this._activeMenuIndex.menuItems=s?s.length-1:-1;const l=[];for(let o=0;o<i.length;o++){const e=i[o].getElementsByTagName("button");1===e?.length&&l.push(e[0])}l.forEach(((t,i)=>{t.getAttribute("data-id")===e&&(t.focus(),this._activeMenuIndex.levels=i)}))}_onItemFocus(e){const t=e.currentTarget,i=t.getAttribute("data-list-id"),s=t.getAttribute("data-id"),l="sites"===i?this._sitesListNode:"facilities"===i?this._facilitiesListNode:"levels"===i?this._levelsListNode:null;if(!l)return;const o=l?.getElementsByTagName("li");if(!o)return;const n=[];Array.from(o).forEach((e=>{const t=e.getElementsByTagName("button");1===t?.length&&n.push(t[0])}));let r=null;switch(i){case"sites":case"facilities":r="menuItems";break;case"levels":r="levels"}r&&n.forEach(((e,t)=>{e.getAttribute("data-id")===s&&this._activeMenuIndex[r]!==t&&(this._activeMenuIndex[r]=t)}))}};e([s()],g.prototype,"_searchInput",void 0),e([s()],g.prototype,"enabled",null),e([s()],g.prototype,"longNames",null),e([s()],g.prototype,"minimized",null),e([s()],g.prototype,"pinnedLevels",null),e([s()],g.prototype,"site",null),e([s()],g.prototype,"facility",null),e([s()],g.prototype,"level",null),e([s()],g.prototype,"view",null),e([s({type:n})],g.prototype,"viewModel",void 0),e([s(),h("esri/widgets/FloorFilter/t9n/FloorFilter")],g.prototype,"messages",void 0),e([s(),h("esri/t9n/common")],g.prototype,"messagesCommon",void 0),e([s()],g.prototype,"goToOverride",null),e([s()],g.prototype,"headingLevel",void 0),g=e([l("esri.widgets.FloorFilter")],g);const p=g;export{p as default};
