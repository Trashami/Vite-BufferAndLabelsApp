/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.25/esri/copyright.txt for details.
*/
import{_ as e}from"../../chunks/tslib.es6.js";import t from"../../core/Collection.js";import r from"../../core/Error.js";import a from"../../core/Evented.js";import{HandleOwnerMixin as o}from"../../core/HandleOwner.js";import i from"../../core/Logger.js";import{on as s,when as n,watch as l,whenOnce as d,initial as p}from"../../core/reactiveUtils.js";import{property as c}from"../../core/accessorSupport/decorators/property.js";import"../../core/arrayUtils.js";import"../../core/accessorSupport/ensureType.js";import{subclass as u}from"../../core/accessorSupport/decorators/subclass.js";import w from"../../layers/GraphicsLayer.js";import h from"../Attachments/AttachmentsViewModel.js";import f from"./CreateFeaturesWorkflow.js";import y from"./CreateWorkflow.js";import{workflowDeprecation as m}from"./deprecationUtils.js";import k from"./UpdateWorkflow.js";import W from"../FeatureForm/FeatureFormViewModel.js";import g from"../FeatureTemplates/FeatureTemplatesViewModel.js";import _ from"../Sketch/SketchViewModel.js";import v from"../Spinner/SpinnerViewModel.js";const b="esri.widgets.Editor.EditorViewModel",C=i.getLogger(b),F=["create","create-features","update"];function E(e,t,a){C.error(new r(e,t,a))}function A(e,t){return e&&e.find((e=>e.layer===t))}let M=class extends(o(a.EventedAccessor)){constructor(e){super(e),this._sketchGraphicsLayer=new w({listMode:"hide",internal:!0}),this.activeWorkflow=null,this._activityQueue=[],this.failures=[],this.attachmentsViewModel=new h({abilities:{editing:!0}}),this.featureFormViewModel=new W,this.featureTemplatesViewModel=new g,this.layerInfos=null,this.sketchViewModel=new _({layer:this._sketchGraphicsLayer}),this.spinnerViewModel=new v}initialize(){this.handles.add([s((()=>this.activeWorkflow),"cancel",(()=>this.emit("workflow-cancel"))),s((()=>this.activeWorkflow),"commit",(()=>this.emit("workflow-commit"))),n((()=>this.view?.map),(e=>{e.add(this._sketchGraphicsLayer)}),p),l((()=>this.editableItems.toArray()),(()=>{const{activeWorkflow:e}=this;if(this.refreshCreationTemplates(),!e)return;const{stepId:t}=e;"create"!==e.type?"update"===e.type&&("awaiting-feature-to-update"===t&&!this.canUpdate||"awaiting-update-feature-candidate"===t&&!e.data.candidates.some((e=>{const t=this.editableItems.find((t=>t.layer===e.layer));return t&&t.supports.includes("update")})))&&this._cancelWorkflow():"awaiting-feature-creation-info"!==t||this.canCreate||this._cancelWorkflow()}))])}destroy(){this._cancelWorkflow().then((()=>{this.view?.map&&this.view.map.remove(this._sketchGraphicsLayer),this.view=null}))}get allowedWorkflows(){return this._get("allowedWorkflows")}set allowedWorkflows(e){e&&0!==e.length||(e=[...F]),this._set("allowedWorkflows",e)}get canCreate(){return this.editableItems.some((e=>e.supports.includes("create")))}get canUpdate(){return this.editableItems.some((e=>e.supports.includes("update")))}get editableItems(){const e=this.view?.allLayerViews;if(!e)return new t;const r=this.view?.map?.editableLayers,a=new Set(r),o=r?.filter((e=>e.visible&&e.capabilities.operations.supportsAdd&&!e.capabilities.operations.supportsQuery)),i=e.filter((e=>a.has(e.layer))).map((({layer:e,suspended:t})=>this._getEditableItemFromLayer(e,t))).reverse();return o?.forEach((e=>i.push(this._getEditableItemFromLayer(e,!1)))),i}get labelOptions(){return this.sketchViewModel.labelOptions}set labelOptions(e){this.sketchViewModel.labelOptions=e}get snappingOptions(){return this.sketchViewModel.snappingOptions}set snappingOptions(e){this.sketchViewModel.snappingOptions=e}get state(){if(!this.get("view.ready")||0===this.editableItems.length)return"disabled";const e=this.attachmentsViewModel.mode;if("add"===e)return"adding-attachment";if("edit"===e)return"editing-attachment";const{activeWorkflow:t}=this;return t?t.stepId:"ready"}get syncing(){return this._activityQueue.length>0}get tooltipOptions(){return this.sketchViewModel.tooltipOptions}set tooltipOptions(e){this.sketchViewModel.tooltipOptions=e}set view(e){this.sketchViewModel.view=e,this.spinnerViewModel.view=e,this._set("view",e)}async startCreateWorkflowAtFeatureTypeSelection(){if(m(C,"startCreateWorkflowAtFeatureTypeSelection","startCreateFeaturesWorkflowAtFeatureTypeSelection"),!this.canCreate)return void E("editing:unsupported-workflow","Create workflow is unsupported or disabled.");await this._cancelWorkflow();const e=this._createCreateWorkflow();await e.start(),this._set("activeWorkflow",e)}async startCreateFeaturesWorkflowAtFeatureTypeSelection(){return this.startCreateFeaturesWorkflow()}async startCreateWorkflowAtFeatureCreation(e){if(m(C,"startCreateWorkflowAtFeatureCreation","startCreateFeaturesWorkflowAtFeatureCreation"),!this.canCreate)return void E("editing:unsupported-workflow","Create workflow is unsupported or disabled.");await this._cancelWorkflow();const t=this._createCreateWorkflow("awaiting-feature-to-create");t.data.creationInfo=e,await t.start(),this._set("activeWorkflow",t)}async startCreateFeaturesWorkflowAtFeatureCreation(e){return this.startCreateFeaturesWorkflow(e,"creating-features")}async startCreateFeaturesWorkflow(e,t="awaiting-feature-creation-info"){if(!this.canCreate)throw new r("editing:unsupported-workflow","Creating features is unsupported or disabled.");await this._cancelWorkflow();const a=this._createCreateFeaturesWorkflow(e,t);await a.start(),this._set("activeWorkflow",a)}async startCreateWorkflowAtFeatureEdit(e){if(m(C,"startCreateWorkflowAtFeatureEdit"),!this.canCreate)return void E("editing:unsupported-workflow","Create workflow is unsupported or disabled.");await this._cancelWorkflow();const t=this._createCreateWorkflow("editing-new-feature");t.data.edits.feature=e,await t.start(),this._set("activeWorkflow",t)}async startUpdateWorkflowAtFeatureSelection(){if(!this.canUpdate)return void E("editing:unsupported-workflow","Update workflow is unsupported or disabled.");await this._cancelWorkflow();const e=this._createUpdateWorkflow();await e.start(),this._set("activeWorkflow",e)}async startUpdateWorkflowAtMultipleFeatureSelection(e){if(!this.canUpdate)return void E("editing:unsupported-workflow","Update workflow is unsupported or disabled.");await this._cancelWorkflow();const t=this._createUpdateWorkflow("awaiting-update-feature-candidate");t.data.candidates=e,await t.start(),this._set("activeWorkflow",t)}async startUpdateWorkflowAtFeatureEdit(e){if(!this.canUpdate)return void E("editing:unsupported-workflow","Update workflow is unsupported or disabled.");await this._cancelWorkflow();const t=this._createUpdateWorkflow("editing-existing-feature");t.data.edits.feature=e,await t.start(),this._set("activeWorkflow",t)}async deleteFeatureFromWorkflow(){const{activeWorkflow:e}=this;e&&"update"===e.type?(await this._delete(e.data.edits.feature),await e.reset()):E("editing:unsupported-workflow","Deleting requires an active update workflow.")}async cancelWorkflow(e){return this._cancelWorkflow({warn:!0,...e})}refreshCreationTemplates(){const e=[];for(const{layer:t,supports:r}of this.editableItems)t.loaded&&r.includes("create")&&e.push(t);this.featureTemplatesViewModel.layers=e}async _cancelWorkflow(e){const t=this.activeWorkflow;if(!t)return void(e&&e.warn&&E("editing:no-active-workflow","There is no active workflow to cancel."));if(!e||!1!==e.force)return this.emit("workflow-cancel"),this._set("activeWorkflow",null),void await t.cancel(e);await t.cancel(e),this._set("activeWorkflow",null)}_createCreateFeaturesWorkflow(e,t){return f.create(this,e,t,((e,t,r)=>this._applyEdits(e,t,r)),((e,t)=>this._addAttachments(e,t)))}_createCreateWorkflow(e){return y.create(this,e,((e,t,r)=>this._applyEdits(e,t,r)))}_createUpdateWorkflow(e){return k.create(this,e,((e,t)=>this._applyEdits(e,t)))}async _delete(e){const t=e.sourceLayer;"applyEdits"in t&&await this._applyEdits(t,{deleteFeatures:[e]})}_addAttachments(e,t){const r=[];return t?.forEach((t=>r.push(this._addAttachment(e,t.feature,t.attachment)))),Promise.all(r)}async _addAttachment(e,t,r){let a=null;return await this._queueOperation((async()=>(a=await e.addAttachment(t,r).catch((e=>{throw e?.error||e})),a))),a}async _applyEdits(e,t,r){let a=null;return await this._queueOperation((async()=>{if(e.capabilities.operations.supportsQuery){const o=await this.view.whenLayerView(e);return a=await e.applyEdits(t,r),await d((()=>!o.updating)),a}return a=await e.applyEdits(t,r),a})),a}_queueOperation(e){this._activityQueue.push(e),this.notifyChange("syncing");const t=(e,t)=>{const r=t.indexOf(e);r>-1&&t.splice(r,1)};return e().then((e=>{if("error"in e&&e.error)throw e.error;if("addFeatureResults"in e){const{addFeatureResults:t,deleteFeatureResults:r,updateFeatureResults:a}=e,o=t.find((e=>!!e.error))||a.find((e=>!!e.error))||r.find((e=>!!e.error));if(o)throw o.error}return e})).catch((r=>{E("editing:operation-error","An error occurred.",{error:r});const a={error:r,retry:()=>(t(a,this.failures),this._queueOperation(e)),cancel:()=>{t(a,this.failures)}};this._set("failures",[...this.failures,a])})).then((()=>{t(e,this._activityQueue),this.notifyChange("syncing")}))}_getEditableItemFromLayer(e,t=!0){const{data:r,editing:a,operations:o}=e.capabilities,i=A(this.layerInfos,e),s=!(!r.supportsAttachment||i&&!1===i.allowAttachments),n=a.supportsGeometryUpdate&&(!i||!1!==i.geometryUpdatesEnabled),l=!i||!1!==i.attributeUpdatesEnabled;if(t)return{hasAttachments:s,layer:e,supports:[],geometryUpdatesEnabled:n,attributeUpdatesEnabled:l};const d=[];return o.supportsAdd&&(this.allowedWorkflows.includes("create")||this.allowedWorkflows.includes("create-features"))&&(!i||!1!==i.enabled&&!1!==i.addEnabled)&&d.push("create"),o.supportsUpdate&&this.allowedWorkflows.includes("update")&&(!i||!1!==i.enabled&&!1!==i.updateEnabled)&&d.push("update"),!1!==(i&&i.deleteEnabled)&&o.supportsDelete&&d.push("delete"),{hasAttachments:s,layer:e,supports:d,geometryUpdatesEnabled:n,attributeUpdatesEnabled:l}}};e([c({readOnly:!0})],M.prototype,"activeWorkflow",void 0),e([c({readOnly:!0})],M.prototype,"_activityQueue",void 0),e([c({value:[...F]})],M.prototype,"allowedWorkflows",null),e([c({readOnly:!0})],M.prototype,"canCreate",null),e([c({readOnly:!0})],M.prototype,"canUpdate",null),e([c({readOnly:!0})],M.prototype,"editableItems",null),e([c({readOnly:!0})],M.prototype,"failures",void 0),e([c()],M.prototype,"attachmentsViewModel",void 0),e([c()],M.prototype,"featureFormViewModel",void 0),e([c()],M.prototype,"featureTemplatesViewModel",void 0),e([c()],M.prototype,"labelOptions",null),e([c()],M.prototype,"layerInfos",void 0),e([c()],M.prototype,"sketchViewModel",void 0),e([c()],M.prototype,"snappingOptions",null),e([c()],M.prototype,"spinnerViewModel",void 0),e([c()],M.prototype,"state",null),e([c({readOnly:!0})],M.prototype,"syncing",null),e([c()],M.prototype,"tooltipOptions",null),e([c()],M.prototype,"view",null),M=e([u(b)],M);const O=M;export{O as default};
