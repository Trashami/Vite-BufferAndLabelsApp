/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.25/esri/copyright.txt for details.
*/
import{_ as e}from"../../chunks/tslib.es6.js";import{remove as t}from"../../core/arrayUtils.js";import{makeHandle as a,handlesGroup as i}from"../../core/handleUtils.js";import{unwrap as r,removeMaybe as o,isSome as n,isNone as s,destroyMaybe as l}from"../../core/maybe.js";import{whenOnce as c,watch as d,syncAndInitial as u}from"../../core/reactiveUtils.js";import{generateUUID as h}from"../../core/uuid.js";import"../../core/Logger.js";import"../../core/accessorSupport/ensureType.js";import"../../core/Error.js";import"../../core/has.js";import{subclass as f}from"../../core/accessorSupport/decorators/subclass.js";import p from"../../views/interactive/snapping/FeatureSnappingLayerSource.js";import{CreateFeaturesWorkflowData as m}from"./CreateFeaturesWorkflowData.js";import w from"./Workflow.js";import{startCreatingNewFeature as g,findLayerInfo as v,updateGraphicSymbolWhenRequired as _,isTerminalUpdateEventType as y,getVisualVariableAttributes as M,startUpdatingFeature as b,createWorkflowSteps as F,avoidFeatureTemplateSelectionWithOnlyOneItem as A,visualVariableInteractiveUpdate as V}from"./workflowUtils.js";var I;const k=Symbol();let j=I=class extends w{constructor(e){super(e),this.type="create-features",this.createFeatureState="create-new",this._featureFormHandle=null,this._visualVariableAttributes={rotation:null,size:null},this._attachmentFileInfos=new Map,this._highlightHandles=new Map,this._preventDefaultActionOnCancel=!1}get numPendingFeatures(){return this.data.viewModel.sketchViewModel.layer.graphics.length}get pendingFeatures(){return this.data.viewModel.sketchViewModel.layer.graphics}async updatePendingFeature(e,a){return this._preventDefaultActionOnCancel=!0,this.data.viewModel.sketchViewModel.cancel(),t(this._lastActiveGraphics,e),this._startUpdating(e,a)}static create(e,t,a,i,o){const n=new I({data:new m({creationInfo:r(t),viewModel:e}),onCommit:async e=>{const t=e.viewModel.sketchViewModel.layer.graphics.toArray(),a=e.creationInfo.layer,r=a.capabilities.editing.supportsGlobalId&&"globalIdField"in a,s=n._attachmentFileInfos;if(0===s.size)return void await i(a,{addFeatures:t});if(r){const e=n._getAttachmentEditsWithGlobalIds(t,a,s),r="addAttachments"in e?{globalIdUsed:!0}:void 0;return void await i(a,e,r)}const{addFeatureResults:l}=await i(a,{addFeatures:t}),c=n._getAddAttachmentsData(t,l,a,s);await o(a,c)}});return n._set("steps",this._createWorkflowSteps(n,a)),n}_fadeExistingFeatures(e){if("effect"in e){const t=e.effect;return e.effect="saturate(0.6) opacity(0.8)",a((()=>e.effect=t))}const t=e.opacity;return e.opacity=.7,a((()=>e.opacity=t))}_highlight(e){const t=this.data.viewModel.view;"3d"===t.type&&this._highlightHandles.set(e,t.highlight(e))}_removeHighlight(e){o(this._highlightHandles.get(e)),this._highlightHandles.delete(e)}async _startCreating(e){return this.createFeatureState="create-new",g(this.data.viewModel.sketchViewModel,this.data.creationInfo,e)}async _startUpdating(e,t){const{featureFormViewModel:a,layerInfos:r,sketchViewModel:s,view:l}=this.data.viewModel,c=this.data.creationInfo.layer,d=v(r,c)?.formTemplate,u=l.spatialReference;return a.set({arcadeEditType:"INSERT",feature:e,formTemplate:d,spatialReference:u,view:l}),o(this._featureFormHandle),this._featureFormHandle=i([a.on("value-change",(async()=>{e.attributes=a.getValues(),await _(e,t)})),s.on(["update","undo","redo"],(e=>{("undo"===e.type||"redo"===e.type||"update"===e.type&&n(e.toolEventInfo)&&y(e.toolEventInfo.type))&&a.notifyFeatureGeometryChanged()}))]),this._removeHighlight(e),this.createFeatureState="update-pending",this._visualVariableAttributes=M(e),b(s,e,c,this._visualVariableAttributes,t)}static _createWorkflowSteps(e,i="awaiting-feature-creation-info"){const{data:r,handles:h}=e;let f=null,m=!0;const w=new Map,g=F(["awaiting-feature-creation-info","creating-features","adding-attachment","editing-attachment"],i,{"awaiting-feature-creation-info":()=>({id:"awaiting-feature-creation-info",async setUp(){r.creationInfo=null,h.add(r.viewModel.featureTemplatesViewModel.on("select",(({item:e})=>{r.creationInfo={layer:e.layer,template:e.template},r.viewModel.activeWorkflow.next()})),this.id)},async tearDown(){h.remove(this.id)}}),"creating-features":()=>({id:"creating-features",async setUp(){if(h.has(this.id))return;const i=r.viewModel.view,g=r.viewModel.sketchViewModel;m=g.updateOnGraphicClick,g.updateOnGraphicClick=!1,e._lastActiveGraphics=[],e._featureFormHandle=o(e._featureFormHandle),e._visualVariableAttributes={rotation:null,size:null};const v="2d"===i.type?e._fadeExistingFeatures(r.creationInfo.layer):null,_=g.on("create",(async t=>{if("cancel"===t.state){if(e._preventDefaultActionOnCancel)return void(e._preventDefaultActionOnCancel=!1);if(e._lastActiveGraphics.length<1)return e._startCreating(w);const t=e._lastActiveGraphics.pop();return e._startUpdating(t,w)}if("complete"===t.state)return e._startUpdating(t.graphic,w)})),y=g.on("update",(async t=>{const o=t.graphics[0];if("complete"===t.state){if(o!==f&&(e._lastActiveGraphics.push(o),e._highlight(o)),f=null,"add"!==r.viewModel.attachmentsViewModel.mode&&"edit"!==r.viewModel.attachmentsViewModel.mode||r.viewModel.activeWorkflow.previous(),t.aborted&&e._preventDefaultActionOnCancel)return void(e._preventDefaultActionOnCancel=!1);const n=i.cursor;return i.cursor="progress",h.add([a((()=>i.cursor=n)),i.on("click",(e=>e.preventDefault()))],k),c((()=>!r.viewModel.featureFormViewModel.updating)).then((()=>{h.remove(k),e._startCreating(w)}))}if("start"===t.state){e._removeHighlight(o);const t=r.viewModel.attachmentsViewModel;"add"!==t.mode&&"edit"!==t.mode||r.viewModel.activeWorkflow.previous(),t.fileInfos.removeAll(),t.graphic=o,t.mode="view";(e._attachmentFileInfos.get(o)||[]).forEach((({file:e,form:a})=>t.addFile(e,a)))}await V(i,o,t,e._visualVariableAttributes,w);const s=o.attributes;if(n(e._visualVariableAttributes.rotation)){const{field:t}=e._visualVariableAttributes.rotation;r.viewModel.featureFormViewModel.setValue(t,s[t])}if(n(e._visualVariableAttributes.size)){const{field:t}=e._visualVariableAttributes.size;r.viewModel.featureFormViewModel.setValue(t,s[t])}})),M=g.on("delete",(async a=>{const i=a.graphics[0];t(e._lastActiveGraphics,i),f=i}));let b=null;const F=d((()=>{const e=g.snappingOptions.featureSources.find((e=>e.layer===r.creationInfo.layer));return{hasFeatureLayerSource:!!e,enabled:e?.enabled??!1}}),(({hasFeatureLayerSource:e,enabled:t})=>{const a=g.snappingOptions.featureSources;e?(s(b)&&(b=new p({layer:g.layer,enabled:t}),a.add(b)),b.enabled=t):(n(b)&&a.remove(b),b=l(b))}),u),A=i.on("immediate-click",(async t=>{const{results:a}=await i.hitTest(t,{include:g.layer}),r=a.find((e=>"graphic"===e.type));if(r){const t=r.graphic;if("transform"===g.activeTool||"reshape"===g.activeTool){if(g.updateGraphics.getItemAt(0)===t)return;await e.updatePendingFeature(t,w)}}})),I=d((()=>r.viewModel.attachmentsViewModel.mode),(e=>{"add"===e&&r.viewModel.activeWorkflow.go("adding-attachment"),"edit"===e&&r.viewModel.activeWorkflow.go("editing-attachment")}));await e._startCreating(w);const j={remove:()=>{o(e._featureFormHandle),_.remove(),y.remove(),M.remove(),F.remove(),n(b)&&g.snappingOptions.featureSources.remove(b),b=l(b),g.cancel(),A.remove(),I.remove(),o(v)}};h.add(j,this.id)},async tearDown(t){t.cancelled&&(r.viewModel.sketchViewModel.layer.removeAll(),h.remove([this.id,k]),r.viewModel.attachmentsViewModel.fileInfos.removeAll(),e._attachmentFileInfos.clear(),r.viewModel.sketchViewModel.updateOnGraphicClick=m)}}),"adding-attachment":()=>({id:"adding-attachment",parent:"creating-features",async setUp(){},async tearDown(){const{graphic:t,fileInfos:a}=r.viewModel.attachmentsViewModel;e._attachmentFileInfos.set(t,a.toArray()),r.viewModel.attachmentsViewModel.mode="view"}}),"editing-attachment":()=>({id:"editing-attachment",parent:"creating-features",async setUp(){},async tearDown(){const{graphic:t,fileInfos:a}=r.viewModel.attachmentsViewModel;e._attachmentFileInfos.set(t,a.toArray()),r.viewModel.attachmentsViewModel.mode="view"}})});return A(r,g)}_getAddAttachmentsData(e,t,a,i){const r=[];return t.forEach(((t,o)=>{if(!t.error){const n=e[o],s=i.get(n)||[];n.attributes[a.objectIdField]=t.objectId,s.forEach((({form:e})=>r.push({feature:n,attachment:e})))}})),r}_getAttachmentEditsWithGlobalIds(e,t,a){const i=[];return e.forEach(((r,o)=>{const n=a.get(r)||[];let l=r.attributes[t.globalIdField];s(l)&&(l=h(),e[o].attributes[t.globalIdField]=l),n.forEach((({file:e})=>i.push({feature:r,attachment:{globalId:h(),data:e}})))})),i.length?{addFeatures:e,addAttachments:i}:{addFeatures:e}}};j=I=e([f("esri.widgets.Editor.CreateFeaturesWorkflow")],j);const C=j;export{C as default};
