/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.25/esri/copyright.txt for details.
*/
import{_ as e}from"../../chunks/tslib.es6.js";import{isSome as t}from"../../core/maybe.js";import{watch as a}from"../../core/reactiveUtils.js";import"../../core/Logger.js";import"../../core/accessorSupport/ensureType.js";import"../../core/arrayUtils.js";import"../../core/Error.js";import"../../core/has.js";import{subclass as i}from"../../core/accessorSupport/decorators/subclass.js";import o from"./CreateWorkflowData.js";import{Edits as r}from"./Edits.js";import s from"./Workflow.js";import{createWorkflowSteps as n,avoidFeatureTemplateSelectionWithOnlyOneItem as d,setUpFeatureAdd as c,findLayerInfo as l,getVisualVariableAttributes as w,startUpdatingFeature as f,visualVariableInteractiveUpdate as m,updateGraphicSymbolWhenRequired as u}from"./workflowUtils.js";var p;let v=p=class extends s{constructor(e){super(e),this.type="create"}static create(e,t,a){const i=new p({data:new o({edits:new r,viewModel:e}),onCommit:async e=>{await a(e.creationInfo.layer,{addFeatures:[e.edits.feature]})}});return i._set("steps",this._createWorkflowSteps(i,t)),i}static _createWorkflowSteps(e,i="awaiting-feature-creation-info"){const{data:o,handles:r}=e,s=new Map,p=n(["awaiting-feature-creation-info","awaiting-feature-to-create","editing-new-feature","adding-attachment","editing-attachment"],i,{"awaiting-feature-creation-info":()=>({id:"awaiting-feature-creation-info",async setUp(){o.creationInfo=null,o.edits.feature=null,o.viewModel.featureTemplatesViewModel.select(null),r.add(o.viewModel.featureTemplatesViewModel.on("select",(({item:e})=>{o.creationInfo={layer:e.layer,template:e.template},o.viewModel.activeWorkflow.next()})),this.id)},async tearDown(){r.remove(this.id)}}),"awaiting-feature-to-create":()=>({id:"awaiting-feature-to-create",async setUp(){r.add(await c(o.viewModel.sketchViewModel,o.creationInfo,(e=>{o.edits.feature=e,o.viewModel.activeWorkflow.next()}),s),this.id)},async tearDown(){r.remove(this.id)}}),"editing-new-feature":()=>({id:"editing-new-feature",async setUp(){const e=o.edits.feature,i=e.sourceLayer,n=o.viewModel,d=n.sketchViewModel,c=l(n.layerInfos,i)?.formTemplate,{spatialReference:p}=n.view;n.featureFormViewModel.set({arcadeEditType:"INSERT",feature:e,formTemplate:c,spatialReference:p}),d.allowDeleteKey=!1;const v=w(e);await f(d,e,i,v,s);const M=d.on("update",(async e=>{const a=e.graphics[0];if("complete"===e.state)return f(d,a,i,v,s);await m(d.view,a,e,v,s);const o=a.attributes;if(t(v.rotation)){const{field:e}=v.rotation;n.featureFormViewModel.setValue(e,o[e])}if(t(v.size)){const{field:e}=v.size;n.featureFormViewModel.setValue(e,o[e])}}));r.add([o.viewModel.featureFormViewModel.on("value-change",(async()=>{o.edits.updateAttributes(o.viewModel.featureFormViewModel.getValues()),e.attributes=o.edits.feature.attributes,"3d"===d.view.type&&await u(e,s)})),M,a((()=>o.viewModel.attachmentsViewModel.mode),(e=>{"add"===e&&o.viewModel.activeWorkflow.go("adding-attachment"),"edit"===e&&o.viewModel.activeWorkflow.go("editing-attachment")}))],this.id)},async tearDown(e){e.cancelled&&o.viewModel.sketchViewModel.layer.removeAll(),r.remove(this.id)}}),"adding-attachment":()=>({id:"adding-attachment",parent:"editing-new-feature",async setUp(){},async tearDown(){o.viewModel.attachmentsViewModel.mode="view"}}),"editing-attachment":()=>({id:"editing-attachment",parent:"editing-new-feature",async setUp(){},async tearDown(){o.viewModel.attachmentsViewModel.mode="view"}})});return d(o,p)}};v=p=e([i("esri.widgets.Editor.CreateWorkflow")],v);const M=v;export{M as default};
